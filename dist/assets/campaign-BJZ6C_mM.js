var V=Object.defineProperty;var W=(r,e,t)=>e in r?V(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var b=(r,e,t)=>W(r,typeof e!="symbol"?e+"":e,t);import{S as x,g as z,P as Y}from"./synapse-CrApDaq9.js";import{s as T}from"./analytics-BeoNQ3KZ.js";import{v as G}from"./vendor-misc-Ce8oRwJD.js";const j={claude35Sonnet:"anthropic/claude-3.5-sonnet"},K="https://openrouter.ai/api/v1/chat/completions",D="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";console.log("[OpenRouter] API Key loaded:",`${D.substring(0,20)}...`);async function Q(r,e={}){var c;const{model:t=j.claude35Sonnet,temperature:s=.7,maxTokens:a=2e3,topP:i=1,stream:n=!1}=e,o={model:t,messages:r,temperature:s,max_tokens:a,top_p:i,stream:n};console.log("[OpenRouter] Making API request:",{model:t,messageCount:r.length,hasApiKey:!0,apiKeyPrefix:D==null?void 0:D.substring(0,20)});try{const d=await fetch(K,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${D}`,"HTTP-Referer":window.location.origin,"X-Title":"MARBA"},body:JSON.stringify(o)});if(console.log("[OpenRouter] Response status:",d.status),!d.ok){const u=await d.json().catch(()=>({}));throw console.error("[OpenRouter] Error response:",u),new Error(`OpenRouter API error: ${d.status} - ${((c=u.error)==null?void 0:c.message)||d.statusText}`)}const l=await d.json();if(!l.choices||l.choices.length===0)throw new Error("No response from OpenRouter API");return l.choices[0].message.content}catch(d){throw console.error("OpenRouter API error:",d),d}}const J={maxAttempts:3,initialDelayMs:1e3,maxDelayMs:1e4,backoffMultiplier:2,retryableCategories:["network","api_limit","timeout","server_error"]};class P{static async executeWithRetry(e,t={},s,a=[]){const i={...J,...t};let n=null;for(let o=1;o<=i.maxAttempts;o++)try{return s&&s({attempt:o,maxAttempts:i.maxAttempts,error:n||void 0}),await e()}catch(c){const d=this.categorizeError(c);if(n=d,console.error(`[ErrorHandler] Attempt ${o}/${i.maxAttempts} failed:`,{category:d.category,message:d.message,retryable:d.retryable}),!this.isRetryable(d,i)){console.error("[ErrorHandler] Non-retryable error encountered:",d);break}if(o===i.maxAttempts){console.error("[ErrorHandler] Max retry attempts reached");break}const l=this.calculateBackoffDelay(o,i.initialDelayMs,i.maxDelayMs,i.backoffMultiplier);console.log(`[ErrorHandler] Retrying in ${l}ms...`),s&&s({attempt:o,maxAttempts:i.maxAttempts,nextRetryIn:l,error:d}),await this.sleep(l)}if(a.length>0){console.log(`[ErrorHandler] Attempting ${a.length} fallback strategies...`);for(const o of a)try{console.log(`[ErrorHandler] Trying fallback: ${o.name}`);const c=await o.execute();return console.log(`[ErrorHandler] Fallback "${o.name}" succeeded`),c}catch(c){console.error(`[ErrorHandler] Fallback "${o.name}" failed:`,c)}}throw n||new Error("Operation failed with unknown error")}static categorizeError(e){const t=new Date;if(this.isAppError(e))return e;const s=e instanceof Error?e:new Error(String(e));let a="unknown",i="retryable",n="An unexpected error occurred. Please try again.";const o=s.message.toLowerCase();o.includes("network")||o.includes("fetch")||o.includes("connection")||o.includes("ECONNREFUSED")||o.includes("ETIMEDOUT")?(a="network",n="Network connection issue. Please check your internet connection and try again."):o.includes("rate limit")||o.includes("too many requests")||o.includes("429")?(a="api_limit",n="Service is busy. We'll retry automatically in a moment."):o.includes("unauthorized")||o.includes("authentication")||o.includes("401")||o.includes("403")?(a="authentication",i="fatal",n="Authentication failed. Please check your credentials."):o.includes("validation")||o.includes("invalid")?(a="validation",i="fatal",n="Invalid input. Please check your data and try again."):o.includes("timeout")||o.includes("timed out")?(a="timeout",n="Request timed out. Retrying..."):(o.includes("500")||o.includes("502")||o.includes("503")||o.includes("server error"))&&(a="server_error",n="Server error. We're retrying automatically.");const c=i==="retryable"&&["network","api_limit","timeout","server_error"].includes(a);return{category:a,severity:i,message:s.message,userMessage:n,originalError:s,retryable:c,timestamp:t}}static isRetryable(e,t){return e.severity==="fatal"?!1:t.retryableCategories.includes(e.category)}static calculateBackoffDelay(e,t,s,a){const i=t*Math.pow(a,e-1),n=i*.25*(Math.random()*2-1),o=Math.min(i+n,s);return Math.floor(o)}static sleep(e){return new Promise(t=>setTimeout(t,e))}static isAppError(e){return typeof e=="object"&&e!==null&&"category"in e&&"severity"in e&&"userMessage"in e}static getUserMessage(e){return this.categorizeError(e).userMessage}static logError(e,t){const s=this.categorizeError(e);console.error("[ErrorHandler]",{timestamp:s.timestamp.toISOString(),category:s.category,severity:s.severity,message:s.message,userMessage:s.userMessage,retryable:s.retryable,context:t})}static createCacheFallback(e,t){return{name:"cache",description:"Use cached data from previous request",execute:async()=>{const s=await t(e);if(!s)throw new Error("No cached data available");return s}}}static createDegradedModeFallback(e,t="Use minimal data in degraded mode"){return{name:"degraded_mode",description:t,execute:e}}}function C(r,e){P.logError(r,e)}const I={apiUrl:"https://api.bannerbear.com/v2",apiKey:"",timeout:6e4,rateLimit:{concurrent:2}};function q(){return!!I.apiKey}const X={linkedin:{feed:{width:1200,height:627,aspectRatio:"1.91:1"},story:{width:1080,height:1920,aspectRatio:"9:16"}},facebook:{feed:{width:1200,height:630,aspectRatio:"1.91:1"},story:{width:1080,height:1920,aspectRatio:"9:16"}},instagram:{feed:{width:1080,height:1080,aspectRatio:"1:1"},story:{width:1080,height:1920,aspectRatio:"9:16"},reel:{width:1080,height:1920,aspectRatio:"9:16"}},twitter:{feed:{width:1200,height:675,aspectRatio:"16:9"},card:{width:800,height:418,aspectRatio:"1.91:1"}},tiktok:{video:{width:1080,height:1920,aspectRatio:"9:16"}}},Z={campaignType:"authority_builder",templateId:"TEMPLATE_AUTHORITY_001",name:"Authority Builder - Professional",description:"Clean, professional design with emphasis on data and expertise. Features bold headline, supporting stats, and trust elements.",fieldMappings:{headline:"headline",subheadline:"subheadline",stat:"key_stat",bodyText:"supporting_text",logoUrl:"logo",brandColor:"primary_color"},defaults:{subheadline:"Industry Insights",supporting_text:"Expert analysis backed by data"},style:{colorScheme:"professional",layout:"centered",typography:"bold"}},ee={campaignType:"trust_builder",templateId:"TEMPLATE_TRUST_001",name:"Trust Builder - Testimonial",description:"Warm, trustworthy design featuring customer testimonials and ratings. Emphasizes real results and satisfaction.",fieldMappings:{headline:"headline",testimonial:"testimonial_text",customerName:"customer_name",bodyText:"result_text",logoUrl:"logo",brandColor:"primary_color"},defaults:{testimonial_text:"Exceptional service and results!",customer_name:"Verified Customer"},style:{colorScheme:"warm",layout:"split",typography:"elegant"}},te={campaignType:"community_champion",templateId:"TEMPLATE_COMMUNITY_001",name:"Community Champion - Local",description:"Vibrant, community-focused design highlighting local events and timing. Features location emphasis and timely messaging.",fieldMappings:{headline:"headline",subheadline:"subheadline",location:"location_text",date:"date_text",bodyText:"event_description",logoUrl:"logo",brandColor:"primary_color"},defaults:{location_text:"Your Local Community",date_text:"This Week"},style:{colorScheme:"vibrant",layout:"overlay",typography:"modern"}},se={campaignType:"revenue_rush",templateId:"TEMPLATE_REVENUE_001",name:"Revenue Rush - Commerce",description:"Bold, urgency-driven design for social commerce. Features product focus, pricing, and clear CTAs for immediate sales.",fieldMappings:{headline:"headline",price:"price_text",offer:"offer_text",bodyText:"product_description",logoUrl:"logo",brandColor:"primary_color"},defaults:{offer_text:"Limited Time Offer",product_description:"Shop now and save"},style:{colorScheme:"bold",layout:"product-focused",typography:"impactful"}},ae={campaignType:"viral_spark",templateId:"TEMPLATE_VIRAL_001",name:"Viral Spark - Trending",description:"Dynamic, attention-grabbing design for video-first content. Features bold text overlays and trending aesthetics.",fieldMappings:{headline:"headline",trendingText:"trending_text",bodyText:"hook_text",logoUrl:"logo",brandColor:"primary_color"},defaults:{trending_text:"POV:",hook_text:"Watch till the end"},style:{colorScheme:"dynamic",layout:"vertical-video",typography:"bold"}},M={authority_builder:Z,trust_builder:ee,community_champion:te,revenue_rush:se,viral_spark:ae};function ie(r){return M[r]}function ne(r){return!M[r].templateId.startsWith("TEMPLATE_")}class oe{constructor(){b(this,"apiUrl");b(this,"apiKey");b(this,"requestQueue",[]);b(this,"visualCache",new Map);b(this,"CACHE_TTL",7*24*60*60*1e3);this.apiUrl=I.apiUrl,this.apiKey=I.apiKey}async createImage(e){this.validateConfig();try{const t=await this.makeRequest("/images",{method:"POST",body:JSON.stringify({template:e.templateId,modifications:this.formatModifications(e.modifications),metadata:e.metadata,webhook_url:null})});return await this.pollForImage(t.uid)}catch(t){throw this.handleError(t)}}async createCarousel(e){this.validateConfig();try{const t=e.slides.map((s,a)=>this.createImage({templateId:e.templateId,modifications:s,metadata:{...e.metadata,slide_index:a,total_slides:e.slides.length}}));return await this.withRateLimit(t)}catch(t){throw this.handleError(t)}}async listTemplates(){this.validateConfig();try{return await this.makeRequest("/templates",{method:"GET"})}catch(e){throw this.handleError(e)}}async getTemplate(e){this.validateConfig();try{return await this.makeRequest(`/templates/${e}`,{method:"GET"})}catch(t){throw this.handleError(t)}}isConfigured(){return q()}async generateCampaignVisual(e){var i;this.validateConfig();const t=Date.now(),s=this.getCacheKey(e),a=this.getCachedVisual(s);if(a)return console.log(`[Bannerbear] Cache hit for ${e.campaignType}/${e.platform}`),a;try{const n=ie(e.campaignType),o=e.templateId||n.templateId;if(!ne(e.campaignType)&&!e.templateId)throw new Error(`Template for ${e.campaignType} not configured in Bannerbear dashboard. Please create template and update campaign-templates.config.ts`);const c=this.mapCampaignContentToTemplate(e.content,n,e.branding),d=e.platform,l=e.format||"feed",u=(i=X[d])==null?void 0:i[l];if(!u)throw new Error(`Invalid platform/format: ${e.platform}/${l}`);console.log(`[Bannerbear] Generating ${e.campaignType} visual for ${e.platform}...`);const g=await this.makeRequest("/images",{method:"POST",body:JSON.stringify({template:o,modifications:this.formatModifications(c),metadata:{campaign_type:e.campaignType,platform:e.platform,format:l,brand_name:e.content.brandName},webhook_url:null})}),p=await this.pollForImage(g.uid),h=Date.now()-t,m={id:`visual_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,campaignType:e.campaignType,platform:e.platform,format:l,imageUrl:p,bannerbearUid:g.uid,templateId:o,metadata:{generatedAt:new Date,generationTime:h,dimensions:{width:u.width,height:u.height},aspectRatio:u.aspectRatio},status:"completed"};return this.cacheVisual(s,m),console.log(`[Bannerbear] ✓ Generated in ${h}ms: ${p}`),m}catch(n){return console.error(`[Bannerbear] Failed to generate ${e.campaignType} visual:`,n),{id:`visual_failed_${Date.now()}`,campaignType:e.campaignType,platform:e.platform,format:e.format||"feed",imageUrl:"",bannerbearUid:"",templateId:"",metadata:{generatedAt:new Date,generationTime:Date.now()-t,dimensions:{width:0,height:0},aspectRatio:"0:0"},status:"failed",error:n.message||"Image generation failed"}}}async generateAllPlatforms(e){const t=e.platforms||["linkedin","facebook","instagram","twitter"],s=Date.now();console.log(`[Bannerbear] Generating ${e.campaignType} visuals for ${t.length} platforms...`);const a=t.map(u=>this.generateCampaignVisual({campaignType:e.campaignType,platform:u,content:e.content,branding:e.branding}).catch(g=>(console.error(`[Bannerbear] Failed to generate for ${u}:`,g),null))),n=(await this.withRateLimit(a)).filter(u=>u!==null),o=n.filter(u=>u.status==="completed").length,c=n.filter(u=>u.status==="failed").length,d=n.filter(u=>u.status==="failed").map(u=>({platform:u.platform,error:u.error||"Unknown error"})),l=Date.now()-s;return console.log(`[Bannerbear] Batch complete in ${l}ms: ${o} succeeded, ${c} failed`),{total:t.length,completed:o,failed:c,visuals:n,errors:d}}validateConfig(){if(!this.apiKey)throw new Error("Bannerbear API key not configured. Please set VITE_BANNERBEAR_API_KEY in your .env file.")}async makeRequest(e,t){const s=`${this.apiUrl}${e}`,a=await fetch(s,{...t,headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,...t.headers},signal:AbortSignal.timeout(I.timeout)});if(!a.ok){const i=await a.json().catch(()=>({}));throw{message:i.message||a.statusText,statusCode:a.status,code:i.code}}return a.json()}async pollForImage(e,t=30){let s=0;const a=2e3;for(;s<t;)try{const i=await this.makeRequest(`/images/${e}`,{method:"GET"});if(i.status==="completed")return i.image_url_png||i.image_url_jpg||i.image_url||"";if(i.status==="failed")throw new Error("Image generation failed");await this.sleep(a),s++}catch(i){if(s>=t-1)throw i;await this.sleep(a),s++}throw new Error("Image generation timed out after 60 seconds")}formatModifications(e){return Object.entries(e).map(([t,s])=>({name:t,text:String(s)}))}async withRateLimit(e){const{concurrent:t}=I.rateLimit,s=[];for(let a=0;a<e.length;a+=t){const i=e.slice(a,a+t),n=await Promise.all(i);s.push(...n),a+t<e.length&&await this.sleep(1e3)}return s}handleError(e){const t=e.statusCode||500,s=e.message||"Bannerbear API error",a=t===429||t>=500;return{message:s,code:e.code,statusCode:t,retryable:a}}sleep(e){return new Promise(t=>setTimeout(t,e))}mapCampaignContentToTemplate(e,t,s){const a={},{fieldMappings:i,defaults:n}=t;return i.headline&&(a[i.headline]=e.headline),i.subheadline&&e.subheadline&&(a[i.subheadline]=e.subheadline),i.bodyText&&e.bodyText&&(a[i.bodyText]=e.bodyText),i.stat&&e.stats&&e.stats.length>0&&(a[i.stat]=e.stats[0]),i.testimonial&&e.testimonial&&(a[i.testimonial]=e.testimonial),i.customerName&&e.customerName&&(a[i.customerName]=e.customerName),i.location&&e.location&&(a[i.location]=e.location),i.logoUrl&&(s!=null&&s.logoUrl)&&(a[i.logoUrl]=s.logoUrl),i.brandColor&&(s!=null&&s.primaryColor)&&(a[i.brandColor]=s.primaryColor),n&&Object.entries(n).forEach(([o,c])=>{a[o]||(a[o]=c)}),a}getCacheKey(e){return[e.campaignType,e.platform,e.format||"feed",e.content.headline,e.content.brandName].join("::")}getCachedVisual(e){const t=this.visualCache.get(e);return t?Date.now()-t.timestamp>this.CACHE_TTL?(this.visualCache.delete(e),null):t.visual:null}cacheVisual(e,t){this.visualCache.set(e,{visual:t,timestamp:Date.now()}),this.visualCache.size%100===0&&this.cleanupCache()}cleanupCache(){const e=Date.now();for(const[t,s]of this.visualCache.entries())e-s.timestamp>this.CACHE_TTL&&this.visualCache.delete(t)}}const re=new oe;class ce{constructor(){b(this,"contentGenerator");b(this,"progressCallbacks");this.contentGenerator=new x,this.progressCallbacks=new Map}async generateCampaign(e,t,s){var i,n,o,c,d;const a=Date.now();console.log(`[CampaignGenerator] Starting campaign generation: ${e.campaignType}`);try{const l=`campaign-${Date.now()}`,u=this.initializeProgress(l,((i=e.options)==null?void 0:i.postsPerCampaign)||7);t&&this.onProgress(l,t),this.updateProgress(l,"initializing",5),this.updateProgress(l,"analyzing_business",10);const g=this.createCampaignTemplate(e.campaignType);this.updateProgress(l,"selecting_insights",20);const p=await this.extractInsights(e.businessContext);this.updateProgress(l,"generating_content",30);const h=await this.generateCampaignPosts(e.campaignType,g,e.businessContext,p,((n=e.options)==null?void 0:n.postsPerCampaign)||g.recommendedCount,((o=e.options)==null?void 0:o.platforms)||["linkedin","facebook"],l,s);((c=e.options)==null?void 0:c.includeVisuals)!==!1&&(this.updateProgress(l,"generating_visuals",70),await this.generateVisualsForPosts(h,s)),((d=e.options)==null?void 0:d.saveToDatabase)!==!1&&(this.updateProgress(l,"saving_to_database",90),await this.saveCampaignToDatabase(e,h));const m={id:e.campaignId,campaignType:e.campaignType,name:g.name,description:g.description,posts:h,totalPosts:h.length,estimatedDuration:g.duration,createdAt:new Date,businessId:e.businessContext.businessData.businessName,metadata:{generatedBy:"ai",sourceInsights:p.map(k=>k.id),confidence:this.calculateCampaignConfidence(h)}};this.updateProgress(l,"complete",100),this.offProgress(l);const f=Date.now()-a;return console.log(`[CampaignGenerator] Campaign generated in ${f}ms: ${h.length} posts`),m}catch(l){throw C(l,{operation:"generateCampaign",campaignType:e.campaignType}),console.error("[CampaignGenerator] Campaign generation failed:",l),l}}async generatePost(e,t){var s,a,i,n,o,c,d,l;console.log(`[CampaignGenerator] Generating single post: ${e.postType}`);try{const u=e.selectedInsights||await this.extractInsights(e.businessContext),g=this.createBusinessProfile(e.businessContext),p=((s=e.platforms)==null?void 0:s[0])||"linkedin",h=await P.executeWithRetry(()=>this.contentGenerator.generate(u,g,{maxContent:1,formats:[this.mapPostTypeToFormat(e.postType)],platforms:e.platforms||[p]}),{maxAttempts:3},t);if(!h.content||h.content.length===0)throw new Error("Content generation failed - no content generated");const m=h.content[0],f={id:`post-${Date.now()}`,type:e.postType,platform:p,content:{headline:(a=m.platformContent[p])==null?void 0:a.headline,hook:(i=m.platformContent[p])==null?void 0:i.hook,body:((n=m.platformContent[p])==null?void 0:n.body)||"",hashtags:((o=m.platformContent[p])==null?void 0:o.hashtags)||[],callToAction:(c=m.platformContent[p])==null?void 0:c.cta},visuals:[],status:"draft",sources:this.createSources(e.businessContext,m.insight),metadata:{impactScore:m.metadata.impactScore,psychologyTriggers:m.metadata.psychologyTriggers,tone:m.metadata.tone,generatedAt:new Date,model:"synapse"}};return((d=e.options)==null?void 0:d.includeVisuals)!==!1&&(f.visuals=await this.generateVisualsForPost(f,t)),((l=e.options)==null?void 0:l.saveToDatabase)!==!1&&await this.savePostToDatabase(f,e.businessContext),console.log(`[CampaignGenerator] Post generated successfully: ${f.id}`),f}catch(u){throw C(u,{operation:"generatePost",postType:e.postType}),console.error("[CampaignGenerator] Post generation failed:",u),u}}createCampaignTemplate(e){const t={trust_builder:{id:"trust-builder",name:"Trust Builder Campaign",description:"Build trust through customer success stories and testimonials",postTypes:["customer_success","value_proposition","behind_the_scenes"],recommendedCount:7,duration:14},authority_builder:{id:"authority-builder",name:"Authority Builder Campaign",description:"Establish expertise through educational content",postTypes:["educational","service_spotlight","problem_solution"],recommendedCount:7,duration:14},problem_solver:{id:"problem-solver",name:"Problem Solver Campaign",description:"Address customer pain points with solutions",postTypes:["problem_solution","customer_success","service_spotlight"],recommendedCount:7,duration:14},differentiator:{id:"differentiator",name:"Value Differentiator Campaign",description:"Highlight what makes you unique",postTypes:["value_proposition","behind_the_scenes","service_spotlight"],recommendedCount:7,duration:14},engagement_driver:{id:"engagement-driver",name:"Community Engagement Campaign",description:"Drive community interaction and loyalty",postTypes:["community_engagement","behind_the_scenes","customer_success"],recommendedCount:7,duration:14}};return t[e]||t.authority_builder}async generateCampaignPosts(e,t,s,a,i,n,o,c){var p,h,m,f,k;const d=[],l=[],u=this.createBusinessProfile(s),g=this.distributePostTypes(t.postTypes,i);for(let w=0;w<i;w++)try{const _=g[w],E=n[w%n.length],U=30+Math.floor(w/i*40);this.updateProgress(o,"generating_content",U,w+1,i);const A=await P.executeWithRetry(()=>this.contentGenerator.generate([a[w%a.length]],u,{maxContent:1,formats:[this.mapPostTypeToFormat(_)],platforms:[E]}),{maxAttempts:2},c,[{name:"template_fallback",description:"Use template-based content generation",execute:async()=>this.generateFromTemplate(_,s,E)}]);if(A.content&&A.content.length>0){const S=A.content[0],H={id:`post-${Date.now()}-${w}`,type:_,platform:E,content:{headline:(p=S.platformContent[E])==null?void 0:p.headline,hook:(h=S.platformContent[E])==null?void 0:h.hook,body:((m=S.platformContent[E])==null?void 0:m.body)||"",hashtags:((f=S.platformContent[E])==null?void 0:f.hashtags)||[],callToAction:(k=S.platformContent[E])==null?void 0:k.cta},visuals:[],status:"draft",sources:this.createSources(s,S.insight),metadata:{impactScore:S.metadata.impactScore,psychologyTriggers:S.metadata.psychologyTriggers,tone:S.metadata.tone,generatedAt:new Date,model:"synapse",templateUsed:t.id}};d.push(H),d.length%3===0&&await this.savePartialResults(d,o)}}catch(_){console.error(`[CampaignGenerator] Failed to generate post ${w+1}:`,_),C(_,{postIndex:w,postType:g[w],sessionId:o}),l.push(_)}if(d.length>0)return console.log(`[CampaignGenerator] Generated ${d.length}/${i} posts successfully`),d;throw new Error(`Failed to generate any posts. Errors: ${l.length}`)}async generateFromTemplate(e,t,s){var o;const a={customer_success:{body:`${t.businessData.businessName} helps customers succeed. Learn how we can help you achieve your goals.`,hashtags:["#CustomerSuccess","#BusinessGrowth"]},service_spotlight:{body:`Discover ${t.businessData.businessName}'s services. We provide quality solutions for ${t.businessData.primaryCustomer||"businesses like yours"}.`,hashtags:["#Services","#Professional"]},problem_solution:{body:`Facing challenges? ${t.businessData.businessName} has the solution. Let us help you overcome obstacles and achieve success.`,hashtags:["#Solutions","#ProblemSolving"]},value_proposition:{body:`What makes ${t.businessData.businessName} unique? We deliver exceptional value through ${((o=t.businessData.selectedServices)==null?void 0:o[0])||"our services"}.`,hashtags:["#Value","#Quality"]},behind_the_scenes:{body:`Get a glimpse behind the scenes at ${t.businessData.businessName}. See how we create value for our customers.`,hashtags:["#BehindTheScenes","#Transparency"]},community_engagement:{body:`Join the ${t.businessData.businessName} community. Connect, share, and grow together.`,hashtags:["#Community","#Engagement"]},educational:{body:`Learn from ${t.businessData.businessName}. We share insights and knowledge to help you succeed.`,hashtags:["#Education","#Learning"]},promotional:{body:`Special offer from ${t.businessData.businessName}. Discover how we can help you today.`,hashtags:["#Promotion","#SpecialOffer"]}},i=a[e]||a.service_spotlight;return{content:[{id:`template-${Date.now()}`,format:"hook-post",insight:{id:"template-insight",type:"service",discovery:i.body,implication:"Template-based content",actionableHook:i.body,confidence:.5,sources:[t.businessData.websiteUrl]},platformContent:{[s]:{body:i.body,hashtags:i.hashtags}},metadata:{impactScore:.5,psychologyTriggers:[],tone:"professional"}}]}}async savePartialResults(e,t){try{console.log(`[CampaignGenerator] Saving partial results: ${e.length} posts`)}catch(s){C(s,{sessionId:t,postsCount:e.length}),console.error("[CampaignGenerator] Failed to save partial results:",s)}}async extractInsights(e){const t=[];return e.uvpData&&(e.uvpData.customerTypes.forEach((s,a)=>{t.push({id:`customer-${a}`,type:"audience",discovery:s.text,implication:`Target messaging for ${s.text}`,actionableHook:`${s.text} face unique challenges we can address`,confidence:s.confidence,sources:[s.source.sourceUrl],targetAudience:s.text})}),e.uvpData.differentiators.forEach((s,a)=>{t.push({id:`differentiator-${a}`,type:"differentiator",discovery:s.text,implication:"Unique value proposition",actionableHook:s.text,confidence:s.confidence,sources:[s.source.sourceUrl]})}),e.uvpData.problemsSolved.forEach((s,a)=>{t.push({id:`problem-${a}`,type:"problem",discovery:s.text,implication:"Customer pain point to address",actionableHook:`Solve ${s.text} effectively`,confidence:s.confidence,sources:[s.source.sourceUrl]})})),t.length===0&&t.push({id:"generic-1",type:"service",discovery:`${e.businessData.businessName} provides quality services`,implication:"Build trust with service quality messaging",actionableHook:"Expert service you can trust",confidence:.7,sources:[e.businessData.websiteUrl]}),t.slice(0,10)}createBusinessProfile(e){var t;return{businessName:e.businessData.businessName,industry:e.businessData.industry||"General",specialization:e.specialization||"Professional Services",targetAudience:e.businessData.primaryCustomer||"Business Owners",tone:((t=e.websiteAnalysis)==null?void 0:t.tone)||"professional",services:e.businessData.selectedServices||[],location:e.businessData.location||""}}distributePostTypes(e,t){const s=[];for(let a=0;a<t;a++)s.push(e[a%e.length]);return s}mapPostTypeToFormat(e){return{customer_success:"story-post",service_spotlight:"hook-post",problem_solution:"hook-post",value_proposition:"data-post",behind_the_scenes:"story-post",community_engagement:"hook-post",educational:"data-post",promotional:"controversial-post"}[e]||"hook-post"}createSources(e,t){const s=[];return s.push({type:"website",url:e.businessData.websiteUrl,confidence:1}),t&&s.push({type:"insight",insightId:t.id,excerpt:t.discovery,confidence:t.confidence}),s}calculateCampaignConfidence(e){return e.length===0?0:e.reduce((s,a)=>s+(a.metadata.impactScore||0),0)/e.length}async generateVisualsForPosts(e,t){for(const s of e)try{s.visuals=await this.generateVisualsForPost(s,t)}catch(a){C(a,{postId:s.id,platform:s.platform}),console.error(`[CampaignGenerator] Visual generation failed for post ${s.id}:`,a)}}async generateVisualsForPost(e,t){try{const s=await P.executeWithRetry(()=>re.generateImage({template:this.selectBannerbearTemplate(e.platform,e.type),modifications:{headline:e.content.headline||"",body:e.content.body.substring(0,200),cta:e.content.callToAction||""}}),{maxAttempts:2,initialDelayMs:1e3},t,[{name:"no_visuals",description:"Continue without visuals",execute:async()=>({image_url:null,uid:null,template:null})}]);return s&&s.image_url?[{id:s.uid,url:s.image_url,type:"image",bannerbearTemplateId:s.template,bannerbearImageId:s.uid,altText:e.content.headline||"Generated visual"}]:[]}catch(s){return C(s,{postId:e.id,platform:e.platform}),[]}}selectBannerbearTemplate(e,t){const s={"linkedin-customer_success":"template-linkedin-story","linkedin-service_spotlight":"template-linkedin-service","facebook-customer_success":"template-facebook-story","instagram-customer_success":"template-instagram-story"},a=`${e}-${t}`;return s[a]||"template-default"}async saveCampaignToDatabase(e,t){console.log(`[CampaignGenerator] Database save not yet implemented for ${e.campaignId}`),console.log(`[CampaignGenerator] Would save campaign with ${t.length} posts`)}async savePostToDatabase(e,t,s){console.log(`[CampaignGenerator] Database save not yet implemented for post ${e.id}`)}initializeProgress(e,t){return{sessionId:e,stage:"initializing",progress:0,currentPost:0,totalPosts:t,errors:[]}}updateProgress(e,t,s,a,i){const n=this.progressCallbacks.get(e);n&&n({sessionId:e,stage:t,progress:s,currentPost:a,totalPosts:i||0,errors:[]})}onProgress(e,t){this.progressCallbacks.set(e,t)}offProgress(e){this.progressCallbacks.delete(e)}getActionableErrorMessage(e,t){const s=P.categorizeError(e),a={network:`Network issue while ${t}. Retrying automatically...`,api_limit:"AI service is busy. Retrying in a moment...",timeout:`${t} is taking longer than expected. Retrying...`,server_error:"Temporary server issue. Retrying automatically...",authentication:"Authentication failed. Please check your API keys in settings.",validation:`Invalid data for ${t}. Please check your inputs.`,unknown:`An unexpected error occurred while ${t}. Retrying...`};return a[s.category]||a.unknown}}const le=new ce,ue={authority_builder:{id:"authority_builder",name:"Authority Builder",description:"7 days to visible expert - thought leadership content positioning you as the go-to industry authority",icon:"GraduationCap",idealFor:["B2B businesses and professional services","Consultants and service providers","Businesses with deep industry expertise","Technical or specialized fields"],platforms:["LinkedIn","Facebook"],contentFormats:["Video tutorials (15-60 seconds)","Industry insights and trends","How-to guides","Behind-the-scenes expertise","Quick tips and tutorials"],exampleOutputs:['"5 Industry Trends Every [Industry] Should Watch"','"Why Most Companies Get [Problem] Wrong (And How to Fix It)"','"Quick Tutorial: How to [Solve Problem] in 60 Seconds"'],dataSources:["YouTube content analysis","Industry trends","Website expertise","Review insights"],color:"blue"},community_champion:{id:"community_champion",name:"Community Champion",description:"Local community leader in 14 days - connection, customer stories, and local exclusive offers",icon:"MapPin",idealFor:["Local businesses (restaurant, salon, retail)","Brick-and-mortar stores","Service area businesses","Neighborhood businesses"],platforms:["Facebook","Instagram","Google Business"],contentFormats:["Behind-the-scenes videos","Local event coverage","Customer spotlights","Community involvement posts","Local exclusive offers"],exampleOutputs:['"Downtown parking problem affecting our neighbors"','"Partnering with [local festival from Perplexity]"','"How we helped Sarah from Main Street save $2000"'],dataSources:["Perplexity (local events)","Weather patterns","Local news","Google Reviews"],color:"orange"},trust_builder:{id:"trust_builder",name:"Trust Builder",description:"Build credibility in 10 days - customer transformation stories and video testimonials",icon:"Award",idealFor:["New businesses (< 2 years)","High-consideration purchases","Competitive markets","Service businesses"],platforms:["Facebook","Instagram"],contentFormats:["Customer video testimonials","Before/after photos","Review highlights","Transformation stories","Social proof amplification"],exampleOutputs:['"How [Customer Name] Achieved [Result] in Just [Timeframe]"',`"Rated 4.9★ by 500+ Customers: Here's What They Say"`,'"Real Results: [Customer] Saved $X Using Our [Service]"'],dataSources:["Google Reviews","Customer testimonials","YouTube comments","Social media mentions"],color:"green"},revenue_rush:{id:"revenue_rush",name:"Revenue Rush",description:"Drive immediate sales in 5 days - shoppable posts and limited offers with social commerce",icon:"DollarSign",idealFor:["E-commerce businesses","Retail stores","Service packages","Seasonal businesses"],platforms:["Instagram Shopping","Facebook Shop"],contentFormats:["Product videos and demos","Customer unboxings","Shoppable posts/Stories","Limited-time offers","Countdown posts"],exampleOutputs:['"Flash Sale: 48 Hours Only - Shop Now"','"Customer Favorite: See Why Everyone Loves This"','"Limited Stock: Only 10 Left - Tag to Purchase"'],dataSources:["Product Scanner","Review mining","Seasonal triggers","Competitive pricing"],color:"purple"},viral_spark:{id:"viral_spark",name:"Viral Spark",description:"Massive reach in 7 days - trending TikTok/Reels content with authenticity over polish",icon:"Sparkles",idealFor:["All SMBs seeking visibility","B2C businesses","Local businesses","Personality-driven brands"],platforms:["TikTok","Instagram Reels"],contentFormats:["Trending challenges","Behind-the-scenes moments","Relatable content","Personality-driven videos","Trending audio participation"],exampleOutputs:['"POV: You walk into [Business] and see this"',`"Things you didn't know about [Industry]"`,'"Trying the viral [trend] at our [business]"'],dataSources:["TikTok/Instagram trending sounds","Viral challenge patterns","YouTube Shorts analytics","Competitor viral content"],color:"pink"}};class de{recommendCampaignType(e){const t=this.calculateScores(e),s=Math.max(t.authority,t.socialProof,t.localPulse);let a,i;t.authority===s?(a="authority_builder",i=this.getAuthorityReasoning(e,t)):t.socialProof===s?(a="social_proof",i=this.getSocialProofReasoning(e,t)):(a="local_pulse",i=this.getLocalPulseReasoning(e,t));const n=Object.values(ue).map(c=>({...c,recommended:c.id===a,recommendationReason:c.id===a?i:void 0,confidenceScore:this.getConfidenceForType(c.id,t)}));return{recommended:n.find(c=>c.id===a),all:n,reasoning:i,confidenceScore:s,dataStrength:{authority:t.authority,socialProof:t.socialProof,localPulse:t.localPulse}}}calculateScores(e){return{authority:this.scoreAuthority(e),socialProof:this.scoreSocialProof(e),localPulse:this.scoreLocalPulse(e)}}scoreAuthority(e){var a,i,n,o,c,d,l;let t=0,s=0;return(i=(a=e.business)==null?void 0:a.profile)!=null&&i.industry&&(t+=.3,s++),(n=e.industry)!=null&&n.trends&&e.industry.trends.length>0&&(t+=.2,s++),(o=e.competitiveIntel)!=null&&o.opportunities&&e.competitiveIntel.opportunities.length>0&&(t+=.2,s++),(c=e.synthesis)!=null&&c.keyInsights&&e.synthesis.keyInsights.length>3&&(t+=.15,s++),(l=(d=e.business)==null?void 0:d.profile)!=null&&l.industry&&(e.business.profile.industry.toLowerCase().includes("consulting")||e.business.profile.industry.toLowerCase().includes("professional")||e.business.profile.industry.toLowerCase().includes("service"))&&(t+=.15,s++),s>0?Math.min(t,1):.3}scoreSocialProof(e){var i,n,o,c,d,l;let t=0,s=0;return((i=e.realTimeCultural)==null?void 0:i.reviews)!==void 0&&((n=e.realTimeCultural)==null?void 0:n.reviews)!==null&&(t+=.4,s++),(o=e.customerPsychology)!=null&&o.identityDesires&&e.customerPsychology.identityDesires.length>0&&(t+=.2,s++),(c=e.synthesis)!=null&&c.keyInsights&&e.synthesis.keyInsights.some(u=>u.toLowerCase().includes("customer")||u.toLowerCase().includes("review"))&&(t+=.2,s++),(l=(d=e.business)==null?void 0:d.profile)!=null&&l.location&&e.business.profile.location.city&&(t+=.2,s++),s>0?Math.min(t,1):.3}scoreLocalPulse(e){var a,i,n,o,c;let t=0,s=0;return(i=(a=e.business)==null?void 0:a.profile)!=null&&i.location&&e.business.profile.location.city&&(t+=.3,s++),((n=e.realTimeCultural)==null?void 0:n.weather)!==void 0&&(t+=.25,s++),(o=e.realTimeCultural)!=null&&o.localEvents&&e.realTimeCultural.localEvents.length>0&&(t+=.25,s++),(c=e.realTimeCultural)!=null&&c.trendingTopics&&e.realTimeCultural.trendingTopics.some(d=>d.scope==="local")&&(t+=.2,s++),s>0?Math.min(t,1):.3}getConfidenceForType(e,t){switch(e){case"authority_builder":return t.authority;case"social_proof":return t.socialProof;case"local_pulse":return t.localPulse;default:return .5}}getAuthorityReasoning(e,t){var a,i,n,o;const s=[];return(i=(a=e.business)==null?void 0:a.profile)!=null&&i.industry&&s.push(`Your specialized expertise in ${e.business.profile.industry} positions you as an authority`),(n=e.industry)!=null&&n.trends&&e.industry.trends.length>0&&s.push(`${e.industry.trends.length} industry trends detected for thought leadership content`),(o=e.competitiveIntel)!=null&&o.opportunities&&e.competitiveIntel.opportunities.length>0&&s.push(`Identified ${e.competitiveIntel.opportunities.length} competitive gaps to address with expert content`),s.length===0?"Your industry and business type benefit most from establishing thought leadership":s.join(". ")+"."}getSocialProofReasoning(e,t){var a,i,n,o;const s=[];return(a=e.realTimeCultural)!=null&&a.reviews&&s.push("Strong customer review presence detected"),(i=e.customerPsychology)!=null&&i.identityDesires&&s.push(`Understanding of ${e.customerPsychology.identityDesires.length} customer desires enables compelling testimonial content`),(o=(n=e.business)==null?void 0:n.profile)!=null&&o.location&&s.push("Local business profile ideal for customer success stories"),s.length===0?"Your customer base and service delivery model are perfect for social proof campaigns":s.join(". ")+"."}getLocalPulseReasoning(e,t){var a,i,n,o,c;const s=[];return(n=(i=(a=e.business)==null?void 0:a.profile)==null?void 0:i.location)!=null&&n.city&&s.push(`Strong local presence in ${e.business.profile.location.city}`),(o=e.realTimeCultural)!=null&&o.weather&&s.push("Weather intelligence available for timely campaigns"),(c=e.realTimeCultural)!=null&&c.localEvents&&e.realTimeCultural.localEvents.length>0&&s.push(`${e.realTimeCultural.localEvents.length} local events identified for tie-in opportunities`),s.length===0?"Your local market position and timing opportunities are strongest":s.join(". ")+"."}}const Ie=new de,ge={relevance:.35,timeliness:.25,evidenceQuality:.25,confidence:.15};async function Re(r,e,t={}){var c,d;const s=Date.now();console.log("[SmartPickGenerator] Generating smart picks..."),console.log("[SmartPickGenerator] Campaign type filter:",e||"all");const{maxPicks:a=5,minConfidence:i=.6,preferTimely:n=!0,includePreview:o=!0}=t;try{const l=await pe(r);console.log(`[SmartPickGenerator] Found ${l.length} total insights`);const u=l.filter(f=>f.confidence>=i);console.log(`[SmartPickGenerator] ${u.length} insights meet confidence threshold (>=${i})`);const g=[];(!e||e==="authority-builder")&&g.push(...await he(r,u,o)),(!e||e==="social-proof")&&g.push(...await me(r,u,o)),(!e||e==="local-pulse")&&g.push(...await fe(r,u,o)),console.log(`[SmartPickGenerator] Generated ${g.length} candidate picks`);const p=g.map(f=>ye(f,r,n));p.sort((f,k)=>k.overallScore-f.overallScore);const h=p.slice(0,a),m=Date.now()-s;return console.log(`[SmartPickGenerator] Selected ${h.length} top picks in ${m}ms`),{picks:h,context:r,metadata:{totalCandidates:g.length,picksGenerated:h.length,generationTimeMs:m,strategiesUsed:["authority-builder","social-proof","local-pulse"]}}}catch(l){console.error("[SmartPickGenerator] Generation failed:",l),C(l,{campaignType:e,businessId:(d=(c=r.business)==null?void 0:c.profile)==null?void 0:d.name});const u=e?R(r,e):[...R(r,"authority-builder"),...R(r,"social-proof"),...R(r,"local-pulse")].slice(0,a),g=Date.now()-s;return{picks:u,context:r,metadata:{totalCandidates:0,picksGenerated:u.length,generationTimeMs:g,strategiesUsed:["template-fallback"],fallback:!0}}}}async function pe(r){var s;if((s=r.synthesis)!=null&&s.insights&&r.synthesis.insights.length>0)return console.log("[SmartPickGenerator] Using existing insights from context"),r.synthesis.insights;console.log("[SmartPickGenerator] Generating new insights...");const e={business:{name:r.business.profile.name,industry:r.business.profile.industry,location:{city:r.business.profile.location.city,state:r.business.profile.location.state}},intelligence:r};return(await z(e)).synapses}async function he(r,e,t){const s=e.filter(i=>i.type==="unexpected_connection"||i.type==="counter_intuitive"||i.type==="predictive_opportunity"||i.evidence&&i.evidence.length>=2),a=[];for(const i of s.slice(0,3)){const n={id:`authority-${i.id}`,campaignType:"authority-builder",title:`Industry Insight: ${B(i.insight,60)}`,insights:[i],preview:t?await O(i,r,"authority-builder"):{headline:"",hook:"",platform:"LinkedIn"},confidence:i.confidence,relevance:0,timeliness:0,evidenceQuality:L(i),overallScore:0,dataSources:N(r,i),reasoning:`Strong evidence-based insight about ${r.business.profile.industry}. Perfect for establishing thought leadership on LinkedIn.`,expectedPerformance:{engagement:"medium",reach:"medium",conversions:"low"},metadata:{generatedAt:new Date}};a.push(n)}return a}async function me(r,e,t){const s=e.filter(i=>i.type==="deep_psychology"||i.type==="cultural_moment"||i.insight.toLowerCase().includes("customer")||i.insight.toLowerCase().includes("review")||i.insight.toLowerCase().includes("testimonial")),a=[];for(const i of s.slice(0,3)){const n={id:`social-${i.id}`,campaignType:"social-proof",title:`Customer Story: ${B(i.insight,60)}`,insights:[i],preview:t?await O(i,r,"social-proof"):{headline:"",hook:"",platform:"Facebook"},confidence:i.confidence,relevance:0,timeliness:0,evidenceQuality:L(i),overallScore:0,dataSources:N(r,i),reasoning:"Leverages customer psychology and social validation. Great for Facebook and Instagram.",expectedPerformance:{engagement:"high",reach:"high",conversions:"medium"},metadata:{generatedAt:new Date}};a.push(n)}return a}async function fe(r,e,t){var c,d,l,u;const s=r.business.profile.location.city,a=(d=(c=r.cultural)==null?void 0:c.currentContext)==null?void 0:d.some(g=>g.source==="weather"),i=(u=(l=r.cultural)==null?void 0:l.currentContext)==null?void 0:u.some(g=>g.source==="local_news");if(!s)return console.log("[SmartPickGenerator] No location data for local pulse picks"),[];const n=e.filter(g=>g.whyNow.toLowerCase().includes("now")||g.whyNow.toLowerCase().includes("today")||g.whyNow.toLowerCase().includes("week")||a&&g.insight.toLowerCase().includes("weather")||i&&g.type==="cultural_moment"),o=[];for(const g of n.slice(0,3)){const p=new Date;p.setDate(p.getDate()+7);const h={id:`local-${g.id}`,campaignType:"local-pulse",title:`Local Moment: ${B(g.insight,60)}`,insights:[g],preview:t?await O(g,r,"local-pulse"):{headline:"",hook:"",platform:"Instagram"},confidence:g.confidence,relevance:0,timeliness:.9,evidenceQuality:L(g),overallScore:0,dataSources:N(r,g),reasoning:`Time-sensitive local content for ${r.business.profile.location.city}. Best posted within 48 hours.`,expectedPerformance:{engagement:"high",reach:"medium",conversions:"medium"},metadata:{generatedAt:new Date,expiresAt:p}};o.push(h)}return o}function ye(r,e,t){const s=be(r,e),a=ve(r),i=r.evidenceQuality,n=r.confidence,o={...ge,timeliness:t?.35:.25,relevance:t?.25:.35},c=s*o.relevance+a*o.timeliness+i*o.evidenceQuality+n*o.confidence;return{...r,relevance:s,timeliness:a,overallScore:c}}function be(r,e){let t=.5;const s=[e.business.profile.industry.toLowerCase(),e.business.profile.location.city.toLowerCase(),e.business.profile.location.state.toLowerCase()],a=r.insights.map(i=>i.insight.toLowerCase()).join(" ");for(const i of s)a.includes(i)&&(t+=.15);return r.campaignType==="local-pulse"&&e.business.profile.location.city&&(t+=.1),r.campaignType==="authority-builder"&&r.evidenceQuality>.7&&(t+=.1),r.campaignType==="social-proof"&&a.includes("customer")&&(t+=.1),Math.min(t,1)}function ve(r){const e=new Date;if(r.metadata.expiresAt){const a=(r.metadata.expiresAt.getTime()-e.getTime())/(1e3*60*60*24);return a<1?1:a<3?.9:a<7?.7:.5}const t=r.insights.map(s=>s.whyNow.toLowerCase()).join(" ");return t.includes("today")||t.includes("now")?.9:t.includes("this week")||t.includes("currently")?.7:t.includes("this month")||t.includes("trending")?.6:t.includes("seasonal")?.5:.4}function L(r){var t;const e=((t=r.evidence)==null?void 0:t.length)||0;return e===0?.3:e===1?.5:e===2?.7:e>=3?.9:.5}function N(r,e){const t=[],s=new Set,a={weather:{source:"weather",icon:"Cloud",label:"Weather Data",verified:!0,freshness:"hourly",dataPoints:0},reviews:{source:"reviews",icon:"Star",label:"Customer Reviews",verified:!0,freshness:"daily",dataPoints:0},trends:{source:"trends",icon:"TrendingUp",label:"Search Trends",verified:!0,freshness:"real-time",dataPoints:0},news:{source:"news",icon:"Newspaper",label:"News Articles",verified:!0,freshness:"hourly",dataPoints:0},reddit:{source:"reddit",icon:"MessageCircle",label:"Reddit Discussions",verified:!0,freshness:"real-time",dataPoints:0},youtube:{source:"youtube",icon:"Video",label:"YouTube Trends",verified:!0,freshness:"daily",dataPoints:0},competitors:{source:"competitors",icon:"Target",label:"Competitor Analysis",verified:!0,freshness:"weekly",dataPoints:0},industry:{source:"industry",icon:"Building",label:"Industry Data",verified:!0,freshness:"static",dataPoints:0}};if(e.evidence)for(const i of e.evidence){const n=i.toLowerCase();n.includes("weather")&&!s.has("weather")&&(t.push({...a.weather,dataPoints:1}),s.add("weather")),(n.includes("review")||n.includes("rating"))&&!s.has("reviews")&&(t.push({...a.reviews,dataPoints:1}),s.add("reviews")),(n.includes("trend")||n.includes("search"))&&!s.has("trends")&&(t.push({...a.trends,dataPoints:1}),s.add("trends")),(n.includes("news")||n.includes("article"))&&!s.has("news")&&(t.push({...a.news,dataPoints:1}),s.add("news")),n.includes("reddit")&&!s.has("reddit")&&(t.push({...a.reddit,dataPoints:1}),s.add("reddit")),n.includes("youtube")&&!s.has("youtube")&&(t.push({...a.youtube,dataPoints:1}),s.add("youtube")),(n.includes("competitor")||n.includes("competition"))&&!s.has("competitors")&&(t.push({...a.competitors,dataPoints:1}),s.add("competitors"))}return t.length===0&&t.push({...a.industry,dataPoints:1}),t}async function O(r,e,t){const s=t==="authority-builder"?"LinkedIn":t==="social-proof"?"Facebook":"Instagram",a=`Generate a compelling social media post preview for ${s}.

Business: ${e.business.profile.name} (${e.business.profile.industry})
Location: ${e.business.profile.location.city}, ${e.business.profile.location.state}

Campaign Type: ${t}
Insight: ${r.insight}
Why Now: ${r.whyNow}

Generate ONLY:
1. Headline (8-12 words, attention-grabbing)
2. Hook (first sentence, 15-25 words, creates curiosity)

Format your response as JSON:
{
  "headline": "Your headline here",
  "hook": "Your hook here"
}

Make it specific to the business and actionable.`;try{const i=await P.executeWithRetry(async()=>await Q([{role:"user",content:a}],{model:"anthropic/claude-3.5-sonnet",temperature:.8,max_tokens:300}),{maxAttempts:3,initialDelayMs:2e3},void 0,[{name:"template_fallback",description:"Generate preview from template",execute:async()=>JSON.stringify({headline:r.contentAngle,hook:r.insight.substring(0,100)})}]),n=JSON.parse(i);return{headline:n.headline||r.contentAngle,hook:n.hook||r.insight.substring(0,100),platform:s}}catch(i){return console.error("[SmartPickGenerator] Preview generation failed:",i),C(i,{campaignType:t,insightId:r.id}),{headline:r.contentAngle,hook:r.insight.substring(0,100),platform:s}}}function R(r,e){const t={"authority-builder":[{id:"smart-pick-authority-1",campaignType:"authority-builder",title:"Industry Insights Campaign",insights:[],preview:{headline:"Share Your Expertise",hook:"Educational content that positions you as an industry expert",platform:"LinkedIn"},confidence:.5,relevance:.5,timeliness:.5,evidenceQuality:.5,overallScore:.5,dataSources:[],reasoning:"Template-generated smart pick",expectedPerformance:{engagement:"medium",reach:"medium",conversions:"low"},metadata:{generatedAt:new Date,fallback:!0}}],"social-proof":[{id:"smart-pick-trust-1",campaignType:"social-proof",title:"Customer Success Stories",insights:[],preview:{headline:"See Real Results",hook:"Showcase authentic customer testimonials and success stories",platform:"Facebook"},confidence:.5,relevance:.5,timeliness:.5,evidenceQuality:.5,overallScore:.5,dataSources:[],reasoning:"Template-generated smart pick",expectedPerformance:{engagement:"high",reach:"high",conversions:"medium"},metadata:{generatedAt:new Date,fallback:!0}}],"local-pulse":[{id:"smart-pick-local-1",campaignType:"local-pulse",title:"Local Community Connection",insights:[],preview:{headline:"Supporting Our Local Community",hook:"Connect with local events and community initiatives",platform:"Instagram"},confidence:.5,relevance:.5,timeliness:.5,evidenceQuality:.5,overallScore:.5,dataSources:[],reasoning:"Template-generated smart pick",expectedPerformance:{engagement:"high",reach:"medium",conversions:"medium"},metadata:{generatedAt:new Date,fallback:!0}}]};return t[e]||t["authority-builder"]}function B(r,e){return r.length<=e?r:r.substring(0,e-3)+"..."}const F={IDLE:["TYPE_SELECTED","ERROR"],TYPE_SELECTED:["CONTENT_SELECTED","ERROR"],CONTENT_SELECTED:["GENERATING","TYPE_SELECTED","ERROR"],GENERATING:["PREVIEW","ERROR"],PREVIEW:["APPROVED","CONTENT_SELECTED","GENERATING","ERROR"],APPROVED:["PUBLISHED","PREVIEW","ERROR"],PUBLISHED:["IDLE"],ERROR:["IDLE","TYPE_SELECTED","CONTENT_SELECTED","GENERATING","PREVIEW"]};class we{constructor(){b(this,"eventHandlers",[])}canTransition(e,t){return F[e].includes(t)}transition(e,t,s){const a=e.state;if(!this.canTransition(a,t))throw new Error(`Invalid state transition: ${a} → ${t}. Valid transitions from ${a}: ${F[a].join(", ")}`);const i={from:a,to:t,timestamp:new Date,metadata:s},n={...e,state:t,progress:this.calculateProgress(t),history:[...e.history,i],updatedAt:new Date,...t==="ERROR"&&(s==null?void 0:s.error)&&{error:s.error}};return this.emitEvent({type:"STATE_CHANGED",sessionId:e.id,timestamp:new Date,data:{fromState:a,toState:t,metadata:s}}),this.saveSessionToStorage(n),console.log(`[CampaignState] ${a} → ${t}`,s),n}calculateProgress(e){return{IDLE:0,TYPE_SELECTED:20,CONTENT_SELECTED:40,GENERATING:60,PREVIEW:80,APPROVED:90,PUBLISHED:100,ERROR:-1}[e]}handleError(e,t){const s={code:t.code||"UNKNOWN_ERROR",message:t.message||"An unknown error occurred",timestamp:new Date,recoverable:t.recoverable??!0,retryCount:t.retryCount??0,stack:t.stack};return this.transition(e,"ERROR",{error:s})}recoverFromError(e,t){if(e.state!=="ERROR")throw new Error("Can only recover from ERROR state");if(!this.canTransition("ERROR",t))throw new Error(`Cannot recover to state: ${t}`);return this.transition(e,t,{recovered:!0})}reset(e){return{...e,state:"IDLE",progress:0,selectedType:void 0,selectedInsights:void 0,selectedSmartPickId:void 0,generatedContent:void 0,error:void 0,history:[...e.history,{from:e.state,to:"IDLE",timestamp:new Date,metadata:{reset:!0}}],updatedAt:new Date}}getHistory(e){return e.history}getStateName(e){return{IDLE:"Ready to Start",TYPE_SELECTED:"Campaign Type Selected",CONTENT_SELECTED:"Content Selected",GENERATING:"Generating Campaign",PREVIEW:"Previewing Campaign",APPROVED:"Campaign Approved",PUBLISHED:"Campaign Published",ERROR:"Error Occurred"}[e]}on(e){return this.eventHandlers.push(e),()=>{this.eventHandlers=this.eventHandlers.filter(t=>t!==e)}}emitEvent(e){this.eventHandlers.forEach(t=>{try{t(e)}catch(s){console.error("[CampaignState] Event handler error:",s)}})}saveSessionToStorage(e){try{const t=`campaign_session_${e.id}`;localStorage.setItem(t,JSON.stringify({...e,context:void 0}))}catch(t){console.warn("[CampaignState] Failed to save to localStorage:",t)}}loadSessionFromStorage(e){try{const t=`campaign_session_${e}`,s=localStorage.getItem(t);if(!s)return null;const a=JSON.parse(s);return a.createdAt=new Date(a.createdAt),a.updatedAt=new Date(a.updatedAt),a.history=a.history.map(i=>({...i,timestamp:new Date(i.timestamp)})),a}catch(t){return console.error("[CampaignState] Failed to load from localStorage:",t),null}}clearSessionStorage(e){try{const t=`campaign_session_${e}`;localStorage.removeItem(t)}catch(t){console.warn("[CampaignState] Failed to clear localStorage:",t)}}}const v=new we;class Ce{async saveDraft(e){console.log("[CampaignDB] Saving draft:",e.campaignName);const{data:t,error:s}=await T.from("marketing_campaigns").insert({business_id:e.businessId,campaign_name:e.campaignName,campaign_type:e.campaignType,status:"draft",goals:e.goals,target_audience:e.targetAudience,content_data:e.contentData}).select().single();if(s)throw console.error("[CampaignDB] Error saving draft:",s),new Error(`Failed to save campaign draft: ${s.message}`);return console.log("[CampaignDB] Draft saved successfully:",t.id),t}async updateCampaign(e,t){console.log("[CampaignDB] Updating campaign:",e);const{data:s,error:a}=await T.from("marketing_campaigns").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(a)throw console.error("[CampaignDB] Error updating campaign:",a),new Error(`Failed to update campaign: ${a.message}`);return s}async approveCampaign(e){return console.log("[CampaignDB] Approving campaign:",e),this.updateCampaign(e,{status:"active",start_date:new Date().toISOString().split("T")[0]})}async getCampaign(e){console.log("[CampaignDB] Fetching campaign:",e);const{data:t,error:s}=await T.from("marketing_campaigns").select(`
        id,
        business_id,
        campaign_name,
        campaign_type,
        status,
        start_date,
        end_date,
        budget_usd,
        goals,
        target_audience,
        content_data,
        created_at,
        updated_at
      `).eq("id",e).single();if(s){if(s.code==="PGRST116")return null;throw console.error("[CampaignDB] Error fetching campaign:",s),new Error(`Failed to fetch campaign: ${s.message}`)}return t}async listCampaigns(e){console.log("[CampaignDB] Listing campaigns for business:",e.businessId);let t=T.from("marketing_campaigns").select(`
        id,
        business_id,
        campaign_name,
        campaign_type,
        status,
        start_date,
        end_date,
        budget_usd,
        goals,
        target_audience,
        content_data,
        created_at,
        updated_at
      `,{count:"exact"}).eq("business_id",e.businessId).order("created_at",{ascending:!1});e.status&&(t=t.eq("status",e.status)),e.limit&&(t=t.limit(e.limit)),e.offset&&(t=t.range(e.offset,e.offset+(e.limit||10)-1));const{data:s,error:a,count:i}=await t;if(a)throw console.error("[CampaignDB] Error listing campaigns:",a),new Error(`Failed to list campaigns: ${a.message}`);return{campaigns:s,total:i||0}}async deleteCampaign(e){console.log("[CampaignDB] Deleting campaign:",e);const{error:t}=await T.from("marketing_campaigns").delete().eq("id",e);if(t)throw console.error("[CampaignDB] Error deleting campaign:",t),new Error(`Failed to delete campaign: ${t.message}`);console.log("[CampaignDB] Campaign deleted successfully")}async saveContentPieces(e,t,s){console.log("[CampaignDB] Saving content pieces for campaign:",e);const a=s.platforms.map(o=>({business_id:t,campaign_id:e,content_type:"post",platform:o.platform,title:o.content.headline,content_text:`${o.content.hook}

${o.content.body}

${o.content.cta}`,hashtags:o.content.hashtags||[],media_urls:o.mediaUrls||[],status:"draft"})),{data:i,error:n}=await T.from("content_pieces").insert(a).select();if(n)throw console.error("[CampaignDB] Error saving content pieces:",n),new Error(`Failed to save content pieces: ${n.message}`);return console.log("[CampaignDB] Saved",i.length,"content pieces"),i}async getContentPieces(e){console.log("[CampaignDB] Fetching content pieces for campaign:",e);const{data:t,error:s}=await T.from("content_pieces").select(`
        id,
        business_id,
        campaign_id,
        content_type,
        platform,
        title,
        content_text,
        media_urls,
        hashtags,
        status,
        scheduled_for,
        published_at,
        created_at,
        updated_at
      `).eq("campaign_id",e).order("created_at",{ascending:!0});if(s)throw console.error("[CampaignDB] Error fetching content pieces:",s),new Error(`Failed to fetch content pieces: ${s.message}`);return t}async updateContentPiece(e,t){console.log("[CampaignDB] Updating content piece:",e);const{data:s,error:a}=await T.from("content_pieces").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select().single();if(a)throw console.error("[CampaignDB] Error updating content piece:",a),new Error(`Failed to update content piece: ${a.message}`);return s}async scheduleContentPiece(e,t){return this.updateContentPiece(e,{status:"scheduled",scheduled_for:t.toISOString()})}async publishContentPiece(e){return this.updateContentPiece(e,{status:"published",published_at:new Date().toISOString()})}}const $=new Ce,Se={autoSave:!0,autoSaveInterval:3e4,retryAttempts:3,timeoutMs:12e4,enableLogging:!0};class Ee{constructor(e={}){b(this,"sessions",new Map);b(this,"config");b(this,"autoSaveIntervals",new Map);this.config={...Se,...e},this.log("CampaignWorkflow initialized")}async startCampaign(e){this.log("Starting new campaign for business:",e.businessId);const t={id:G(),businessId:e.businessId,state:"IDLE",progress:0,context:e.context,history:[],createdAt:new Date,updatedAt:new Date};return this.sessions.set(t.id,t),this.config.autoSave&&this.startAutoSave(t.id),this.log("Campaign session created:",t.id),t}selectCampaignType(e,t){this.log("Selecting campaign type:",t);const s=this.getSession(e),a=v.transition(s,"TYPE_SELECTED",{campaignType:t});return a.selectedType=t,this.sessions.set(e,a),a}selectSmartPick(e,t,s){this.log("Selecting Smart Pick:",t);const a=this.getSession(e);if(!a.selectedType)throw new Error("Campaign type must be selected before choosing content");const i=v.transition(a,"CONTENT_SELECTED",{smartPickId:t,insightCount:s.length});return i.selectedSmartPickId=t,i.selectedInsights=s,this.sessions.set(e,i),i}selectCustomInsights(e,t){this.log("Selecting custom insights:",t.length);const s=this.getSession(e);if(!s.selectedType)throw new Error("Campaign type must be selected before choosing content");const a=v.transition(s,"CONTENT_SELECTED",{insightCount:t.length,custom:!0});return a.selectedInsights=t,this.sessions.set(e,a),a}async generateCampaign(e){var s;this.log("Generating campaign content");const t=this.getSession(e);if(!t.selectedInsights||t.selectedInsights.length===0)throw new Error("Insights must be selected before generating campaign");try{let a=v.transition(t,"GENERATING");this.sessions.set(e,a);const i={campaignId:e,campaignType:t.selectedType,businessContext:{businessData:t.context.businessProfile,uvpData:t.context.uvpData,websiteAnalysis:null,specialization:(s=t.context.businessProfile)==null?void 0:s.specialization},options:{postsPerCampaign:7,platforms:["linkedin","facebook"],includeVisuals:!0,saveToDatabase:!0}},n=await le.generateCampaign(i),o={campaignName:n.name,posts:n.posts.map(c=>{var d;return{id:c.id,platform:c.platform,content:{headline:c.content.headline||"",body:c.content.body,hashtags:c.content.hashtags,cta:c.content.callToAction||""},visuals:c.visuals,scheduledDate:(d=c.scheduledFor)==null?void 0:d.toISOString(),status:c.status}}),metadata:{totalPosts:n.totalPosts,generatedAt:n.createdAt.toISOString(),confidence:n.metadata.confidence}};return a=v.transition(a,"PREVIEW",{contentGenerated:!0}),a.generatedContent=o,this.sessions.set(e,a),this.config.autoSave&&await this.saveCampaignToDB(a),this.log("Campaign content generated successfully"),a}catch(a){this.log("Error generating campaign:",a);const i=v.handleError(t,{code:"CONTENT_GENERATION_FAILED",message:a instanceof Error?a.message:"Content generation failed",recoverable:!0});throw this.sessions.set(e,i),a}}async approveCampaign(e){this.log("Approving campaign");const t=this.getSession(e);if(!t.generatedContent)throw new Error("Campaign must be generated before approval");try{const s=v.transition(t,"APPROVED");this.sessions.set(e,s);const a=await this.saveCampaignToDB(s);return a&&await $.approveCampaign(a.id),this.log("Campaign approved successfully"),s}catch(s){this.log("Error approving campaign:",s);const a=v.handleError(t,{code:"DATABASE_ERROR",message:s instanceof Error?s.message:"Failed to approve campaign",recoverable:!0});throw this.sessions.set(e,a),s}}async publishCampaign(e,t){this.log("Publishing campaign to platforms:",t);const s=this.getSession(e);if(s.state!=="APPROVED")throw new Error("Campaign must be approved before publishing");try{this.log("Publishing not yet implemented - placeholder only");const a=v.transition(s,"PUBLISHED",{platforms:t,publishedAt:new Date});return this.sessions.set(e,a),this.stopAutoSave(e),this.log("Campaign published successfully"),a}catch(a){this.log("Error publishing campaign:",a);const i=v.handleError(s,{code:"NETWORK_ERROR",message:a instanceof Error?a.message:"Failed to publish campaign",recoverable:!0});throw this.sessions.set(e,i),a}}getSession(e){const t=this.sessions.get(e);if(!t){const s=v.loadSessionFromStorage(e);if(s)return this.sessions.set(e,s),s;throw new Error(`Campaign session not found: ${e}`)}return t}resetSession(e){this.log("Resetting session:",e);const t=this.getSession(e),s=v.reset(t);return this.sessions.set(e,s),s}deleteSession(e){this.log("Deleting session:",e),this.stopAutoSave(e),this.sessions.delete(e),v.clearSessionStorage(e)}async generateMockContent(e,t,s){const a=new Y,i=s?{id:s.business.profile.id,name:s.business.profile.name,industry:s.business.profile.industry,location:s.business.profile.location,website:s.business.profile.website}:{id:"demo-business",name:"Demo Business",industry:"Professional Services",location:{city:"San Francisco",state:"CA",country:"USA"},website:"https://example.com"},n=t.length>0?t.reduce((l,u)=>u.confidence>l.confidence?u:l):{id:"fallback-insight",insight:"Industry expertise and thought leadership",confidence:.7,reasoning:"Fallback insight for demonstration",dataSource:"System",timestamp:new Date,score:70,metadata:{}},c=["linkedin","facebook","instagram","twitter"].map(async l=>{try{const u=await a.generatePremiumContent(n,i,l),p=`${u.headline}

${u.hook}

${u.body}

${u.cta}`.length;return{platform:l,content:u,characterCount:p}}catch(u){return this.log(`Error generating content for ${l}:`,u),{platform:l,content:{headline:`${e} Campaign - ${l}`,hook:n.insight,body:"Generated body content based on your business insights and industry expertise.",cta:"Learn more",hashtags:["business","growth"]},characterCount:200}}}),d=await Promise.all(c);return{campaignId:G(),campaignType:e,platforms:d,metadata:{insightsUsed:t.map(l=>l.id),generatedAt:new Date,model:"claude-sonnet-4.5",confidence:n.confidence}}}async saveCampaignToDB(e){var t;if(!e.generatedContent)return null;try{const s=await $.saveDraft({businessId:e.businessId,campaignName:`${e.selectedType} Campaign - ${new Date().toLocaleDateString()}`,campaignType:e.selectedType,contentData:e.generatedContent,goals:{type:e.selectedType,insightCount:((t=e.selectedInsights)==null?void 0:t.length)||0}});return await $.saveContentPieces(s.id,e.businessId,e.generatedContent),s}catch(s){return this.log("Error saving to database:",s),null}}startAutoSave(e){const t=setInterval(()=>{const s=this.sessions.get(e);s&&this.saveCampaignToDB(s).catch(a=>this.log("Auto-save error:",a))},this.config.autoSaveInterval);this.autoSaveIntervals.set(e,t)}stopAutoSave(e){const t=this.autoSaveIntervals.get(e);t&&(clearInterval(t),this.autoSaveIntervals.delete(e))}log(...e){this.config.enableLogging&&console.log("[CampaignWorkflow]",...e)}}const y=new Ee;class Te{constructor(e={}){b(this,"currentSessionId");b(this,"config");b(this,"eventUnsubscribe");this.config=e,this.log("CampaignOrchestrator initialized")}async initialize(e){this.log("Initializing campaign for business:",e.businessId);try{const t=await y.startCampaign(e);return this.currentSessionId=t.id,this.subscribeToStateChanges(),this.log("Campaign initialized:",t.id),this.notifyStateChange(t),t}catch(t){throw this.handleError(t),t}}selectCampaignType(e){this.log("Selecting campaign type:",e);try{const t=y.selectCampaignType(this.requireSessionId(),e);return this.notifyStateChange(t),this.notifyProgress(t),t}catch(t){throw this.handleError(t),t}}selectSmartPick(e){this.log("Selecting Smart Pick:",e.smartPickId);try{const t=y.selectSmartPick(this.requireSessionId(),e.smartPickId,e.insights);return this.notifyStateChange(t),this.notifyProgress(t),t}catch(t){throw this.handleError(t),t}}selectCustomInsights(e){this.log("Selecting custom insights:",e.length);try{const t=y.selectCustomInsights(this.requireSessionId(),e);return this.notifyStateChange(t),this.notifyProgress(t),t}catch(t){throw this.handleError(t),t}}async generateCampaign(){this.log("Generating campaign content");try{const e=await P.executeWithRetry(()=>y.generateCampaign(this.requireSessionId()),{maxAttempts:3});return this.notifyStateChange(e),this.notifyProgress(e),e}catch(e){throw C(e,{sessionId:this.currentSessionId,operation:"generateCampaign"}),this.handleError(e),e}}async regenerateSection(e){this.log("Regenerating section:",e);try{const t=y.getSession(this.requireSessionId());return this.log("Section regeneration not yet implemented"),t}catch(t){throw this.handleError(t),t}}async approveCampaign(){this.log("Approving campaign");try{const e=await y.approveCampaign(this.requireSessionId());return this.notifyStateChange(e),this.notifyProgress(e),e}catch(e){throw this.handleError(e),e}}async publishCampaign(e){this.log("Publishing campaign to platforms:",e);try{const t=await P.executeWithRetry(()=>y.publishCampaign(this.requireSessionId(),e),{maxAttempts:2});return this.notifyStateChange(t),this.notifyProgress(t),t}catch(t){throw C(t,{sessionId:this.currentSessionId,platforms:e,operation:"publishCampaign"}),this.handleError(t),t}}getCurrentSession(){if(!this.currentSessionId)return null;try{return y.getSession(this.currentSessionId)}catch{return null}}resumeSession(e){this.log("Resuming session:",e);const t=y.getSession(e);return this.currentSessionId=e,this.subscribeToStateChanges(),t}resetSession(){this.log("Resetting session");const e=y.resetSession(this.requireSessionId());return this.notifyStateChange(e),this.notifyProgress(e),e}endSession(){this.log("Ending session"),this.currentSessionId&&(y.deleteSession(this.currentSessionId),this.currentSessionId=void 0),this.eventUnsubscribe&&(this.eventUnsubscribe(),this.eventUnsubscribe=void 0)}handleError(e){const t=e instanceof Error?e:new Error(String(e));if(this.log("Error occurred:",t.message),this.config.onError&&this.currentSessionId)try{const s=y.getSession(this.currentSessionId);this.config.onError(t,s)}catch{this.config.onError(t,{})}}recoverFromError(e){this.log("Recovering from error to state:",e);const t=y.getSession(this.requireSessionId()),s=v.recoverFromError(t,e);return this.notifyStateChange(s),s}onStateChange(e){return this.config.onStateChange=e,()=>{this.config.onStateChange=void 0}}onProgress(e){return this.config.onProgress=e,()=>{this.config.onProgress=void 0}}requireSessionId(){if(!this.currentSessionId)throw new Error("No active campaign session. Call initialize() first.");return this.currentSessionId}subscribeToStateChanges(){this.eventUnsubscribe&&this.eventUnsubscribe();const e=t=>{if(t.sessionId===this.currentSessionId){if(this.log("Workflow event:",t.type),t.type==="STATE_CHANGED"&&this.config.onStateChange)try{const s=y.getSession(this.currentSessionId);this.config.onStateChange(s)}catch(s){this.log("Error in state change handler:",s)}if(t.type==="PROGRESS_UPDATED"&&this.config.onProgress)try{const s=y.getSession(this.currentSessionId);this.config.onProgress(s.progress,s)}catch(s){this.log("Error in progress handler:",s)}}};this.eventUnsubscribe=v.on(e)}notifyStateChange(e){this.config.onStateChange&&this.config.onStateChange(e)}notifyProgress(e){this.config.onProgress&&this.config.onProgress(e.progress,e)}log(...e){console.log("[CampaignOrchestrator]",...e)}}const Ae=new Te;export{P as E,le as a,Ie as b,Q as c,Ae as d,Re as g};
//# sourceMappingURL=campaign-BJZ6C_mM.js.map
