var P=Object.defineProperty;var y=(c,t,e)=>t in c?P(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var n=(c,t,e)=>y(c,typeof t!="symbol"?t+"":t,e);import{aZ as _,aK as j,r as k,a as s,a8 as T,an as N,aJ as b,A as g,a_ as w,h as A}from"./vendor-Ck9QY3SP.js";import{i as v,A as m,o as x,B as u}from"./content-DNJ5jCle.js";import{s as p}from"./analytics-BeoNQ3KZ.js";import"./vendor-misc-Ce8oRwJD.js";import"./radix-ui-BA32w1ww.js";import"./calendar-libs-Dd4YSJ5A.js";import"./ui-utils-BZoEee2W.js";import"./synapse-CMLSaE2R.js";import"./campaign-CpExTzZS.js";import"./supabase-CviTlR-N.js";class E{constructor(t){n(this,"config");n(this,"accessToken");n(this,"refreshToken");n(this,"API_BASE_URL","https://api.socialpilot.co");n(this,"MAX_RETRIES",3);n(this,"RETRY_DELAY",1e3);this.config=t,this.loadTokens()}async loadTokens(){try{const{data:t,error:e}=await p.from("socialpilot_connections").select("access_token, refresh_token, expires_at").single();!e&&t&&(this.accessToken=t.access_token,this.refreshToken=t.refresh_token,new Date(t.expires_at)<new Date&&(console.log("[SocialPilot] Token expired, refreshing..."),await this.refreshAccessToken()))}catch(t){console.warn("[SocialPilot] Failed to load tokens:",t)}}async getAuthorizationUrl(){const t=new URLSearchParams({client_id:this.config.clientId,redirect_uri:this.config.redirectUri,response_type:"code",scope:"accounts:read posts:write analytics:read"}),e=`${this.API_BASE_URL}/oauth/authorize?${t}`;return console.log("[SocialPilot] Generated authorization URL"),e}async exchangeCodeForToken(t){console.log("[SocialPilot] Exchanging code for token...");try{const e=await fetch(`${this.API_BASE_URL}/oauth/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:this.config.clientId,client_secret:this.config.clientSecret,code:t,grant_type:"authorization_code",redirect_uri:this.config.redirectUri})});if(!e.ok){const a=await e.text();throw new Error(`Token exchange failed: ${e.status} - ${a}`)}const o=await e.json();this.accessToken=o.access_token,this.refreshToken=o.refresh_token,await this.storeTokens(o),console.log("[SocialPilot] Successfully obtained access token")}catch(e){throw console.error("[SocialPilot] Token exchange error:",e),e}}async refreshAccessToken(){if(!this.refreshToken)throw new Error("No refresh token available. Please re-authenticate.");console.log("[SocialPilot] Refreshing access token...");try{const t=await fetch(`${this.API_BASE_URL}/oauth/token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:this.config.clientId,client_secret:this.config.clientSecret,refresh_token:this.refreshToken,grant_type:"refresh_token"})});if(!t.ok){const o=await t.text();throw new Error(`Token refresh failed: ${t.status} - ${o}`)}const e=await t.json();this.accessToken=e.access_token,e.refresh_token&&(this.refreshToken=e.refresh_token),await this.storeTokens(e),console.log("[SocialPilot] Successfully refreshed access token")}catch(t){throw console.error("[SocialPilot] Token refresh error:",t),t}}isAuthenticated(){return!!this.accessToken}async disconnect(){this.accessToken=void 0,this.refreshToken=void 0;try{await p.from("socialpilot_connections").delete().eq("user_id","current"),console.log("[SocialPilot] Disconnected successfully")}catch(t){console.error("[SocialPilot] Disconnect error:",t)}}async getAccounts(){console.log("[SocialPilot] Fetching connected accounts...");try{const e=((await this.apiCall("GET","/accounts")).accounts||[]).map(o=>({id:o.id,platform:this.normalizePlatform(o.platform),name:o.name||o.username,handle:o.username||o.handle,avatar:o.profile_image_url||o.avatar||"",connected:o.status==="active"}));return console.log(`[SocialPilot] Found ${e.length} connected accounts`),e}catch(t){throw console.error("[SocialPilot] Failed to fetch accounts:",t),t}}async getAccount(t){try{return(await this.getAccounts()).find(o=>o.id===t)||null}catch(e){return console.error("[SocialPilot] Failed to fetch account:",e),null}}async schedulePost(t){console.log("[SocialPilot] Scheduling post...",{accounts:t.accountIds.length,scheduledTime:t.scheduledTime});try{const e=await this.apiCall("POST","/posts/schedule",{account_ids:t.accountIds,text:t.content,scheduled_at:t.scheduledTime.toISOString(),media_urls:t.media||[],hashtags:t.hashtags||[]}),o={id:e.id||e.post_id,status:e.status||"scheduled",accountsPosted:e.accounts_posted||t.accountIds.length,accountsFailed:e.accounts_failed||0,error:e.error};return console.log("[SocialPilot] Post scheduled successfully:",o.id),o}catch(e){throw console.error("[SocialPilot] Failed to schedule post:",e),e}}async publishPost(t){console.log("[SocialPilot] Publishing post immediately...");try{const e=await this.apiCall("POST","/posts",{account_ids:t.accountIds,text:t.content,media_urls:t.media||[],hashtags:t.hashtags||[]}),o={id:e.id||e.post_id,status:"published",accountsPosted:e.accounts_posted||t.accountIds.length,accountsFailed:e.accounts_failed||0,error:e.error};return console.log("[SocialPilot] Post published successfully:",o.id),o}catch(e){throw console.error("[SocialPilot] Failed to publish post:",e),e}}async getPostStatus(t){console.log("[SocialPilot] Fetching post status:",t);try{const e=await this.apiCall("GET",`/posts/${t}`);return{id:e.id,status:e.status,accountsPosted:e.accounts_posted||0,accountsFailed:e.accounts_failed||0,error:e.error}}catch(e){throw console.error("[SocialPilot] Failed to fetch post status:",e),e}}async deletePost(t){console.log("[SocialPilot] Deleting post:",t);try{await this.apiCall("DELETE",`/posts/${t}`),console.log("[SocialPilot] Post deleted successfully")}catch(e){throw console.error("[SocialPilot] Failed to delete post:",e),e}}async getPostAnalytics(t){console.log("[SocialPilot] Fetching post analytics:",t);try{return await this.apiCall("GET",`/posts/${t}/analytics`)}catch(e){throw console.error("[SocialPilot] Failed to fetch analytics:",e),e}}async apiCall(t,e,o,a=0){if(!this.accessToken)throw new Error("Not authenticated. Please call exchangeCodeForToken() first.");const h=`${this.API_BASE_URL}${e}`;try{const r=await fetch(h,{method:t,headers:{Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"},body:o?JSON.stringify(o):void 0});if(r.status===401){if(console.warn("[SocialPilot] Token expired (401), attempting refresh..."),await this.refreshAccessToken(),a<this.MAX_RETRIES)return this.apiCall(t,e,o,a+1);throw new Error("Max retries exceeded after token refresh")}if(r.status===429)if(a<this.MAX_RETRIES){const i=parseInt(r.headers.get("Retry-After")||"60",10),l=i*1e3;return console.warn(`[SocialPilot] Rate limited, retrying after ${i}s...`),await this.sleep(l),this.apiCall(t,e,o,a+1)}else throw new Error("Rate limit exceeded, max retries reached");if(!r.ok){const i=await r.text();throw new Error(`API call failed: ${r.status} - ${i}`)}return await r.json()}catch(r){if(console.error(`[SocialPilot] API call failed (${t} ${e}):`,r),a<this.MAX_RETRIES&&this.isNetworkError(r))return console.warn(`[SocialPilot] Network error, retrying (${a+1}/${this.MAX_RETRIES})...`),await this.sleep(this.RETRY_DELAY*(a+1)),this.apiCall(t,e,o,a+1);throw r}}async storeTokens(t){try{const e=new Date(Date.now()+t.expires_in*1e3),{error:o}=await p.from("socialpilot_connections").upsert({access_token:t.access_token,refresh_token:t.refresh_token,expires_at:e.toISOString(),token_type:t.token_type,updated_at:new Date().toISOString()},{onConflict:"user_id"});o?console.error("[SocialPilot] Failed to store tokens:",o):console.log("[SocialPilot] Tokens stored securely")}catch(e){console.error("[SocialPilot] Token storage error:",e)}}normalizePlatform(t){const e=t.toLowerCase();return{fb:"facebook",tw:"twitter",li:"linkedin",ig:"instagram",tk:"tiktok",pin:"pinterest",yt:"youtube"}[e]||e}isNetworkError(t){var e,o;return t instanceof TypeError||((e=t.message)==null?void 0:e.includes("fetch"))||((o=t.message)==null?void 0:o.includes("network"))}sleep(t){return new Promise(e=>setTimeout(e,t))}}function C(){const c={clientId:"test_client_id",clientSecret:"test_client_secret",redirectUri:"http://localhost:5173/auth/socialpilot/callback"};return new E(c)}function Y(){const[c]=_(),t=j(),[e,o]=k.useState({status:"loading"});k.useEffect(()=>{a()},[]);const a=async()=>{console.log("[SocialPilotCallback] Processing OAuth callback...");const i=c.get("code"),l=c.get("error"),f=c.get("error_description");if(l==="access_denied"){console.log("[SocialPilotCallback] User denied authorization"),o({status:"user_denied",message:"You cancelled the connection",errorDetails:f||"Authorization was cancelled"});return}if(l){console.error("[SocialPilotCallback] OAuth error:",l,f),o({status:"error",message:"Authorization failed",errorDetails:f||l});return}if(!i){console.error("[SocialPilotCallback] No authorization code received"),o({status:"error",message:"Invalid callback",errorDetails:"No authorization code received from SocialPilot"});return}try{const d=C();console.log("[SocialPilotCallback] Exchanging code for token..."),await d.exchangeCodeForToken(i),console.log("[SocialPilotCallback] Successfully connected!"),o({status:"success",message:"Successfully connected to SocialPilot!"}),setTimeout(()=>{console.log("[SocialPilotCallback] Redirecting to calendar..."),t("/content-calendar")},2e3)}catch(d){console.error("[SocialPilotCallback] Token exchange failed:",d);const S=d instanceof Error?d.message:"Unknown error occurred";o({status:"error",message:"Failed to complete connection",errorDetails:S})}},h=()=>{t("/content-calendar")},r=()=>{o({status:"loading"}),a()};return s.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 flex items-center justify-center p-4",children:s.jsxs(v,{className:"max-w-md w-full p-8",children:[e.status==="loading"&&s.jsxs("div",{className:"text-center space-y-4",children:[s.jsx(T,{className:"w-16 h-16 mx-auto text-blue-600 animate-spin"}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Connecting..."}),s.jsx("p",{className:"text-muted-foreground",children:"Please wait while we connect your SocialPilot account"})]}),s.jsx("div",{className:"pt-4",children:s.jsxs("div",{className:"flex items-center justify-center gap-2 text-sm text-muted-foreground",children:[s.jsx("div",{className:"w-2 h-2 bg-blue-600 rounded-full animate-bounce"}),s.jsx("div",{className:"w-2 h-2 bg-blue-600 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),s.jsx("div",{className:"w-2 h-2 bg-blue-600 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]})})]}),e.status==="success"&&s.jsxs("div",{className:"text-center space-y-4",children:[s.jsx("div",{className:"w-16 h-16 mx-auto bg-green-100 rounded-full flex items-center justify-center",children:s.jsx(N,{className:"w-10 h-10 text-green-600"})}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-2xl font-bold mb-2 text-green-900",children:"Successfully Connected!"}),s.jsx("p",{className:"text-muted-foreground",children:e.message})]}),s.jsxs(m,{className:"bg-green-50 border-green-200 text-left",children:[s.jsx(b,{className:"h-4 w-4 text-green-600"}),s.jsx(x,{className:"text-green-900",children:"Your SocialPilot account is now connected. You can now schedule posts to all your social media platforms."})]}),s.jsx("div",{className:"pt-4",children:s.jsx("p",{className:"text-sm text-muted-foreground",children:"Redirecting to calendar..."})})]}),e.status==="user_denied"&&s.jsxs("div",{className:"text-center space-y-4",children:[s.jsx("div",{className:"w-16 h-16 mx-auto bg-orange-100 rounded-full flex items-center justify-center",children:s.jsx(g,{className:"w-10 h-10 text-orange-600"})}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-2xl font-bold mb-2 text-orange-900",children:"Connection Cancelled"}),s.jsx("p",{className:"text-muted-foreground",children:e.message})]}),s.jsxs(m,{className:"bg-orange-50 border-orange-200 text-left",children:[s.jsx(g,{className:"h-4 w-4 text-orange-600"}),s.jsx(x,{className:"text-orange-900",children:"You need to authorize access to SocialPilot to enable automated publishing."})]}),s.jsxs("div",{className:"flex gap-3 pt-4",children:[s.jsxs(u,{variant:"outline",onClick:h,className:"flex-1",children:[s.jsx(w,{className:"w-4 h-4 mr-2"}),"Go Back"]}),s.jsx(u,{onClick:r,className:"flex-1",children:"Try Again"})]})]}),e.status==="error"&&s.jsxs("div",{className:"text-center space-y-4",children:[s.jsx("div",{className:"w-16 h-16 mx-auto bg-red-100 rounded-full flex items-center justify-center",children:s.jsx(A,{className:"w-10 h-10 text-red-600"})}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-2xl font-bold mb-2 text-red-900",children:"Connection Failed"}),s.jsx("p",{className:"text-muted-foreground",children:e.message})]}),e.errorDetails&&s.jsxs(m,{variant:"destructive",className:"text-left",children:[s.jsx(g,{className:"h-4 w-4"}),s.jsx(x,{className:"text-sm font-mono break-all",children:e.errorDetails})]}),s.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg text-left text-sm space-y-2",children:[s.jsx("h4",{className:"font-semibold",children:"Troubleshooting:"}),s.jsxs("ul",{className:"list-disc list-inside space-y-1 text-muted-foreground",children:[s.jsx("li",{children:"Make sure you have a SocialPilot account"}),s.jsx("li",{children:"Check that your API credentials are correct"}),s.jsx("li",{children:"Verify your network connection"}),s.jsx("li",{children:"Try again in a few moments"})]})]}),s.jsxs("div",{className:"flex gap-3 pt-4",children:[s.jsxs(u,{variant:"outline",onClick:h,className:"flex-1",children:[s.jsx(w,{className:"w-4 h-4 mr-2"}),"Go Back"]}),s.jsx(u,{onClick:r,className:"flex-1",children:"Try Again"})]})]})]})})}export{Y as SocialPilotCallback};
//# sourceMappingURL=SocialPilotCallback-BFZWhgPW.js.map
