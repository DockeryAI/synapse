var Ae=Object.defineProperty;var Ce=(l,e,t)=>e in l?Ae(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var y=(l,e,t)=>Ce(l,typeof e!="symbol"?e+"":e,t);import{s as C}from"./analytics-BeoNQ3KZ.js";import{c as F}from"./campaign-CpExTzZS.js";const U="apify_api_BBYGaC6brF502BKwK6q6A7aSQ9kku52SSXVR",G="https://api.apify.com/v2",B={WEBSITE_CONTENT:"apify/website-content-crawler",GOOGLE_MAPS:"nwua9Gu5YrADL7ZDj",INSTAGRAM:"apify/instagram-scraper"};class ke{async runActor(e,t,o=120){try{const n=await fetch(`${G}/acts/${e}/runs?token=${U}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(`Failed to start Apify actor: ${n.status} ${n.statusText}`);const s=(await n.json()).data.id;console.log(`[Apify] Started actor ${e}, run ID: ${s}`);const i=Date.now();for(;Date.now()-i<o*1e3;){await new Promise(u=>setTimeout(u,2e3));const c=await fetch(`${G}/actor-runs/${s}?token=${U}`);if(!c.ok)throw new Error(`Failed to check run status: ${c.status}`);const a=await c.json(),d=a.data.status;if(d==="SUCCEEDED"){const u=a.data.defaultDatasetId,g=await fetch(`${G}/datasets/${u}/items?token=${U}`);if(!g.ok)throw new Error(`Failed to get dataset: ${g.status}`);const p=await g.json();return console.log(`[Apify] Actor completed successfully, ${p.length} results`),p}else if(d==="FAILED"||d==="ABORTED"||d==="TIMED-OUT")throw new Error(`Actor run ${d.toLowerCase()}: ${a.data.statusMessage||"Unknown error"}`);console.log(`[Apify] Run status: ${d}, waiting...`)}throw new Error(`Actor run timed out after ${o} seconds`)}catch(n){throw console.error("[Apify] Actor run error:",n),n}}async scrapeWebsiteContent(e){var t,o,n,r,s,i,c;try{console.log("[Apify] Scraping website content:",e);const a=await this.runActor(B.WEBSITE_CONTENT,{startUrls:[{url:e}],maxCrawlPages:1,crawlerType:"cheerio"});if(!a||a.length===0)throw new Error("No content extracted from website");const d=a[0];return{url:d.url||e,title:d.title||"",description:d.description||((t=d.metadata)==null?void 0:t.description)||"",text:d.text||"",headings:d.headings||[],links:d.links||[],metadata:{author:(o=d.metadata)==null?void 0:o.author,keywords:(n=d.metadata)==null?void 0:n.keywords,ogTitle:(s=(r=d.metadata)==null?void 0:r.og)==null?void 0:s.title,ogDescription:(c=(i=d.metadata)==null?void 0:i.og)==null?void 0:c.description}}}catch(a){throw console.error("[Apify] Website scraping error:",a),a}}async scrapeGoogleMapsReviews(e){try{console.log("[Apify] Scraping Google Maps reviews:",e);const t={maxReviews:e.maxReviews||50,reviewsSort:"newest",language:"en"};if(e.placeId)t.searchStringsArray=[`https://www.google.com/maps/place/?q=place_id:${e.placeId}`];else if(e.searchQuery&&e.location)t.searchStringsArray=[`${e.searchQuery} ${e.location}`];else if(e.searchQuery)t.searchStringsArray=[e.searchQuery];else throw new Error("Either placeId or searchQuery must be provided");return(await this.runActor(B.GOOGLE_MAPS,t,180)).map(n=>({placeId:n.placeId||"",name:n.title||n.name||"",address:n.address||"",rating:n.totalScore||n.rating||0,reviewsCount:n.reviewsCount||0,phone:n.phone,website:n.website,category:n.categoryName||n.category,reviews:(n.reviews||[]).map(r=>({name:r.name||r.reviewerName||"",text:r.text||"",stars:r.stars||0,publishedAtDate:r.publishedAtDate||r.publishAt||"",likesCount:r.likesCount||0,reviewId:r.reviewId,reviewUrl:r.reviewUrl,reviewerId:r.reviewerId,reviewerName:r.reviewerName,reviewerPhotoUrl:r.reviewerPhotoUrl}))}))}catch(t){throw console.error("[Apify] Google Maps scraping error:",t),t}}async scrapeInstagramBasic(e,t=12){try{console.log("[Apify] Scraping Instagram profile:",e);const o=await this.runActor(B.INSTAGRAM,{directUrls:[`https://www.instagram.com/${e}/`],resultsType:"posts",resultsLimit:t,searchType:"user",searchLimit:1},180);if(!o||o.length===0)return console.warn("[Apify] No Instagram data found for:",e),null;const n=o[0];return{username:n.ownerUsername||e,fullName:n.ownerFullName||"",biography:n.caption||"",followersCount:n.followersCount||0,followsCount:n.followsCount||0,postsCount:n.postsCount||0,isVerified:n.isVerified||!1,url:n.url||`https://www.instagram.com/${e}/`,posts:o.slice(0,t).map(r=>({url:r.url||"",caption:r.caption||"",likesCount:r.likesCount||0,commentsCount:r.commentsCount||0,timestamp:r.timestamp||new Date().toISOString()}))}}catch(o){return console.error("[Apify] Instagram scraping error:",o),null}}async scrapeWebsite(e){return this.scrapeWebsiteContent(e)}async scrapeInstagram(e){return this.scrapeInstagramBasic(e)}}const ye=new ke,Ie="NGE3MWQ0ZjQ3MTUzNGJmY2I5ZjNmM2U2OGY2MTljOTB8YzE1OWJmZGVjNA",Te="https://api.app.outscraper.com";class Pe{constructor(){y(this,"baseUrl",Te)}checkApiKey(){}async makeRequest(e,t){this.checkApiKey();const o=new URL(`${this.baseUrl}${e}`);Object.entries(t).forEach(([n,r])=>{r!=null&&o.searchParams.append(n,String(r))});try{const n=await fetch(o.toString(),{method:"GET",headers:{"X-API-KEY":Ie,"Content-Type":"application/json"}});if(!n.ok){const s=await n.text();throw new Error(`OutScraper API error (${n.status}): ${s}
Endpoint: ${e}
Check your API key and quota at: https://outscraper.com/dashboard/`)}return await n.json()}catch(n){throw n instanceof Error?(console.error("[OutScraper API] Request failed:",n.message),n):new Error(`OutScraper API request failed: ${String(n)}`)}}async getBusinessListings(e){var n;console.log("[OutScraper] Fetching business listings:",e.query),console.log("[OutScraper] API Key present:",!0);const t="/maps/search-v2",o={query:e.location?`${e.query} near ${e.location}`:e.query,limit:e.limit||20,language:e.language||"en",region:e.region||"US",async:!1,fields:"place_id,name,full_address,phone,site,category,rating,reviews,price_level,working_hours,photos_count,verified,claimed,latitude,longitude"};console.log("[OutScraper] Request params:",o);try{const r=await this.makeRequest(t,o);if(console.log("[OutScraper] Raw response:",r),r.status==="Pending")return console.warn("[OutScraper] Request is async/pending. Results not immediately available."),console.warn("[OutScraper] OutScraper queued the request. Would need to poll:",r.results_location),console.warn("[OutScraper] Using synchronous mode would be better for real-time results."),[];const s=((n=r.data)==null?void 0:n[0])||[];console.log("[OutScraper] Extracted results array:",s);const i=s.map(c=>({place_id:c.place_id||c.google_id||"",name:c.name||"",address:c.full_address||c.address||"",phone:c.phone,website:c.site||c.website,category:Array.isArray(c.category)?c.category:[c.category||"Business"],rating:parseFloat(c.rating)||0,reviews_count:parseInt(c.reviews)||0,price_level:c.price_level,verified:c.verified===!0||c.verified==="true",claimed:c.claimed===!0||c.claimed==="true",latitude:c.latitude,longitude:c.longitude}));return console.log("[OutScraper] Found",i.length,"business listings"),i}catch(r){throw console.error("[OutScraper] getBusinessListings failed:",r),console.error("[OutScraper] Error details:",r instanceof Error?r.message:r),r}}async scrapeGoogleReviews(e){var o,n,r,s;console.log("[OutScraper] Scraping reviews for:",e.business_name||e.place_id);const t=e.limit||100;if(e.place_id)try{console.log("[OutScraper] ATTEMPT 1: Trying place_id:",e.place_id);const i="/maps/reviews-v2",c={query:e.place_id,reviewsLimit:t,sort:e.sort||"newest",cutoff:e.cutoff_date,language:"en",async:!1};console.log("[OutScraper] Request params:",c);const a=await this.makeRequest(i,c);console.log("[OutScraper] Response status:",a.status),console.log("[OutScraper] Response data length:",(o=a.data)==null?void 0:o.length);const d=((n=a.data)==null?void 0:n[0])||[];d&&(console.log("[OutScraper] Results keys:",Object.keys(d)),console.log("[OutScraper] Business name from results:",d.name||d.business_name||"not found"));const u=d.reviews_data||d.reviews||[];if(console.log("[OutScraper] Reviews found via place_id:",u.length),u.length>0){const g=u.map(p=>({author_name:p.author_title||p.author_name||"Anonymous",author_photo:p.author_image||p.author_photo,rating:parseInt(p.review_rating)||parseInt(p.rating)||0,text:p.review_text||p.text||"",time:p.review_datetime_utc||p.time||new Date().toISOString(),language:p.review_language||p.language,likes:parseInt(p.review_likes)||0,author_reviews_count:parseInt(p.reviews_count)||0,response:p.owner_answer?{text:p.owner_answer,time:p.owner_answer_timestamp||""}:void 0}));return console.log("[OutScraper] âœ… Found",g.length,"reviews via place_id"),g}else console.warn("[OutScraper] place_id returned 0 reviews, trying name search...")}catch(i){console.warn("[OutScraper] place_id lookup failed:",i)}if(e.business_name&&e.location)try{console.log("[OutScraper] ATTEMPT 2: Trying business name + location search...");const i="/maps/reviews-v2",c=e.industry?`${e.business_name} ${e.industry} ${e.location}`:`${e.business_name} ${e.location}`;console.log("[OutScraper] Search query:",c);const a={query:c,reviewsLimit:t,sort:e.sort||"newest",cutoff:e.cutoff_date,language:"en",async:!1};console.log("[OutScraper] Request params:",a);const d=await this.makeRequest(i,a);console.log("[OutScraper] Response status:",d.status),console.log("[OutScraper] Response data length:",(r=d.data)==null?void 0:r.length);const u=((s=d.data)==null?void 0:s[0])||[];u&&(console.log("[OutScraper] Results keys:",Object.keys(u)),console.log("[OutScraper] Business name from results:",u.name||u.business_name||"not found"));const g=u.reviews_data||u.reviews||[];if(console.log("[OutScraper] Reviews found via name search:",g.length),g.length>0){const p=g.map(h=>({author_name:h.author_title||h.author_name||"Anonymous",author_photo:h.author_image||h.author_photo,rating:parseInt(h.review_rating)||parseInt(h.rating)||0,text:h.review_text||h.text||"",time:h.review_datetime_utc||h.time||new Date().toISOString(),language:h.review_language||h.language,likes:parseInt(h.review_likes)||0,author_reviews_count:parseInt(h.reviews_count)||0,response:h.owner_answer?{text:h.owner_answer,time:h.owner_answer_timestamp||""}:void 0}));return console.log("[OutScraper] âœ… Found",p.length,"reviews via name search"),p}else console.warn("[OutScraper] Name search returned 0 reviews")}catch(i){console.warn("[OutScraper] Name search failed:",i)}return console.warn("[OutScraper] âš ï¸ No reviews found via OutScraper"),console.log("[OutScraper] Trying Apify Google Maps fallback..."),await this.fallbackToApify(e.place_id,e.business_name,e.location,t)}async fallbackToApify(e,t,o,n){try{if(console.log("[OutScraper â†’ Apify] Starting fallback to Apify Google Maps Scraper"),!e&&(!t||!o))return console.warn("[OutScraper â†’ Apify] Cannot fallback - missing placeId and business_name+location"),console.warn("[OutScraper â†’ Apify] Received:",{placeId:e,businessName:t,location:o}),[];let r;t&&o&&(r=`${t} ${o}`,console.log(`[OutScraper â†’ Apify] Searching with query: "${r}"`));const s=await ye.scrapeGoogleMapsReviews({placeId:e,searchQuery:r,location:o,maxReviews:n});if(s.length===0)return console.warn("[OutScraper â†’ Apify] No places found"),[];const c=s[0].reviews||[];return c.length===0?(console.warn("[OutScraper â†’ Apify] Place found but no reviews available"),[]):(console.log(`[OutScraper â†’ Apify] âœ… Found ${c.length} reviews from Apify`),c.map(d=>({author_name:d.name,author_photo:d.reviewerPhotoUrl,rating:d.stars,text:d.text,time:d.publishedAtDate,language:void 0,likes:d.likesCount,author_reviews_count:void 0,response:void 0})))}catch(r){return console.error("[OutScraper â†’ Apify] Fallback failed:",r),[]}}async getBusinessDetails(e){var n;console.log("[OutScraper] Fetching business details for:",e);const t="/maps/search-v2",o={query:e,limit:1,language:"en"};try{const i=(((n=(await this.makeRequest(t,o)).data)==null?void 0:n[0])||[])[0];if(!i)throw new Error(`No business found with place_id: ${e}`);const c={place_id:i.place_id||i.google_id||"",name:i.name||"",address:i.full_address||i.address||"",phone:i.phone,website:i.site||i.website,category:Array.isArray(i.category)?i.category:[i.category||"Business"],rating:parseFloat(i.rating)||0,reviews_count:parseInt(i.reviews)||0,price_level:i.price_level,verified:i.verified===!0,claimed:i.claimed===!0,latitude:i.latitude,longitude:i.longitude,description:i.description||i.about,services:i.services||[],attributes:i.attributes||{}};return console.log("[OutScraper] Retrieved business profile for:",c.name),c}catch(r){throw console.error("[OutScraper] getBusinessDetails failed:",r),r}}async discoverCompetitors(e){console.log("[OutScraper] Discovering competitors for:",e.businessName);const t=`${e.industry} near ${e.location}`,r=(await this.getBusinessListings({query:t,location:e.location,limit:20})).filter(s=>!s.name.toLowerCase().includes(e.businessName.toLowerCase())).map(s=>({...s,relative_strength:this.assessRelativeStrength(s),competitive_advantages:this.identifyAdvantages(s)}));return console.log("[OutScraper] Found",r.length,"competitors"),r}async analyzeReviewSentiment(e){console.log("[OutScraper] Analyzing sentiment for",e.length,"reviews");const t=e.filter(c=>c.rating>=4).length,o=e.filter(c=>c.rating<=2).length,n=e.filter(c=>c.rating===3).length,r=e.reduce((c,a)=>c+a.rating/5,0)/e.length,s=e.map(c=>c.text.toLowerCase()).join(" "),i=this.extractCommonPhrases(s);return{overall_sentiment:r,positive_count:t,negative_count:o,neutral_count:n,themes:this.extractThemes(e),common_phrases:i}}async getLocalSearchRankings(e){console.log("[OutScraper] Checking local rankings for:",e.businessName);const t=[];for(const o of e.keywords){const n=await this.getBusinessListings({query:o,location:e.location,limit:10}),r=n.findIndex(s=>s.name.toLowerCase().includes(e.businessName.toLowerCase()));t.push({keyword:o,position:r>=0?r+1:void 0,map_pack_position:r>=0&&r<3?r+1:void 0,organic_position:r>=3?r-2:void 0,competitors_above:n.slice(0,r>0?r:0).map(s=>s.name)})}return t}async getLinkedInProfiles(e,t=20){var r;console.log("[OutScraper] Searching LinkedIn profiles:",e);const o="/linkedin/profiles",n={query:e,limit:t,async:!1};try{const s=await this.makeRequest(o,n);let i=((r=s.data)==null?void 0:r[0])||s.data||[];Array.isArray(i)||(console.log("[OutScraper] Response is not an array, wrapping:",typeof i),i=i?[i]:[]);const c=i.map(a=>({name:a.name||a.full_name||"",headline:a.headline||a.title||"",profileUrl:a.profile_url||a.url||"",location:a.location||a.geo||void 0,company:a.company||a.current_company||void 0,position:a.position||a.current_position||void 0,connections:a.connections?parseInt(a.connections):void 0,followers:a.followers?parseInt(a.followers):void 0,about:a.about||a.summary||void 0,experience:a.experience||[],education:a.education||[]}));return console.log("[OutScraper] Found",c.length,"LinkedIn profiles"),c}catch(s){return console.error("[OutScraper] getLinkedInProfiles failed:",s),[]}}async getLinkedInCompanies(e,t=20){var r;console.log("[OutScraper] Searching LinkedIn companies:",e);const o="/linkedin/companies",n={query:e,limit:t,async:!1};try{const s=await this.makeRequest(o,n);let i=((r=s.data)==null?void 0:r[0])||s.data||[];Array.isArray(i)||(console.log("[OutScraper] Response is not an array, wrapping:",typeof i),i=i?[i]:[]);const c=i.map(a=>({name:a.name||a.company_name||"",profileUrl:a.profile_url||a.url||"",description:a.description||a.about||"",industry:a.industry||void 0,companySize:a.company_size||a.size||void 0,location:a.location||a.headquarters||void 0,followers:a.followers?parseInt(a.followers):void 0,employees:a.employees?parseInt(a.employees):void 0,website:a.website||void 0,specialties:a.specialties||[]}));return console.log("[OutScraper] Found",c.length,"LinkedIn companies"),c}catch(s){return console.error("[OutScraper] getLinkedInCompanies failed:",s),[]}}async getLinkedInPosts(e,t=20){var r;console.log("[OutScraper] Searching LinkedIn posts:",e);const o="/linkedin/posts",n={query:e,limit:t,async:!1};try{const s=await this.makeRequest(o,n);let i=((r=s.data)==null?void 0:r[0])||s.data||[];Array.isArray(i)||(console.log("[OutScraper] Response is not an array, wrapping:",typeof i),i=i?[i]:[]);const c=i.map(a=>({author:a.author||a.author_name||"",authorProfile:a.author_profile||a.author_url||void 0,authorHeadline:a.author_headline||a.author_title||void 0,content:a.content||a.text||a.post_text||"",postUrl:a.post_url||a.url||"",publishedAt:a.published_at||a.date||a.timestamp||void 0,engagement:{likes:a.likes?parseInt(a.likes):void 0,comments:a.comments?parseInt(a.comments):void 0,shares:a.shares?parseInt(a.shares):void 0},hashtags:a.hashtags||[],media:a.media||[]}));return console.log("[OutScraper] Found",c.length,"LinkedIn posts"),c}catch(s){return console.error("[OutScraper] getLinkedInPosts failed:",s),[]}}assessRelativeStrength(e){return e.rating>=4.5&&e.reviews_count>100?"stronger":e.rating>=4&&e.reviews_count>50?"similar":"weaker"}identifyAdvantages(e){const t=[];return e.rating>=4.7&&t.push("Excellent ratings"),e.reviews_count>200&&t.push("High review volume"),e.verified&&t.push("Verified business"),e.claimed&&t.push("Claimed listing"),e.photos&&e.photos.length>10&&t.push("Strong visual presence"),t}extractCommonPhrases(e){const t=e.split(/\s+/).filter(n=>n.length>3),o={};return t.forEach(n=>{o[n]=(o[n]||0)+1}),Object.entries(o).sort(([,n],[,r])=>r-n).slice(0,10).map(([n])=>n)}extractThemes(e){return[{keyword:"service",theme:"Service Quality"},{keyword:"price",theme:"Pricing"},{keyword:"staff",theme:"Staff"},{keyword:"professional",theme:"Professionalism"},{keyword:"quick",theme:"Speed"},{keyword:"recommend",theme:"Recommendation"}].map(({keyword:o,theme:n})=>{const r=e.filter(i=>i.text.toLowerCase().includes(o)),s=r.length>0?r.reduce((i,c)=>i+c.rating,0)/r.length/5:0;return{theme:n,sentiment:s,mention_count:r.length}}).filter(o=>o.mention_count>0)}}const _=new Pe;class Ee{async detectLocation(e,t){console.log("[LocationDetection] Starting detection for:",e);let o=null;return o=this.detectFromDomain(e),o&&o.confidence>.7?(console.log("[LocationDetection] âœ… Domain parsing succeeded:",o),o):(o=await this.checkCache(e),o?(console.log("[LocationDetection] âœ… Cache hit:",o),o):(console.log("[LocationDetection] Cache miss, trying website scraping (most reliable)..."),o=await this.detectFromWebsite(e,t),console.log("[LocationDetection] Website scraping result:",o),o&&o.confidence>.6?(console.log("[LocationDetection] âœ… Website scraping succeeded:",o),await this.cacheResult(e,o),o):(console.log("[LocationDetection] Website scraping failed, trying AI detection..."),o=await this.detectWithAI(e,t),console.log("[LocationDetection] AI detection result:",o),o&&o.confidence>.6?(console.log("[LocationDetection] âœ… AI detection succeeded:",o),await this.cacheResult(e,o),o):(console.log("[LocationDetection] Domain-based AI detection failed, trying OutScraper..."),o=await this.detectWithOutScraper(e,t),console.log("[LocationDetection] OutScraper detection result:",o),o&&o.confidence>.7?(console.log("[LocationDetection] âœ… OutScraper detection succeeded:",o),await this.cacheResult(e,o),o):(console.log("[LocationDetection] âš ï¸ All detection methods failed"),null)))))}detectFromDomain(e){try{const t=e.match(/^https?:\/\//i)?e:`https://${e}`,o=new URL(t).hostname.toLowerCase().replace("www.","").split(".")[0],n={"nyc|newyork":{city:"New York",state:"NY"},dallas:{city:"Dallas",state:"TX"},austin:{city:"Austin",state:"TX"},houston:{city:"Houston",state:"TX"},sanantonio:{city:"San Antonio",state:"TX"},phoenix:{city:"Phoenix",state:"AZ"},"philadelphia|philly":{city:"Philadelphia",state:"PA"},sandiego:{city:"San Diego",state:"CA"},sanjose:{city:"San Jose",state:"CA"},jacksonville:{city:"Jacksonville",state:"FL"},fortworth:{city:"Fort Worth",state:"TX"},columbus:{city:"Columbus",state:"OH"},charlotte:{city:"Charlotte",state:"NC"},"sanfrancisco|sf":{city:"San Francisco",state:"CA"},indianapolis:{city:"Indianapolis",state:"IN"},seattle:{city:"Seattle",state:"WA"},denver:{city:"Denver",state:"CO"},"washington|dc":{city:"Washington",state:"DC"},boston:{city:"Boston",state:"MA"},elpaso:{city:"El Paso",state:"TX"},nashville:{city:"Nashville",state:"TN"},detroit:{city:"Detroit",state:"MI"},memphis:{city:"Memphis",state:"TN"},portland:{city:"Portland",state:"OR"},oklahomacity:{city:"Oklahoma City",state:"OK"},"lasvegas|vegas":{city:"Las Vegas",state:"NV"},louisville:{city:"Louisville",state:"KY"},baltimore:{city:"Baltimore",state:"MD"},milwaukee:{city:"Milwaukee",state:"WI"},albuquerque:{city:"Albuquerque",state:"NM"},tucson:{city:"Tucson",state:"AZ"},fresno:{city:"Fresno",state:"CA"},mesa:{city:"Mesa",state:"AZ"},sacramento:{city:"Sacramento",state:"CA"},atlanta:{city:"Atlanta",state:"GA"},kansascity:{city:"Kansas City",state:"MO"},colorado:{city:"Denver",state:"CO"},miami:{city:"Miami",state:"FL"},raleigh:{city:"Raleigh",state:"NC"},omaha:{city:"Omaha",state:"NE"},longbeach:{city:"Long Beach",state:"CA"},virginia:{city:"Virginia Beach",state:"VA"},oakland:{city:"Oakland",state:"CA"},minneapolis:{city:"Minneapolis",state:"MN"},tulsa:{city:"Tulsa",state:"OK"},tampa:{city:"Tampa",state:"FL"},arlington:{city:"Arlington",state:"TX"},neworleans:{city:"New Orleans",state:"LA"},chicago:{city:"Chicago",state:"IL"},"losangeles|la":{city:"Los Angeles",state:"CA"}};for(const[r,s]of Object.entries(n))if(new RegExp(`^${r}(?![a-z])`,"i").test(o))return{...s,confidence:.8,method:"domain",reasoning:`Detected "${s.city}" in domain name`};return null}catch(t){return console.error("[LocationDetection] Domain parsing error:",t),null}}async checkCache(e){var t;try{const o=e.match(/^https?:\/\//i)?e:`https://${e}`,n=new URL(o).hostname,{data:r,error:s}=await C.from("location_detection_cache").select("city, state, confidence, method, reasoning").eq("domain",n).single();return s?((t=s.message)!=null&&t.includes("406")&&console.log("[LocationDetection] âš ï¸ Cache table not accessible (406) - PostgREST cache issue, falling through to AI detection"),null):r?r.hasMultipleLocations===void 0?(console.log("[LocationDetection] Cache entry outdated (no multi-location support), invalidating..."),null):r:null}catch(o){return console.log("[LocationDetection] Cache check error:",o),null}}async detectWithAI(e,t){console.log("[LocationDetection] Starting AI detection for:",e);try{const o=e.startsWith("http")?e:`https://${e}`,n=new URL(o).hostname,r=`You are a location detection expert. Analyze this business URL and determine the most likely city and state.

URL: ${e}
Domain: ${n}
${t?`Industry: ${t}`:""}

Look for location clues in:
1. Domain name (e.g., "dallasplumbing.com" â†’ Dallas, TX)
2. Common city abbreviations or nicknames
3. Regional service patterns

Respond ONLY with valid JSON in this exact format:
{
  "city": "City Name",
  "state": "XX",
  "confidence": 0.0-1.0,
  "reasoning": "brief explanation"
}

If you cannot detect a location with confidence > 0.5, respond with:
{
  "city": null,
  "state": null,
  "confidence": 0.0,
  "reasoning": "Could not detect location from URL"
}`;console.log("[LocationDetection] Calling OpenRouter AI...");const s=await F([{role:"user",content:r}],{model:"anthropic/claude-3.5-sonnet",temperature:.3,max_tokens:200});console.log("[LocationDetection] AI response received:",s==null?void 0:s.substring(0,100));const i=s.trim(),c=i.match(/\{[\s\S]*\}/);if(!c)throw console.error("[LocationDetection] No JSON in AI response:",i),new Error("No JSON in AI response");const a=JSON.parse(c[0]);return console.log("[LocationDetection] Parsed AI result:",a),!a.city||!a.state||a.confidence<.5?(console.log("[LocationDetection] AI result rejected: city/state missing or confidence < 0.5"),null):{city:a.city,state:a.state,confidence:a.confidence,method:"ai",reasoning:a.reasoning}}catch(o){return console.error("[LocationDetection] AI inference error:",o),null}}async detectWithOutScraper(e,t){console.log("[LocationDetection] Starting OutScraper detection for:",e);try{const o=e.startsWith("http")?e:`https://${e}`;let r=new URL(o).hostname.replace("www.","").split(".")[0].replace(/[-_]/g," ");const s=["restaurant","cafe","bar","grill","bistro","eatery","kitchen","dining"];for(const d of s){const u=new RegExp(d+"$","i");if(u.test(r)){r=r.replace(u,` ${d}`);break}}r=r.replace(/^the\s+/i,"The "),r=r.split(" ").map(d=>d.charAt(0).toUpperCase()+d.slice(1).toLowerCase()).join(" ").trim(),console.log("[LocationDetection] Searching Google Maps for:",r);const i=await _.getBusinessListings({query:r,limit:50});if(console.log("[LocationDetection] OutScraper found",i.length,"listings"),i.length===0)return null;const c=new Set,a=[];for(const d of i){if(!d.address){console.log("[LocationDetection] Skipping listing with no address:",d.name);continue}console.log("[LocationDetection] Parsing address:",d.address);const u=d.address.split(",").map(h=>h.trim());console.log("[LocationDetection] Address parts:",u);let g="",p="";for(let h=u.length-1;h>=0;h--){const m=u[h].match(/\b([A-Z]{2})\b/);if(m&&!p){p=m[1],h>0&&(g=u[h-1]);break}}if(g&&p&&p.length===2){const h=`${g}|${p}`;c.has(h)||(c.add(h),a.push({city:g,state:p}),console.log("[LocationDetection] âœ… Extracted location:",{city:g,state:p}))}else console.log("[LocationDetection] âŒ Failed to extract location from:",d.address)}return console.log("[LocationDetection] Extracted",a.length,"unique locations from OutScraper"),a.length===0?null:a.length===1?{city:a[0].city,state:a[0].state,confidence:.9,method:"ai",reasoning:`Found single location via Google Maps: ${a[0].city}, ${a[0].state}`,hasMultipleLocations:!1}:{city:a[0].city,state:a[0].state,confidence:.95,method:"ai",reasoning:`Found ${a.length} locations via Google Maps, primary: ${a[0].city}, ${a[0].state}`,hasMultipleLocations:!0,allLocations:a}}catch(o){return console.error("[LocationDetection] OutScraper detection error:",o),null}}async detectFromWebsite(e,t){console.log("[LocationDetection] Fetching website content...");const o=e.match(/^https?:\/\//i)?e:`https://${e}`,n=new URL(o).origin,r=[`${n}/locations`,`${n}/locations-menus`,`${n}/find-us`,`${n}/contact`,`${n}/store-locator`,`${n}/our-locations`];for(const s of r){console.log("[LocationDetection] Trying location page:",s);const i=await this.scrapeAndAnalyze(s,t);if(i&&i.confidence>.6)return console.log("[LocationDetection] âœ… Found locations on dedicated page:",s),i}return console.log("[LocationDetection] No location page found, trying homepage..."),await this.scrapeAndAnalyze(o,t)}async scrapeAndAnalyze(e,t){var o,n,r,s;try{const{data:i,error:c}=await C.functions.invoke("scrape-website",{body:{url:e}});if(c||!(i!=null&&i.content))return console.log("[LocationDetection] Scraping failed for:",e,(c==null?void 0:c.message)||"No content"),null;const a=i.content,u=["=== STRUCTURED DATA (JSON-LD, SCRIPT TAGS) ===",a.structuredData||"","","=== NAVIGATION & LOCATION SELECTORS ===",a.navigation||"","","=== ADDRESSES ===",a.addresses||"","","=== FOOTER ===",a.footer||"","","=== PAGE CONTENT ===",a.title||"",a.description||"",...a.headings||[],a.text||""].join(`
`).substring(0,8e3);console.log("[LocationDetection] Website content fetched"),console.log("[LocationDetection] - Structured data length:",((o=a.structuredData)==null?void 0:o.length)||0),console.log("[LocationDetection] - Navigation length:",((n=a.navigation)==null?void 0:n.length)||0),console.log("[LocationDetection] - Addresses length:",((r=a.addresses)==null?void 0:r.length)||0),console.log("[LocationDetection] - Footer length:",((s=a.footer)==null?void 0:s.length)||0),console.log("[LocationDetection] - Total content length:",u.length);const g=`You are a location detection expert. Analyze this website content and extract ALL physical business locations.

URL: ${e}
${t?`Industry: ${t}`:""}

Website Content (prioritized sections):
${u}

CRITICAL INSTRUCTIONS:
This may be a LOCATIONS PAGE or HOMEPAGE. Extract EVERY location mentioned.

Look for:
1. **STRUCTURED DATA (HIGHEST PRIORITY)** - JSON-LD, script tags with location arrays
   - Look for JSON objects with "address", "location", "city", "state" fields
   - Parse JavaScript data structures embedded in the page
   - Example: {"locations": [{"city": "Dallas", "state": "TX"}, ...]}

2. **LOCATION LISTS** - Lists of cities/states with addresses
   - "Dallas, TX", "Houston, TX", "Miami, FL" etc.
   - Full addresses: "123 Main St, Dallas, TX 75201"
   - Location cards or sections

3. **NAVIGATION & SELECTORS** - Dropdowns with city names

4. **ADDRESSES** - Structured address elements

5. **CONTACT INFO** - Footer addresses, phone numbers with area codes

IGNORE:
- Service areas without physical addresses
- "Coming Soon" announcements
- Promotional hero banners (these show NEWEST, not primary)

Determine PRIMARY location:
- First location listed on locations page
- HQ or headquarters designation
- Most detailed address info
- NOT the promotional banner location

Extract EVERY city and state pair you find. If you see 9 locations, return all 9.

Respond ONLY with valid JSON in this exact format:

If SINGLE location found:
{
  "city": "City Name",
  "state": "XX",
  "confidence": 0.0-1.0,
  "hasMultipleLocations": false,
  "reasoning": "explanation"
}

If MULTIPLE locations found:
{
  "city": "Primary City",
  "state": "XX",
  "confidence": 0.0-1.0,
  "hasMultipleLocations": true,
  "allLocations": [
    {"city": "City1", "state": "XX"},
    {"city": "City2", "state": "YY"}
  ],
  "reasoning": "Found N locations, primary is City1 based on..."
}

If NO location found:
{
  "city": null,
  "state": null,
  "confidence": 0.0,
  "hasMultipleLocations": false,
  "reasoning": "No location information found"
}`;console.log("[LocationDetection] Analyzing website content with AI...");const p=await F([{role:"user",content:g}],{model:"anthropic/claude-3.5-sonnet",temperature:.2,max_tokens:500});console.log("[LocationDetection] Website analysis response:",p==null?void 0:p.substring(0,100));const f=p.trim().match(/\{[\s\S]*\}/);if(!f)return console.error("[LocationDetection] No JSON in website analysis response"),null;const m=JSON.parse(f[0]);return console.log("[LocationDetection] Parsed website analysis result:",m),!(m.city&&m.state||m.state&&m.confidence>=.7)||m.confidence<.5?(console.log("[LocationDetection] Website analysis rejected: insufficient confidence or missing data"),null):{city:m.city||null,state:m.state,confidence:m.confidence,method:"website_scraping",reasoning:m.reasoning,hasMultipleLocations:m.hasMultipleLocations||!1,allLocations:m.allLocations||void 0}}catch(i){return console.error("[LocationDetection] Website scraping error:",i),null}}async cacheResult(e,t){try{const o=e.match(/^https?:\/\//i)?e:`https://${e}`,n=new URL(o).hostname;await C.from("location_detection_cache").delete().eq("domain",n),await C.from("location_detection_cache").insert({domain:n,city:t.city,state:t.state,confidence:t.confidence,method:t.method,reasoning:t.reasoning,hasMultipleLocations:t.hasMultipleLocations||!1,allLocations:t.allLocations||null,updated_at:new Date().toISOString()}),console.log("[LocationDetection] Cached result for:",n)}catch(o){console.log("[LocationDetection] Cache save failed (non-critical):",o)}}formatLocation(e){return`${e.city}, ${e.state}`}}const zt=new Ee,j="AIzaSyAxDUys6ZoILskNxhaFFyPxqsV-depYUTU",$e=60*60*1e3;class Oe{constructor(){y(this,"cache",new Map)}getCached(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<$e?t.data:(this.cache.delete(e),null)}setCache(e,t){this.cache.set(e,{data:t,timestamp:Date.now()})}async getTrendingVideos(e,t="US"){const o=`trending_${e}_${t}`,n=this.getCached(o);if(n)return n;try{const r=e?`&videoCategoryId=${e}`:"",s=`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&chart=mostPopular&regionCode=${t}${r}&maxResults=50&key=${j}`,i=await fetch(s);if(!i.ok)throw new Error(`YouTube API error: ${i.statusText}`);const a=(await i.json()).items.map(d=>({id:d.id,title:d.snippet.title,description:d.snippet.description,channelTitle:d.snippet.channelTitle,publishedAt:d.snippet.publishedAt,viewCount:parseInt(d.statistics.viewCount||"0"),likeCount:parseInt(d.statistics.likeCount||"0"),commentCount:parseInt(d.statistics.commentCount||"0"),tags:d.snippet.tags||[],categoryId:d.snippet.categoryId}));return this.setCache(o,a),a}catch(r){throw console.error("[YouTube API] Error fetching trending videos:",r),r}}async searchVideos(e,t=20){const o=e.join(" "),n=`search_${o}_${t}`,r=this.getCached(n);if(r)return r;try{const s=`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(o)}&type=video&maxResults=${t}&key=${j}`,i=await fetch(s);if(!i.ok)throw new Error(`YouTube search error: ${i.statusText}`);const d=`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=${(await i.json()).items.map(h=>h.id.videoId).join(",")}&key=${j}`,p=(await(await fetch(d)).json()).items.map(h=>({id:h.id,title:h.snippet.title,description:h.snippet.description,channelTitle:h.snippet.channelTitle,publishedAt:h.snippet.publishedAt,viewCount:parseInt(h.statistics.viewCount||"0"),likeCount:parseInt(h.statistics.likeCount||"0"),commentCount:parseInt(h.statistics.commentCount||"0"),tags:h.snippet.tags||[],categoryId:h.snippet.categoryId}));return this.setCache(n,p),p}catch(s){throw console.error("[YouTube API] Error searching videos:",s),s}}async analyzeVideoTrends(e,t){const o=`trends_${e}_${t.join("_")}`,n=this.getCached(o);if(n)return n;try{const r=await this.searchVideos(t,50),i=r.flatMap(f=>f.tags).reduce((f,m)=>(f[m]=(f[m]||0)+1,f),{}),c=Object.entries(i).sort((f,m)=>m[1]-f[1]).slice(0,10).map(([f])=>f),a={};r.forEach(f=>{f.title.toLowerCase().includes("tutorial")&&(a.Tutorial=(a.Tutorial||0)+1),f.title.toLowerCase().includes("review")&&(a.Review=(a.Review||0)+1),f.title.toLowerCase().includes("how to")&&(a["How-To"]=(a["How-To"]||0)+1),f.title.toLowerCase().includes("tips")&&(a.Tips=(a.Tips||0)+1),f.title.toLowerCase().includes("vs")&&(a.Comparison=(a.Comparison||0)+1)});const d=Object.entries(a).sort((f,m)=>m[1]-f[1]).slice(0,5).map(([f])=>f),u=r.reduce((f,m)=>f+m.viewCount,0)/r.length,g=r.reduce((f,m)=>{const v=(m.likeCount+m.commentCount)/(m.viewCount||1);return f+v},0)/r.length,p=[...new Set(r.slice(0,10).map(f=>{const m=f.title.toLowerCase();return m.includes("beginner")?"Beginner-friendly content":m.includes("advanced")?"Advanced techniques":m.includes("mistake")?"Common mistakes to avoid":m.includes("secret")?"Insider secrets":m.includes("best")?"Best practices":"Educational content"}))],h={trending_topics:c,popular_formats:d,engagement_patterns:{avgViewCount:Math.round(u),avgEngagementRate:parseFloat((g*100).toFixed(2)),peakPostingTimes:["10 AM EST","2 PM EST","6 PM EST"]},content_angles:p,relevance_score:Math.min(100,Math.round(r.length/50*100))};return this.setCache(o,h),h}catch(r){throw console.error("[YouTube API] Error analyzing trends:",r),r}}}const xe=new Oe,Re=60*60*1e3;class _e{constructor(){y(this,"cache",new Map)}getCached(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<Re?t.data:(this.cache.delete(e),null)}setCache(e,t){this.cache.set(e,{data:t,timestamp:Date.now()})}generateBroaderSearchTerms(e,t){const o=new Set;t.forEach(i=>o.add(i));const n=["services","solutions","inc","llc","corp","company","the","and","or"];return e.toLowerCase().split(/\s+/).filter(i=>i.length>2&&!n.includes(i)).forEach(i=>o.add(i)),o.add("small business"),o.add("local business"),o.add("business trends"),Object.entries({hvac:["energy efficiency","home improvement","climate control"],plumbing:["home repair","water systems","home services"],electrical:["home improvement","smart home","energy"],restaurant:["food industry","hospitality","dining"],retail:["e-commerce","shopping","consumer trends"],fitness:["health","wellness","exercise"],salon:["beauty","wellness","personal care"],dental:["healthcare","oral health","medical"],legal:["law","attorney","legal services"],accounting:["finance","tax","business services"]}).forEach(([i,c])=>{e.toLowerCase().includes(i)&&c.forEach(a=>o.add(a))}),Array.from(o).slice(0,10)}async getIndustryNews(e,t){const o=`industry_${e}_${t.join("_")}`,n=this.getCached(o);if(n)return n;try{const r="https://jpwljchikgmggjidogon.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impwd2xqY2hpa2dtZ2dqaWRvZ29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTY1NDAsImV4cCI6MjA3ODczMjU0MH0.At0TEROiEHP2XZQ7ccEErLa2qUG6LtGFwDJl4ukpTuo",i=this.generateBroaderSearchTerms(e,t);console.log("[NewsAPI] ðŸ” Searching with terms:",i.slice(0,5).join(", "));const c=await fetch(`${r}/functions/v1/fetch-news`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({type:"industry",industry:e,keywords:i,limit:20})});if(!c.ok){const g=await c.json().catch(()=>({}));return console.error(`[NewsAPI] âŒ Edge Function error (${c.status}): ${g.error||c.statusText}`),console.error("[NewsAPI] This likely means NEWS_API_KEY is not configured in Supabase Edge Function secrets"),[]}const a=await c.json();if(!a.success)return console.error("[NewsAPI] âŒ Edge Function returned error:",a.error),[];console.log(`[NewsAPI] ðŸ“° Retrieved ${a.articles.length} articles`);const u=a.articles.map(g=>({...g,relevanceScore:this.calculateRelevance(g,i)})).filter(g=>g.relevanceScore>=40);if(console.log(`[NewsAPI] âœ… Filtered to ${u.length} relevant articles (score >= 40)`),u.length===0){console.log("[NewsAPI] No industry-specific news found, trying general small business news...");const g=await fetch(`${r}/functions/v1/fetch-news`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({type:"industry",industry:"business",keywords:["small business","local business","business trends","entrepreneurship"],limit:15})});if(g.ok){const p=await g.json();if(p.success&&p.articles.length>0)return console.log(`[NewsAPI] ðŸ“° Fallback retrieved ${p.articles.length} general business articles`),this.setCache(o,p.articles),p.articles}}return this.setCache(o,u),u}catch(r){return console.error("[NewsAPI] âŒ Failed to fetch industry news:",r),[]}}async getLocalNews(e){const t=`local_${e}`,o=this.getCached(t);if(o)return o;try{const s=await fetch("https://jpwljchikgmggjidogon.supabase.co/functions/v1/fetch-news",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impwd2xqY2hpa2dtZ2dqaWRvZ29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTY1NDAsImV4cCI6MjA3ODczMjU0MH0.At0TEROiEHP2XZQ7ccEErLa2qUG6LtGFwDJl4ukpTuo"},body:JSON.stringify({type:"local",location:e,limit:15})});if(!s.ok){const c=await s.json().catch(()=>({}));return console.error(`[NewsAPI] âŒ Edge Function error (${s.status}): ${c.error||s.statusText}`),console.error("[NewsAPI] This likely means NEWS_API_KEY is not configured in Supabase Edge Function secrets"),[]}const i=await s.json();return i.success?(this.setCache(t,i.articles),i.articles):(console.error("[NewsAPI] âŒ Edge Function returned error:",i.error),[])}catch(n){return console.error("[NewsAPI] âŒ Failed to fetch local news:",n),[]}}calculateRelevance(e,t){let o=50;const n=`${e.title} ${e.description}`.toLowerCase();return t.forEach(r=>{n.includes(r.toLowerCase())&&(o+=15)}),Math.min(100,o)}}const Ne=new _e,Le=30*60*1e3;class De{constructor(){y(this,"cache",new Map)}getCached(e){const t=this.cache.get(e);return t&&Date.now()-t.timestamp<Le?t.data:(this.cache.delete(e),null)}setCache(e,t){this.cache.set(e,{data:t,timestamp:Date.now()})}async getCurrentWeather(e){const t=`current_${e}`,o=this.getCached(t);if(o)return o;try{const s=await fetch("https://jpwljchikgmggjidogon.supabase.co/functions/v1/fetch-weather",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impwd2xqY2hpa2dtZ2dqaWRvZ29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTY1NDAsImV4cCI6MjA3ODczMjU0MH0.At0TEROiEHP2XZQ7ccEErLa2qUG6LtGFwDJl4ukpTuo"},body:JSON.stringify({type:"current",location:e})});if(!s.ok){const a=await s.json().catch(()=>({}));throw console.error(`[WeatherAPI] âŒ Edge Function error (${s.status}): ${a.error||s.statusText}`),console.error("[WeatherAPI] This likely means WEATHER_API_KEY is not configured in Supabase Edge Function secrets"),new Error(`Weather Edge Function error (${s.status}): ${a.error||s.statusText}`)}const i=await s.json();if(!i.success)throw console.error("[WeatherAPI] âŒ Edge Function returned error:",i.error),new Error(`Weather Edge Function error: ${i.error}`);const c=i.data;return this.setCache(t,c),c}catch(n){throw console.error("[Weather API] Error:",n),n}}async get5DayForecast(e){const t=`forecast_${e}`,o=this.getCached(t);if(o)return o;try{const s=await fetch("https://jpwljchikgmggjidogon.supabase.co/functions/v1/fetch-weather",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impwd2xqY2hpa2dtZ2dqaWRvZ29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTY1NDAsImV4cCI6MjA3ODczMjU0MH0.At0TEROiEHP2XZQ7ccEErLa2qUG6LtGFwDJl4ukpTuo"},body:JSON.stringify({type:"forecast",location:e})});if(!s.ok){const a=await s.json().catch(()=>({}));throw console.error(`[WeatherAPI] âŒ Edge Function error (${s.status}): ${a.error||s.statusText}`),console.error("[WeatherAPI] This likely means WEATHER_API_KEY is not configured in Supabase Edge Function secrets"),new Error(`Weather Edge Function error (${s.status}): ${a.error||s.statusText}`)}const i=await s.json();if(!i.success)throw console.error("[WeatherAPI] âŒ Edge Function returned error:",i.error),new Error(`Weather Edge Function error: ${i.error}`);const c=i.data;return this.setCache(t,c),c}catch(n){throw console.error("[Weather API] Error:",n),n}}async detectWeatherOpportunities(e,t){const o=await this.getCurrentWeather(e),n=await this.get5DayForecast(e),r=[],s=o.temperature;s>90&&r.push({type:"heat_wave",urgency:"critical",title:"Heat Wave Alert",description:`Temperature ${Math.round(s)}Â°F - High demand for cooling services`,impact_score:95,suggested_actions:["Promote emergency AC repair services","Offer heat wave specials","Increase ad spend for cooling keywords","Send email campaign about heat protection"]}),s<32&&r.push({type:"cold_snap",urgency:"high",title:"Freezing Temperatures",description:`Temperature ${Math.round(s)}Â°F - Heating system demand`,impact_score:90,suggested_actions:["Promote heating system checks","Offer winterization services","Target frozen pipe prevention messaging"]}),s>=75&&s<=90&&r.push({type:"heat_wave",urgency:"medium",title:"Warm Weather Window",description:`Temperature ${Math.round(s)}Â°F - Ideal for AC tune-ups and outdoor services`,impact_score:65,suggested_actions:["Promote preventive AC maintenance before peak heat","Offer outdoor service specials","Remind customers about summer preparation","Target lawn care, exterior painting, roofing"]}),s>=50&&s<65&&r.push({type:"seasonal",urgency:"medium",title:"Perfect Service Weather",description:`Temperature ${Math.round(s)}Â°F - Comfortable conditions for outdoor work`,impact_score:60,suggested_actions:["Promote seasonal maintenance (HVAC, landscaping)","Offer exterior home services (painting, roofing, windows)","Target spring/fall preparation messaging","Schedule outdoor installations while weather is mild"]}),s>=32&&s<50&&r.push({type:"cold_snap",urgency:"medium",title:"Heating Season Active",description:`Temperature ${Math.round(s)}Â°F - Heating systems in regular use`,impact_score:55,suggested_actions:["Promote heating system maintenance","Offer insulation and weatherproofing","Target energy efficiency messaging","Remind customers about heating tune-ups"]});const i=o.condition.toLowerCase().includes("rain")||o.condition.toLowerCase().includes("drizzle");o.condition.toLowerCase().includes("snow")?r.push({type:"precipitation",urgency:"high",title:"Active Snowfall",description:"Snow conditions - high demand for winter services",impact_score:85,suggested_actions:["Promote snow removal services","Offer emergency heating repairs","Target winterization and insulation","Send winter safety tips"]}):i&&r.push({type:"precipitation",urgency:"medium",title:"Active Rainfall",description:"Current rain - opportunity for water-related services",impact_score:60,suggested_actions:["Promote waterproofing and drainage","Offer roof and gutter inspections","Target basement waterproofing","Send maintenance reminders"]});const a=n.some(g=>g.precipitation_chance>60),d=n.some(g=>g.precipitation_chance>30&&g.precipitation_chance<=60);a&&!i?r.push({type:"precipitation",urgency:"medium",title:"Heavy Rain Forecast",description:"Significant rain expected - prepare customers now",impact_score:70,suggested_actions:["Promote waterproofing services","Offer gutter cleaning before rain","Target flood prevention messaging","Send weather alert emails"]}):d&&!i&&!a&&r.push({type:"precipitation",urgency:"low",title:"Rain in Forecast",description:"Moderate rain expected - good time for preventive services",impact_score:45,suggested_actions:["Remind customers about drainage checks","Offer preventive maintenance","Target outdoor project completion messaging"]});const u=n.reduce((g,p)=>{const h=p.temp_max-p.temp_min;return Math.max(g,h)},0);if(u>30&&r.push({type:"seasonal",urgency:"low",title:"Temperature Fluctuations",description:`Large temperature swings (${Math.round(u)}Â°F) can strain HVAC systems`,impact_score:50,suggested_actions:["Promote HVAC system checks","Offer multi-season maintenance packages","Target energy efficiency messaging","Remind customers about system stress during swings"]}),r.length===0){const g=new Date().getMonth()+1;let p;g>=6&&g<=8?p={type:"seasonal",urgency:"low",title:"Summer Season",description:`Temperature ${Math.round(s)}Â°F - Summer service opportunities`,impact_score:40,suggested_actions:["Promote AC maintenance and tune-ups","Offer summer service packages","Target outdoor services (landscaping, exterior work)","Send seasonal maintenance reminders"]}:g>=12||g<=2?p={type:"seasonal",urgency:"low",title:"Winter Season",description:`Temperature ${Math.round(s)}Â°F - Winter service opportunities`,impact_score:40,suggested_actions:["Promote heating system maintenance","Offer winterization services","Target indoor home improvement projects","Send winter preparation tips"]}:g>=3&&g<=5?p={type:"seasonal",urgency:"low",title:"Spring Season",description:`Temperature ${Math.round(s)}Â°F - Spring preparation opportunities`,impact_score:40,suggested_actions:["Promote spring AC tune-ups before summer","Offer exterior home services (painting, roofing)","Target landscaping and outdoor projects","Send spring cleaning and maintenance reminders"]}:p={type:"seasonal",urgency:"low",title:"Fall Season",description:`Temperature ${Math.round(s)}Â°F - Fall preparation opportunities`,impact_score:40,suggested_actions:["Promote heating system tune-ups before winter","Offer winterization and insulation","Target gutter cleaning and exterior prep","Send fall maintenance reminders"]},r.push(p)}return console.log(`[WeatherAPI] ðŸŒ¤ï¸ Detected ${r.length} weather opportunities for ${e}`),r}}const Fe=new De,I="94d1dece6ee22346e263cb3c90af596988152d46";class Me{async searchGoogle(e){try{return((await(await fetch("https://google.serper.dev/search",{method:"POST",headers:{"X-API-KEY":I,"Content-Type":"application/json"},body:JSON.stringify({q:e})})).json()).organic||[]).map((n,r)=>({title:n.title,link:n.link,snippet:n.snippet,position:r+1}))}catch(t){throw console.error("[Serper API] Error:",t),t}}async getTrendingSearches(){throw new Error("getTrendingSearches() not yet implemented. Use Google Trends API instead.")}async searchCompetitors(e,t){const n=(await this.searchGoogle(e)).map(r=>{try{return new URL(r.link).hostname.replace(/^www\./,"")}catch{return null}}).filter(r=>r!==null).filter(r=>!(["wikipedia.org","youtube.com","facebook.com","twitter.com","linkedin.com","instagram.com"].some(i=>r.includes(i))||t&&r.toLowerCase().includes(t.toLowerCase())));return Array.from(new Set(n))}async getNews(e,t){try{const o={q:e};t&&(o.location=t);const n=await fetch("https://google.serper.dev/news",{method:"POST",headers:{"X-API-KEY":I,"Content-Type":"application/json"},body:JSON.stringify(o)});if(!n.ok)throw new Error(`Serper News API error: ${n.status}`);return((await n.json()).news||[]).map(s=>({title:s.title||"",link:s.link||"",snippet:s.snippet||"",date:s.date||new Date().toISOString(),source:s.source||"Unknown",imageUrl:s.imageUrl}))}catch(o){throw console.error("[Serper News API] Error:",o),o}}async getTrends(e,t){try{const[o,n]=await Promise.all([this.searchGoogle(e),this.getAutocomplete(e)]),r=o.some(s=>{var i,c;return((i=s.snippet)==null?void 0:i.toLowerCase().includes("trending"))||((c=s.snippet)==null?void 0:c.toLowerCase().includes("popular"))});return{keyword:e,relatedQueries:n.slice(0,5),timeRange:t||"past 30 days",trend:r?"rising":"stable",growthPercentage:r?25:0}}catch(o){throw console.error("[Serper Trends] Error:",o),o}}async getAutocomplete(e){try{const t=await fetch("https://google.serper.dev/search",{method:"POST",headers:{"X-API-KEY":I,"Content-Type":"application/json"},body:JSON.stringify({q:e,autocorrect:!0})});if(!t.ok)throw new Error(`Serper Autocomplete API error: ${t.status}`);const o=await t.json(),n=[];return o.peopleAlsoAsk&&n.push(...o.peopleAlsoAsk.map(r=>r.question)),o.relatedSearches&&n.push(...o.relatedSearches.map(r=>r.query)),n.filter(Boolean).slice(0,10)}catch(t){return console.error("[Serper Autocomplete] Error:",t),[]}}async getPlaces(e,t){try{const o=await fetch("https://google.serper.dev/places",{method:"POST",headers:{"X-API-KEY":I,"Content-Type":"application/json"},body:JSON.stringify({q:e,location:t})});if(!o.ok)throw new Error(`Serper Places API error: ${o.status}`);return((await o.json()).places||[]).map(r=>{const s=r.placeId||r.place_id||r.cid||r.data_id||r.dataId;return{name:r.title||r.name||"",address:r.address||"",rating:r.rating||void 0,reviewCount:r.reviews||r.ratingCount||void 0,phone:r.phoneNumber||r.phone||void 0,website:r.website||void 0,category:r.category||r.type||void 0,placeId:s,_raw:r}})}catch(o){throw console.error("[Serper Places] Error:",o),o}}async getPlaceReviews(e){try{console.log("[Serper] Fetching reviews for place_id:",e);const t=await fetch("https://google.serper.dev/places",{method:"POST",headers:{"X-API-KEY":I,"Content-Type":"application/json"},body:JSON.stringify({q:`place_id:${e}`})});if(!t.ok)throw new Error(`Serper Places API error: ${t.status}`);const n=(await t.json()).reviews||[];return console.log("[Serper] Found",n.length,"reviews"),n.map(r=>({author:r.author||r.name||"Anonymous",rating:r.rating||0,text:r.snippet||r.text||"",date:r.date||r.publishedAtDate||new Date().toISOString(),snippet:r.snippet}))}catch(t){return console.error("[Serper] Error fetching reviews:",t),[]}}async getImages(e){try{const t=await fetch("https://google.serper.dev/images",{method:"POST",headers:{"X-API-KEY":I,"Content-Type":"application/json"},body:JSON.stringify({q:e})});if(!t.ok)throw new Error(`Serper Images API error: ${t.status}`);return((await t.json()).images||[]).map(n=>({title:n.title||"",imageUrl:n.imageUrl||"",link:n.link||"",source:n.source||"",thumbnail:n.thumbnailUrl||n.thumbnail||void 0}))}catch(t){throw console.error("[Serper Images] Error:",t),t}}async getVideos(e){try{const t=await fetch("https://google.serper.dev/videos",{method:"POST",headers:{"X-API-KEY":I,"Content-Type":"application/json"},body:JSON.stringify({q:e})});if(!t.ok)throw new Error(`Serper Videos API error: ${t.status}`);return((await t.json()).videos||[]).map(n=>({title:n.title||"",link:n.link||"",snippet:n.snippet||n.description||"",channel:n.channel||n.source||"",date:n.date||new Date().toISOString(),duration:n.duration||void 0,thumbnail:n.imageUrl||n.thumbnail||void 0}))}catch(t){throw console.error("[Serper Videos] Error:",t),t}}async getShopping(e){try{const t=await fetch("https://google.serper.dev/shopping",{method:"POST",headers:{"X-API-KEY":I,"Content-Type":"application/json"},body:JSON.stringify({q:e})});if(!t.ok)throw new Error(`Serper Shopping API error: ${t.status}`);return((await t.json()).shopping||[]).map(n=>{var r;return{title:n.title||"",link:n.link||"",price:n.price||"N/A",source:n.source||"",rating:n.rating||void 0,reviewCount:n.reviews||n.ratingCount||void 0,imageUrl:n.imageUrl||n.thumbnail||void 0,inStock:((r=n.delivery)==null?void 0:r.includes("In stock"))||void 0}})}catch(t){throw console.error("[Serper Shopping] Error:",t),t}}}const k=new Me;class We{async getDomainOverview(e){console.log("[Semrush] Fetching domain overview for:",e);try{const{data:t,error:o}=await C.functions.invoke("fetch-seo-metrics",{body:{domain:e,type:"overview"}});if(o)throw console.error("[Semrush] Edge function error:",o),new Error(`Failed to fetch SEO metrics: ${o.message}`);if(!t.success||!t.data||t.data.length===0)throw new Error("No data returned from SEMrush");const n=t.data[0],r=parseInt(n["Organic Traffic"]||n.Ot||"0"),s=parseInt(n["Organic Keywords"]||n.Or||"0"),i=parseInt(n["Adwords Keywords"]||n.Ad||"0"),c=parseInt(n["Adwords Traffic"]||n.At||"0");return{domain:e,organic_keywords:s,organic_traffic:r,paid_keywords:i,backlinks:c,authority_score:Math.min(100,Math.round(c/100))}}catch(t){throw console.error("[Semrush API] Error:",t),new Error(`Failed to fetch SEMrush data: ${t.message}`)}}async getKeywordRankings(e,t){console.log("[Semrush] Fetching keyword rankings for:",e);try{const{data:o,error:n}=await C.functions.invoke("fetch-seo-metrics",{body:{domain:e,type:"keywords"}});if(n)throw console.error("[Semrush] Edge function error:",n),new Error(`Failed to fetch keyword rankings: ${n.message}`);if(!o.success||!o.data)throw new Error("No data returned from SEMrush");const r=o.data.filter(s=>s.Ph||s.Keyword).map(s=>{const i=s.Ph||s.Keyword||"",c=t?i.toLowerCase().includes(t.toLowerCase()):!1,a=parseInt(s.Po||s.Position||"0"),d=parseInt(s.Nq||s["Search Volume"]||"0"),u=this.estimateDifficulty(d),g=parseInt(s.Tr||s.Traffic||"0"),p=this.estimateTrend(a,d,u);return{keyword:i,position:a,searchVolume:d,difficulty:u,traffic:g,url:s.Ur||s.URL||"",isBranded:c,trend:p.indicator,trendData:p.data}}).filter(s=>s.keyword&&!s.isBranded);return console.log("[Semrush] Found",r.length,"non-branded keyword rankings"),r}catch(o){throw console.error("[Semrush] Error fetching rankings:",o),new Error(`Failed to fetch keyword rankings: ${o.message}`)}}async getDetailedKeywordMetrics(e,t,o=20){return console.log("[Semrush] Fetching detailed keyword metrics for:",e),(await this.getKeywordRankings(e,t)).map(s=>({...s,score:this.calculateKeywordImportance(s)})).sort((s,i)=>i.score-s.score).slice(0,o)}async getKeywordOpportunities(e,t){console.log("[Semrush] Finding keyword opportunities for:",e);const o=await this.getKeywordRankings(e,t),n=[];for(const r of o)r.position>=11&&r.position<=20&&r.searchVolume>=100&&n.push({keyword:r.keyword,searchVolume:r.searchVolume,difficulty:r.difficulty,currentPosition:r.position,estimatedTraffic:Math.round(r.searchVolume*.15),opportunity:"quick-win",reasoning:`Currently ranked #${r.position} - just outside page 1. With optimization, could reach top 10.`}),r.searchVolume>=1e3&&(!r.position||r.position>50)&&n.push({keyword:r.keyword,searchVolume:r.searchVolume,difficulty:r.difficulty,currentPosition:r.position||void 0,estimatedTraffic:Math.round(r.searchVolume*.2),opportunity:"high-value",reasoning:`High search volume (${r.searchVolume}/mo) with room for improvement.`}),r.position>=21&&r.position<=50&&r.difficulty>=60&&n.push({keyword:r.keyword,searchVolume:r.searchVolume,difficulty:r.difficulty,currentPosition:r.position,estimatedTraffic:Math.round(r.searchVolume*.1),opportunity:"long-term",reasoning:"Competitive keyword but you already have some authority. Build content consistently."});return n.sort((r,s)=>s.estimatedTraffic-r.estimatedTraffic),console.log("[Semrush] Found",n.length,"keyword opportunities"),n.slice(0,20)}async getComprehensiveSEOMetrics(e,t){console.log("[Semrush] Fetching comprehensive SEO metrics for:",e);const[o,n,r]=await Promise.all([this.getDomainOverview(e),this.getKeywordRankings(e,t),this.getKeywordOpportunities(e,t)]),s=this.calculateSEOHealth(o,n);return{domain:e,overview:o,rankings:n.slice(0,50),opportunities:r,competitors:[],healthScore:s}}async getCompetitorKeywords(e){return(await this.getKeywordRankings(e)).slice(0,10).map(o=>o.keyword)}estimateDifficulty(e){return e<100?20:e<500?35:e<1e3?50:e<5e3?65:e<1e4?75:85}estimateTrend(e,t,o){return e<=3&&t>1e3?{indicator:"stable",data:{direction:"stable"}}:e<=10&&o>60?{indicator:"rising",data:{direction:"up"}}:e>20&&o<40?{indicator:"declining",data:{direction:"down"}}:{indicator:"stable",data:{direction:"stable"}}}calculateKeywordImportance(e){let t=0;return e.position<=3?t+=40:e.position<=10?t+=30:e.position<=20?t+=20:t+=10,e.searchVolume>=1e4?t+=30:e.searchVolume>=5e3?t+=25:e.searchVolume>=1e3?t+=20:e.searchVolume>=500?t+=15:e.searchVolume>=100?t+=10:t+=5,e.traffic>=1e3?t+=30:e.traffic>=500?t+=25:e.traffic>=100?t+=20:e.traffic>=50?t+=15:e.traffic>=10?t+=10:t+=5,t}calculateSEOHealth(e,t){let o=0;o+=Math.min(40,e.authority_score*.4);const n=t.filter(r=>r.position<=10).length;return o+=Math.min(30,n*2),e.backlinks>1e4?o+=20:e.backlinks>5e3?o+=15:e.backlinks>1e3?o+=10:e.backlinks>100&&(o+=5),e.organic_traffic>1e5?o+=10:e.organic_traffic>5e4?o+=7:e.organic_traffic>1e4?o+=5:e.organic_traffic>1e3&&(o+=2),Math.round(o)}}const N=new We,Ue="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",ie="https://jpwljchikgmggjidogon.supabase.co",ae="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impwd2xqY2hpa2dtZ2dqaWRvZ29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTY1NDAsImV4cCI6MjA3ODczMjU0MH0.At0TEROiEHP2XZQ7ccEErLa2qUG6LtGFwDJl4ukpTuo";class Ge{async extractWebsiteContent(e){var t;try{console.log("[WebsiteAnalyzer] Fetching content from:",e),console.log("[WebsiteAnalyzer] Using Edge Function for content extraction...");const o=await fetch(`${ie}/functions/v1/scrape-website`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${ae}`},body:JSON.stringify({url:e})});if(!o.ok){const s=await o.text();throw console.error("[WebsiteAnalyzer] Edge Function error:",o.status,s),new Error(`Edge Function failed: ${o.status}`)}const n=await o.json();if(!n.success)throw new Error(n.error||"Unknown error from Edge Function");const r=[n.content.title,n.content.description,n.content.text,(t=n.content.headings)==null?void 0:t.join(" ")].filter(Boolean).join(`

`);return console.log("[WebsiteAnalyzer] Edge Function extracted",r.length,"characters"),r}catch(o){throw console.error("[WebsiteAnalyzer] Failed to fetch website:",o),new Error(`Failed to fetch website: ${o instanceof Error?o.message:"Unknown error"}`)}}async analyzeWebsiteMessaging(e,t){var o,n,r,s,i,c,a,d,u,g,p,h;try{console.log("[WebsiteAnalyzer] Starting AI analysis for:",t);const f=e.slice(0,2e4),m=`You are a brand strategist analyzing a business's website content to understand EXACTLY what they sell and who they serve.

Business: ${t}
Website Content:
${f}

Extract the following business-specific information. CRITICAL RULES:
- Only include what they EXPLICITLY state on their website
- Use their EXACT words and phrases whenever possible
- DO NOT use generic industry assumptions
- If something is not mentioned, use empty array
- FOCUS on finding their SPECIALIZATION (niche, specific services, unique focus)

1. VALUE PROPOSITIONS: What unique benefits, guarantees, or promises do they explicitly mention? Their exact value statements.

2. TARGET AUDIENCE: Who EXACTLY are they talking to? Look for specific demographics, industries, types of customers. Use their exact language. Examples: "luxury car owners", "classic car collectors", "high-net-worth individuals", "exotic vehicle enthusiasts", "young families", "first-time homebuyers", etc.

3. CUSTOMER PROBLEMS: What specific problems, pain points, or challenges do they say their customers face? Use their exact words.

4. THEIR SOLUTION: How do they describe solving those problems? What specific services or products do they offer? BE SPECIFIC about what they sell.

5. PROOF POINTS: What credentials, experience, results, testimonials, certifications, awards, or stats do they cite?

6. DIFFERENTIATORS: What makes them different or specialized? Look for:
   - Niche focus (e.g., "rare cars", "vintage vehicles", "luxury homes", "commercial properties")
   - Specific expertise (e.g., "25 years insuring classic cars", "certified appraisers for collectibles")
   - Unique services (e.g., "agreed value coverage", "restoration specialists", "concierge service")
   - Market position (e.g., "only provider in X", "largest X in Y")

Return ONLY valid JSON (no markdown, no explanations):
{
  "valuePropositions": ["exact quote 1", "exact quote 2"],
  "targetAudience": ["exact audience description 1", "exact audience 2"],
  "customerProblems": ["problem 1 in their words", "problem 2"],
  "solutions": ["specific service/product 1", "specific service 2"],
  "proofPoints": ["credential 1", "stat 1", "testimonial theme"],
  "differentiators": ["unique specialization 1", "niche focus 2", "unique service 3"]
}`,v=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${Ue}`,"HTTP-Referer":"https://marba.ai","X-Title":"MARBA Intelligence","Content-Type":"application/json"},body:JSON.stringify({model:"anthropic/claude-3.5-sonnet",messages:[{role:"user",content:m}],max_tokens:4096,temperature:.3})});if(!v.ok){const x=await v.text();throw console.error("[WebsiteAnalyzer] OpenRouter API error:",v.status,x),new Error(`OpenRouter API error: ${v.status}`)}const S=(await v.json()).choices[0].message.content;console.log("[WebsiteAnalyzer] Raw AI response:",S.substring(0,200)+"...");const w=JSON.parse(S),T=[((o=w.valuePropositions)==null?void 0:o.length)||0,((n=w.targetAudience)==null?void 0:n.length)||0,((r=w.customerProblems)==null?void 0:r.length)||0,((s=w.solutions)==null?void 0:s.length)||0,((i=w.proofPoints)==null?void 0:i.length)||0,((c=w.differentiators)==null?void 0:c.length)||0].reduce((x,L)=>x+L,0),P=Math.min(T>0?50+T*5:30,95);return console.log("[WebsiteAnalyzer] Analysis complete:"),console.log("  - Value Propositions:",((a=w.valuePropositions)==null?void 0:a.length)||0),console.log("  - Target Audience:",((d=w.targetAudience)==null?void 0:d.length)||0),console.log("  - Problems:",((u=w.customerProblems)==null?void 0:u.length)||0),console.log("  - Solutions:",((g=w.solutions)==null?void 0:g.length)||0),console.log("  - Proof Points:",((p=w.proofPoints)==null?void 0:p.length)||0),console.log("  - Differentiators:",((h=w.differentiators)==null?void 0:h.length)||0),console.log("  - Confidence:",P+"%"),{valuePropositions:w.valuePropositions||[],targetAudience:w.targetAudience||[],customerProblems:w.customerProblems||[],solutions:w.solutions||[],proofPoints:w.proofPoints||[],differentiators:w.differentiators||[],confidence:P}}catch(f){return console.error("[WebsiteAnalyzer] AI analysis failed:",f),{valuePropositions:[],targetAudience:[],customerProblems:[],solutions:[],proofPoints:[],differentiators:[],confidence:0}}}async analyzeWebsite(e){try{const t=new URL(e).hostname.replace("www.","").split(".")[0],o=await this.extractWebsiteContent(e);return await this.analyzeWebsiteMessaging(o,t)}catch(t){throw console.error("[WebsiteAnalyzer] analyzeWebsite failed:",t),t}}}const we=new Ge;class Be{constructor(e){y(this,"clientId");y(this,"clientSecret");y(this,"userAgent");y(this,"accessToken",null);this.clientId=(e==null?void 0:e.clientId)||"lqPkpB00yesSrf8MDSHMPw",this.clientSecret=(e==null?void 0:e.clientSecret)||"HNHTMFc0wcMU9TU_kHswDL_dxDGmUA",this.userAgent=(e==null?void 0:e.userAgent)||"Synapse/1.0 by Perfect-News7007"}async getAccessToken(){if(this.accessToken&&Date.now()<this.accessToken.expiresAt)return this.accessToken.accessToken;console.log("[RedditAPI] Fetching new access token via Edge Function...");const e="https://jpwljchikgmggjidogon.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impwd2xqY2hpa2dtZ2dqaWRvZ29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTY1NDAsImV4cCI6MjA3ODczMjU0MH0.At0TEROiEHP2XZQ7ccEErLa2qUG6LtGFwDJl4ukpTuo";if(!this.clientId||!this.clientSecret)throw new Error("Reddit API credentials not configured");try{const o=await fetch(`${e}/functions/v1/reddit-oauth`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({endpoint:"/oauth/token",userAgent:this.userAgent})});if(!o.ok){const r=await o.text();throw console.error("[RedditAPI] Edge Function error:",o.status,r),new Error(`Edge Function failed: ${o.status}`)}const n=await o.json();if(!n.success)throw new Error(n.error||"Unknown error from Edge Function");return this.accessToken={accessToken:n.accessToken,tokenType:n.tokenType,expiresIn:n.expiresIn,scope:n.scope,expiresAt:Date.now()+n.expiresIn*1e3-6e4},console.log("[RedditAPI] âœ… Access token obtained via Edge Function, expires in",n.expiresIn,"seconds"),this.accessToken.accessToken}catch(o){throw console.error("[RedditAPI] OAuth error:",o),new Error("Failed to authenticate with Reddit API")}}async fetchAPI(e,t=!0){const o="https://jpwljchikgmggjidogon.supabase.co",n="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impwd2xqY2hpa2dtZ2dqaWRvZ29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTY1NDAsImV4cCI6MjA3ODczMjU0MH0.At0TEROiEHP2XZQ7ccEErLa2qUG6LtGFwDJl4ukpTuo";try{let r="";if(t)try{r=await this.getAccessToken()}catch(c){console.warn("[RedditAPI] OAuth failed, falling back to public API:",c),t=!1}const s=await fetch(`${o}/functions/v1/reddit-oauth`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({endpoint:e,accessToken:r,userAgent:this.userAgent,useAuth:t})});if(!s.ok){const c=await s.text();throw console.error("[RedditAPI] Edge Function error:",s.status,c),new Error(`Edge Function failed: ${s.status}`)}const i=await s.json();if(!i.success)throw new Error(i.error||"Unknown error from Edge Function");return i.data}catch(r){throw console.error("[RedditAPI] Fetch error:",r),r}}analyzePsychologicalTriggers(e,t){const o=[];e.toLowerCase();const n=[/you (won't|wont) believe/i,/the secret (to|of)/i,/what (actually|really) (happened|works)/i,/turns out/i,/discovered (that|how)/i,/found out (that|how)/i];for(const u of n)u.test(e)&&o.push({text:this.extractMatchContext(e,u),type:"curiosity",intensity:this.calculateTriggerIntensity(t.upvotes,"curiosity"),context:e.substring(0,200),subreddit:t.subreddit,upvotes:t.upvotes,url:t.url});const r=[/avoid|warning|mistake|danger|risk|scary|afraid/i,/don't (do|make|try)/i,/be careful/i,/watch out/i];for(const u of r)u.test(e)&&o.push({text:this.extractMatchContext(e,u),type:"fear",intensity:this.calculateTriggerIntensity(t.upvotes,"fear"),context:e.substring(0,200),subreddit:t.subreddit,upvotes:t.upvotes,url:t.url});const s=[/imagine|dream|wish|want|hope|achieve|accomplish/i,/finally (got|found|achieved)/i,/this changed my life/i];for(const u of s)u.test(e)&&o.push({text:this.extractMatchContext(e,u),type:"desire",intensity:this.calculateTriggerIntensity(t.upvotes,"desire"),context:e.substring(0,200),subreddit:t.subreddit,upvotes:t.upvotes,url:t.url});const i=[/join (us|our|the)/i,/community|together|family|tribe|team/i,/one of us|we all/i,/everyone (here|knows)/i];for(const u of i)u.test(e)&&o.push({text:this.extractMatchContext(e,u),type:"belonging",intensity:this.calculateTriggerIntensity(t.upvotes,"belonging"),context:e.substring(0,200),subreddit:t.subreddit,upvotes:t.upvotes,url:t.url});const c=[/success|victory|accomplished|proud|finally (did|achieved)/i,/made it|reached|hit (my|the) goal/i,/(beat|overcame|conquered)/i];for(const u of c)u.test(e)&&o.push({text:this.extractMatchContext(e,u),type:"achievement",intensity:this.calculateTriggerIntensity(t.upvotes,"achievement"),context:e.substring(0,200),subreddit:t.subreddit,upvotes:t.upvotes,url:t.url});const a=[/honest(ly)?|transparent|authentic|genuine/i,/trust me|believe me|i promise/i,/no (bs|bullshit|lie)/i];for(const u of a)u.test(e)&&o.push({text:this.extractMatchContext(e,u),type:"trust",intensity:this.calculateTriggerIntensity(t.upvotes,"trust"),context:e.substring(0,200),subreddit:t.subreddit,upvotes:t.upvotes,url:t.url});const d=[/last chance|running out|limited|now or never/i,/don't wait|act (now|fast|quickly)/i,/hurry|urgent/i];for(const u of d)u.test(e)&&o.push({text:this.extractMatchContext(e,u),type:"urgency",intensity:this.calculateTriggerIntensity(t.upvotes,"urgency"),context:e.substring(0,200),subreddit:t.subreddit,upvotes:t.upvotes,url:t.url});return o}extractMatchContext(e,t){const o=e.match(t);if(!o)return e.substring(0,100);const n=o.index||0,r=Math.max(0,n-50),s=Math.min(e.length,n+o[0].length+50);return e.substring(r,s).trim()}calculateTriggerIntensity(e,t){let o=Math.min(10,Math.floor(e/10)+1);return o*={curiosity:1,fear:1.2,desire:1.1,belonging:.9,achievement:1,trust:.8,urgency:1.3}[t],Math.min(10,Math.max(1,Math.round(o)))}extractCustomerInsights(e,t){e.toLowerCase();const o=[/i hate (when|how|that)/i,/i can't stand/i,/frustrating (when|how|that)/i,/annoying (when|how|that)/i,/why (is it so|does)/i,/the problem (is|with)/i];for(const r of o){const s=e.match(r);if(s){const i=s.index||0;return{painPoint:e.substring(i,Math.min(e.length,i+200)),context:e.substring(0,300),subreddit:t.subreddit,upvotes:t.upvotes,url:t.url}}}const n=[/i wish (there was|i could|someone would)/i,/if only (there was|i could)/i,/i'd love (to|if)/i,/would be (great|amazing|perfect) if/i,/someone (should|needs to) (make|create|build)/i];for(const r of n){const s=e.match(r);if(s){const i=s.index||0;return{desire:e.substring(i,Math.min(e.length,i+200)),context:e.substring(0,300),subreddit:t.subreddit,upvotes:t.upvotes,url:t.url}}}return null}async mineIntelligence(e,t={}){var u,g,p;const{subreddits:o=[],limit:n=25,commentsPerPost:r=20,sortBy:s="relevance",timeFilter:i="month"}=t;console.log("[RedditAPI] Mining intelligence for:",e);const c=[],a=[],d=new Map;try{const h=o.length>0?` subreddit:${o.join(" OR subreddit:")}`:"",f=e+h,m=`/search?q=${encodeURIComponent(f)}&sort=${s}&t=${i}&limit=${n}`,A=((u=(await this.fetchAPI(m)).data)==null?void 0:u.children)||[];console.log("[RedditAPI] Found",A.length,"posts");for(const S of A){const w=S.data,O=`https://reddit.com${w.permalink}`,T=`${w.title} ${w.selftext||""}`,P={subreddit:w.subreddit,upvotes:w.ups,url:O},x=this.analyzePsychologicalTriggers(T,P);c.push(...x);const L=this.extractCustomerInsights(T,P);L&&a.push(L);try{const ne=`/r/${w.subreddit}/comments/${w.id}?limit=${r}`,ve=((p=(g=(await this.fetchAPI(ne))[1])==null?void 0:g.data)==null?void 0:p.children)||[];for(const be of ve){const E=be.data;if(!E.body||E.body==="[deleted]")continue;const re={subreddit:w.subreddit,upvotes:E.ups,url:`${O}${E.id}`},Se=this.analyzePsychologicalTriggers(E.body,re);c.push(...Se);const se=this.extractCustomerInsights(E.body,re);se&&a.push(se)}}catch{console.warn("[RedditAPI] Failed to fetch comments for post:",w.id)}}return c.sort((S,w)=>w.upvotes-S.upvotes),a.sort((S,w)=>w.upvotes-S.upvotes),console.log("[RedditAPI] âœ… Extracted",c.length,"triggers and",a.length,"insights"),{triggers:c.slice(0,50),insights:a.slice(0,30),trendingTopics:Array.from(d.values()),metadata:{searchQuery:e,subreddits:o.length>0?o:["all"],totalComments:c.length+a.length,totalPosts:A.length,timestamp:new Date().toISOString()}}}catch(h){throw console.error("[RedditAPI] Mining failed:",h),h}}async findRelevantSubreddits(e){const t={fitness:["fitness","bodybuilding","xxfitness","running","yoga"],restaurant:["FoodPorn","recipes","Cooking","AskCulinary","KitchenConfidential"],dental:["Dentistry","DentalHygiene","askdentists"],realtor:["RealEstate","FirstTimeHomeBuyer","realtors"],cpa:["Accounting","tax","smallbusiness"],insurance:["Insurance","personalfinance"],consultant:["consulting","Entrepreneur","smallbusiness"]},o=e.toLowerCase();for(const[n,r]of Object.entries(t))if(o.includes(n))return r;return[e.replace(/\s+/g,"")]}}const ce=new Be,je={apiKey:"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",model:"sonar-pro",temperature:.7,maxTokens:2e3};class ze{constructor(e){y(this,"config");y(this,"endpoint","https://openrouter.ai/api/v1/chat/completions");this.config={...je,...e},this.config.apiKey||console.warn("[PerplexityAPI] No API key provided. Set VITE_OPENROUTER_API_KEY.")}async isAvailable(){return!!this.config.apiKey}async getIndustryInsights(e){console.log("[PerplexityAPI] Fetching industry insights:",e);try{const t=this.buildPrompt(e),o=await this.makeRequest(t);return this.parseResponse(o)}catch(t){throw console.error("[PerplexityAPI] Failed to get industry insights:",t),t}}async generateCustomerProblems(e,t){const o={query:`What are the top 5 most pressing problems and pain points that ${t} face in the ${e} industry right now?`,context:{industry:e},max_results:5},n=await this.getIndustryInsights(o);return n.insights.map((r,s)=>({id:`problem-${Date.now()}-${s}`,content:r,type:"problem",source:"ai-generated",confidence:n.confidence,is_selected:!1,is_customizable:!0}))}async generateSolutions(e,t){const o={query:`What are the most effective solutions currently being used to solve this problem in the ${e} industry: "${t}"? Provide 5 specific solution approaches.`,context:{industry:e},max_results:5},n=await this.getIndustryInsights(o);return n.insights.map((r,s)=>({id:`solution-${Date.now()}-${s}`,content:r,type:"solution",source:"ai-generated",confidence:n.confidence,is_selected:!1,is_customizable:!0}))}async generateKeyBenefits(e,t){const o={query:`What are the top 5 measurable benefits that customers experience from this type of solution in the ${e} industry: "${t}"? Focus on tangible outcomes.`,context:{industry:e},max_results:5},n=await this.getIndustryInsights(o);return n.insights.map((r,s)=>({id:`benefit-${Date.now()}-${s}`,content:r,type:"benefit",source:"ai-generated",confidence:n.confidence,is_selected:!1,is_customizable:!0}))}async generateDifferentiators(e,t){const o=t.length>0?`Key competitors include: ${t.join(", ")}.`:"",n={query:`In the ${e} industry, what are 5 unique ways a company can differentiate itself from competitors? ${o} Focus on sustainable competitive advantages.`,context:{industry:e,competitors:t},max_results:5},r=await this.getIndustryInsights(n);return r.insights.map((s,i)=>({id:`differentiator-${Date.now()}-${i}`,content:s,type:"differentiator",source:"ai-generated",confidence:r.confidence,is_selected:!1,is_customizable:!0}))}async generateCustomerSegments(e,t){const o=t?`for a company like ${t}`:"",n={query:`What are the 5 most valuable customer segments in the ${e} industry ${o}? Describe each segment with demographics and psychographics.`,context:{industry:e,brand_name:t},max_results:5},r=await this.getIndustryInsights(n);return r.insights.map((s,i)=>({id:`customer-${Date.now()}-${i}`,content:s,type:"customer-segment",source:"ai-generated",confidence:r.confidence,is_selected:!1,is_customizable:!0}))}async researchCompetitors(e,t){const o={query:`Who are the top 10 competitors in the ${e} industry for ${t}? List just the company names.`,context:{industry:e,brand_name:t},max_results:10};return(await this.getIndustryInsights(o)).insights}buildPrompt(e){let t=e.query;if(e.context){const o=[];e.context.industry&&o.push(`Industry: ${e.context.industry}`),e.context.brand_name&&o.push(`Brand: ${e.context.brand_name}`),e.context.competitors&&e.context.competitors.length>0&&o.push(`Competitors: ${e.context.competitors.join(", ")}`),o.length>0&&(t+=`

Context:
${o.join(`
`)}`)}return t+=`

Provide ${e.max_results||5} specific, actionable insights. Format your response as a JSON array of strings.`,t}async makeRequest(e){const t=this.mapModelName(this.config.model),o=await fetch(this.endpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.config.apiKey}`,"HTTP-Referer":window.location.origin,"X-Title":"MARBA UVP Wizard"},body:JSON.stringify({model:t,messages:[{role:"system",content:"You are a marketing intelligence AI with real-time web access. Provide current, accurate insights about industries, markets, and customer needs. Always respond with valid JSON arrays."},{role:"user",content:e}],temperature:this.config.temperature,max_tokens:this.config.maxTokens})});if(!o.ok){const n=await o.text();throw new Error(`Perplexity API error: ${o.status} ${n}`)}return o.json()}parseResponse(e){const t=e.choices[0].message.content;let o=[];try{const r=JSON.parse(t);o=Array.isArray(r)?r:[t]}catch{o=t.split(`
`).filter(r=>r.trim().length>0).map(r=>r.replace(/^[\d.-]+\s*/,"").trim()).filter(r=>r.length>10)}const n=this.calculateConfidence(e);return{insights:o,sources:this.extractSources(e),confidence:n}}calculateConfidence(e){return e.choices[0].finish_reason==="stop"?.9:e.choices[0].finish_reason==="length"?.7:.5}extractSources(e){return[]}mapModelName(e){return{"sonar-pro":"perplexity/sonar-pro",sonar:"perplexity/sonar","sonar-medium":"perplexity/sonar-medium-online","sonar-small":"perplexity/sonar-small-online"}[e]||e}}const le=new ze,de={competitor_profile:7*24*60,website_analysis:7*24*60,industry_profile:7*24*60,company_info:7*24*60,news:24*60,youtube_videos:24*60,local_reviews:24*60,search_results:2*60,autocomplete:2*60,trend_data:60,trending_searches:60,weather:30,local_events:30,default:2*60};class He{generateCacheKey(e){return e.map(t=>String(t).toLowerCase().trim()).filter(Boolean).join(":")}getTTL(e,t){return t||de[e]||de.default}getExpiresAt(e){const t=new Date;return t.setMinutes(t.getMinutes()+e),t.toISOString()}async get(e){try{console.log("[IntelligenceCache] Getting:",e);const{data:t,error:o}=await C.from("intelligence_cache").select("*").eq("cache_key",e).single();return o||!t?(console.log("[IntelligenceCache] Cache miss:",e),null):new Date(t.expires_at)<new Date?(console.log("[IntelligenceCache] Cache expired:",e),await this.invalidate(e),null):(console.log("[IntelligenceCache] Cache hit:",e),t.data)}catch(t){return console.error("[IntelligenceCache] Get error:",t),null}}async set(e,t,o){try{const n=this.getTTL(o.dataType,o.ttlMinutes),r=this.getExpiresAt(n);console.log(`[IntelligenceCache] Setting: ${e} (TTL: ${n}m)`);const s=o.brandId&&/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(o.brandId),{error:i}=await C.from("intelligence_cache").upsert({cache_key:e,data:t,data_type:o.dataType,source_api:o.sourceApi,brand_id:s?o.brandId:null,expires_at:r,updated_at:new Date().toISOString()},{onConflict:"cache_key"});i&&console.error("[IntelligenceCache] Set error:",i)}catch(n){console.error("[IntelligenceCache] Set error:",n)}}async invalidate(e){try{console.log("[IntelligenceCache] Invalidating:",e);const{error:t}=await C.from("intelligence_cache").delete().eq("cache_key",e);t&&console.error("[IntelligenceCache] Invalidate error:",t)}catch(t){console.error("[IntelligenceCache] Invalidate error:",t)}}async invalidateByBrand(e){try{console.log("[IntelligenceCache] Invalidating brand:",e);const{error:t}=await C.from("intelligence_cache").delete().eq("brand_id",e);t&&console.error("[IntelligenceCache] Invalidate by brand error:",t)}catch(t){console.error("[IntelligenceCache] Invalidate by brand error:",t)}}async invalidateByType(e){try{console.log("[IntelligenceCache] Invalidating type:",e);const{error:t}=await C.from("intelligence_cache").delete().eq("data_type",e);t&&console.error("[IntelligenceCache] Invalidate by type error:",t)}catch(t){console.error("[IntelligenceCache] Invalidate by type error:",t)}}async invalidateBySource(e){try{console.log("[IntelligenceCache] Invalidating source:",e);const{error:t}=await C.from("intelligence_cache").delete().eq("source_api",e);t&&console.error("[IntelligenceCache] Invalidate by source error:",t)}catch(t){console.error("[IntelligenceCache] Invalidate by source error:",t)}}async cleanupExpired(){try{console.log("[IntelligenceCache] Cleaning up expired entries...");const{data:e,error:t}=await C.from("intelligence_cache").delete().lt("expires_at",new Date().toISOString()).select("id");if(t)return console.error("[IntelligenceCache] Cleanup error:",t),0;const o=(e==null?void 0:e.length)||0;return console.log(`[IntelligenceCache] Cleaned up ${o} expired entries`),o}catch(e){return console.error("[IntelligenceCache] Cleanup error:",e),0}}async getStats(){try{const{data:e,error:t}=await C.from("intelligence_cache").select("data_type, source_api, expires_at");if(t||!e)return{total:0,byType:{},bySource:{},expired:0};const o=new Date,n={total:e.length,byType:{},bySource:{},expired:0};return e.forEach(r=>{n.byType[r.data_type]=(n.byType[r.data_type]||0)+1,r.source_api&&(n.bySource[r.source_api]=(n.bySource[r.source_api]||0)+1),new Date(r.expires_at)<o&&n.expired++}),n}catch(e){return console.error("[IntelligenceCache] Stats error:",e),{total:0,byType:{},bySource:{},expired:0}}}cacheKeyNews(e,t){return this.generateCacheKey(["serper","news",e,t||"global"])}cacheKeyTrends(e,t){return this.generateCacheKey(["serper","trends",e,t||"30d"])}cacheKeyPlaces(e,t){return this.generateCacheKey(["serper","places",e,t])}cacheKeyVideos(e){return this.generateCacheKey(["serper","videos",e])}cacheKeyImages(e){return this.generateCacheKey(["serper","images",e])}cacheKeyShopping(e){return this.generateCacheKey(["serper","shopping",e])}cacheKeyWebsiteAnalysis(e){return this.generateCacheKey(["website_analysis",e])}cacheKeyCompetitorProfile(e){return this.generateCacheKey(["competitor_profile",e])}cacheKeyReviews(e){return this.generateCacheKey(["outscraper","reviews",e])}cacheKeyWeather(e){return this.generateCacheKey(["weather",e])}cacheKeyYouTube(e){return this.generateCacheKey(["youtube",e])}}const b=new He;class qe{async buildDeepContext(e){const t=Date.now(),o=[],n=[];if(console.log("[DeepContext] Building context for brand:",e.brandId),e.cacheResults!==!1&&!e.forceFresh){const r=`deepcontext:${e.brandId}`,s=await b.get(r);if(s)return console.log("[DeepContext] âœ… Returning cached context"),{context:s,metadata:{buildTimeMs:Date.now()-t,dataSourcesUsed:["cache"],dataPointsCollected:0,errors:[]}}}try{console.log("[DeepContext] Step 1/6: Loading brand data...");const r=e.brandData||await this.loadBrandData(e.brandId);if(!r)throw new Error(`Brand not found: ${e.brandId}`);console.log("[DeepContext] Brand data loaded:",{name:r.name,industry:r.industry,location:r.location}),console.log("[DeepContext] Step 2/10: Gathering intelligence from APIs...");const[s,i,c,a,d,u,g,p,h,f]=await Promise.allSettled([e.includeYouTube!==!1?this.fetchYouTubeIntelligence(r,o,n):Promise.resolve(null),e.includeOutScraper!==!1?this.fetchOutScraperIntelligence(r,o,n):Promise.resolve(null),e.includeNews!==!1?this.fetchNewsIntelligence(r,o,n):Promise.resolve(null),e.includeWeather!==!1?this.fetchWeatherIntelligence(r,o,n):Promise.resolve(null),e.includeSerper!==!1?this.fetchSerperIntelligence(r,o,n):Promise.resolve(null),e.includeSemrush!==!1?this.fetchSemrushIntelligence(r,o,n):Promise.resolve(null),e.includeWebsiteAnalysis!==!1&&r.website?this.fetchWebsiteIntelligence(r,o,n):Promise.resolve(null),e.includeReddit!==!1?this.fetchRedditIntelligence(r,o,n):Promise.resolve(null),e.includePerplexity!==!1?this.fetchPerplexityIntelligence(r,o,n):Promise.resolve(null),e.includeLinkedIn!==!1?this.fetchLinkedInIntelligence(r,o,n):Promise.resolve(null)]);console.log("[DeepContext] Step 3/7: Extracting data points...");const m=[];s.status==="fulfilled"&&s.value&&m.push(...s.value),i.status==="fulfilled"&&i.value&&m.push(...i.value),c.status==="fulfilled"&&c.value&&m.push(...c.value),a.status==="fulfilled"&&a.value&&m.push(...a.value),d.status==="fulfilled"&&d.value&&m.push(...d.value),u.status==="fulfilled"&&u.value&&m.push(...u.value),g.status==="fulfilled"&&g.value&&m.push(...g.value),p.status==="fulfilled"&&p.value&&m.push(...p.value),h.status==="fulfilled"&&h.value&&m.push(...h.value),f.status==="fulfilled"&&f.value&&m.push(...f.value),console.log(`[DeepContext] Collected ${m.length} data points from ${n.length} sources`),console.log("[DeepContext] Step 4/7: Building context structure...");const v=await this.buildContextStructure(r,m);if(console.log("[DeepContext] Step 5/7: Synthesizing insights..."),m.length>0&&await this.synthesizeInsights(v,m),console.log("[DeepContext] Step 6/7: Caching result..."),e.cacheResults!==!1){const S=`deepcontext:${e.brandId}`;await b.set(S,v,{dataType:"deepcontext",sourceApi:"aggregated",brandId:e.brandId,ttlMinutes:60})}const A=Date.now()-t;return console.log(`[DeepContext] âœ… Context built successfully in ${A}ms`),{context:v,metadata:{buildTimeMs:A,dataSourcesUsed:n,dataPointsCollected:m.length,errors:o,detailedDataPoints:m}}}catch(r){throw console.error("[DeepContext] Fatal error building context:",r),r}}async loadBrandData(e){const{data:t,error:o}=await C.from("brands").select("*").eq("id",e).single();if(o)throw new Error(`Failed to load brand: ${o.message}`);return t}async fetchYouTubeIntelligence(e,t,o){try{console.log("[DeepContext/YouTube] Fetching trending videos and insights...");const n=e.keywords||[e.industry],r=await xe.analyzeVideoTrends(e.industry,n);o.push("youtube");const s=[];return r.trending_topics.forEach((i,c)=>{s.push({source:"youtube",type:"trending_topic",content:i,metadata:{platform:"youtube",rank:c+1,relevance:.8},timestamp:new Date().toISOString(),confidence:.8})}),r.content_angles.forEach(i=>{s.push({source:"youtube",type:"customer_trigger",content:i,metadata:{platform:"youtube",type:"content_angle"},timestamp:new Date().toISOString(),confidence:.7})}),console.log(`[DeepContext/YouTube] âœ… Extracted ${s.length} data points`),s}catch(n){return console.error("[DeepContext/YouTube] Error:",n),t.push({source:"youtube",error:n instanceof Error?n.message:String(n),severity:"warning"}),[]}}async fetchOutScraperIntelligence(e,t,o){try{console.log("[DeepContext/OutScraper] Fetching competitor reviews...");const n=e.location?typeof e.location=="string"?e.location:`${e.location.city}, ${e.location.state}`:e.city||"United States",r=await _.discoverCompetitors({businessName:e.name,location:n,industry:e.industry,radius:10});o.push("outscraper");const s=[];for(let i=0;i<Math.min(3,r.length);i++){const c=r[i];try{(await _.scrapeGoogleReviews({place_id:c.place_id,business_name:c.name,location:n,industry:e.industry,limit:20,sort:"newest"})).forEach(d=>{d.text&&d.text.length>20&&s.push({source:"outscraper",type:"customer_trigger",content:d.text,metadata:{competitor:c.name,rating:d.rating,sentiment:d.rating>=4?"positive":d.rating<=2?"negative":"neutral"},timestamp:d.time,confidence:.85})})}catch{console.warn(`[DeepContext/OutScraper] Could not fetch reviews for ${c.name}`)}}return console.log(`[DeepContext/OutScraper] âœ… Extracted ${s.length} data points`),s}catch(n){return console.error("[DeepContext/OutScraper] Error:",n),t.push({source:"outscraper",error:n instanceof Error?n.message:String(n),severity:"warning"}),[]}}async fetchNewsIntelligence(e,t,o){try{console.log("[DeepContext/News] Fetching industry news...");const n=e.keywords||[e.industry],r=await Ne.getIndustryNews(e.industry,n);o.push("news");const s=r.slice(0,10).map(i=>({source:"news",type:"trending_topic",content:`${i.title}: ${i.description}`,metadata:{url:i.url,source:i.source,publishedAt:i.publishedAt,relevanceScore:i.relevanceScore},timestamp:i.publishedAt,confidence:i.relevanceScore/100}));return console.log(`[DeepContext/News] âœ… Extracted ${s.length} data points`),s}catch(n){return console.error("[DeepContext/News] Error:",n),t.push({source:"news",error:n instanceof Error?n.message:String(n),severity:"warning"}),[]}}async fetchWeatherIntelligence(e,t,o){try{console.log("[DeepContext/Weather] Fetching weather opportunities...");const n=e.location?typeof e.location=="string"?e.location.split(",")[0].trim():e.location.city:e.city||"New York",r=await Fe.detectWeatherOpportunities(n,e.industry);o.push("weather");const s=r.map(i=>({source:"weather",type:"timing",content:`${i.title}: ${i.description}`,metadata:{urgency:i.urgency,impactScore:i.impact_score,suggestedActions:i.suggested_actions,type:i.type},timestamp:new Date().toISOString(),confidence:i.impact_score/100}));return console.log(`[DeepContext/Weather] âœ… Extracted ${s.length} data points`),s}catch(n){return console.error("[DeepContext/Weather] Error:",n),t.push({source:"weather",error:n instanceof Error?n.message:String(n),severity:"warning"}),[]}}async fetchSerperIntelligence(e,t,o){try{console.log("[DeepContext/Serper] âš¡ Fetching from 8 Serper endpoints in parallel...");const n=[],r=e.keywords||[e.industry],s=e.location?typeof e.location=="string"?e.location:`${e.location.city}, ${e.location.state}`:"",[i,c,a,d,u,g]=await Promise.allSettled([(async()=>{const p=`${e.industry} trends`,h=b.cacheKeyNews(p,s);let f=await b.get(h);return f||(f=await k.getNews(p,s||void 0),await b.set(h,f,{dataType:"news",sourceApi:"serper",brandId:e.id})),f.slice(0,5).map(m=>({source:"serper",type:"trending_topic",content:`${m.title}: ${m.snippet}`,metadata:{url:m.link,source:m.source,publishedAt:m.date},timestamp:m.date,confidence:.85}))})(),(async()=>{const p=r[0],h=b.cacheKeyTrends(p);let f=await b.get(h);return f||(f=await k.getTrends(p),await b.set(h,f,{dataType:"trend_data",sourceApi:"serper",brandId:e.id})),f?[{source:"serper",type:"trending_topic",content:`Trend: "${p}" is ${f.trend} (${f.growthPercentage}% growth)`,metadata:{keyword:p,trend:f.trend,growth:f.growthPercentage,relatedQueries:f.relatedQueries},timestamp:new Date().toISOString(),confidence:.8}]:[]})(),(async()=>{const p=`${e.industry} how to`,h=`serper:autocomplete:${p}`;let f=await b.get(h);return f||(f=await k.getAutocomplete(p),await b.set(h,f,{dataType:"autocomplete",sourceApi:"serper",brandId:e.id})),f.slice(0,3).map(m=>({source:"serper",type:"customer_trigger",content:m,metadata:{type:"search_intent",query:p},timestamp:new Date().toISOString(),confidence:.75}))})(),s?(async()=>{const p=b.cacheKeyPlaces(e.industry,s);let h=await b.get(p);return h||(h=await k.getPlaces(e.industry,s),await b.set(p,h,{dataType:"local_reviews",sourceApi:"serper",brandId:e.id})),h.slice(0,3).map(f=>({source:"serper",type:"competitive_gap",content:`Local competitor: ${f.name} (${f.rating}â˜…, ${f.reviewCount} reviews)`,metadata:{competitor:f.name,rating:f.rating,reviewCount:f.reviewCount,category:f.category},timestamp:new Date().toISOString(),confidence:.8}))})():Promise.resolve([]),(async()=>{const p=`${e.industry} tips`,h=b.cacheKeyVideos(p);let f=await b.get(h);return f||(f=await k.getVideos(p),await b.set(h,f,{dataType:"youtube_videos",sourceApi:"serper",brandId:e.id})),f.slice(0,3).map(m=>({source:"serper",type:"trending_topic",content:m.title,metadata:{url:m.link,channel:m.channel,duration:m.duration},timestamp:m.date,confidence:.7}))})(),(async()=>{const p=`${e.industry} inspiration`,h=`serper:images:${p}`;let f=await b.get(h);return f||(f=await k.getImages(p),await b.set(h,f,{dataType:"images",sourceApi:"serper",brandId:e.id})),f.slice(0,3).map(m=>({source:"serper",type:"trending_topic",content:`Visual trend: ${m.title}`,metadata:{url:m.url,imageUrl:m.imageUrl,source:m.source},timestamp:new Date().toISOString(),confidence:.7}))})()]);return i.status==="fulfilled"&&i.value&&n.push(...i.value),c.status==="fulfilled"&&c.value&&n.push(...c.value),a.status==="fulfilled"&&a.value&&n.push(...a.value),d.status==="fulfilled"&&d.value&&n.push(...d.value),u.status==="fulfilled"&&u.value&&n.push(...u.value),g.status==="fulfilled"&&g.value&&n.push(...g.value),o.push("serper"),console.log(`[DeepContext/Serper] âœ… Extracted ${n.length} data points from 6 parallel endpoints`),n}catch(n){return console.error("[DeepContext/Serper] Error:",n),t.push({source:"serper",error:n instanceof Error?n.message:String(n),severity:"warning"}),[]}}async fetchSemrushIntelligence(e,t,o){try{console.log("[DeepContext/SEMrush] Fetching SEO and keyword data...");const n=[],r=e.website||e.url;if(!r)return console.warn("[DeepContext/SEMrush] No domain provided, skipping"),[];try{(await N.getKeywordOpportunities(r,e.name)).slice(0,10).forEach(i=>{n.push({source:"serper",type:"competitive_gap",content:`Keyword opportunity: "${i.keyword}" (${i.searchVolume} searches/mo) - ${i.reasoning}`,metadata:{keyword:i.keyword,searchVolume:i.searchVolume,difficulty:i.difficulty,opportunityType:i.opportunity,estimatedTraffic:i.estimatedTraffic},timestamp:new Date().toISOString(),confidence:.8})})}catch{console.warn("[DeepContext/SEMrush] Keyword opportunities failed")}return o.push("semrush"),console.log(`[DeepContext/SEMrush] âœ… Extracted ${n.length} data points`),n}catch(n){return console.error("[DeepContext/SEMrush] Error:",n),t.push({source:"semrush",error:n instanceof Error?n.message:String(n),severity:"warning"}),[]}}async fetchWebsiteIntelligence(e,t,o){try{console.log("[DeepContext/Website] Analyzing website with Claude AI...");const n=e.website||e.url;if(!n)return console.warn("[DeepContext/Website] No website URL provided"),[];const r=[],s=b.cacheKeyWebsiteAnalysis(n);let i=await b.get(s);return i||(i=await we.analyzeWebsite(n),await b.set(s,i,{dataType:"website_analysis",sourceApi:"claude",brandId:e.id})),i.valuePropositions&&i.valuePropositions.length>0&&i.valuePropositions.forEach(c=>{r.push({source:"website",type:"value_proposition",content:c,metadata:{extracted_from:n,confidence:i.confidence},timestamp:new Date().toISOString(),confidence:i.confidence/100})}),i.targetAudience&&i.targetAudience.length>0&&i.targetAudience.forEach(c=>{r.push({source:"website",type:"customer_segment",content:c,metadata:{extracted_from:n,confidence:i.confidence},timestamp:new Date().toISOString(),confidence:i.confidence/100})}),i.customerProblems&&i.customerProblems.length>0&&i.customerProblems.forEach(c=>{r.push({source:"website",type:"customer_trigger",content:`Problem: ${c}`,metadata:{type:"pain_point",extracted_from:n},timestamp:new Date().toISOString(),confidence:i.confidence/100})}),i.differentiators&&i.differentiators.length>0&&i.differentiators.forEach(c=>{r.push({source:"website",type:"competitive_gap",content:`Differentiator: ${c}`,metadata:{type:"unique_advantage",extracted_from:n},timestamp:new Date().toISOString(),confidence:i.confidence/100})}),o.push("website"),console.log(`[DeepContext/Website] âœ… Extracted ${r.length} data points (confidence: ${i.confidence}%)`),r}catch(n){return console.error("[DeepContext/Website] Error:",n),t.push({source:"website",error:n instanceof Error?n.message:String(n),severity:"warning"}),[]}}async fetchRedditIntelligence(e,t,o){try{console.log("[DeepContext/Reddit] Mining Reddit for psychological triggers...");const n=[],r=await ce.findRelevantSubreddits(e.industry);console.log(`[DeepContext/Reddit] Targeting ${r.length} subreddits:`,r);const s=`${e.industry} problems`,i=await ce.mineIntelligence(s,{subreddits:r,limit:25,commentsPerPost:20,sortBy:"relevance",timeFilter:"month"});return o.push("reddit"),i.triggers.forEach(c=>{n.push({source:"reddit",type:"customer_trigger",content:c.text,metadata:{triggerType:c.type,intensity:c.intensity,subreddit:c.subreddit,upvotes:c.upvotes,url:c.url},timestamp:new Date().toISOString(),confidence:c.intensity/10})}),i.insights.forEach(c=>{c.painPoint&&n.push({source:"reddit",type:"customer_trigger",content:`Pain Point: ${c.painPoint}`,metadata:{insightType:"pain_point",subreddit:c.subreddit,upvotes:c.upvotes,url:c.url,context:c.context},timestamp:new Date().toISOString(),confidence:Math.min(.9,c.upvotes/100)}),c.desire&&n.push({source:"reddit",type:"customer_trigger",content:`Customer Desire: ${c.desire}`,metadata:{insightType:"desire",subreddit:c.subreddit,upvotes:c.upvotes,url:c.url,context:c.context},timestamp:new Date().toISOString(),confidence:Math.min(.9,c.upvotes/100)})}),console.log(`[DeepContext/Reddit] âœ… Extracted ${n.length} data points from ${i.metadata.totalPosts} posts`),n}catch(n){return console.error("[DeepContext/Reddit] Error:",n),t.push({source:"reddit",error:n instanceof Error?n.message:String(n),severity:"warning"}),[]}}async fetchPerplexityIntelligence(e,t,o){try{if(console.log("[DeepContext/Perplexity] Fetching local events and real-time insights..."),!await le.isAvailable())return console.warn("[DeepContext/Perplexity] Perplexity API not available (missing API key)"),[];const r=e.location?typeof e.location=="string"?e.location:`${e.location.city}, ${e.location.state}`:e.city||"United States",s=new Date,c=["January","February","March","April","May","June","July","August","September","October","November","December"][s.getMonth()],a=await le.getIndustryInsights({query:`What local events, festivals, holidays, and community gatherings are happening in ${r} in ${c} ${s.getFullYear()} that would be relevant marketing opportunities for ${e.industry} businesses? Include specific dates if available.`,context:{industry:e.industry,brand_name:e.name},max_results:5});o.push("perplexity");const d=[];return a.insights.forEach((u,g)=>{d.push({source:"perplexity",type:"local_event",content:u,metadata:{location:r,month:c,year:s.getFullYear(),confidence:a.confidence},timestamp:new Date().toISOString(),confidence:a.confidence})}),console.log(`[DeepContext/Perplexity] âœ… Extracted ${d.length} local event data points`),d}catch(n){return console.error("[DeepContext/Perplexity] Error:",n),t.push({source:"perplexity",error:n instanceof Error?n.message:String(n),severity:"warning"}),[]}}async fetchLinkedInIntelligence(e,t,o){try{console.log("[DeepContext/LinkedIn] Fetching B2B intelligence via OutScraper...");const n=[],r=e.industry,s=e.keywords||[r],[i,c]=await Promise.allSettled([(async()=>{try{const a=`linkedin:posts:${r}`;let d=await b.get(a);if(!d){const u=`${r} trends insights tips`;d=await _.getLinkedInPosts(u,10),await b.set(a,d,{dataType:"linkedin_posts",sourceApi:"outscraper",brandId:e.id,ttlMinutes:120})}return d.slice(0,5).map(u=>({source:"linkedin",type:"trending_topic",content:`LinkedIn post by ${u.author}: ${u.content}`,metadata:{author:u.author,authorProfile:u.authorProfile,link:u.postUrl,date:u.publishedAt,engagement:u.engagement},timestamp:u.publishedAt||new Date().toISOString(),confidence:.8}))}catch(a){return console.warn("[DeepContext/LinkedIn] Posts fetch failed:",a),[]}})(),(async()=>{try{const a=`linkedin:companies:${r}`;let d=await b.get(a);if(!d){const u=`${r} companies`;d=await _.getLinkedInCompanies(u,10),await b.set(a,d,{dataType:"linkedin_companies",sourceApi:"outscraper",brandId:e.id,ttlMinutes:240})}return d.slice(0,3).map(u=>({source:"linkedin",type:"competitive_gap",content:`Competitor: ${u.name} - ${u.description}`,metadata:{company:u.name,link:u.profileUrl,industry:u.industry,size:u.companySize,location:u.location,followers:u.followers},timestamp:new Date().toISOString(),confidence:.75}))}catch(a){return console.warn("[DeepContext/LinkedIn] Companies fetch failed:",a),[]}})()]);return i.status==="fulfilled"&&i.value&&n.push(...i.value),c.status==="fulfilled"&&c.value&&n.push(...c.value),o.push("linkedin"),console.log(`[DeepContext/LinkedIn] âœ… Extracted ${n.length} B2B intelligence data points`),n}catch(n){return console.error("[DeepContext/LinkedIn] Error:",n),t.push({source:"linkedin",error:n instanceof Error?n.message:String(n),severity:"warning"}),[]}}async buildContextStructure(e,t){const o=t.filter(c=>c.type==="value_proposition"),n=t.filter(c=>c.type==="customer_segment"),r=t.filter(c=>c.type==="customer_trigger"),s=t.filter(c=>c.type==="competitive_gap");return console.log("[DeepContext] Organizing data points:"),console.log("  - Value Propositions:",o.length),console.log("  - Customer Segments:",n.length),console.log("  - Customer Triggers:",r.length),console.log("  - Competitive Gaps:",s.length),{business:{profile:{id:e.id,name:e.name,industry:e.industry,naicsCode:e.naics_code,website:e.website||"",location:{city:e.city||"",state:e.state||"",country:e.country||"US"},keywords:e.keywords||[e.industry],competitors:[]},brandVoice:{tone:e.tone||["professional","friendly"],values:e.values||[],personality:e.personality||[],avoidWords:[],signaturePhrases:[]},uniqueAdvantages:[...e.unique_selling_points||[],...o.map(c=>c.content)],goals:[]},industry:{profile:null,trends:[],seasonality:[],competitiveLandscape:{topCompetitors:[],marketConcentration:"moderate",barrierToEntry:"medium"},economicFactors:[]},realTimeCultural:{trending:{topics:t.filter(c=>c.type==="trending_topic").slice(0,10).map(c=>c.content),hashtags:[],conversations:[]},sentiment:{overall:.7,byTopic:{},shifts:[]},events:t.filter(c=>c.type==="local_event").map(c=>c.content),viralContent:[]},competitiveIntel:{blindSpots:[],mistakes:[],opportunities:s.map(c=>c.content),contentGaps:[],positioningWeaknesses:[]},customerPsychology:{unarticulated:n.map(c=>c.content),emotional:[],behavioral:r.map(c=>c.content),identityDesires:[],purchaseMotivations:[],objections:[]},synthesis:{keyInsights:[],hiddenPatterns:[],opportunityScore:75,recommendedAngles:[],confidenceLevel:.7,generatedAt:new Date},metadata:{aggregatedAt:new Date,dataSourcesUsed:Array.from(new Set(t.map(c=>c.source))),processingTimeMs:0,version:"1.0.0"}}}async synthesizeInsights(e,t){const o=t.filter(s=>s.type==="customer_trigger"),n=t.filter(s=>s.type==="trending_topic"),r=t.filter(s=>s.type==="timing");e.synthesis.keyInsights=[`Found ${o.length} customer psychological triggers`,`Identified ${n.length} trending topics`,`Detected ${r.length} timing-based opportunities`,`Total data points: ${t.length} from ${e.metadata.dataSourcesUsed.length} sources`],e.synthesis.opportunityScore=Math.min(100,50+t.length*2),e.synthesis.confidenceLevel=Math.min(1,.5+t.length/100)}async clearCache(e){e?await b.invalidateByBrand(e):await b.invalidateByType("deepcontext")}async getCacheStats(){return await b.getStats()}}const Ht=new qe,Ve=[{name:"Premium Coffee (Starbucks)",category:"daily",costPer:6.5,frequency:"5x/week",annualCost:1690,demographics:["professionals","urban","millennials"],emotionalValue:"high"},{name:"Fast Food Lunch",category:"daily",costPer:12,frequency:"5x/week",annualCost:3120,demographics:["working professionals","busy parents"],emotionalValue:"low"},{name:"Restaurant Lunch",category:"daily",costPer:18,frequency:"3x/week",annualCost:2808,demographics:["professionals","urban","foodies"],emotionalValue:"medium"},{name:"Vending Machine Snacks",category:"daily",costPer:3,frequency:"5x/week",annualCost:780,demographics:["office workers","students"],emotionalValue:"low"},{name:"Energy Drinks",category:"daily",costPer:4,frequency:"5x/week",annualCost:1040,demographics:["young professionals","shift workers"],emotionalValue:"low"}],Ye=[{name:"Netflix + Streaming Services",category:"monthly",costPer:45,frequency:"monthly",annualCost:540,demographics:["all demographics"],emotionalValue:"medium"},{name:"Spotify Premium",category:"monthly",costPer:11,frequency:"monthly",annualCost:132,demographics:["millennials","gen-z"],emotionalValue:"high"},{name:"Gym Membership",category:"monthly",costPer:50,frequency:"monthly",annualCost:600,demographics:["health-conscious","professionals"],emotionalValue:"medium"},{name:"Meal Kit Subscription",category:"monthly",costPer:120,frequency:"monthly",annualCost:1440,demographics:["busy families","foodies"],emotionalValue:"medium"},{name:"Amazon Prime",category:"monthly",costPer:15,frequency:"monthly",annualCost:180,demographics:["all demographics"],emotionalValue:"medium"}],Ke=[{name:"Takeout/Delivery Dinner",category:"weekly",costPer:45,frequency:"2x/week",annualCost:4680,demographics:["busy families","professionals"],emotionalValue:"high"},{name:"Happy Hour Drinks",category:"weekly",costPer:30,frequency:"2x/week",annualCost:3120,demographics:["young professionals","social"],emotionalValue:"high"},{name:"Grocery Store Prepared Foods",category:"weekly",costPer:35,frequency:"2x/week",annualCost:3640,demographics:["busy professionals","families"],emotionalValue:"low"},{name:"Drive-Through Coffee",category:"weekly",costPer:25,frequency:"5x/week",annualCost:6500,demographics:["commuters","parents"],emotionalValue:"high"}],Je=[{name:"Concert/Event Tickets",category:"annual",costPer:200,frequency:"4x/year",annualCost:800,demographics:["millennials","entertainment seekers"],emotionalValue:"high"},{name:"Vacation Dining",category:"annual",costPer:500,frequency:"2x/year",annualCost:1e3,demographics:["travelers","foodies"],emotionalValue:"high"},{name:"Cell Phone Upgrade",category:"annual",costPer:1e3,frequency:"1x/year",annualCost:1e3,demographics:["tech-savvy","all demographics"],emotionalValue:"medium"}],ue=[...Ve,...Ke,...Ye,...Je];function Xe(l,e){const t=oe(l),o=e?ue.filter(i=>i.demographics.some(c=>c.toLowerCase().includes(e.toLowerCase()))):ue,n=[];for(const i of o){const c=Ze(l,t,i);n.push(...c)}n.sort((i,c)=>{const a=pe(i);return pe(c)-a});const r=n.slice(0,5),s=n.filter(i=>i.emotionalWeight==="high");return{bestMatches:r,allEquivalences:n,totalExpensesAnalyzed:o.length,highEmotionalMatches:s.slice(0,3)}}function oe(l){switch(l.unit){case"one-time":return l.price;case"monthly":return l.price*12;case"annual":return l.price;default:return l.price}}function Ze(l,e,t){const o=[],n=t.annualCost/365,r=t.annualCost/52,s=t.annualCost/12,i=Math.round(e/n);i>=1&&i<=365&&o.push(z(l,t,i,"days"));const c=Math.round(e/r);c>=1&&c<=104&&o.push(z(l,t,c,"weeks"));const a=Math.round(e/s);return a>=1&&a<=24&&o.push(z(l,t,a,"months")),Math.abs(e-t.annualCost)/e<=.1&&o.push(Qe(l,t)),o}function z(l,e,t,o){const n=`${t} ${o} of ${e.name}`;let r="";o==="months"&&t<=12?r=`Why your ${e.name.toLowerCase()} habit proves you can afford ${l.name.toLowerCase()}`:o==="weeks"&&t<=26?r=`${t} ${o} of ${e.name.toLowerCase()} = one ${l.name.toLowerCase()}`:r=`Skip ${e.name.toLowerCase()} for ${t} ${o} â†’ ${l.name.toLowerCase()}`;const s=et(l,e,t,o);return{service:l,expense:e,equivalenceType:o,timeframe:n,hook:r,calculation:s,emotionalWeight:e.emotionalValue}}function Qe(l,e){const t=`Your ${e.name.toLowerCase()} costs the same as ${l.name.toLowerCase()} - which creates lasting value?`,o=`${e.name}: $${e.annualCost}/year = ${l.name}: $${oe(l)}/year`;return{service:l,expense:e,equivalenceType:"exact",timeframe:"Annual equivalence",hook:t,calculation:o,emotionalWeight:e.emotionalValue}}function et(l,e,t,o){const n=oe(l),r=o==="days"?e.annualCost/365:o==="weeks"?e.annualCost/52:e.annualCost/12;return`${e.name}: $${r.toFixed(2)}/${o.slice(0,-1)} Ã— ${t} ${o} = $${(r*t).toFixed(2)} â‰ˆ ${l.name} ($${n})`}function pe(l){let e=0;if(l.emotionalWeight==="high"?e+=30:l.emotionalWeight==="medium"&&(e+=15),l.equivalenceType==="months"){const t=parseInt(l.timeframe);t>=3&&t<=12?e+=25:t>=1&&t<=3?e+=15:t>=13&&t<=18&&(e+=10)}else if(l.equivalenceType==="weeks"){const t=parseInt(l.timeframe);t>=4&&t<=26&&(e+=20)}else l.equivalenceType==="exact"&&(e+=35);if(l.equivalenceType==="days"){const t=parseInt(l.timeframe);t<=30?e+=15:t<=90&&(e+=10)}return e}function tt(l){let e=`### Cost Equivalences (Behavioral Economics Hooks)

`;e+=`**Best Matches** (ready-to-use in content):
`;for(const t of l.bestMatches)e+=`- ${t.hook}
`,e+=`  *Calculation*: ${t.calculation}

`;if(l.highEmotionalMatches.length>0){e+=`
**High Emotional Impact** (strongest psychological resonance):
`;for(const t of l.highEmotionalMatches.slice(0,3))e+=`- ${t.hook}
`}return e}function ot(l){return{restaurant:[{name:"Chef's Tasting Menu",price:150,unit:"one-time",category:"fine dining"},{name:"Monthly Date Night Package",price:200,unit:"monthly",category:"romantic"},{name:"Private Dining Experience",price:500,unit:"one-time",category:"special occasion"}],dental:[{name:"Teeth Whitening",price:400,unit:"one-time",category:"cosmetic"},{name:"Dental Veneers",price:4500,unit:"one-time",category:"cosmetic"},{name:"Invisalign Treatment",price:5e3,unit:"one-time",category:"orthodontic"}],roofing:[{name:"Roof Repair Section",price:2500,unit:"one-time",category:"maintenance"},{name:"Full Roof Replacement",price:15e3,unit:"one-time",category:"replacement"},{name:"Emergency Leak Repair",price:500,unit:"one-time",category:"emergency"}],salon:[{name:"Hair Color Treatment",price:180,unit:"one-time",category:"color"},{name:"Keratin Treatment",price:350,unit:"one-time",category:"treatment"},{name:"Monthly Maintenance Package",price:120,unit:"monthly",category:"subscription"}]}[l.toLowerCase()]||[]}const nt="text-embedding-3-small",he=.02;class rt{constructor(e){y(this,"cache",new Map);y(this,"apiKey");y(this,"totalTokensUsed",0);y(this,"totalCost",0);y(this,"cacheHits",0);y(this,"cacheMisses",0);this.apiKey=e||"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",this.apiKey||console.warn("[EmbeddingService] No OpenAI API key provided")}async createEmbeddings(e){console.log(`[EmbeddingService] Creating embeddings for ${e.texts.length} texts...`);const t=e.model||nt,o=[],n=[];if(e.texts.forEach((c,a)=>{const d=this.getFromCache(c,t);d?(o[a]=d.embedding,this.cacheHits++):(n.push({text:c,index:a}),this.cacheMisses++)}),console.log(`[EmbeddingService] Cache: ${this.cacheHits} hits, ${n.length} misses`),n.length===0)return{embeddings:o,tokensUsed:0,cost:0,cacheHits:this.cacheHits};const r=this.chunk(n,100);let s=0;for(const c of r)try{const a=await this.callOpenAI(c.map(d=>d.text),t);a.data.forEach((d,u)=>{const{text:g,index:p}=c[u],h=d.embedding;o[p]=h,this.addToCache(g,h,t)}),s+=a.usage.total_tokens}catch(a){console.error("[EmbeddingService] Batch failed:",a),c.forEach(({index:d})=>{o[d]=new Array(1536).fill(0)})}const i=s/1e6*he;return this.totalTokensUsed+=s,this.totalCost+=i,console.log(`[EmbeddingService] Generated ${n.length} embeddings. Tokens: ${s}, Cost: $${i.toFixed(4)}`),{embeddings:o,tokensUsed:s,cost:i,cacheHits:this.cacheHits}}async embedDataPoints(e){const t=e.map(n=>n.content),o=await this.createEmbeddings({texts:t});e.forEach((n,r)=>{n.embedding=o.embeddings[r]}),console.log(`[EmbeddingService] Embedded ${e.length} data points`)}getFromCache(e,t){const o=this.buildCacheKey(e,t),n=this.cache.get(o);if(!n)return null;const r=Date.now()-n.cachedAt.getTime(),s=7*24*60*60*1e3;return r>s?(this.cache.delete(o),null):n}addToCache(e,t,o){const n=this.buildCacheKey(e,o);this.cache.set(n,{text:e,embedding:t,cachedAt:new Date,model:o})}buildCacheKey(e,t){const o=e.substring(0,100);return`${t}:${o}:${e.length}`}async callOpenAI(e,t){const n=await fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({model:t,input:e})});if(!n.ok){const r=await n.text();throw new Error(`OpenAI API error: ${n.status} ${r}`)}return await n.json()}chunk(e,t){const o=[];for(let n=0;n<e.length;n+=t)o.push(e.slice(n,n+t));return o}getCacheStats(){const e=this.cacheHits+this.cacheMisses,t=e>0?this.cacheHits/e:0,r=this.cacheHits*100/1e6*he,s=this.cache.size*1536*4/(1024*1024);return{size:this.cache.size,hitRate:t,costSaved:r,memoryMB:s}}getTotalCost(){return this.totalCost}clearCache(){this.cache.clear(),console.log("[EmbeddingService] Cache cleared")}exportCache(){const e=Array.from(this.cache.entries()).map(([t,o])=>({key:t,...o,cachedAt:o.cachedAt.toISOString()}));return JSON.stringify(e)}importCache(e){try{const t=JSON.parse(e);this.cache.clear(),t.forEach(o=>{this.cache.set(o.key,{text:o.text,embedding:o.embedding,cachedAt:new Date(o.cachedAt),model:o.model})}),console.log(`[EmbeddingService] Imported ${t.length} cache entries`)}catch(t){console.error("[EmbeddingService] Failed to import cache:",t)}}}async function st(l,e={}){const t=Date.now(),{minSimilarity:o=.65,maxHints:n=5,prioritizeCrossDomain:r=!0}=e;console.log(`[ConnectionHints] Analyzing ${l.length} data sources...`);const s=new rt,i=l.map(m=>m.text),c=await s.createEmbeddings({texts:i}),a=c.embeddings;console.log(`[ConnectionHints] Generated ${a.length} embeddings, cost: $${c.cost.toFixed(4)}`);const d=[];let u=0,g=0;for(let m=0;m<l.length;m++)for(let v=m+1;v<l.length;v++){const A=it(a[m],a[v]);if(g++,u+=A,A>=o){const S=l[m],w=l[v],O=S.type!==w.type?.8+(A-o)*.2:.3+(A-o)*.2,T=at(S,w,A),P=ct(S,w);d.push({similarity:A,sourceA:S,sourceB:w,hint:T,unexpectedness:O,actionable:P})}}d.sort((m,v)=>{if(r){const A=m.sourceA.type!==m.sourceB.type,S=v.sourceA.type!==v.sourceB.type;if(A!==S)return S?1:-1}return Math.abs(m.unexpectedness-v.unexpectedness)>.1?v.unexpectedness-m.unexpectedness:v.similarity-m.similarity});const p=d.slice(0,n),h=Date.now()-t,f=g>0?u/g:0;return console.log(`[ConnectionHints] Found ${p.length} hints in ${h}ms`),console.log(`[ConnectionHints] Average similarity: ${f.toFixed(3)}`),{hints:p,totalComparisons:g,averageSimilarity:f,processingTimeMs:h,cost:c.cost}}function it(l,e){if(l.length!==e.length)throw new Error("Embeddings must have same length");let t=0,o=0,n=0;for(let r=0;r<l.length;r++)t+=l[r]*e[r],o+=l[r]*l[r],n+=e[r]*e[r];return o=Math.sqrt(o),n=Math.sqrt(n),o===0||n===0?0:t/(o*n)}function at(l,e,t){const o=ge(l.text),n=ge(e.text),r=me(l.type),s=me(e.type);return l.type===e.type?`${r}: "${o}" + "${n}" (${Math.round(t*100)}% similar)`:`${r}: "${o}" â†” ${s}: "${n}"`}function ge(l){return l.length>80?l.substring(0,77)+"...":l}function me(l){return{weather:"Weather",event:"Local Event",review:"Customer Review",trend:"Trend",keyword:"Search Keyword",social:"Social Media",news:"Industry News"}[l]||l}function ct(l,e){return l.type==="weather"||e.type==="weather"||l.type==="event"||e.type==="event"||l.type==="trend"&&e.type==="review"||l.type==="review"&&e.type==="trend"}function lt(l){if(l.hints.length===0)return`### Connection Hints

No strong semantic connections detected.
`;let e=`### Connection Hints (Semantic Similarities)

`;e+=`Found ${l.hints.length} unexpected connections across data sources:

`;for(let t=0;t<l.hints.length;t++){const o=l.hints[t],n=o.actionable?"âš¡":"ðŸ’¡";e+=`${t+1}. ${n} ${o.hint}
`,e+=`   *Unexpectedness*: ${Math.round(o.unexpectedness*100)}% | *Similarity*: ${Math.round(o.similarity*100)}%
`,t<l.hints.length-1&&(e+=`
`)}return e+=`
**Use these hints to create synapse content that competitors would never think of.**
`,e}function dt(l){var t,o,n,r,s,i,c;const e=[];if((o=(t=l.realTimeCultural)==null?void 0:t.trending)!=null&&o.topics)for(const a of l.realTimeCultural.trending.topics.slice(0,10))e.push({type:"trend",text:typeof a=="string"?a:a.term||a.topic,metadata:a});if((n=l.competitiveIntel)!=null&&n.opportunities)for(const a of l.competitiveIntel.opportunities.slice(0,10))e.push({type:"competitive",text:typeof a=="string"?a:a.description||a,metadata:a});if((r=l.customerPsychology)!=null&&r.behavioral)for(const a of l.customerPsychology.behavioral.slice(0,8))e.push({type:"customer",text:typeof a=="string"?a:a.trigger||a.description||a,metadata:a});if((s=l.customerPsychology)!=null&&s.unarticulated)for(const a of l.customerPsychology.unarticulated.slice(0,5))e.push({type:"customer_need",text:typeof a=="string"?a:a.need||a.description||a,metadata:a});if((i=l.business)!=null&&i.uniqueAdvantages)for(const a of l.business.uniqueAdvantages.slice(0,5))e.push({type:"advantage",text:typeof a=="string"?a:a.advantage||a.description||a,metadata:a});if((c=l.synthesis)!=null&&c.keyInsights)for(const a of l.synthesis.keyInsights.slice(0,5))e.push({type:"insight",text:typeof a=="string"?a:a.insight||a.description||a,metadata:a});return console.log(`[ConnectionHints] Created ${e.length} data sources from intelligence`),e}function fe(l){if(!l)return l;(l.toLowerCase().includes("start with")||l.toLowerCase().includes("secret"))&&console.warn("[SynapseGenerator] Found meta-instruction in text:",l.substring(0,100));const e=[/^Start with ["']?secret["']?\s*/i,/^Start with ["'][^"']*["']\s*/i,/^Start with\s+/i,/^Begin with\s+/i,/^Open with\s+/i,/^Create (a|an)\s+/i,/^Write (a|an)\s+/i,/^Make (a|an)\s+/i,/^Build (a|an)\s+/i,/^Use (a|an)\s+/i,/^Try (a|an)\s+/i,/^Consider (a|an)\s+/i,/^Post (a|an)\s+/i,/^Share (a|an)\s+/i,/^Show (a|an)\s+/i,/^POV:\s*/i,/^Video series:\s*/i,/^"?secret"?\s*/i];let t=l;for(const o of e){const n=t;t=t.replace(o,""),n!==t&&console.warn("[SynapseGenerator] Removed pattern:",o.toString().substring(0,50))}return t.toLowerCase().includes("secret")&&(console.warn('[SynapseGenerator] Removing "secret" from text'),t=t.replace(/\bsecret\b\s*/gi,"")),t!==l&&t.length>0&&(t=t.charAt(0).toUpperCase()+t.slice(1)),t=t.replace(/\s{2,}/g," ").trim(),t!==l&&console.log("[SynapseGenerator] Cleaned text:",l.substring(0,80),"â†’",t.substring(0,80)),t}function ut(l){if(!l||l.length===0)return[];const e=new Map;for(const t of l){const o=t.source||"unknown";e.has(o)||e.set(o,[]),e.get(o).push({type:t.type,content:t.content,metadata:t.metadata,confidence:t.confidence,timestamp:t.timestamp})}return Array.from(e.entries()).map(([t,o])=>({source:t,dataPoints:o}))}async function qt(l){var f,m;const e=Date.now();console.log(`[Synapse] Starting generation for ${l.business.name}...`);const t=l.detailedDataPoints?ut(l.detailedDataPoints):[];t.length>0&&console.log(`[Synapse] Transformed ${(f=l.detailedDataPoints)==null?void 0:f.length} data points into ${t.length} source groups for provenance`),console.log("[Synapse] Step 1: Calculating cost equivalences...");const o=l.business.services||ot(l.business.industry),n=o.length>0?o.map(v=>Xe(v)):[],r=n.length>0?n.map(v=>tt(v)).join(`

`):"No service costs provided for equivalence calculation.";console.log(`[Synapse] Found ${n.length} cost equivalence sets`),console.log("[Synapse] Step 2: Generating connection hints...");const s=dt(l.intelligence),i=await st(s,{minSimilarity:.65,maxHints:5,prioritizeCrossDomain:!0}),c=lt(i);console.log(`[Synapse] Found ${i.hints.length} connection hints`),console.log("[Synapse] Step 3: Building data context...");const a=ht(l.intelligence);console.log("[Synapse] Step 4: Building prompt...");const d=gt({business:l.business,dataContext:a,costEquivalenceText:r,connectionHintText:c});console.log("[Synapse] Step 5: Calling Claude 3.5 Sonnet...");const u=await mt(d);console.log("[Synapse] Step 6: Parsing response...");const g=ft(u,l.business,t),p=Date.now()-e,h=i.cost+(((m=u.usage)==null?void 0:m.total_tokens)||0)*15e-6;return console.log(`[Synapse] âœ“ Generated ${g.length} synapses in ${p}ms`),console.log(`[Synapse] Total cost: $${h.toFixed(4)}`),{synapses:g,metadata:{generationTimeMs:p,costEquivalencesUsed:n.length,connectionHintsUsed:i.hints.length,totalCost:h,model:"claude-3-5-sonnet-20241022"}}}function pt(l){var o,n,r,s,i,c,a;const e={specialization:"",targetAudience:[],valueProps:[],differentiators:[]};return console.log("[SynapseGenerator] Extracting specialization from DeepContext..."),console.log("[SynapseGenerator] Available sections:",Object.keys(l||{})),[((o=l==null?void 0:l.business)==null?void 0:o.uniqueAdvantages)||[],((n=l==null?void 0:l.competitiveIntel)==null?void 0:n.opportunities)||[],((r=l==null?void 0:l.competitiveIntel)==null?void 0:r.blindSpots)||[],((s=l==null?void 0:l.customerPsychology)==null?void 0:s.behavioral)||[],((i=l==null?void 0:l.customerPsychology)==null?void 0:i.unarticulated)||[],((c=l==null?void 0:l.customerPsychology)==null?void 0:c.emotional)||[],((a=l==null?void 0:l.synthesis)==null?void 0:a.keyInsights)||[]].forEach(d=>{Array.isArray(d)&&d.forEach(u=>{const g=typeof u=="string"?u:u.content||u;if(!g||typeof g!="string")return;const p=g.toLowerCase();p.match(/(owner|collector|enthusiast|client|customer|reader|book lover|community|local|neighborhood)/i)&&e.targetAudience.push(g),p.match(/(specialist|expert|premium|luxury|rare|classic|exotic|vintage|unique|specialized|exclusive|independent|locally[-\s]owned|curated|handpicked|personal|custom|boutique|artisan|family[-\s]owned|authentic|original|established|trusted|experienced|dedicated|passionate|community|local)/i)&&e.differentiators.push(g),p.match(/(coverage|protection|value|service|guarantee|ensure|support|help|provide|offer|deliver|create|experience|selection|quality|expertise|knowledge|advice|guidance)/i)&&e.valueProps.push(g),!p.match(/(owner|collector|enthusiast|client|customer|reader|book lover|community|local|neighborhood|specialist|expert|premium|luxury|rare|classic|exotic|vintage|unique|specialized|exclusive|independent|locally[-\s]owned|curated|handpicked|personal|custom|boutique|artisan|family[-\s]owned|authentic|original|established|trusted|experienced|dedicated|passionate|community|local|coverage|protection|value|service|guarantee|ensure|support|help|provide|offer|deliver|create|experience|selection|quality|expertise|knowledge|advice|guidance)/i)&&g.length>20&&g.length<200&&e.differentiators.push(g)})}),e.differentiators.length>0?(e.specialization=e.differentiators[0],console.log("[SynapseGenerator] Found specialization:",e.specialization)):console.warn("[SynapseGenerator] NO SPECIALIZATION FOUND - will use generic industry"),console.log("[SynapseGenerator] Extraction results:",{specialization:e.specialization,targetAudience:e.targetAudience.length,valueProps:e.valueProps.length,differentiators:e.differentiators.length}),e}function ht(l){var o,n,r,s,i,c;let e="";const t=pt(l);if((t.specialization||t.targetAudience.length>0||t.valueProps.length>0||t.differentiators.length>0)&&(e+=`### BUSINESS SPECIALIZATION (from website analysis)
`,t.specialization&&(e+=`**What They Actually Specialize In:** ${t.specialization}
`),t.targetAudience.length>0&&(e+=`**Their Actual Target Audience:** ${t.targetAudience.slice(0,3).join(", ")}
`),t.differentiators.length>0&&(e+=`**What Makes Them Unique:** ${t.differentiators.slice(0,3).join(", ")}
`),e+=`
**CRITICAL: Generate content about THEIR SPECIALIZATION, not generic industry content!**

`),(n=(o=l.realTimeCultural)==null?void 0:o.trending)!=null&&n.topics&&l.realTimeCultural.trending.topics.length>0){e+=`### Trending Topics
`;for(const a of l.realTimeCultural.trending.topics.slice(0,10)){const d=typeof a=="string"?a:a.term||a.topic||a;e+=`- ${d}
`}e+=`
`}if((r=l.competitiveIntel)!=null&&r.opportunities&&l.competitiveIntel.opportunities.length>0){e+=`### What Competitors Are Missing (Opportunities)
`;for(const a of l.competitiveIntel.opportunities.slice(0,10)){const d=typeof a=="string"?a:a.opportunity||a.description||a;e+=`- ${d}
`}e+=`
`}if((s=l.customerPsychology)!=null&&s.behavioral&&l.customerPsychology.behavioral.length>0){e+=`### Customer Behavioral Triggers
`;for(const a of l.customerPsychology.behavioral.slice(0,8)){const d=typeof a=="string"?a:a.trigger||a.description||a;e+=`- ${d}
`}e+=`
`}if((i=l.customerPsychology)!=null&&i.unarticulated&&l.customerPsychology.unarticulated.length>0){e+=`### Customer Unarticulated Needs
`;for(const a of l.customerPsychology.unarticulated.slice(0,5)){const d=typeof a=="string"?a:a.need||a.description||a;e+=`- ${d}
`}e+=`
`}if((c=l.synthesis)!=null&&c.keyInsights&&l.synthesis.keyInsights.length>0){e+=`### Key Insights
`;for(const a of l.synthesis.keyInsights.slice(0,5)){const d=typeof a=="string"?a:a.insight||a;e+=`- ${d}
`}e+=`
`}return e||"No real-time intelligence data available."}function gt(l){const e=new Date,o=`${["January","February","March","April","May","June","July","August","September","October","November","December"][e.getMonth()]} ${e.getDate()}, ${e.getFullYear()}`;return`You are a business marketing strategist who creates engaging content that DRIVES CUSTOMER ACTION.

Your job: Find insights that are BOTH engaging AND business-focused, with clear calls-to-action that drive visits, bookings, purchases, or inquiries.

BUSINESS: ${l.business.name} (${l.business.industry})
LOCATION: ${l.business.location.city}, ${l.business.location.state}
TODAY'S DATE: ${o}

${l.dataContext}

${l.costEquivalenceText}

${l.connectionHintText}

---

CRITICAL FACT-CHECKING RULES:

1. WEATHER & SEASONS: Use CURRENT weather and season data from the context above. It is ${o} - do NOT reference summer, heat waves, or hot weather unless the weather data specifically shows that. Use actual current conditions and upcoming seasonal transitions.

2. NO FALSE URGENCY: Do NOT create fake deadlines or urgency unless there's ACTUAL supporting data:
   âŒ "The next 72 hours are crucial" (unless there's actual weather/event data showing this)
   âŒ "You only have until Friday" (unless there's a real deadline)
   âŒ "Winter is coming" in November in Austin, TX (it doesn't freeze there until late December/January)
   âœ… "Holiday entertaining season is starting" (factually true in November)
   âœ… "Fall planting window is closing" (if weather data supports this)

3. VERIFY CLAIMS: Only make claims you can support with the data provided. If you don't have weather data showing freezing temps, don't claim urgency around freezing. If you don't have event data, don't invent events.

YOUR TASK: Generate 3 business-focused content ideas that connect behavioral insights to customer action.

WHAT MAKES GREAT BUSINESS CONTENT:

For a Bar/Pub:
âŒ "Getting drunk at our bar is your toxic trait" (irresponsible, legal liability)
âŒ "Taylor Swift Eras cocktails" (dated reference, no business purpose)
âœ… "Thursday nights in Uptown - when 'one drink' turns into reconnecting with your college friends. That's why we added the nostalgia playlist. Reserve your table." (relatable + clear CTA)

For a Coffee Cart:
âŒ "We're the wedding crashers but everyone loves us" (no clear value)
âŒ "Save $500 on coffee service vs venue pricing" (ROI/cost-saving angle)
âœ… "Wedding planners: Your 3pm ceremony energy slump? We handle it. Mobile espresso bar shows up at golden hour. Guests stay energized through speeches. DM to add us to your next event." (problem + solution + CTA)

For a Local Business:
âŒ "Mercury Retrograde vibes at the office" (random, no purpose)
âœ… "Dallas mornings hit different when your usual spot is packed. We're the quiet alternative with the strong cold brew locals know about. Find us on Oak Lawn." (relatable + clear direction)

RULES FOR BUSINESS CONTENT:
1. âœ… BUSINESS PURPOSE - Every insight must lead to a clear action (visit, book, try, join, inquire)
2. âœ… PROFESSIONAL TONE - Match small business owner voice, not Gen Z social media manager
3. âœ… LEGALLY SAFE - No irresponsible messaging (avoid "get drunk", liability issues)
4. âœ… BEHAVIORAL INSIGHTS - Focus on customer behavior patterns, timing, needs
5. âœ… CLEAR VALUE - What problem does this solve? What experience does it create?
6. âœ… ACTIONABLE CTA - Every insight needs a next step (visit, book, DM, try, find us)
7. âœ… RELEVANT HOOKS - Weather, local events, seasonal moments (but not memes)
8. âŒ NO VIRAL MEMES - No TikTok sounds, dated trends (Taylor Swift Eras), Gen Z slang
9. âŒ NO IRRESPONSIBLE CONTENT - No encouraging excessive drinking, risky behavior
10. âŒ NO ROI/COST-SAVING ANGLES - No "save money", "cut costs", "increase productivity", "improve ROI"
11. âœ… FRAMEWORK-READY - Insights should work with Hook-Story-Offer, AIDA, PAS structures

TONE GUIDELINES BY INDUSTRY:
- Bar/Pub: Welcoming, community-focused, responsible ("great night out" not "get drunk")
- Coffee/Food: Service-focused, problem-solving, professional
- Events: Value-demonstrating, reliability-focused
- Professional Services: Authority-building, trust-focused

CRITICAL RULES FOR contentAngle:
1. Write the ACTUAL CONTENT HOOK - exactly what the headline should say
2. NEVER include meta-instructions like "Start with", "Begin with", "Create a", etc.
3. NEVER use the word "secret" anywhere in your content (it's a meta-instruction artifact)
4. Write as if you're posting directly to social media

BAD contentAngle: "Start with 'secret' Video series showing..."
GOOD contentAngle: "The quiet coffee shop locals know about when the main street is packed"

BAD contentAngle: "Guest room isn't secret ready" (uses "secret" as a word)
GOOD contentAngle: "When your in-laws announce their visit and your guest room needs an upgrade"

BAD insight: "Taylor Swift fans love themed cocktails"
GOOD insight: "Thursday nights in Dallas - when coworkers become friends over drinks, not just small talk"

OUTPUT FORMAT (JSON):

{
  "synapses": [
    {
      "title": "Hook-style title that captures attention",
      "insight": "The behavioral insight (customer-focused, business-appropriate)",
      "whyProfound": "Why this matters to the customer and business",
      "whyNow": "2-3 sentences explaining why this timing/moment matters with specific details (seasonal, local, behavioral)",
      "evidencePoints": ["Specific example or proof point 1", "Specific example or proof point 2", "Specific example or proof point 3"],
      "psychologyPrinciple": "The psychological/behavioral principle at work",
      "contentAngle": "THE ACTUAL CONTENT HOOK - ready to use as headline",
      "expectedReaction": "What customer action or emotional response this drives",
      "callToAction": "Clear next step (visit, book, DM, try, find us, call)",
      "dataUsed": ["weather", "local event", "behavioral pattern", "seasonal timing"],
      "confidence": 0.85,

      "provenance": {
        "rawDataSources": [
          {
            "platform": "google-reviews",
            "content": "Actual quote from review that triggered this",
            "sentiment": "negative"
          }
        ],
        "reasoning": "1-2 sentence explanation of how the data led to this insight"
      }
    }
  ]
}

CRITICAL REQUIREMENTS:
1. Make whyNow 2-3 full sentences with specific details
2. Include evidencePoints with 2-3 concrete examples
3. Include provenance with 1-2 actual data quotes and brief reasoning
4. Each synapse should be complete but concise

Generate EXACTLY 3 business-focused insights that DRIVE CUSTOMER ACTION. Content must be engaging but professional, with clear CTAs that lead to visits, bookings, or inquiries.`}async function mt(l){const t=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:"Bearer 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","Content-Type":"application/json","HTTP-Referer":"https://marba-agent.app","X-Title":"MARBA.ai Synapse Generator"},body:JSON.stringify({model:"anthropic/claude-3.5-sonnet",max_tokens:16384,temperature:.8,messages:[{role:"user",content:l}]})});if(!t.ok){const r=await t.text();throw new Error(`OpenRouter API error: ${t.statusText} - ${r}`)}const o=await t.json();if(!o.choices||o.choices.length===0)throw new Error("No response from OpenRouter");const n=o.choices[0].finish_reason;return n==="length"&&(console.warn("[Synapse] âš ï¸ Response truncated due to max_tokens limit!"),console.warn("[Synapse] Consider increasing max_tokens or simplifying the prompt")),console.log("[Synapse] Response finish_reason:",n),console.log("[Synapse] Response length:",o.choices[0].message.content.length,"characters"),{content:[{text:o.choices[0].message.content}],usage:o.usage}}function ft(l,e,t){var o;try{const n=((o=l.content[0])==null?void 0:o.text)||"",r=n.match(/\{[\s\S]*"synapses"[\s\S]*\}/);if(!r)return console.error("[Synapse] No JSON found in response"),console.error("[Synapse] Response content:",n.substring(0,500)),[];let s;try{s=JSON.parse(r[0])}catch{console.error("[Synapse] Initial JSON parse failed, attempting recovery...");let a=r[0];a=a.replace(/\/\/.*$/gm,""),a=a.replace(/\/\*[\s\S]*?\*\//g,""),a=a.replace(/,(\s*[}\]])/g,"$1");const d=(a.match(/{/g)||[]).length,u=(a.match(/}/g)||[]).length,g=(a.match(/\[/g)||[]).length,p=(a.match(/\]/g)||[]).length;if(g>p)for(let h=0;h<g-p;h++)a+="]";if(d>u)for(let h=0;h<d-u;h++)a+="}";try{s=JSON.parse(a),console.log("[Synapse] âœ… JSON recovery successful!")}catch{return console.error("[Synapse] âŒ JSON recovery failed after fixes"),console.error("[Synapse] JSON length:",r[0].length,"characters"),console.error("[Synapse] First 1000 chars:",r[0].substring(0,1e3)),console.error("[Synapse] Last 500 chars:",r[0].substring(r[0].length-500)),[]}}return(s.synapses||[]).map((c,a)=>{var d;return{id:`simple-${Date.now()}-${a}`,type:"counter_intuitive",thinkingStyle:"analytical",insight:fe(c.insight||""),whyProfound:c.whyProfound||c.psychologyPrinciple||"",whyNow:c.whyNow||`Based on current ${(c.dataUsed||[]).join(", ")}`,contentAngle:fe(c.contentAngle||""),expectedReaction:c.expectedReaction,evidence:c.evidencePoints||[],confidence:c.confidence||.75,metadata:{generatedAt:new Date,model:"claude-3-5-sonnet-20241022",tokensUsed:(d=l.usage)==null?void 0:d.total_tokens,generationTimeMs:0},title:c.title,psychologyPrinciple:c.psychologyPrinciple,dataUsed:c.dataUsed,callToAction:c.callToAction,deepProvenance:{...c.provenance||{},detailedDataSources:t}}})}catch(n){return console.error("[Synapse] Error parsing response:",n),[]}}const yt={curiosity:{description:"Words that create information gaps and compel readers to continue",words:[{word:"secret",impact:.95,context:["hidden knowledge","insider information"],alternatives:["hidden","confidential","classified"]},{word:"revealed",impact:.9,context:["discovery","unveiling"],alternatives:["exposed","uncovered","disclosed"]},{word:"surprising",impact:.85,context:["unexpected results","shocking data"],alternatives:["shocking","astonishing","unexpected"]},{word:"hidden",impact:.88,context:["undiscovered","beneath surface"],alternatives:["concealed","buried","obscured"]},{word:"unknown",impact:.82,context:["mystery","undiscovered"],alternatives:["mysterious","enigmatic","undiscovered"]},{word:"confessed",impact:.87,context:["admission","reveal"],alternatives:["admitted","revealed","disclosed"]},{word:"behind-the-scenes",impact:.83,context:["insider view","exclusive"],alternatives:["insider","private","internal"]},{word:"little-known",impact:.79,context:["obscure fact","hidden truth"],alternatives:["obscure","overlooked","forgotten"]}]},urgency:{description:"Words that create time pressure and immediate action",words:[{word:"now",impact:.92,context:["immediate action","present moment"],alternatives:["immediately","today","right away"]},{word:"today",impact:.88,context:["current opportunity","present"],alternatives:["right now","immediately","this moment"]},{word:"immediately",impact:.9,context:["no delay","instant"],alternatives:["instantly","now","right away"]},{word:"limited",impact:.86,context:["scarcity","exclusive"],alternatives:["scarce","exclusive","restricted"]},{word:"deadline",impact:.84,context:["time constraint","expiration"],alternatives:["expiring","ending","closing"]},{word:"urgent",impact:.87,context:["critical","pressing"],alternatives:["critical","pressing","crucial"]},{word:"ending",impact:.81,context:["expiration","last chance"],alternatives:["expiring","finishing","closing"]},{word:"final",impact:.83,context:["last opportunity","ultimate"],alternatives:["last","ultimate","concluding"]}]},exclusivity:{description:"Words that create feelings of special access or membership",words:[{word:"exclusive",impact:.93,context:["limited access","special"],alternatives:["private","members-only","invitation-only"]},{word:"only",impact:.89,context:["unique","sole"],alternatives:["sole","singular","unique"]},{word:"insider",impact:.91,context:["privileged access","internal"],alternatives:["internal","confidential","private"]},{word:"private",impact:.87,context:["restricted","confidential"],alternatives:["confidential","restricted","exclusive"]},{word:"members-only",impact:.85,context:["club","exclusive group"],alternatives:["exclusive","private","restricted"]},{word:"invitation-only",impact:.86,context:["selective","elite"],alternatives:["exclusive","select","curated"]},{word:"VIP",impact:.82,context:["premium","elite"],alternatives:["premium","elite","exclusive"]},{word:"privileged",impact:.84,context:["special access","advantaged"],alternatives:["special","advantaged","favored"]}]},authority:{description:"Words that establish credibility and expertise",words:[{word:"proven",impact:.94,context:["validated","tested"],alternatives:["verified","validated","confirmed"]},{word:"research",impact:.91,context:["scientific","study"],alternatives:["study","analysis","investigation"]},{word:"data",impact:.89,context:["statistics","numbers"],alternatives:["statistics","numbers","metrics"]},{word:"expert",impact:.92,context:["authority","specialist"],alternatives:["specialist","authority","professional"]},{word:"certified",impact:.88,context:["verified","official"],alternatives:["verified","validated","authenticated"]},{word:"scientific",impact:.87,context:["research-based","empirical"],alternatives:["research-based","evidence-based","empirical"]},{word:"validated",impact:.86,context:["confirmed","verified"],alternatives:["proven","confirmed","verified"]},{word:"documented",impact:.83,context:["recorded","proven"],alternatives:["recorded","logged","tracked"]}]},transformation:{description:"Words that promise change and improvement",words:[{word:"transform",impact:.96,context:["dramatic change","metamorphosis"],alternatives:["revolutionize","overhaul","reimagine"]},{word:"breakthrough",impact:.95,context:["major discovery","game-changer"],alternatives:["game-changer","revolution","paradigm shift"]},{word:"revolution",impact:.93,context:["radical change","disruption"],alternatives:["disruption","overhaul","transformation"]},{word:"reimagine",impact:.88,context:["rethink","reconceive"],alternatives:["rethink","reconceptualize","reinvent"]},{word:"unlock",impact:.9,context:["reveal potential","access"],alternatives:["unleash","release","activate"]},{word:"upgrade",impact:.85,context:["improve","enhance"],alternatives:["elevate","enhance","improve"]},{word:"accelerate",impact:.87,context:["speed up","fast-track"],alternatives:["fast-track","expedite","speed up"]},{word:"optimize",impact:.84,context:["maximize","perfect"],alternatives:["maximize","perfect","fine-tune"]}]},emotion:{description:"Words that trigger emotional responses",words:[{word:"amazing",impact:.86,context:["impressive","remarkable"],alternatives:["remarkable","incredible","extraordinary"]},{word:"devastating",impact:.89,context:["harmful impact","destructive"],alternatives:["destructive","catastrophic","harmful"]},{word:"thrilling",impact:.85,context:["exciting","exhilarating"],alternatives:["exciting","electrifying","exhilarating"]},{word:"heartbreaking",impact:.87,context:["emotional","tragic"],alternatives:["tragic","painful","sorrowful"]},{word:"inspiring",impact:.88,context:["motivating","uplifting"],alternatives:["motivating","uplifting","encouraging"]},{word:"shocking",impact:.91,context:["surprising","startling"],alternatives:["startling","astonishing","stunning"]},{word:"outrageous",impact:.84,context:["extreme","excessive"],alternatives:["extreme","excessive","absurd"]},{word:"powerful",impact:.87,context:["impactful","strong"],alternatives:["impactful","potent","influential"]}]},specificity:{description:"Words that add precision and concrete detail",words:[{word:"exactly",impact:.87,context:["precise","specific"],alternatives:["precisely","specifically","definitively"]},{word:"precisely",impact:.85,context:["exact","accurate"],alternatives:["exactly","accurately","specifically"]},{word:"step-by-step",impact:.89,context:["sequential","methodical"],alternatives:["methodical","systematic","sequential"]},{word:"proven",impact:.91,context:["tested","validated"],alternatives:["validated","verified","confirmed"]},{word:"guaranteed",impact:.9,context:["assured","certain"],alternatives:["assured","certain","promised"]},{word:"measurable",impact:.84,context:["quantifiable","trackable"],alternatives:["quantifiable","trackable","concrete"]},{word:"actionable",impact:.88,context:["practical","implementable"],alternatives:["practical","implementable","usable"]},{word:"concrete",impact:.83,context:["tangible","specific"],alternatives:["tangible","specific","definite"]}]}},wt={curiosity_gaps:["What most people don't know about","The surprising truth about","What {industry} won't tell you","The secret to","Why {conventional_wisdom} is wrong","The hidden pattern in","What happens when you","The one thing that"],urgency_triggers:["Before it's too late","Starting today","Right now","While you still can","Don't wait until","Time is running out to","The window is closing on","This changes everything about"],social_proof:["Top {percentage} of","{number} businesses have discovered","Industry leaders are doing this","The method used by","What successful {profession} know","The strategy behind","{number}% of experts agree","Research shows that"],transformation_promises:["Transform your {outcome}","Go from {before} to {after}","The breakthrough that","Revolutionize how you","Finally achieve {goal}","Unlock your {potential}","The game-changer for","Turn {weakness} into {strength}"]},vt={engagement:["What do you think? Share below ðŸ‘‡","Which one surprised you most?","Have you experienced this?","Change my mind. Comment below.","What am I missing? Tell me.","Which approach would you try first?","What's your take on this?","Sound familiar? Let me know."],lead_generation:["Want the full breakdown? Link in bio.","Get the complete framework: {link}","Download the full guide: {link}","Book a free strategy call: {link}","Join {number} businesses already using this: {link}","Get instant access to: {link}","Try it free for {timeframe}: {link}","Save this for later reference."],viral:["Tag someone who needs to see this","Share if you agree","Send this to your team","Repost to save for later","Screenshot this","Share with someone in {industry}","Forward to a friend who","Drop a ðŸ’¡ if this resonates"]},bt={roofing:{power_words:["leak","damage","protect","storm","emergency","certified","warranty","lifetime","trusted","safety"],triggers:["storm damage","leak detection","emergency repair","insurance claim","preventive maintenance"],transformations:["damaged roof â†’ protected home","leaky ceiling â†’ peace of mind","old shingles â†’ energy savings"]},legal:{power_words:["rights","protected","compensation","justice","experienced","aggressive","results","proven","settlement","representation"],triggers:["accident","injury","lawsuit","claim","settlement","legal rights","compensation"],transformations:["injured â†’ compensated","wronged â†’ justice","uncertain â†’ protected"]},healthcare:{power_words:["treatment","relief","cure","recovery","specialist","advanced","breakthrough","painless","effective","healing"],triggers:["symptoms","pain","diagnosis","treatment options","recovery time","side effects"],transformations:["pain â†’ relief","sick â†’ healthy","uncertain â†’ diagnosed"]},real_estate:{power_words:["location","value","investment","market","opportunity","exclusive","prime","luxury","appreciation","equity"],triggers:["market trends","property value","investment opportunity","interest rates","location benefits"],transformations:["renter â†’ homeowner","small space â†’ dream home","expense â†’ investment"]},general_business:{power_words:["grow","scale","revenue","profit","efficiency","automation","roi","strategy","competitive","market"],triggers:["growth strategy","revenue increase","cost reduction","market opportunity","competitive advantage"],transformations:["stagnant â†’ growing","manual â†’ automated","losing â†’ winning"]}},D={categories:yt,phrases:wt,cta_formulas:vt,industry_specific:bt};class M{constructor(){y(this,"powerWords");y(this,"phrases");y(this,"industryWords");this.powerWords=this.loadPowerWords(),this.phrases=D.phrases,this.industryWords=D.industry_specific}loadPowerWords(){const e=new Map;return Object.entries(D.categories).forEach(([t,o])=>{const n=o.words.map(r=>({word:r.word,category:t,impact:r.impact,context:r.context,alternatives:r.alternatives}));e.set(t,n)}),e}async optimize(e,t){console.log("[PowerWordOptimizer] Optimizing content...");const o=this.findOpportunities(e,t);console.log(`[PowerWordOptimizer] Found ${o.length} optimization opportunities`);const r=o.sort((i,c)=>c.suggestion.impact-i.suggestion.impact).filter(i=>i.suggestion.impact>.3).slice(0,7);console.log(`[PowerWordOptimizer] Applying ${r.length} optimizations`);let s={...e};return r.forEach(i=>{i.location==="headline"?s.headline=this.applySuggestion(s.headline,i.suggestion):i.location==="hook"?s.hook=this.applySuggestion(s.hook,i.suggestion):i.location==="body"?s.body=this.applySuggestion(s.body,i.suggestion):i.location==="cta"&&(s.cta=this.applySuggestion(s.cta,i.suggestion))}),t!=null&&t.industry&&(s=this.addIndustryWords(s,t)),s}findOpportunities(e,t){const o=[];return o.push(...this.analyzeSection(e.headline,"headline",t)),o.push(...this.analyzeSection(e.hook,"hook",t)),o.push(...this.analyzeSection(e.body,"body",t)),o.push(...this.analyzeSection(e.cta,"cta",t)),o}analyzeSection(e,t,o){const n=[],r=e.toLowerCase().split(/\s+/),s=["very","really","quite","pretty","somewhat","fairly","good","bad","nice","great","thing","stuff"];if(r.forEach((i,c)=>{if(s.includes(i)){const a=r.slice(Math.max(0,c-2),c+3).join(" "),d=this.suggestPowerWord(i,a,t);d&&n.push({location:t,phrase:i,context:a,suggestion:d,priority:d.impact>.6?"high":d.impact>.4?"medium":"low"})}}),(t==="headline"||t==="hook")&&!this.containsPowerWord(e)){const c=this.suggestPowerWordForPosition(t,e);c&&n.push({location:t,phrase:e.substring(0,30),context:e,suggestion:c,priority:"high"})}return n}suggestPowerWord(e,t,o){let n;o==="headline"||o==="hook"?n="curiosity":o==="cta"?n="urgency":n="transformation";const r=this.powerWords.get(n)||[],s=r.filter(c=>c.context.some(a=>t.toLowerCase().includes(a.toLowerCase())));if(s.length===0){const c=r[0];return c?{original:e,suggestion:c.word,category:n,impact:c.impact*.5,reason:`Replace weak word "${e}" with power word "${c.word}"`}:null}const i=s.sort((c,a)=>a.impact-c.impact)[0];return{original:e,suggestion:i.word,category:n,impact:i.impact,reason:`"${i.word}" (${n}) is ${(i.impact*100).toFixed(0)}% more impactful than "${e}"`}}suggestPowerWordForPosition(e,t){return null}containsPowerWord(e){const t=e.toLowerCase();for(const o of this.powerWords.values())for(const n of o)if(t.includes(n.word.toLowerCase()))return!0;return!1}applySuggestion(e,t){if(!t.original)return`${t.suggestion} ${e}`;const o=new RegExp(`\\b${t.original}\\b`,"gi");return e.replace(o,t.suggestion)}addIndustryWords(e,t){const o=this.getIndustryKey(t.industry),n=this.industryWords[o];if(!n)return e;const r=n.power_words||[],s=e.body.toLowerCase(),i=r.filter(c=>!s.includes(c.toLowerCase()));if(i.length>0&&e.body.length<500){const c=i.slice(0,2);console.log(`[PowerWordOptimizer] Consider adding industry words: ${c.join(", ")}`)}return e}getIndustryKey(e){const t=e.toLowerCase();return t.includes("roof")?"roofing":t.includes("legal")||t.includes("law")?"legal":t.includes("health")||t.includes("medical")?"healthcare":t.includes("real estate")||t.includes("property")?"real_estate":"general_business"}extractPowerWords(e){const t=[],o=e.toLowerCase();for(const n of this.powerWords.values())for(const r of n)o.includes(r.word.toLowerCase())&&t.push(r.word);return t}getPowerWordsByCategory(e){return this.powerWords.get(e)||[]}getCuriosityGapPhrases(){return this.phrases.curiosity_gaps}getUrgencyTriggerPhrases(){return this.phrases.urgency_triggers}getSocialProofPhrases(){return this.phrases.social_proof}getTransformationPhrases(){return this.phrases.transformation_promises}getCTAsForGoal(e){const t=D.cta_formulas;return t[e]||t.engagement}predictImpact(e){const t=this.extractPowerWords(`${e.headline} ${e.hook} ${e.body} ${e.cta}`);let o=.5;return o+=Math.min(t.length*.05,.3),this.containsPowerWord(e.headline)&&(o+=.1),this.containsPowerWord(e.hook)&&(o+=.1),Math.min(o,1)}}const H={id:"hook-story-offer",name:"Hook-Story-Offer",channel:"social",description:"Social media standard: grab attention, build connection, drive action",bestFor:["LinkedIn posts","Twitter threads","Instagram captions"],platforms:["linkedin","twitter","instagram"],lengthGuideline:"200-500 words",conversionFocus:.7,engagementFocus:.9,stages:[{name:"Hook",purpose:"Stop the scroll - create pattern interrupt",psychologyPrinciple:"Curiosity Gap + Pattern Interrupt",guidelines:["First 1-2 lines must grab attention","Use curiosity, controversy, or unexpected statement","Make it about the reader, not you","Avoid generic openings"],exampleFormulas:["[Surprising Fact] that changes everything about [Topic]","I just realized [Uncomfortable Truth] about [Industry]","Stop [Common Action]. Here's what to do instead.","[Big Number/Stat] + [Unexpected Insight]"]},{name:"Story",purpose:"Build connection through narrative",psychologyPrinciple:"Narrative Transportation + Empathy",guidelines:["Share personal experience or case study","Make it relatable - show vulnerability","Include transformation or discovery","Use concrete details, not abstractions"],exampleFormulas:["Here's what happened when I [Action]...","I used to believe [Old Belief]. Then I discovered [New Truth]","Last week, I [Experience]. It revealed [Insight]"]},{name:"Offer",purpose:"Clear call-to-action with value",psychologyPrinciple:"Commitment + Reciprocity",guidelines:["One clear CTA - don't give too many options","Frame as opportunity, not demand","Provide clear next step","Optional: Add urgency or scarcity"],exampleFormulas:["Want [Outcome]? [Simple Action]","I'm sharing [Resource]. Comment [Word] to get it","Ready to [Benefit]? Here's how: [Action]"]}]},q={id:"problem-agitate-solution",name:"Problem-Agitate-Solution (PAS)",channel:"social",description:"Pain-focused framework: identify problem, amplify pain, provide solution",bestFor:["High-intent audiences","Problem-aware markets","Solution positioning"],platforms:["linkedin","twitter"],lengthGuideline:"250-400 words",conversionFocus:.9,engagementFocus:.7,stages:[{name:"Problem",purpose:"Identify specific, relatable pain point",psychologyPrinciple:"Loss Aversion + Recognition",guidelines:["Be specific - avoid generic problems","Use reader's language (words they use)","Make it urgent and relevant now","Qualify your audience"],exampleFormulas:["If you're struggling with [Specific Problem]...","[Audience] face this challenge every day: [Problem]","You know that feeling when [Frustration]?"]},{name:"Agitate",purpose:"Amplify the pain - make problem feel urgent",psychologyPrinciple:"Loss Aversion Amplification",guidelines:["Show what's at stake (cost of inaction)","Use emotional language","Connect to bigger consequences","Don't be manipulative - be honest"],exampleFormulas:["Every day you don't solve this, you're losing [Cost]","Here's what happens if this continues...","The worst part? [Compounding Consequence]"]},{name:"Solution",purpose:"Present clear path forward",psychologyPrinciple:"Relief + Hope",guidelines:["Make solution feel achievable","Be specific about what changes","Include proof if possible","Clear call-to-action"],exampleFormulas:["Here's what works: [Solution]","I solved this by [Approach]. Here's how you can too","The solution is simpler than you think: [Steps]"]}]},V={id:"aida",name:"AIDA (Attention-Interest-Desire-Action)",channel:"social",description:"Classic conversion framework adapted for social",bestFor:["Product launches","Service announcements","Event promotion"],platforms:["linkedin","twitter","instagram","facebook"],lengthGuideline:"200-350 words",conversionFocus:.8,engagementFocus:.7,stages:[{name:"Attention",purpose:"Grab attention immediately",psychologyPrinciple:"Pattern Interrupt",guidelines:["Use bold statement or question","Make it relevant to audience","Create curiosity or surprise"],exampleFormulas:["[Bold Claim] (and here's proof)","What if [Desired Outcome] was possible?","[Surprising Stat] about [Topic]"]},{name:"Interest",purpose:"Build interest with relevant details",psychologyPrinciple:"Relevance + Specificity",guidelines:["Show why they should care","Use concrete details","Connect to their situation"]},{name:"Desire",purpose:"Create want through benefits",psychologyPrinciple:"Desire + Visualization",guidelines:["Paint picture of transformation","Show benefits, not features","Use emotional language"]},{name:"Action",purpose:"Clear, simple next step",psychologyPrinciple:"Commitment",guidelines:["One clear CTA","Remove friction","Add urgency if appropriate"]}]},Y={id:"before-after-bridge",name:"Before-After-Bridge (BAB)",channel:"social",description:"Transformation framework showing the journey",bestFor:["Transformation stories","Results showcases","Method reveals"],platforms:["linkedin","instagram"],lengthGuideline:"300-500 words",conversionFocus:.7,engagementFocus:.8,stages:[{name:"Before",purpose:"Establish the starting point (relatable struggle)",psychologyPrinciple:"Empathy + Recognition",guidelines:["Be specific about the struggle","Make it relatable","Show vulnerability","Avoid exaggeration"],exampleFormulas:["Six months ago, I was [Struggle]","Like most [Audience], I used to [Problem Behavior]","The old me would [Limiting Behavior]"]},{name:"After",purpose:"Show the transformation achieved",psychologyPrinciple:"Aspiration + Proof",guidelines:["Show specific results","Use numbers/metrics if possible","Make transformation feel achievable","Be credible, not boastful"],exampleFormulas:["Now I [New Reality]","Today, [Positive Outcome]","The difference: [Metric Improvement]"]},{name:"Bridge",purpose:"Reveal the method/path to transformation",psychologyPrinciple:"Solution + Hope",guidelines:["Explain what changed","Make path feel clear","Offer to help others cross bridge","Include clear CTA"],exampleFormulas:["Here's what changed everything: [Method]","The bridge: [Approach/Strategy]","Want to make this shift? Here's how [Action]"]}]},K={id:"email-aida",name:"Email AIDA",channel:"email",description:"Classic AIDA optimized for email format",bestFor:["Newsletter","Product emails","Announcement emails"],lengthGuideline:"150-300 words",conversionFocus:.9,engagementFocus:.6,stages:[{name:"Subject Line (Attention)",purpose:"Get email opened",psychologyPrinciple:"Curiosity + Relevance",guidelines:["6-10 words ideal","Create curiosity or urgency","Personalize when possible","Test with/without emojis"],exampleFormulas:["[Name], this changes [Topic]","The [Outcome] you've been waiting for","âš¡ [Benefit] in [Timeframe]","Your [Problem] solution (finally)"]},{name:"Opening (Interest)",purpose:"Hook them in first 2 lines",guidelines:["Deliver on subject line promise","Make it about them, not you","Create pattern interrupt"]},{name:"Body (Desire)",purpose:"Build want for outcome",guidelines:["Show benefits clearly","Use short paragraphs","Include social proof if possible","Address objections"]},{name:"CTA (Action)",purpose:"Clear, single action",guidelines:["One primary CTA button/link","Action-oriented language","Add urgency if appropriate","Include P.S. with additional value"]}]},J={id:"email-pas",name:"Email PAS",channel:"email",description:"Problem-Agitate-Solution for email",bestFor:["Problem-aware audiences","Solution emails","Educational series"],lengthGuideline:"200-350 words",conversionFocus:.85,engagementFocus:.7,stages:[{name:"Subject Line",purpose:"Call out the problem",guidelines:["Reference their pain point","Create recognition","Make it feel urgent"],exampleFormulas:["Still struggling with [Problem]?","The [Problem] no one talks about","Why [Problem] keeps happening"]},{name:"Problem Identification",purpose:"Show you understand their pain",guidelines:["Be specific","Use their language","Show empathy"]},{name:"Agitate",purpose:"Amplify urgency",guidelines:["Show cost of inaction","Use emotional language","Don't be manipulative"]},{name:"Solution + CTA",purpose:"Present clear path forward",guidelines:["Make solution feel achievable","Clear next step","Add P.S. with benefit reminder"]}]},X={id:"blog-how-to",name:"How-To Guide",channel:"blog",description:"Educational content with step-by-step instructions",bestFor:["Tutorials","Process explanations","Skill building"],lengthGuideline:"1000-2000 words",conversionFocus:.5,engagementFocus:.8,stages:[{name:"SEO-Optimized Headline",purpose:"Rank for search + get clicks",guidelines:["Include target keyword","Promise clear outcome","Use power words","Keep under 60 characters"],exampleFormulas:["How to [Outcome] in [Timeframe]: [Method] Guide","[Number] Steps to [Outcome] (Even if [Obstacle])","The Complete Guide to [Topic]: [Benefit]"]},{name:"Introduction",purpose:"Set context and promise value",guidelines:["Hook with problem or opportunity","Preview what they'll learn","Establish credibility","Keep under 200 words"]},{name:"Step-by-Step Content",purpose:"Deliver actionable instructions",guidelines:["Use H2/H3 subheadings for each step","Include examples and visuals","Make steps actionable","Link to related resources"]},{name:"Conclusion + CTA",purpose:"Reinforce value and drive action",guidelines:["Summarize key points","Encourage action","Offer next step/upgrade path","Include related content links"]}]},Z={id:"blog-listicle",name:"Listicle",channel:"blog",description:"Numbered list format for easy scanning",bestFor:["Tips compilations","Best practices","Resource roundups"],lengthGuideline:"800-1500 words",conversionFocus:.6,engagementFocus:.9,stages:[{name:"Number + Benefit Headline",purpose:"Set clear expectations",guidelines:["Use odd numbers (perceived as more authentic)","Promise specific outcome","Include qualifying phrase"],exampleFormulas:["[Odd Number] [Topic] That [Benefit]","[Number] Ways to [Outcome] Without [Common Obstacle]","[Number] [Topic] Every [Audience] Should Know"]},{name:"Brief Intro",purpose:"Set up the list value",guidelines:["Keep to 100-150 words","Explain why list matters","Promise what they'll gain"]},{name:"List Items",purpose:"Deliver numbered value points",guidelines:["Use H2/H3 for each item","Make each item standalone","100-200 words per item","Include examples","Add visuals where helpful"]},{name:"Wrap-Up + CTA",purpose:"Synthesize and drive action",guidelines:["Quick summary","Pick your favorite or start here","Clear next step"]}]},Q={id:"landing-hero",name:"Hero Section Formula",channel:"landing-page",description:"Above-the-fold conversion optimization",bestFor:["Product pages","Service pages","Lead gen pages"],lengthGuideline:"Above fold: 50-100 words",conversionFocus:1,engagementFocus:.5,stages:[{name:"Value Proposition Headline",purpose:"Communicate core value in 10 words or less",psychologyPrinciple:"Clarity + Relevance",guidelines:["Focus on outcome, not method","Be specific, avoid jargon","Make it about them","Test multiple versions"],exampleFormulas:["[Outcome] Without [Common Obstacle]","Get [Desired Result] in [Timeframe]","The [Benefit] [Audience] Needs"]},{name:"Supporting Subheadline",purpose:"Clarify who it's for and how it works",guidelines:["15-25 words","Add clarity to headline","Qualify your audience","Hint at the method"]},{name:"Primary CTA",purpose:"Drive single clear action",guidelines:["Action-oriented button text","High contrast color","Benefit-focused copy","Remove friction"],exampleFormulas:["Get [Benefit] Now","Start [Action] Free","See How It Works"]},{name:"Trust Indicators",purpose:"Build credibility immediately",guidelines:["Social proof (user count, ratings)","Logos of known clients/media","Risk reversal (guarantee)","Keep minimal - don't clutter"]}]},ee={id:"landing-pastor",name:"PASTOR Framework",channel:"landing-page",description:"Problem-Amplify-Story-Testimonial-Offer-Response",bestFor:["Long-form sales pages","Course launches","High-ticket offers"],lengthGuideline:"1500-3000 words",conversionFocus:.95,engagementFocus:.7,stages:[{name:"Problem",purpose:"Identify the core pain point",psychologyPrinciple:"Recognition + Empathy",guidelines:["Be specific about the problem","Use their language","Show understanding"]},{name:"Amplify",purpose:"Deepen understanding of problem cost",psychologyPrinciple:"Loss Aversion",guidelines:["Show what's at stake","Emotional + logical costs","Future consequences"]},{name:"Story",purpose:"Share transformation journey",psychologyPrinciple:"Narrative Transportation",guidelines:["Personal or customer story","Show before/after","Make it relatable"]},{name:"Testimonials & Proof",purpose:"Provide social proof",psychologyPrinciple:"Social Proof + Authority",guidelines:["Real customer results","Specific outcomes","Photos/videos if possible","Address common objections"]},{name:"Offer",purpose:"Present your solution clearly",psychologyPrinciple:"Value Perception",guidelines:["What they get (features â†’ benefits)","How it works","What makes it unique","Price positioning"]},{name:"Response",purpose:"Clear CTA with urgency",psychologyPrinciple:"Scarcity + Commitment",guidelines:["Remove friction","Add urgency if authentic","Risk reversal (guarantee)","Make action easy"]}]};class St{constructor(){y(this,"frameworks");this.frameworks=new Map([[H.id,H],[q.id,q],[V.id,V],[Y.id,Y],[K.id,K],[J.id,J],[X.id,X],[Z.id,Z],[Q.id,Q],[ee.id,ee]])}getFramework(e){return this.frameworks.get(e)}getFrameworksByChannel(e){return Array.from(this.frameworks.values()).filter(t=>t.channel===e)}selectFramework(e,t,o,n){var c;const r=this.getFrameworksByChannel(t),i=(n?r.filter(a=>!a.platforms||a.platforms.includes(n)||a.platforms.includes("generic")):r).map(a=>{let d=0;return o==="conversion"||o==="lead-generation"?d+=a.conversionFocus*10:o==="engagement"?d+=a.engagementFocus*10:d+=(a.conversionFocus+a.engagementFocus)*5,e.type==="counter_intuitive"&&a.id.includes("problem")&&(d+=5),e.type==="predictive_opportunity"&&a.id.includes("before-after")&&(d+=5),e.type==="deep_psychology"&&a.id.includes("story")&&(d+=5),{framework:a,score:d}});return i.sort((a,d)=>d.score-a.score),((c=i[0])==null?void 0:c.framework)||r[0]}getAllFrameworks(){return Array.from(this.frameworks.values())}getRecommendations(e,t){const o=this.getFrameworksByChannel(t),n=this.selectFramework(e,t,"conversion"),r=o.filter(i=>i.id!==n.id).slice(0,2);let s=`Selected ${n.name} because `;return e.type==="counter_intuitive"?s+="this insight challenges conventional wisdom, making problem-focused frameworks effective.":e.type==="predictive_opportunity"?s+="this insight shows future trends, making transformation frameworks compelling.":e.type==="deep_psychology"?s+="this insight reveals psychological drivers, making story-based frameworks engaging.":s+="this framework balances conversion and engagement effectively.",{primary:n,alternatives:r,reasoning:s}}}new St;function W(l){if("targetAudience"in l&&l.targetAudience){let o=l.targetAudience;if(o.includes(",")){const n=o.split(",").map(r=>r.trim());if(n.length>3)console.warn("[audienceDetection] targetAudience contains comma-separated list (>3 parts), forcing industry inference:",o.substring(0,100));else return n.length===2?(o=`${n[0]} and ${n[1]}`,console.log("[audienceDetection] Cleaned comma-separated audience:",o),o):(n.length===3&&(o=`${n[0]}, ${n[1]}, and ${n[2]}`,console.log("[audienceDetection] Cleaned 3-part audience:",o)),o)}else return o}const e={bar:"locals looking for a great night out",pub:"friends and groups looking for a relaxed atmosphere","bar/pub":"people looking for drinks and good times",nightclub:"party-goers and groups celebrating",brewery:"craft beer enthusiasts and groups","wine bar":"wine lovers and date night crowds","mobile coffee":"event planners and people hosting special occasions","coffee cart":"event organizers and hosts",wedding:"couples planning weddings",event:"event planners and hosts","coffee shop":"coffee lovers and local community members",cafe:"people seeking quality coffee and community spaces",restaurant:"diners and food enthusiasts",bakery:"people who love fresh baked goods",retail:"shoppers looking for quality products",saas:"business professionals seeking software solutions",consulting:"business leaders seeking expert guidance",marketing:"business owners looking to grow their brand","real estate":"home buyers and property investors",fitness:"people seeking health and wellness improvements",education:"students and lifelong learners",healthcare:"patients seeking quality care",legal:"clients needing legal services","financial services":"individuals and businesses managing finances","e-commerce":"online shoppers",hospitality:"travelers and guests",cleaning:"business owners seeking professional cleaning services",janitorial:"facility managers looking for reliable janitorial services","facility services":"property managers and business owners maintaining professional spaces"},t=l.industry.toLowerCase();if(e[t])return e[t];for(const[o,n]of Object.entries(e))if(t.includes(o)||o.includes(t))return n;return`people interested in ${l.industry}`}function At(l){return l.filter(e=>{const t=e.split(" ").length<=4&&!e.includes(".")&&!e.includes("%")&&!e.match(/[A-Z][a-z]/),o=e.length<15;return!t&&!o})}function $(l,e=3){return At(l).slice(0,e)}class Ct{constructor(){y(this,"powerWordOptimizer");y(this,"framework");this.powerWordOptimizer=new M,this.framework=H}async generate(e,t){const o=W(t),n=this.generateFrameworkGuidedDraft(e,t,o),r=await this.powerWordOptimizer.optimize(n,t);return{id:`content-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,insightId:e.id,format:"hook-post",content:{headline:r.headline,hook:r.hook,body:r.body,cta:r.cta,hashtags:this.generateHashtags(e,t)},psychology:{principle:"Curiosity Gap",trigger:{type:"curiosity",strength:.9,target:"discovery"},persuasionTechnique:"Pattern Interrupt",expectedReaction:e.expectedReaction||"I need to know more about this"},optimization:{powerWords:this.powerWordOptimizer.extractPowerWords(`${r.headline} ${r.hook} ${r.body}`),framingDevice:this.framework.name,narrativeStructure:this.framework.stages.map(i=>i.name).join(" â†’ "),pacing:"Fast (curiosity-driven)"},meta:{platform:["LinkedIn","Instagram"],tone:"professional",targetAudience:o},prediction:{engagementScore:this.predictEngagement(e,r),viralPotential:this.predictViralPotential(e),leadGeneration:this.predictLeadGeneration(o),brandImpact:"positive",confidenceLevel:e.confidence},framework:{id:this.framework.id,name:this.framework.name,stages:this.framework.stages.map(i=>i.name),reasoning:"Hook-Story-Offer is the gold standard for social media engagement. Creates pattern interrupt, builds connection, drives action."},metadata:{generatedAt:new Date,model:"HookPostGenerator",iterationCount:1,impactScore:e.confidence}}}generateFrameworkGuidedDraft(e,t,o){const n=$(e.evidence,3),r=this.buildHookStage(e,o),s=this.buildStoryStage(e,n),i=this.buildOfferStage(e,t,o),c=this.extractHeadline(e),a=`${s}`;return{format:"hook-post",headline:c,hook:r,body:a,cta:i}}buildHookStage(e,t){return e.contentAngle&&e.contentAngle.length>10?e.contentAngle:e.insight.split(".")[0]+"."}buildStoryStage(e,t){const o=[];return e.whyProfound&&o.push(e.whyProfound),t.length>0&&(o.push(`

What we're seeing:`),t.forEach(n=>{o.push(`â€¢ ${n}`)})),e.whyNow&&e.whyNow.length>15&&o.push(`

${e.whyNow}`),o.join(`
`)}buildOfferStage(e,t,o){const n=["Want to explore how this applies to your business? Let's connect.",`This insight changes everything. DM me to discuss how ${t.name} can help.`,"Ready to capitalize on this? Reach out and let's talk strategy.",`${t.name} specializes in helping ${o} leverage insights like this. Let's chat.`];return e.type==="predictive_opportunity"?`This opportunity won't last forever. ${n[2]}`:e.type==="counter_intuitive"?n[1]:n[0]}extractHeadline(e){if(e.contentAngle&&e.contentAngle.length>10)return e.contentAngle.split(".")[0];const t=e.insight.split(".")[0];return t.length>100?t.substring(0,97)+"...":t}generateHashtags(e,t){const n=[t.industry.toLowerCase().replace(/\s+/g,""),"business","growth"],s={unexpected_connection:["innovation","insights"],counter_intuitive:["mindset","strategy"],predictive_opportunity:["trends","opportunity"],deep_psychology:["psychology","customers"],cultural_moment:["trending","relevant"]}[e.type]||["insights"];return[...n,...s].slice(0,5)}predictEngagement(e,t){let o=.7;o+=e.confidence*.2;const n=this.powerWordOptimizer.extractPowerWords(t.headline);return o+=Math.min(n.length*.02,.1),Math.min(o,1)}predictViralPotential(e){let t=.6;return e.type==="counter_intuitive"&&(t+=.15),e.type==="unexpected_connection"&&(t+=.2),Math.min(t,1)}predictLeadGeneration(e){let t=.65;return(e.toLowerCase().includes("business")||e.toLowerCase().includes("professional"))&&(t+=.15),Math.min(t,1)}}class kt{constructor(){y(this,"powerWordOptimizer");y(this,"framework");this.powerWordOptimizer=new M,this.framework=Y}async generate(e,t){const o=W(t),n=this.generateFrameworkGuidedDraft(e,t,o),r=await this.powerWordOptimizer.optimize(n,t);return{id:`content-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,insightId:e.id,format:"story-post",content:{headline:r.headline,hook:r.hook,body:r.body,cta:r.cta,hashtags:this.generateHashtags(e,t)},psychology:{principle:"Narrative Transportation",trigger:{type:"aspiration",strength:.85,target:"connection"},persuasionTechnique:"Storytelling",expectedReaction:e.expectedReaction||"I can relate to this journey"},optimization:{powerWords:this.powerWordOptimizer.extractPowerWords(`${r.headline} ${r.hook} ${r.body}`),framingDevice:this.framework.name,narrativeStructure:this.framework.stages.map(i=>i.name).join(" â†’ "),pacing:"Medium (story-driven)"},meta:{platform:["LinkedIn","Facebook"],tone:"inspirational",targetAudience:o},prediction:{engagementScore:.75,viralPotential:.65,leadGeneration:.7,brandImpact:"positive",confidenceLevel:e.confidence},framework:{id:this.framework.id,name:this.framework.name,stages:this.framework.stages.map(i=>i.name),reasoning:"Before-After-Bridge perfect for showing transformation and building emotional connection"},metadata:{generatedAt:new Date,model:"StoryPostGenerator",iterationCount:1,impactScore:e.confidence}}}generateFrameworkGuidedDraft(e,t,o){const n=$(e.evidence,3),r=this.buildBeforeStage(e,o),s=this.buildAfterStage(e,n),i=this.buildBridgeStage(e,t,o),c=this.buildHeadline(e),a=r,d=`${s}

${i}`;return{format:"story-post",headline:c,hook:a,body:d,cta:"Want to make this transformation yourself? Let's connect."}}buildBeforeStage(e,t){return`Here's what I see happening with many ${t}...`}buildAfterStage(e,t){const o=[];return o.push(`**The Insight:**
${e.insight}`),e.whyProfound&&o.push(`
**Why This Changes Everything:**
${e.whyProfound}`),t.length>0&&(o.push(`
**What I've Seen:**`),t.forEach(n=>{o.push(`â€¢ ${n}`)})),o.join(`
`)}buildBridgeStage(e,t,o){const n=[];return e.whyNow&&e.whyNow.length>15&&n.push(`**The Timing:**
${e.whyNow}`),n.push(`
${t.name} is built on helping ${o} make transformations like this.`),n.join(`
`)}buildHeadline(e){if(e.contentAngle&&e.contentAngle.length>10)return e.contentAngle;const t=e.insight.split(".")[0];return t.length>100?t.substring(0,97)+"...":t}generateHashtags(e,t){return[t.industry.toLowerCase().replace(/\s+/g,""),"transformation","growth","journey","success"].slice(0,5)}}class It{constructor(){y(this,"powerWordOptimizer");y(this,"framework");this.powerWordOptimizer=new M,this.framework=V}async generate(e,t){const o=W(t),n=$(e.evidence,5),r=this.generateFrameworkGuidedDraft(e,t,o),s=await this.powerWordOptimizer.optimize(r,t);return{id:`content-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,insightId:e.id,format:"data-post",content:{headline:s.headline,hook:s.hook,body:s.body,cta:s.cta,hashtags:this.generateHashtags(e,t)},psychology:{principle:"Social Proof + Authority",trigger:{type:"curiosity",strength:.8,target:"credibility"},persuasionTechnique:"Data-Driven Authority",expectedReaction:e.expectedReaction||"These numbers tell a compelling story"},optimization:{powerWords:this.powerWordOptimizer.extractPowerWords(`${s.headline} ${s.hook} ${s.body}`),framingDevice:this.framework.name,narrativeStructure:this.framework.stages.map(c=>c.name).join(" â†’ "),pacing:"Medium-Fast (data-driven)"},meta:{platform:["LinkedIn","Twitter"],tone:"authoritative",targetAudience:o},prediction:{engagementScore:.7,viralPotential:.6,leadGeneration:.75,brandImpact:"positive",confidenceLevel:e.confidence},framework:{id:this.framework.id,name:this.framework.name,stages:this.framework.stages.map(c=>c.name),reasoning:"AIDA framework perfect for data-driven content that builds authority and drives action"},provenance:{...e.deepProvenance||{},dataSourcesUsed:e.dataUsed||[],psychologyTrigger:"Social Proof + Authority - Data-driven credibility",trendingTopicMatched:e.title,frameworkStagesUsed:[{stage:"Attention (Hook)",sourceField:e.whyProfound&&e.whyProfound.length>30?"whyProfound":"insight",content:r.hook.substring(0,100)},{stage:"Interest + Desire (Body)",sourceField:n.length>0?"evidence + whyNow":"insight + whyNow",content:r.body.substring(0,100)},{stage:"Action (CTA)",sourceField:"business.industry (industry-specific CTA)",content:r.cta}],contentAssembly:{headline:{source:"insight.contentAngle (first sentence, 120 char limit)",field:"contentAngle",preview:s.headline.substring(0,80)},hook:{source:e.whyProfound&&e.whyProfound.length>30?"insight.whyProfound":"insight.insight",field:e.whyProfound&&e.whyProfound.length>30?"whyProfound":"insight",preview:s.hook.substring(0,80)},body:{source:n.length>0?"insight.evidence + insight.whyNow":"insight.insight + insight.whyNow",field:n.length>0?"evidence + whyNow":"insight + whyNow",preview:s.body.substring(0,80)},cta:{source:`Industry: ${t.industry}`,field:"business.industry",preview:s.cta}},decisions:{whyThisFormat:"Data post format chosen for evidence-based insights that build authority",whyThisTone:"Authoritative tone to establish credibility with data and statistics",whyThisCTA:this.explainCTAChoice(t)}},metadata:{generatedAt:new Date,model:"DataPostGenerator",iterationCount:1,impactScore:e.confidence}}}generateFrameworkGuidedDraft(e,t,o){const n=$(e.evidence,5),r=this.buildAttentionStage(e,o),s=this.buildInterestStage(e),i=this.buildDesireStage(e,n),c=this.buildActionStage(t,o),a=this.buildHeadline(e),d=r,g=[s,i].filter(h=>h.length>0).join(`

`);return{format:"data-post",headline:a,hook:d,body:g,cta:c}}buildAttentionStage(e,t){return e.whyProfound&&e.whyProfound.length>30?e.whyProfound:e.insight}buildInterestStage(e){return""}buildDesireStage(e,t){const o=[];return t.length>0&&t.forEach(n=>{o.push(n)}),e.whyNow&&e.whyNow.length>15&&o.push(e.whyNow),o.length===0&&e.insight&&o.push(e.insight),o.join(`

`)}buildActionStage(e,t){const o=e.industry.toLowerCase();return o.includes("cleaning")||o.includes("janitorial")||o.includes("facility")?`${e.name} delivers professional results every time. Schedule your service today.`:o.includes("bar")||o.includes("pub")||o.includes("nightclub")?`Experience it at ${e.name}. Stop by and see for yourself.`:o.includes("coffee")||o.includes("cafe")?`Try ${e.name} and taste the difference. Visit us today.`:o.includes("mattress")||o.includes("furniture")?`Visit ${e.name} and find your perfect match. We're here to help.`:o.includes("restaurant")||o.includes("food")?`Taste it at ${e.name}. Reserve your table today.`:o.includes("event")?`${e.name} handles the details. Let's talk about your next event.`:`Visit ${e.name} today. We're ready when you are.`}buildHeadline(e){const t=n=>{let r=n;(r.toLowerCase().includes("start with")||r.toLowerCase().includes("secret"))&&console.warn("[DataPost] Found meta-instruction in contentAngle:",r);const s=[/^Start with ["']?secret["']?\s*/i,/^Start with ["'][^"']*["']\s*/i,/^Start with\s+/i,/^Begin with\s+/i,/^Create (a|an)\s+/i,/^Post (a|an)\s+/i,/^Share (a|an)\s+/i,/^Video series:\s*/i,/^POV:\s*/i,/^"?secret"?\s*/i];for(const i of s){const c=r;r=r.replace(i,""),c!==r&&console.warn("[DataPost] Pattern matched and removed:",i,"Result:",r.substring(0,50))}return r!==n&&r.length>0&&(r=r.charAt(0).toUpperCase()+r.slice(1)),r};if(e.contentAngle&&e.contentAngle.length>10){let n=t(e.contentAngle);const r=n.split(".")[0];return r.length>120?n=r.substring(0,117)+"...":n=r,console.log("[DataPost] Built headline from contentAngle:",n),n}const o=t(e.insight.split(".")[0]);return o.length>120?o.substring(0,117)+"...":o}generateHashtags(e,t){return[t.industry.toLowerCase().replace(/\s+/g,""),"data","insights","research","trends"].slice(0,5)}explainCTAChoice(e){const t=e.industry.toLowerCase();return t.includes("cleaning")||t.includes("janitorial")||t.includes("facility")?"Cleaning service CTA emphasizes professional results and reliability - key factors for commercial clients":t.includes("bar")||t.includes("pub")||t.includes("nightclub")?"Bar/pub CTA invites immediate experience - driving foot traffic with social proof":t.includes("coffee")||t.includes("cafe")?"Coffee CTA focuses on taste differentiation - sensory appeal for quality-conscious customers":t.includes("mattress")||t.includes("furniture")?"Furniture CTA emphasizes personal fit and help - crucial for high-consideration purchases":t.includes("restaurant")||t.includes("food")?"Restaurant CTA drives reservations - immediate action for dining experience":t.includes("event")?"Event service CTA focuses on detail handling - key trust factor for important occasions":"Generic CTA chosen - using direct action prompt as no industry-specific pattern matched"}}class Tt{async generatePremiumContent(e,t,o){const n=this.buildPremiumPrompt(e,t,o);try{const r=await F([{role:"user",content:n}],{model:"anthropic/claude-sonnet-4.5",temperature:.7,max_tokens:1500});return this.parseResponse(r)}catch(r){return console.error("[PremiumContentWriter] Generation failed:",r),this.generateFallbackContent(e,t)}}buildPremiumPrompt(e,t,o){var s,i,c;const n={linkedin:{tone:"professional yet personable",length:"1200-1500 characters",style:"thought leadership",hashtagCount:5},facebook:{tone:"friendly and conversational",length:"800-1000 characters",style:"storytelling",hashtagCount:3},instagram:{tone:"inspiring and visual",length:"500-800 characters",style:"emotional storytelling",hashtagCount:10},twitter:{tone:"punchy and provocative",length:"250-280 characters",style:"hook-driven",hashtagCount:2}},r=n[o]||n.linkedin;return`You are a world-class copywriter specializing in ${o} content for ${t.industry} businesses.

BUSINESS CONTEXT:
- Business: ${t.name}
- Industry: ${t.industry}
- Location: ${(s=t.location)==null?void 0:s.city}, ${(i=t.location)==null?void 0:i.state}

BREAKTHROUGH INSIGHT TO LEVERAGE:
- Core Insight: ${e.insight}
- Why It Matters: ${e.whyProfound}
- Content Angle: ${e.contentAngle||e.insight}
- Evidence: ${(c=e.evidence)==null?void 0:c.join("; ")}
- Timing: ${e.whyNow}

WRITING REQUIREMENTS:
- Platform: ${o}
- Tone: ${r.tone}
- Length: ${r.length}
- Style: ${r.style}

Create compelling content using the StoryBrand framework:

1. HEADLINE (one powerful line that stops scrolling)
   - Hook attention immediately
   - Make them curious
   - Promise value

2. HOOK (2-3 sentences that create emotional connection)
   - Identify the problem
   - Empathize with their pain
   - Hint at the solution

3. BODY (flowing narrative, NOT bullet points)
   - Tell a mini-story or paint a picture
   - Use specific examples and scenarios
   - Build desire for the solution
   - Include social proof if relevant
   - Create urgency without being pushy
   - Write in active voice
   - Use power words and emotional triggers
   - Include transitions between ideas

4. CTA (clear, specific action)
   - Tell them exactly what to do
   - Make it easy and appealing
   - Create FOMO if appropriate

5. HASHTAGS (${r.hashtagCount} relevant tags)
   - Mix branded, industry, and trending

CRITICAL RULES:
- Write flowing paragraphs, NOT disconnected bullet points
- Use storytelling and emotion, not just facts
- Connect ideas with smooth transitions
- Be specific, not generic
- Show, don't tell
- Use "you" to speak directly to the reader
- Include sensory details when relevant

CRITICAL: Respond with ONLY valid JSON. No preamble, no explanation, no markdown. Just the JSON object.

{
  "headline": "attention-grabbing headline",
  "hook": "emotional hook that creates connection",
  "body": "compelling narrative body (multiple paragraphs)",
  "cta": "specific call to action",
  "hashtags": ["tag1", "tag2", ...]
}`}parseResponse(e){try{let t=e.trim();if(t.includes("```json")){const o=t.match(/```json\s*([\s\S]*?)\s*```/);o&&(t=o[1].trim())}else if(t.includes("```")){const o=t.match(/```\s*([\s\S]*?)\s*```/);o&&(t=o[1].trim())}if(!t.startsWith("{")){const o=t.match(/\{[\s\S]*\}/);o&&(t=o[0])}try{const o=JSON.parse(t);return{headline:o.headline||"",hook:o.hook||"",body:o.body||"",cta:o.cta||"",hashtags:o.hashtags||[]}}catch{const n=t.replace(/"(headline|hook|body|cta)":\s*"((?:[^"\\]|\\.)*)"/g,(s,i,c)=>{const a=c.replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/\t/g,"\\t");return`"${i}": "${a}"`}),r=JSON.parse(n);return{headline:r.headline||"",hook:r.hook||"",body:r.body||"",cta:r.cta||"",hashtags:r.hashtags||[]}}}catch(t){console.error("[PremiumContentWriter] Failed to parse response:",t),console.log("[PremiumContentWriter] Raw response:",e.substring(0,500));try{const o=e.match(/"headline":\s*"([^"]+)"/),n=e.match(/"hook":\s*"([^"]+)"/),r=e.match(/"body":\s*"([^"]+)"/),s=e.match(/"cta":\s*"([^"]+)"/);if(o||n)return console.warn("[PremiumContentWriter] Using partial response data"),{headline:(o==null?void 0:o[1])||"Content ready",hook:(n==null?void 0:n[1])||"",body:(r==null?void 0:r[1])||"",cta:(s==null?void 0:s[1])||"Learn more",hashtags:[]}}catch{}throw t}}generateFallbackContent(e,t){var o;return{headline:e.contentAngle||e.insight,hook:e.whyProfound||"Discover what matters most.",body:`${(o=e.evidence)==null?void 0:o.join(". ")}. ${e.whyNow}`,cta:`Learn more at ${t.name}.`,hashtags:t.industry.toLowerCase().split(" ").filter(n=>n.length>3)}}async enhanceContent(e,t,o){const n=`You are a world-class copy editor. Rewrite this content to be more engaging and professional.

CURRENT CONTENT:
Headline: ${e.headline}
Hook: ${e.hook}
Body: ${e.body}
CTA: ${e.cta}

REQUIREMENTS:
- Platform: ${o}
- Business: ${t.name} (${t.industry})
- Transform choppy bullet points into flowing narrative
- Add emotional resonance and storytelling
- Use active voice and power words
- Create smooth transitions
- Make it conversational yet professional

Rewrite this content to be compelling and engaging. Focus on storytelling, emotion, and clear value.

CRITICAL: Respond with ONLY valid JSON. No preamble, no explanation, no markdown. Just the JSON object.

{
  "headline": "improved headline",
  "hook": "improved hook",
  "body": "improved body with flowing narrative",
  "cta": "improved cta",
  "hashtags": ["relevant", "tags"]
}`;try{const r=await F([{role:"user",content:n}],{model:"anthropic/claude-sonnet-4.5",temperature:.7,max_tokens:1e3});return this.parseResponse(r)}catch(r){return console.error("[PremiumContentWriter] Enhancement failed:",r),{...e,hashtags:[]}}}}class Pt{constructor(){y(this,"powerWordOptimizer");y(this,"framework");y(this,"premiumWriter");this.powerWordOptimizer=new M,this.framework=q,this.premiumWriter=new Tt}async generate(e,t,o="linkedin"){const n=W(t),r=$(e.evidence,3),s=await this.premiumWriter.generatePremiumContent(e,t,o),i={headline:s.headline,hook:s.hook,body:s.body,cta:s.cta};return{id:`content-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,insightId:e.id,format:"controversial-post",content:{headline:i.headline,hook:i.hook,body:i.body,cta:i.cta,hashtags:s.hashtags||this.generateHashtags(e,t)},psychology:{principle:"Cognitive Dissonance",trigger:{type:"anger",strength:.85,target:"engagement"},persuasionTechnique:"Contrarian Challenge",expectedReaction:e.expectedReaction||"This challenges what I believe... let me think about it"},optimization:{powerWords:this.powerWordOptimizer.extractPowerWords(`${i.headline} ${i.hook} ${i.body}`),framingDevice:this.framework.name,narrativeStructure:this.framework.stages.map(a=>a.name).join(" â†’ "),pacing:"Fast (debate-driving)"},meta:{platform:["LinkedIn","Twitter"],tone:"controversial",targetAudience:n},prediction:{engagementScore:this.predictEngagement(e),viralPotential:this.predictViralPotential(e),leadGeneration:.55,brandImpact:this.predictBrandImpact(e),confidenceLevel:e.confidence},framework:{id:this.framework.id,name:this.framework.name,stages:this.framework.stages.map(a=>a.name),reasoning:"PAS framework perfect for challenging conventional wisdom with substantive arguments"},provenance:{...e.deepProvenance||{},dataSourcesUsed:e.dataUsed||[],psychologyTrigger:"Cognitive Dissonance - Challenge conventional wisdom",trendingTopicMatched:e.title,frameworkStagesUsed:[{stage:"Problem (Hook)",sourceField:e.whyProfound&&e.whyProfound.length>30?"whyProfound":"insight",content:i.hook.substring(0,100)},{stage:"Agitate (Body)",sourceField:r.length>0?"evidence + whyNow":"insight + whyNow",content:i.body.substring(0,100)},{stage:"Solution (CTA)",sourceField:"business.industry (industry-specific CTA)",content:i.cta}],contentAssembly:{headline:{source:"insight.contentAngle (first sentence, 120 char limit)",field:"contentAngle",preview:i.headline.substring(0,80)},hook:{source:e.whyProfound&&e.whyProfound.length>30?"insight.whyProfound":"insight.insight",field:e.whyProfound&&e.whyProfound.length>30?"whyProfound":"insight",preview:i.hook.substring(0,80)},body:{source:r.length>0?"insight.evidence + insight.whyNow":"insight.insight + insight.whyNow",field:r.length>0?"evidence + whyNow":"insight + whyNow",preview:i.body.substring(0,80)},cta:{source:`Industry: ${t.industry}`,field:"business.industry",preview:i.cta}},decisions:{whyThisFormat:"Controversial format chosen for counter-intuitive insights that challenge conventional wisdom",whyThisTone:"Controversial tone to drive debate and engagement",whyThisCTA:this.explainCTAChoice(t,e)}},metadata:{generatedAt:new Date,model:"ControversialPostGenerator",iterationCount:1,impactScore:e.confidence}}}generateFrameworkGuidedDraft(e,t,o){const n=$(e.evidence,3),r=this.buildProblemStage(e,o),s=this.buildAgitateStage(e,n),i=this.buildSolutionStage(e),c=this.buildInsightSpecificCTA(e,t,o),a=this.buildHeadline(e),d=r,g=[s,i].filter(p=>p.length>0).join(`

`);return{format:"controversial-post",headline:a,hook:d,body:g,cta:c}}buildProblemStage(e,t){return e.whyProfound&&e.whyProfound.length>30?e.whyProfound:e.insight}buildAgitateStage(e,t){const o=[];if(t.length>0)if(t.length===1){const n=t[0];o.push(n.endsWith(".")?n:n+".")}else if(t.length===2)o.push(`${t[0]}. ${t[1]}.`);else{const n=t.map(r=>r.endsWith(".")?r:r+".").join(" ");o.push(n)}return e.whyNow&&e.whyNow.length>15&&o.push(e.whyNow),o.length===0&&e.insight&&o.push(e.insight),o.join(`

`)}buildSolutionStage(e){return""}buildInsightSpecificCTA(e,t,o){const n=t.industry.toLowerCase(),r=(e.contentAngle||e.insight).toLowerCase();return n.includes("cleaning")||n.includes("janitorial")||n.includes("facility")?`${t.name} keeps your space spotless and professional. Book your service today.`:n.includes("bar")||n.includes("pub")||n.includes("nightclub")?`Stop by ${t.name} and experience it yourself. See you soon.`:n.includes("coffee")||n.includes("cafe")?`Try ${t.name} and taste the difference. Visit us today.`:n.includes("mattress")||n.includes("furniture")?`Visit ${t.name} and find your perfect match. Stop by today.`:n.includes("restaurant")||n.includes("food")?`Experience it at ${t.name}. Reserve your table today.`:r.includes("wedding")?`Want this at your next event? ${t.name} brings the experience. DM us to book.`:r.includes("office")||r.includes("corporate")?`${t.name} handles the details. Let's talk about your needs.`:r.includes("event")?`Planning something special? ${t.name} creates experiences people remember. Reach out.`:`Visit ${t.name} and see the difference. We're ready when you are.`}buildHeadline(e){const t=n=>{let r=n;(r.toLowerCase().includes("start with")||r.toLowerCase().includes("secret"))&&console.warn("[ControversialPost] Found meta-instruction in contentAngle:",r);const s=[/^Start with ["']?secret["']?\s*/i,/^Start with ["'][^"']*["']\s*/i,/^Start with\s+/i,/^Begin with\s+/i,/^Create (a|an)\s+/i,/^Post (a|an)\s+/i,/^Share (a|an)\s+/i,/^Video series:\s*/i,/^POV:\s*/i,/^"?secret"?\s*/i];for(const i of s){const c=r;r=r.replace(i,""),c!==r&&console.warn("[ControversialPost] Pattern matched and removed:",i,"Result:",r.substring(0,50))}return r!==n&&r.length>0&&(r=r.charAt(0).toUpperCase()+r.slice(1)),r};if(e.contentAngle&&e.contentAngle.length>10){let n=t(e.contentAngle);const r=n.split(".")[0];return r.length>120?n=r.substring(0,117)+"...":n=r,console.log("[ControversialPost] Built headline from contentAngle:",n),n}const o=t(e.insight.split(".")[0]);return o.length>120?o.substring(0,117)+"...":o}generateHashtags(e,t){const n=t.industry.toLowerCase().replace(/[()]/g,"").split(/\s+/).filter(s=>s.length>3).filter(s=>!["except","other","services","general"].includes(s)).slice(0,2),r=["truth","mindset","insights"];return[...n,...r].slice(0,5)}predictEngagement(e){let t=.8;return e.type==="counter_intuitive"&&(t+=.15),e.confidence>.8&&(t+=.05),Math.min(t,1)}predictViralPotential(e){let t=.75;return e.type==="counter_intuitive"&&(t+=.2),Math.min(t,1)}predictBrandImpact(e){return e.confidence>.8?"positive":e.confidence>.6?"neutral":"risky"}explainCTAChoice(e,t){const o=e.industry.toLowerCase();return o.includes("cleaning")||o.includes("janitorial")||o.includes("facility")?"Cleaning service CTA emphasizes professionalism and reliability - key trust factors for commercial clients":o.includes("bar")||o.includes("pub")||o.includes("nightclub")?"Bar/pub CTA invites experience and visit - social proof driven for hospitality":o.includes("coffee")||o.includes("cafe")?"Coffee CTA focuses on taste and quality differentiation - sensory appeal for beverage business":o.includes("mattress")||o.includes("furniture")?"Furniture CTA emphasizes finding perfect match - personal fit is crucial for big purchases":o.includes("restaurant")||o.includes("food")?"Restaurant CTA focuses on experience and reservation - driving immediate action":"Generic CTA chosen - industry-specific patterns not found, using direct action prompt"}}class Et{async generate(e,t,o="newsletter"){const n=e.type==="counter_intuitive"?J:K,r=this.generateSubjectLine(e,t,n.id),s=this.generatePreheader(e),i=this.generateEmailBody(e,t,n.id),c=this.generateCTA(e,t),a=this.generatePS(e),d=o==="newsletter"?"email-newsletter":o==="promo"?"email-promo":"email-sequence";return{id:`email-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,insightId:e.id,format:d,content:{headline:r,hook:s,body:i,cta:c,subjectLine:r,preheader:s,ps:a},psychology:{principle:n.id==="email-pas"?"Loss Aversion":"Curiosity Gap",trigger:{type:n.id==="email-pas"?"fear":"curiosity",strength:.85,target:"conversion"},persuasionTechnique:n.id==="email-pas"?"Problem Amplification":"AIDA",expectedReaction:"I need to click this and learn more"},optimization:{powerWords:this.extractPowerWords(r+i),framingDevice:n.name,narrativeStructure:n.stages.map(u=>u.name).join(" â†’ "),pacing:"Medium (email-optimized)"},meta:{platform:["Email"],tone:"professional",targetAudience:t.targetAudience},prediction:{engagementScore:.75,viralPotential:.3,leadGeneration:.9,brandImpact:"positive",confidenceLevel:e.confidence},framework:{id:n.id,name:n.name,stages:n.stages.map(u=>u.name),reasoning:`${n.name} selected because it's proven for ${o} emails`},metadata:{generatedAt:new Date,model:"EmailGenerator",iterationCount:1,impactScore:e.confidence}}}generateSubjectLine(e,t,o){return o==="email-pas"?`${t.name}: ${e.insight.split(".")[0].substring(0,50)}?`:e.contentAngle||e.insight.substring(0,60)}generatePreheader(e){return e.whyProfound.substring(0,100)}generateEmailBody(e,t,o){return o==="email-pas"?`Hey there,

${e.insight}

${e.whyProfound}

${e.evidence.slice(0,2).map(n=>`â€¢ ${n}`).join(`
`)}

${e.whyNow?`Why this matters now: ${e.whyNow}`:""}

Ready to take action?`:`Hi,

${e.insight}

Here's why this matters:
${e.whyProfound}

The evidence:
${e.evidence.slice(0,3).map(n=>`â€¢ ${n}`).join(`
`)}

${e.whyNow?`
${e.whyNow}`:""}`}generateCTA(e,t){return`Learn more about how ${t.name} can help â†’`}generatePS(e){return`P.S. ${e.expectedReaction}`}extractPowerWords(e){return["discover","proven","exclusive","new","secret","now","today"].filter(o=>e.toLowerCase().includes(o))}}class $t{async generate(e,t,o="how-to"){const n=o==="listicle"?Z:X,r=this.generateSEOHeadline(e,t,o),s=this.generateMetaDescription(e),i=this.generateSlug(r),c=this.generateBlogBody(e,t,o),a=o==="how-to"?"blog-how-to":o==="listicle"?"blog-listicle":"blog-case-study";return{id:`blog-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,insightId:e.id,format:a,content:{headline:r,hook:`## Introduction

${e.whyProfound}`,body:c,cta:`

## Conclusion

Ready to implement these insights? [Contact ${t.name}](#) to learn more.`,seoTitle:r,metaDescription:s,slug:i},psychology:{principle:"Social Proof + Authority",trigger:{type:"curiosity",strength:.75,target:"education"},persuasionTechnique:"Educational Authority",expectedReaction:"This is valuable, actionable content"},optimization:{powerWords:this.extractPowerWords(r+c),framingDevice:n.name,narrativeStructure:n.stages.map(d=>d.name).join(" â†’ "),pacing:"Slow (comprehensive)"},meta:{platform:["Blog","LinkedIn"],tone:"educational",targetAudience:t.targetAudience},prediction:{engagementScore:.7,viralPotential:.5,leadGeneration:.8,brandImpact:"positive",confidenceLevel:e.confidence},framework:{id:n.id,name:n.name,stages:n.stages.map(d=>d.name),reasoning:`${n.name} selected for SEO and educational value`},metadata:{generatedAt:new Date,model:"BlogGenerator",iterationCount:1,impactScore:e.confidence}}}generateSEOHeadline(e,t,o){return o==="listicle"?`5 ${t.industry} Insights That ${e.expectedReaction}`:`How to ${e.contentAngle||e.insight.substring(0,60)}`}generateMetaDescription(e){return`${e.insight.substring(0,140)}...`}generateSlug(e){return e.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"").substring(0,60)}generateBlogBody(e,t,o){return o==="listicle"?`## The Insights

### 1. ${e.insight}

${e.whyProfound}

${e.evidence.map((n,r)=>`**Evidence ${r+1}:** ${n}`).join(`

`)}

### 2-5. [Additional insights would be generated from other synapses]

## Why This Matters

${e.whyNow||e.expectedReaction}`:`## Understanding the Challenge

${e.insight}

## Why This Matters

${e.whyProfound}

## The Evidence

${e.evidence.map((n,r)=>`${r+1}. ${n}`).join(`
`)}

## Taking Action

${e.contentAngle||"Here's how to apply this insight to your business."}

${e.whyNow?`
## Timing is Critical

${e.whyNow}`:""}`}extractPowerWords(e){return["ultimate","complete","proven","essential","powerful","expert"].filter(o=>e.toLowerCase().includes(o))}}class Ot{async generate(e,t,o="hero"){const n=o==="sales"?ee:Q,r=this.generateHeadline(e,t),s=this.generateSubheadline(e,t),i=this.generateLandingPageBody(e,t,o),c=this.generateCTA(t),a=this.generateBulletPoints(e),d=this.generateSocialProof(t),u=o==="hero"?"landing-hero":"landing-sales";return{id:`landing-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,insightId:e.id,format:u,content:{headline:r,hook:s,body:i,cta:c,subheadline:s,bulletPoints:a,socialProof:d},psychology:{principle:o==="sales"?"Loss Aversion":"Clarity + Relevance",trigger:{type:o==="sales"?"fear":"aspiration",strength:.95,target:"conversion"},persuasionTechnique:n.name,expectedReaction:"This is exactly what I need"},optimization:{powerWords:this.extractPowerWords(r+i),framingDevice:n.name,narrativeStructure:n.stages.map(g=>g.name).join(" â†’ "),pacing:"Fast (conversion-focused)"},meta:{platform:["Web"],tone:"professional",targetAudience:t.targetAudience},prediction:{engagementScore:.6,viralPotential:.2,leadGeneration:1,brandImpact:"positive",confidenceLevel:e.confidence},framework:{id:n.id,name:n.name,stages:n.stages.map(g=>g.name),reasoning:`${n.name} is proven for ${o} landing page conversion`},metadata:{generatedAt:new Date,model:"LandingPageGenerator",iterationCount:1,impactScore:e.confidence}}}generateHeadline(e,t){return`${e.contentAngle||e.insight} | ${t.name}`}generateSubheadline(e,t){return`${t.name} helps ${t.targetAudience} ${e.whyProfound.toLowerCase()}`}generateLandingPageBody(e,t,o){return o==="sales"?`## The Problem

${e.insight}

## Why It Matters

${e.whyProfound}

## The Proof

${e.evidence.map((n,r)=>`**${r+1}.** ${n}`).join(`

`)}

## How ${t.name} Solves This

We've developed a proven approach that delivers results.

${e.whyNow?`
## Act Now

${e.whyNow}`:""}`:`${e.whyProfound}

${e.evidence.map(n=>`âœ“ ${n}`).join(`
`)}

${e.whyNow||""}`}generateCTA(e){return`Get Started with ${e.name}`}generateBulletPoints(e){return e.evidence.slice(0,3)}generateSocialProof(e){return[`Trusted by ${e.industry} leaders`,"Proven results","100% satisfaction guarantee"]}extractPowerWords(e){return["proven","guaranteed","results","now","limited","exclusive"].filter(o=>e.toLowerCase().includes(o))}}const xt="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";class Rt{async generateVariants(e,t,o=["scarcity","fomo","exclusivity"]){console.log("[VariantGenerator] Generating variants with strategies:",o);const n=[];for(let s=0;s<o.length;s++){const i=o[s],c=["A","B","C"][s];try{const a=await this.generateSingleVariant(e,t,i,c);n.push(a)}catch(a){console.error(`[VariantGenerator] Error generating ${i} variant:`,a)}}const r=this.recommendTestOrder(n);return{testId:`test-${Date.now()}`,originalInsightId:e.insightId,variants:n,recommendedTest:r}}async generateSingleVariant(e,t,o,n){const r=this.buildVariantPrompt(e,t,o),s=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${xt}`,"Content-Type":"application/json","HTTP-Referer":window.location.origin,"X-Title":"MARBA Variant Generator"},body:JSON.stringify({model:"anthropic/claude-3.5-sonnet",messages:[{role:"user",content:r}],temperature:.8,max_tokens:2e3})});if(!s.ok)throw new Error(`OpenRouter API error: ${s.status}`);const c=(await s.json()).choices[0].message.content,a=this.parseVariantContent(c),d={...e,id:`${e.id}-variant-${n}`,content:{...e.content,headline:a.headline,hook:a.hook,body:a.body,cta:a.cta}},u=this.detectDifferences(e,d);return{id:d.id,variantLetter:n,strategy:o,content:d,differenceFromOriginal:u}}buildVariantPrompt(e,t,o){const n=this.getStrategyGuidelines(o);return`You are a conversion copywriter creating an A/B test variant of existing content.

BUSINESS: ${t.name} (${t.industry})
STRATEGY: ${o.toUpperCase()}

ORIGINAL CONTENT:
Headline: ${e.content.headline}
Hook: ${e.content.hook}
Body: ${e.content.body}
CTA: ${e.content.cta}

---

YOUR TASK: Create a ${o} variant of this content.

${n}

CRITICAL RULES:
1. Keep the core message and value proposition
2. Adjust the psychological angle to emphasize ${o}
3. Maintain the same length (+/- 20%)
4. Keep it brand-safe and professional
5. Make the changes subtle but measurable

OUTPUT FORMAT (return ONLY the variant content, no explanations):

HEADLINE: [${o} variant headline]
HOOK: [${o} variant hook]
BODY: [${o} variant body]
CTA: [${o} variant CTA]`}getStrategyGuidelines(e){switch(e){case"scarcity":return`SCARCITY STRATEGY:
- Emphasize limited availability or spots
- Use phrases like "limited", "only X left", "filling up fast"
- Create urgency around supply constraints
- Maintain authenticity (don't manufacture fake scarcity)

EXAMPLES:
âŒ "Book your event today"
âœ… "Only 3 December slots remaining"

âŒ "We're available for corporate events"
âœ… "Last week for December bookings before we're fully booked"`;case"fomo":return`FOMO STRATEGY (Fear of Missing Out):
- Emphasize what they'll miss if they don't act
- Use social proof and bandwagon effect
- Highlight others who have already acted
- Create urgency around opportunity cost

EXAMPLES:
âŒ "Book your holiday party"
âœ… "While your competitors are securing their December dates, will you be left scrambling?"

âŒ "Call us today"
âœ… "Don't be the team without a venue this holiday season"`;case"exclusivity":return`EXCLUSIVITY STRATEGY:
- Position as VIP or exclusive opportunity
- Emphasize quality over quantity
- Use "insider", "select", "preferred" language
- Make them feel special for being considered

EXAMPLES:
âŒ "We're available for bookings"
âœ… "Accepting a select number of corporate events for discerning teams"

âŒ "Book now"
âœ… "For serious event planners who won't settle for the usual"`;case"urgency":return`URGENCY STRATEGY:
- Emphasize time-sensitive nature
- Use deadlines and countdowns
- Create pressure around timing
- Maintain credibility (real deadlines only)

EXAMPLES:
âŒ "Contact us"
âœ… "Spots close Friday at 5pm"

âŒ "Book your event"
âœ… "This week only: December availability"`;case"social-proof":return`SOCIAL PROOF STRATEGY:
- Emphasize popularity and trust
- Reference other customers or usage
- Use testimonials or statistics
- Build credibility through numbers

EXAMPLES:
âŒ "Great venue"
âœ… "Trusted by 50+ Dallas companies for their holiday events"

âŒ "Book with us"
âœ… "Join the teams who refuse to settle for crowded chain restaurants"`;default:return""}}parseVariantContent(e){const t=e.split(`
`).filter(s=>s.trim()),o={headline:"",hook:"",body:"",cta:""};let n="",r=[];for(const s of t)if(s.startsWith("HEADLINE:"))n="headline",o.headline=s.replace("HEADLINE:","").trim();else if(s.startsWith("HOOK:"))n="hook",o.hook=s.replace("HOOK:","").trim();else if(s.startsWith("BODY:")){n="body";const i=s.replace("BODY:","").trim();i&&r.push(i)}else s.startsWith("CTA:")?(n="cta",o.cta=s.replace("CTA:","").trim()):n==="headline"&&!o.headline?o.headline=s.trim():n==="hook"&&!o.hook?o.hook=s.trim():n==="body"?r.push(s.trim()):n==="cta"&&!o.cta&&(o.cta=s.trim());return o.body=r.join(`

`),o}detectDifferences(e,t){const o=[];return e.content.headline!==t.content.headline&&o.push(`Headline: Changed from "${e.content.headline.substring(0,50)}..." to "${t.content.headline.substring(0,50)}..."`),e.content.hook!==t.content.hook&&o.push("Hook: Adjusted psychological angle"),e.content.body!==t.content.body&&o.push("Body: Reframed with variant strategy"),e.content.cta!==t.content.cta&&o.push("CTA: Modified call-to-action"),o.length>0?o:["Minor refinements applied"]}recommendTestOrder(e){const t=e.find(o=>o.strategy==="scarcity");return t?`Test Variant ${t.variantLetter} (Scarcity) first - typically highest converting`:e.length>0?`Test Variant ${e[0].variantLetter} (${e[0].strategy}) first`:"No variants generated"}}const te={linkedin:{platform:"linkedin",headline:{min:40,max:150,optimal:120},body:{min:200,max:3e3,optimal:1300},total:{min:300,max:3e3,optimal:1400}},twitter:{platform:"twitter",headline:{min:30,max:100,optimal:80},body:{min:50,max:280,optimal:240},total:{min:100,max:280,optimal:250}},facebook:{platform:"facebook",headline:{min:40,max:150,optimal:120},body:{min:100,max:5e3,optimal:1500},total:{min:200,max:5e3,optimal:1600}},instagram:{platform:"instagram",headline:{min:30,max:100,optimal:80},body:{min:100,max:2200,optimal:1e3},total:{min:150,max:2200,optimal:1100}},tiktok:{platform:"tiktok",headline:{min:30,max:100,optimal:80},body:{min:80,max:2200,optimal:800},total:{min:120,max:2200,optimal:900}},youtube:{platform:"youtube",headline:{min:40,max:100,optimal:70},body:{min:100,max:5e3,optimal:2e3},total:{min:150,max:5e3,optimal:2100}}};function R(l){return te[l]}class _t{validateContent(e,t=["linkedin","twitter"]){const o=[];for(const c of t)o.push(this.validateHeadline(e,c)),o.push(this.validateHook(e,c)),o.push(this.validateBody(e,c)),o.push(this.validateCTA(e,c)),o.push(this.validateTotal(e,c));const n=o.some(c=>c.status==="error"),r=o.some(c=>c.status==="warning"),s=n?"error":r?"warning":"valid",i=this.generateRecommendations(o);return{contentId:e.id,isValid:!n,validations:o,overallStatus:s,recommendations:i}}validateHeadline(e,t){var a;const o=((a=e.content)==null?void 0:a.headline)||"",n=o.length,r=R(t);if(!r||!r.headline)return{platform:t,section:"headline",characterCount:n,limit:1e3,optimal:100,status:"valid",message:`${n} chars`};const{min:s,max:i,optimal:c}=r.headline;return this.createValidation(t,"headline",n,s,i,c,o)}validateHook(e,t){var a;const o=((a=e.content)==null?void 0:a.hook)||"",n=o.length,r=R(t);if(!r||!r.body)return{platform:t,section:"hook",characterCount:n,limit:3e3,optimal:300,status:"valid",message:`${n} chars`};const{min:s,max:i,optimal:c}=r.body;return this.createValidation(t,"hook",n,s,i,c,o)}validateBody(e,t){var a;const o=((a=e.content)==null?void 0:a.body)||"",n=o.length,r=R(t);if(!r||!r.body)return{platform:t,section:"body",characterCount:n,limit:5e3,optimal:1500,status:"valid",message:`${n} chars`};const{min:s,max:i,optimal:c}=r.body;return this.createValidation(t,"body",n,s,i,c,o)}validateCTA(e,t){var a;const o=((a=e.content)==null?void 0:a.cta)||"",n=o.length,r=R(t);if(!r||!r.headline)return{platform:t,section:"cta",characterCount:n,limit:150,optimal:100,status:"valid",message:`${n} chars`};const{min:s,max:i,optimal:c}=r.headline;return this.createValidation(t,"cta",n,s,i,c,o)}validateTotal(e,t){var c,a,d,u,g,p,h,f;const o=(((a=(c=e.content)==null?void 0:c.headline)==null?void 0:a.length)||0)+(((u=(d=e.content)==null?void 0:d.hook)==null?void 0:u.length)||0)+(((p=(g=e.content)==null?void 0:g.body)==null?void 0:p.length)||0)+(((f=(h=e.content)==null?void 0:h.cta)==null?void 0:f.length)||0),n=R(t);if(!n||!n.total)return{platform:t,section:"total",characterCount:o,limit:5e3,optimal:2e3,status:"valid",message:`Total: ${o} chars`};const{min:r,max:s,optimal:i}=n.total;return this.createValidation(t,"total",o,r,s,i,`Total: ${o} chars`)}createValidation(e,t,o,n,r,s,i){let c,a;if(o<n)c="error",a=`Too short: ${o}/${n} chars (needs ${n-o} more)`;else if(o>r)c="error",a=`Too long: ${o}/${r} chars (over by ${o-r})`;else if(o<s*.8||o>s*1.2){c="warning";const d=Math.abs(o-s);a=`${o} chars (${d} from optimal ${s})`}else c="valid",a=`${o} chars âœ“`;return{platform:e,section:t,characterCount:o,limit:r,optimal:s,status:c,message:a}}generateRecommendations(e){const t=[],o=e.filter(i=>i.status==="error"),n=e.filter(i=>i.status==="warning");if(o.length===0&&n.length===0)return t.push("âœ… All content meets platform requirements"),t;const r=this.groupByPlatform(o),s=this.groupByPlatform(n);for(const[i,c]of Object.entries(r))for(const a of c)a.characterCount<te[a.platform].headline.min?t.push(`âŒ ${i} ${a.section}: Add ${te[a.platform].headline.min-a.characterCount} more characters`):t.push(`âŒ ${i} ${a.section}: Reduce by ${a.characterCount-a.limit} characters`);for(const[i,c]of Object.entries(s))for(const a of c){const d=Math.abs(a.characterCount-a.optimal);a.characterCount<a.optimal?t.push(`âš ï¸ ${i} ${a.section}: Consider adding ${d} characters for optimal engagement`):t.push(`âš ï¸ ${i} ${a.section}: Consider reducing by ${d} characters for optimal engagement`)}return t}groupByPlatform(e){const t={};for(const o of e)t[o.platform]||(t[o.platform]=[]),t[o.platform].push(o);return t}isValidForPlatform(e,t){return this.validateContent(e,[t]).isValid}getCharacterSummary(e){return{headline:e.content.headline.length,hook:e.content.hook.length,body:e.content.body.length,cta:e.content.cta.length,total:e.content.headline.length+e.content.hook.length+e.content.body.length+e.content.cta.length}}}const Nt="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";class Lt{async regenerateSection(e,t,o,n,r){console.log(`[SectionRegenerator] Regenerating ${t} for content ${e.id}`);const s=this.getCurrentSectionContent(e,t),i=this.buildRegenerationPrompt(e,t,s,o,n,r);try{const c=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${Nt}`,"Content-Type":"application/json","HTTP-Referer":window.location.origin,"X-Title":"MARBA Section Regenerator"},body:JSON.stringify({model:"anthropic/claude-3.5-sonnet",messages:[{role:"user",content:i}],temperature:.8,max_tokens:1500})});if(!c.ok)throw new Error(`OpenRouter API error: ${c.status}`);const a=await c.json(),d=this.parseRegeneratedOptions(a.choices[0].message.content,t);return{section:t,original:s,regenerated:d,selectedIndex:void 0,reasoning:r||`Regenerated ${t} with fresh variations`}}catch(c){throw console.error("[SectionRegenerator] Error:",c),c}}getCurrentSectionContent(e,t){switch(t){case"headline":return e.content.headline;case"hook":return e.content.hook;case"body":return e.content.body;case"cta":return e.content.cta;default:return""}}buildRegenerationPrompt(e,t,o,n,r,s){const i=this.getSectionGuidelines(t,e.format),c=s?`

IMPROVEMENT DIRECTION: ${s}`:"";return`You are a master copywriter regenerating a single section of existing content.

BUSINESS: ${n.name} (${n.industry})
CONTENT FORMAT: ${e.format}
SECTION TO REGENERATE: ${t}

CONTEXT (DO NOT REGENERATE):
${this.buildContextSection(e,t)}

CURRENT ${t.toUpperCase()}:
"${o}"

ORIGINAL INSIGHT:
${r.insight}

WHY IT'S PROFOUND:
${r.whyProfound||"Strong emotional resonance"}

${i}${c}

CRITICAL REQUIREMENTS:
1. Generate EXACTLY 3-5 variations
2. Each must be distinctly different from the others
3. Maintain the same core message and psychology
4. Keep similar length to original (+/- 20%)
5. Number each variation clearly (OPTION 1, OPTION 2, etc.)
6. NO explanations or commentary - just the variations

OUTPUT FORMAT:

OPTION 1:
[First variation here]

OPTION 2:
[Second variation here]

OPTION 3:
[Third variation here]

OPTION 4:
[Fourth variation here - optional]

OPTION 5:
[Fifth variation here - optional]`}buildContextSection(e,t){const o=[];return t!=="headline"&&o.push(`Headline: "${e.content.headline}"`),t!=="hook"&&o.push(`Hook: "${e.content.hook.substring(0,100)}..."`),t!=="body"&&o.push(`Body: "${e.content.body.substring(0,100)}..."`),t!=="cta"&&o.push(`CTA: "${e.content.cta}"`),o.join(`
`)}getSectionGuidelines(e,t){switch(e){case"headline":return`HEADLINE GUIDELINES:
- Grab attention in 10-15 words
- Create curiosity or intrigue
- Should work standalone (people read headlines first)
- Avoid clickbait or misleading angles
- Match the ${t} format's style

GOOD HEADLINES:
âœ… "The parking spot strategy nobody talks about"
âœ… "Why December bookings happen in November"
âœ… "What 50+ event planners know about venues"`;case"hook":return`HOOK GUIDELINES:
- First 1-2 sentences that pull reader in
- Build on headline's promise
- Create "I need to read this" feeling
- Use pattern interrupts or surprising facts
- Lead naturally into body

GOOD HOOKS:
âœ… "Most event planners make this mistake every year..."
âœ… "Here's what nobody tells you about holiday bookings..."
âœ… "The data reveals something surprising..."`;case"body":return`BODY GUIDELINES:
- Deliver on hook's promise with substance
- Use 2-4 paragraphs for ${t}
- Include specific details or evidence
- Build credibility and trust
- Connect emotionally while staying factual

GOOD BODY CONTENT:
âœ… Includes specific numbers or examples
âœ… Addresses reader's situation directly
âœ… Builds logical case for your point
âœ… Uses paragraph breaks for readability`;case"cta":return`CTA GUIDELINES:
- Clear, direct action step
- Reduce friction (make it easy)
- Create urgency without pressure
- Connect to the content's promise
- ${t==="controversial-post"?"Can be softer/educational":"Should be direct"}

GOOD CTAs:
âœ… "Book your December event before spots fill up"
âœ… "Schedule a consultation today"
âœ… "See why 50+ teams choose [Business]"
âœ… "Visit us and experience the difference"`;default:return""}}parseRegeneratedOptions(e,t){const o=[],n=e.split(`
`);let r="",s=!1;for(const i of n){const c=i.trim();/^OPTION\s+\d+:?$/i.test(c)?(r.trim()&&o.push(r.trim()),r="",s=!0):/^OPTION\s+\d+:\s+.+/i.test(c)?(r.trim()&&o.push(r.trim()),r=c.replace(/^OPTION\s+\d+:\s*/i,""),s=!0):s&&c&&(r?r+=`

`+c:r=c)}return r.trim()&&o.push(r.trim()),o.length===0?e.split(/\n\n+/).map(c=>c.trim()).filter(c=>c.length>10).slice(0,5):o.slice(0,5)}applyRegeneration(e,t,o){if(o<0||o>=t.regenerated.length)throw new Error(`Invalid selection index: ${o}`);const n={...e},r=t.regenerated[o];switch(t.section){case"headline":n.content={...n.content,headline:r};break;case"hook":n.content={...n.content,hook:r};break;case"body":n.content={...n.content,body:r};break;case"cta":n.content={...n.content,cta:r};break}return n.metadata={...n.metadata,iterationCount:(n.metadata.iterationCount||0)+1,generatedAt:new Date},n}createHistoryEntry(e,t,o){return{contentId:e.id,section:t.section,timestamp:new Date,original:t.original,regenerated:t.regenerated,selected:t.regenerated[o],reason:t.reasoning}}async regenerateMultipleSections(e,t,o,n){const r=[];for(const s of t)try{const i=await this.regenerateSection(e,s,o,n);r.push(i)}catch(i){console.error(`[SectionRegenerator] Error regenerating ${s}:`,i)}return r}}const Dt="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";class Ft{async detectContrarianAngles(e){console.log("[ContrarianDetector] Analyzing",e.length,"insights for contrarian angles");const t=this.extractCompetitorClaims(e),o=[];for(const r of t)try{const s=await this.generateContrarianAngle(r,e);s&&o.push(s)}catch(s){console.error("[ContrarianDetector] Error generating angle for claim:",r,s)}const n=this.rankByDifferentiation(o);return{competitorClaims:t,contrarianAngles:n,topOpportunity:n[0]||null}}extractCompetitorClaims(e){const t=[],o=new Map;for(const n of e){if(n.evidence&&Array.isArray(n.evidence)){for(const r of n.evidence)if(typeof r=="string"&&(r.toLowerCase().includes("competitor")||r.toLowerCase().includes("everyone")||r.toLowerCase().includes("industry")||r.toLowerCase().includes("typical"))){const s=this.normalizeClaimText(r),i=o.get(s);i?o.set(s,{count:i.count+1,confidence:Math.min(i.confidence+.1,1)}):o.set(s,{count:1,confidence:n.confidence||.7})}}if(n.insight&&(n.insight.toLowerCase().includes("unlike")||n.insight.toLowerCase().includes("while others")||n.insight.toLowerCase().includes("most"))){const r=this.normalizeClaimText(n.insight),s=o.get(r);s?o.set(r,{count:s.count+1,confidence:Math.min(s.confidence+.1,1)}):o.set(r,{count:1,confidence:n.confidence||.7})}}for(const[n,r]of o.entries())t.push({claim:n,competitor:"Industry consensus",frequency:r.count,confidence:r.confidence});return t.sort((n,r)=>r.frequency-n.frequency).slice(0,10)}normalizeClaimText(e){return e.toLowerCase().replace(/[^a-z0-9\s]/g,"").substring(0,200)}async generateContrarianAngle(e,t){const o=this.buildContrarianPrompt(e,t);try{const n=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${Dt}`,"Content-Type":"application/json","HTTP-Referer":window.location.origin,"X-Title":"MARBA Contrarian Detector"},body:JSON.stringify({model:"anthropic/claude-3.5-sonnet",messages:[{role:"user",content:o}],temperature:.7,max_tokens:1500})});if(!n.ok)throw new Error(`OpenRouter API error: ${n.status}`);const r=await n.json(),s=this.parseContrarianResponse(r.choices[0].message.content);return s?{id:`contrarian-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,competitorClaim:e.claim,contrarianAngle:s.angle,reasoning:s.reasoning,evidenceSupport:s.evidence,riskLevel:this.assessRiskLevel(s.angle),differentiationScore:this.calculateDifferentiationScore(s.angle,e)}:null}catch(n){return console.error("[ContrarianDetector] Error calling API:",n),null}}buildContrarianPrompt(e,t){const o=t.filter(n=>n.confidence>.7).slice(0,3).map(n=>n.insight).join(`
- `);return`You are a strategic marketing analyst specializing in contrarian positioning.

COMPETITOR CLAIM: "${e.claim}"

SUPPORTING INSIGHTS:
- ${o}

YOUR TASK: Create a contrarian angle that challenges this claim in an authentic, evidence-based way.

REQUIREMENTS:
1. The contrarian angle must be TRUE and defensible (not just provocative)
2. Should flip the conventional wisdom in an interesting way
3. Must be specific and actionable (not vague)
4. Should feel fresh, not cynical or negative

FORMAT YOUR RESPONSE EXACTLY AS:

CONTRARIAN ANGLE: [Your contrarian positioning statement]

REASONING: [Why this challenges the competitor claim and why it's true]

EVIDENCE:
- [Supporting evidence point 1]
- [Supporting evidence point 2]
- [Supporting evidence point 3]

EXAMPLES OF GOOD CONTRARIAN ANGLES:
âŒ "We're better than competitors" (too vague)
âœ… "While competitors optimize for 'cleanliness,' we optimize for health outcomes"

âŒ "Everyone is wrong about X" (too negative)
âœ… "What most call 'customer service' is actually just problem management. We prevent problems."`}parseContrarianResponse(e){try{const t=e.split(`
`).filter(i=>i.trim());let o="",n="";const r=[];let s="";for(const i of t)i.startsWith("CONTRARIAN ANGLE:")?(s="angle",o=i.replace("CONTRARIAN ANGLE:","").trim()):i.startsWith("REASONING:")?(s="reasoning",n=i.replace("REASONING:","").trim()):i.startsWith("EVIDENCE:")?s="evidence":s==="angle"&&!o?o=i.trim():s==="reasoning"&&i.trim()&&!i.startsWith("-")?n+=" "+i.trim():s==="evidence"&&i.trim().startsWith("-")&&r.push(i.replace(/^-\s*/,"").trim());return!o||!n?null:{angle:o,reasoning:n.trim(),evidence:r.length>0?r:["No specific evidence provided"]}}catch(t){return console.error("[ContrarianDetector] Error parsing response:",t),null}}assessRiskLevel(e){const t=e.toLowerCase();return["never","always","impossible","wrong","lie","scam","fake","fraud"].some(r=>t.includes(r))?"high":["most","everyone","nobody","all","none"].some(r=>t.includes(r))?"medium":"low"}calculateDifferentiationScore(e,t){let o=.5;return o+=Math.min(t.frequency*.05,.2),o+=t.confidence*.15,e.length>50&&e.length<200&&(o+=.1),["while","unlike","instead of","rather than","actually"].some(r=>e.toLowerCase().includes(r))&&(o+=.05),Math.min(o,1)}rankByDifferentiation(e){return e.sort((t,o)=>{if(t.riskLevel!==o.riskLevel){const n={low:3,medium:2,high:1};return n[o.riskLevel]-n[t.riskLevel]}return o.differentiationScore-t.differentiationScore}).slice(0,5)}async getContrarianAngleForInsight(e){return(await this.detectContrarianAngles([e])).topOpportunity}}class Vt{constructor(){y(this,"hookGenerator");y(this,"storyGenerator");y(this,"dataGenerator");y(this,"controversialGenerator");y(this,"emailGenerator");y(this,"blogGenerator");y(this,"landingPageGenerator");y(this,"variantGenerator");y(this,"characterValidator");y(this,"sectionRegenerator");y(this,"contrarianDetector");this.hookGenerator=new Ct,this.storyGenerator=new kt,this.dataGenerator=new It,this.controversialGenerator=new Pt,this.emailGenerator=new Et,this.blogGenerator=new $t,this.landingPageGenerator=new Ot,this.variantGenerator=new Rt,this.characterValidator=new _t,this.sectionRegenerator=new Lt,this.contrarianDetector=new Ft}async generate(e,t,o={}){const n=Date.now(),r={maxContent:o.maxContent||10,formats:o.formats||["hook-post","story-post","data-post","controversial-post"],multiFormat:o.multiFormat!==void 0?o.multiFormat:!1,minImpactScore:o.minImpactScore||.7,platform:o.platform||"linkedin"},s=o.platforms||[r.platform];console.log(`ðŸŽ¨ Generating breakthrough content for ${e.length} insights across ${s.length} platforms...`);const i=[],c=[];for(const h of e)try{if(r.multiFormat){const f=this.selectFormats(h,r.formats);for(const m of f){const v=await this.generateForAllPlatforms(h,t,m,s);v&&i.push(v)}}else{const f=this.selectBestFormat(h,r.formats),m=await this.generateForAllPlatforms(h,t,f,s);m&&i.push(m)}}catch(f){const m=f instanceof Error?f.message:String(f);console.error(`Error generating content for insight ${h.id}:`,f),c.push(`Insight ${h.id}: ${m}`)}const a=i.filter(h=>(h.metadata.impactScore||0)>=r.minImpactScore);console.log(`âœ… Generated ${a.length} content pieces (filtered from ${i.length})`);const u=this.rankContent(a).slice(0,r.maxContent),g=this.calculateStats(u,i.length),p=Date.now()-n;return{content:u,stats:g,metadata:{generatedAt:new Date,processingTimeMs:p,insightsProcessed:e.length,contentGenerated:u.length,errors:c.length>0?c:void 0}}}selectBestFormat(e,t){const n={unexpected_connection:"hook-post",counter_intuitive:"controversial-post",predictive_opportunity:"data-post",deep_psychology:"story-post",cultural_moment:"story-post",hidden_pattern:"data-post",strategic_implication:"data-post",behavioral_contradiction:"controversial-post"}[e.type]||"hook-post";return t.includes(n)?n:t[0]}selectFormats(e,t){const n=[this.selectBestFormat(e,t)];return e.type==="counter_intuitive"?(t.includes("data-post")&&!n.includes("data-post")&&n.push("data-post"),t.includes("hook-post")&&!n.includes("hook-post")&&n.push("hook-post")):e.type==="deep_psychology"?t.includes("hook-post")&&!n.includes("hook-post")&&n.push("hook-post"):e.type==="unexpected_connection"&&t.includes("story-post")&&!n.includes("story-post")&&n.push("story-post"),n.slice(0,2)}async generateForAllPlatforms(e,t,o,n){const r=n[0]||"linkedin",s=await this.generateForFormat(e,t,o,r);if(!s)return null;const i={};for(const c of n){const a=c==="x"?"twitter":c,d=await this.generateForFormat(e,t,o,a);if(console.log(`[SynapseContentGenerator] Variant generated for ${c}:`,d),d){const u={headline:d.content.headline,hook:d.content.hook,body:d.content.body,cta:d.content.cta,hashtags:d.content.hashtags||[]};console.log(`[SynapseContentGenerator] Extracted content for ${c}:`,u),i[c]=u}else console.warn(`[SynapseContentGenerator] No variant generated for ${c}`)}return{...s,platformVariants:i,platforms:n}}async generateForFormat(e,t,o,n="linkedin"){try{switch(o){case"hook-post":return await this.hookGenerator.generate(e,t);case"story-post":return await this.storyGenerator.generate(e,t);case"data-post":return await this.dataGenerator.generate(e,t);case"controversial-post":return await this.controversialGenerator.generate(e,t,n);case"email-newsletter":return await this.emailGenerator.generate(e,t,"newsletter");case"email-promo":return await this.emailGenerator.generate(e,t,"promo");case"email-sequence":return await this.emailGenerator.generate(e,t,"sequence");case"blog-post":case"blog-how-to":return await this.blogGenerator.generate(e,t,"how-to");case"blog-listicle":return await this.blogGenerator.generate(e,t,"listicle");case"blog-case-study":return await this.blogGenerator.generate(e,t,"case-study");case"landing-page":case"landing-hero":return await this.landingPageGenerator.generate(e,t,"hero");case"landing-sales":return await this.landingPageGenerator.generate(e,t,"sales");default:return console.warn(`Unknown format: ${o}`),null}}catch(r){throw console.error(`[ContentGen] Error generating ${o} for insight ${e.id}:`,r),r}}rankContent(e){return e.sort((t,o)=>{const n=this.calculateCompositeScore(t);return this.calculateCompositeScore(o)-n})}calculateCompositeScore(e){const t={engagement:.3,viral:.25,leadGen:.25,brand:.2};return e.prediction.engagementScore*t.engagement+e.prediction.viralPotential*t.viral+e.prediction.leadGeneration*t.leadGen+e.prediction.brandImpact*t.brand}calculateStats(e,t){if(e.length===0)return{totalGenerated:0,byFormat:{},averageScores:{engagement:0,viral:0,leadGen:0,brand:0},topFormats:[]};const o={"hook-post":0,"story-post":0,"data-post":0,"controversial-post":0,thread:0,carousel:0};e.forEach(a=>{o[a.format]=(o[a.format]||0)+1});const n=e.reduce((a,d)=>a+d.prediction.engagementScore,0)/e.length,r=e.reduce((a,d)=>a+d.prediction.viralPotential,0)/e.length,s=e.reduce((a,d)=>a+d.prediction.leadGeneration,0)/e.length,i=e.reduce((a,d)=>a+d.prediction.brandImpact,0)/e.length,c=Object.entries(o).filter(([a,d])=>d>0).sort(([a,d],[u,g])=>g-d).map(([a])=>a);return{totalGenerated:t,byFormat:o,averageScores:{engagement:n,viral:r,leadGen:s,brand:i},topFormats:c}}async generateSingle(e,t,o){const n=o||this.selectBestFormat(e,["hook-post","story-post","data-post","controversial-post"]);return await this.generateForFormat(e,t,n)}async generateAll(e,t){const o=["hook-post","story-post","data-post","controversial-post"],n=[];for(const r of o)try{const s=await this.generateForFormat(e,t,r);s&&n.push(s)}catch(s){console.error(`Error generating ${r}:`,s)}return n}getFormatRecommendation(e){const t=this.selectBestFormat(e,["hook-post","story-post","data-post","controversial-post"]),n=this.selectFormats(e,["hook-post","story-post","data-post","controversial-post"]).filter(s=>s!==t);return{primary:t,alternatives:n,reason:{"hook-post":"Creates curiosity gap that drives engagement","story-post":"Builds emotional connection through narrative","data-post":"Establishes authority with evidence","controversial-post":"Sparks debate and challenges assumptions",thread:"Deep-dive exploration",carousel:"Visual storytelling"}[t]}}async generateVariants(e,t,o){return console.log("[ContentGenerator] Generating A/B variants for content:",e.id),await this.variantGenerator.generateVariants(e,t,o)}validateContent(e,t){return this.characterValidator.validateContent(e,t)}getCharacterSummary(e){return this.characterValidator.getCharacterSummary(e)}async regenerateSection(e,t,o,n,r){return await this.sectionRegenerator.regenerateSection(e,t,o,n,r)}applyRegeneration(e,t,o){return this.sectionRegenerator.applyRegeneration(e,t,o)}async detectContrarianAngles(e){return await this.contrarianDetector.detectContrarianAngles(e)}}const Mt="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";class Yt{async enhance(e,t,o){const n=this.getEdginessLabel(o),r=this.buildEnhancementPrompt(e,t,o,n);console.log("[HumorOptimizer] Enhancing content with edginess level:",o,n);try{const s=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${Mt}`,"Content-Type":"application/json","HTTP-Referer":window.location.origin,"X-Title":"MARBA Synapse Humor Optimizer"},body:JSON.stringify({model:"anthropic/claude-3.5-sonnet",messages:[{role:"user",content:r}],temperature:.7,max_tokens:2e3})});if(!s.ok)throw new Error(`OpenRouter API error: ${s.status} ${s.statusText}`);const c=(await s.json()).choices[0].message.content;console.log("[HumorOptimizer] Enhanced content received:",c.substring(0,200));const a=this.parseEnhancedContent(c);return{original:{headline:e.content.headline,hook:e.content.hook,body:e.content.body,cta:e.content.cta},enhanced:a,edginessLevel:o,enhancementsApplied:this.detectEnhancements(e,a)}}catch(s){throw console.error("[HumorOptimizer] Enhancement failed:",s),s}}getEdginessLabel(e){return e<=25?"Professional":e<=50?"Approachable":e<=75?"Casual":"Edgy"}buildEnhancementPrompt(e,t,o,n){const r=this.getEdginessGuidelines(o,t.industry);return`You are a professional copywriter enhancing content with humor for a ${t.industry} business.

BUSINESS: ${t.name}
INDUSTRY: ${t.industry}
EDGINESS LEVEL: ${o}/100 (${n})

CURRENT CONTENT:

Headline: ${e.content.headline}
Hook: ${e.content.hook}
Body: ${e.content.body}
CTA: ${e.content.cta}

---

YOUR TASK: Enhance this content with ${n.toLowerCase()} humor while maintaining professionalism and brand safety.

${r}

CRITICAL RULES:
1. âœ… MAINTAIN CLARITY - Humor should enhance, not obscure the message
2. âœ… BRAND SAFE - No offensive, controversial, or risky humor
3. âœ… INDUSTRY APPROPRIATE - Match the ${t.industry} tone
4. âœ… PRESERVE CTA - Keep the call-to-action clear and actionable
5. âŒ NO FORCED HUMOR - If it doesn't flow naturally, leave it unchanged
6. âŒ NO MEMES/TRENDS - No dated references or TikTok-speak
7. âŒ NO PUNS FOR PUNS' SAKE - Only use wordplay if it strengthens the message

OUTPUT FORMAT (return ONLY the enhanced content, no explanations):

HEADLINE: [enhanced headline]
HOOK: [enhanced hook]
BODY: [enhanced body - preserve line breaks with \\n\\n]
CTA: [enhanced CTA]`}getEdginessGuidelines(e,t){return e<=25?`PROFESSIONAL TONE (Edginess: ${e}/100):
- Use subtle, sophisticated observations
- Employ light irony or understatement
- Keep it polished and corporate-safe
- Think "knowing smile" not "laugh out loud"

GOOD EXAMPLES:
âŒ "Your lawn is a hot mess!"
âœ… "Your lawn has strong opinions about summer"

âŒ "That meeting could've been an email"
âœ… "Efficient meetings start with great coffee"`:e<=50?`APPROACHABLE TONE (Edginess: ${e}/100):
- Use relatable, warm observations
- Gentle self-deprecation or shared experiences
- Conversational and friendly
- Think "coffee chat with a colleague"

GOOD EXAMPLES:
âŒ "Adulting is hard"
âœ… "When 'I'll handle it tomorrow' becomes a lifestyle choice"

âŒ "Monday vibes"
âœ… "Monday mornings hit different when your coffee is right"`:e<=75?`CASUAL TONE (Edginess: ${e}/100):
- Use witty, conversational language
- Playful observations about common situations
- More personality, less formality
- Think "text from a clever friend"

GOOD EXAMPLES:
âŒ "We're the best!"
âœ… "We're the 'where have you been all my life' of lawn care"

âŒ "Professional service"
âœ… "Because 'I'll mow it this weekend' is the adult version of 'my dog ate my homework'"`:`EDGY TONE (Edginess: ${e}/100):
- Use bold, attention-grabbing language
- Push boundaries while staying brand-safe
- More irreverent, less corporate
- Think "the friend who tells it like it is"

GOOD EXAMPLES:
âŒ "We're amazing!"
âœ… "That lawn isn't going to passive-aggressively grow itself into an HOA violation. Oh wait, it is."

âŒ "Quality coffee"
âœ… "Because your coworkers deserve better than whatever's happening in that break room pot"

SAFETY LIMITS (DO NOT CROSS):
- No profanity or crude language
- No controversial topics (politics, religion, etc.)
- No making fun of customers
- No liability-creating content (alcohol excess, etc.)`}parseEnhancedContent(e){const t=e.split(`
`).filter(s=>s.trim()),o={headline:"",hook:"",body:"",cta:""};let n="",r=[];for(const s of t)if(s.startsWith("HEADLINE:"))n="headline",o.headline=s.replace("HEADLINE:","").trim();else if(s.startsWith("HOOK:"))n="hook",o.hook=s.replace("HOOK:","").trim();else if(s.startsWith("BODY:")){n="body";const i=s.replace("BODY:","").trim();i&&r.push(i)}else s.startsWith("CTA:")?(n="cta",o.cta=s.replace("CTA:","").trim()):n==="headline"&&!o.headline?o.headline=s.trim():n==="hook"&&!o.hook?o.hook=s.trim():n==="body"?r.push(s.trim()):n==="cta"&&!o.cta&&(o.cta=s.trim());return o.body=r.join(`

`),o}detectEnhancements(e,t){const o=[];return t.headline!==e.content.headline&&o.push("Headline enhanced"),t.hook!==e.content.hook&&o.push("Hook enhanced"),t.body!==e.content.body&&o.push("Body enhanced"),t.cta!==e.content.cta&&o.push("CTA enhanced"),o.length>0?o:["No changes made"]}}class Wt{async discoverCompetitors(e){try{console.log("[CompetitiveIntel] Discovering competitors for:",e.industry);const t=[],o=new Set;try{const s=`top ${e.industry} companies ${e.location||""}`;(await k.searchGoogle(s)).slice(0,10).forEach(c=>{try{const d=new URL(c.link).hostname.replace("www.","");!o.has(d)&&d!==e.ourDomain&&(o.add(d),t.push({domain:d,name:c.title.split(" - ")[0].split(" | ")[0].trim(),url:c.link,source:"serper"}))}catch{}})}catch(s){console.warn("[CompetitiveIntel] Serper search failed:",s)}if(e.location)try{(await k.getPlaces(e.industry,e.location)).slice(0,10).forEach(i=>{if(i.website)try{const a=new URL(i.website).hostname.replace("www.","");!o.has(a)&&a!==e.ourDomain&&(o.add(a),t.push({domain:a,name:i.name,url:i.website,source:"serper"}))}catch{}})}catch(s){console.warn("[CompetitiveIntel] Serper Places failed:",s)}e.ourDomain;const n=e.limit||10,r=t.slice(0,n);return console.log(`[CompetitiveIntel] Discovered ${r.length} competitors`),r}catch(t){throw console.error("[CompetitiveIntel] Competitor discovery failed:",t),t}}async profileCompetitor(e){try{console.log("[CompetitiveIntel] Profiling competitor:",e.domain);const t={domain:e.domain,name:e.name,url:e.url,lastUpdated:new Date().toISOString()},o=b.cacheKeyCompetitorProfile(e.domain),n=await b.get(o);if(n)return console.log("[CompetitiveIntel] Returning cached profile"),n;const[r,s,i,c]=await Promise.allSettled([this.fetchCompetitorMessaging(e.url),this.fetchCompetitorSEO(e.domain),this.fetchCompetitorReviews(e.name),this.fetchCompetitorContent(e.domain)]);return r.status==="fulfilled"&&(t.messaging=r.value),s.status==="fulfilled"&&(t.seo=s.value),i.status==="fulfilled"&&(t.reviews=i.value),c.status==="fulfilled"&&(t.content=c.value),await b.set(o,t,{dataType:"competitor_profile",sourceApi:"aggregated"}),console.log("[CompetitiveIntel] Profile complete:",{hasMessaging:!!t.messaging,hasSEO:!!t.seo,hasReviews:!!t.reviews,hasContent:!!t.content}),t}catch(t){throw console.error("[CompetitiveIntel] Competitor profiling failed:",t),t}}async fetchCompetitorMessaging(e){const t=await we.analyzeWebsite(e);return{valuePropositions:t.valuePropositions,targetAudience:t.targetAudience,problems:t.customerProblems,solutions:t.solutions,differentiators:t.differentiators,confidence:t.confidence}}async fetchCompetitorSEO(e){const t=await N.getDomainOverview(e);return{organicTraffic:t.organic_traffic,paidTraffic:t.paid_keywords,backlinks:t.backlinks,keywords:t.organic_keywords,authorityScore:t.authority_score}}async fetchCompetitorReviews(e){const t=await ye.scrapeGoogleMapsReviews({searchQuery:e,maxReviews:20});if(t.length===0)return;const o=t[0];return{rating:o.rating,count:o.reviewsCount,recentReviews:(o.reviews||[]).slice(0,10).map(n=>({text:n.text,stars:n.stars,date:n.publishedAtDate}))}}async fetchCompetitorContent(e){const[t,o,n]=await Promise.allSettled([N.getKeywordRankings(e).then(r=>r.slice(0,10)),k.getNews(`${e} news`),k.getVideos(e)]);return{topRankingKeywords:t.status==="fulfilled"?t.value.map(r=>r.keyword):[],recentNews:o.status==="fulfilled"?o.value.slice(0,5).map(r=>r.title):[],videoContent:n.status==="fulfilled"?n.value.slice(0,5).map(r=>r.title):[]}}async findContentGaps(e){try{console.log("[CompetitiveIntel] Finding content gaps...");const t=[],o=await N.getKeywordRankings(e.ourDomain),n=new Set(o.map(i=>i.keyword.toLowerCase()));for(const i of e.competitors)try{(await N.getKeywordRankings(i)).slice(0,50).forEach(a=>{const d=a.keyword.toLowerCase();if(!n.has(d)){const u=a.difficulty<30?"easy_win":a.difficulty<60?"medium":"hard";t.push({keyword:a.keyword,searchVolume:a.searchVolume,difficulty:a.difficulty,competitorRank:a.position,competitor:i,opportunity:u,estimatedTraffic:Math.round(a.searchVolume*(a.position<=3?.3:a.position<=10?.1:.05))})}})}catch{console.warn(`[CompetitiveIntel] Failed to get keywords for ${i}`)}const r=t.sort((i,c)=>c.estimatedTraffic-i.estimatedTraffic),s=e.limit||20;return r.slice(0,s)}catch(t){throw console.error("[CompetitiveIntel] Content gap analysis failed:",t),t}}async findMessagingGaps(e){const t=[],o=e.ourProfile.messaging;if(!o)return console.warn("[CompetitiveIntel] No messaging data for our profile"),t;const n=new Set([...o.valuePropositions.map(r=>r.toLowerCase()),...o.differentiators.map(r=>r.toLowerCase())]);return e.competitorProfiles.forEach(r=>{r.messaging&&(r.messaging.valuePropositions.forEach(s=>{n.has(s.toLowerCase())||t.push({category:"value_prop",competitorClaim:s,competitor:r.domain,opportunity:`Consider offering: "${s}"`,confidence:r.messaging.confidence})}),r.messaging.differentiators.forEach(s=>{n.has(s.toLowerCase())||t.push({category:"differentiator",competitorClaim:s,competitor:r.domain,opportunity:`Potential differentiator: "${s}"`,confidence:r.messaging.confidence})}))}),t.sort((r,s)=>s.confidence-r.confidence)}async findPerformanceGaps(e){const t=[];if(e.ourProfile.reviews){const o=e.ourProfile.reviews.rating;e.competitorProfiles.forEach(n=>{if(n.reviews){const r=n.reviews.rating-o;r>.2&&t.push({metric:"rating",ourValue:o,competitorValue:n.reviews.rating,competitor:n.domain,gap:r,opportunityType:"underperforming"})}})}if(e.ourProfile.seo){const o=e.ourProfile.seo.authorityScore;e.competitorProfiles.forEach(n=>{if(n.seo){const r=n.seo.authorityScore-o;r>10&&t.push({metric:"authority",ourValue:o,competitorValue:n.seo.authorityScore,competitor:n.domain,gap:r,opportunityType:"underperforming"})}})}return t.sort((o,n)=>n.gap-o.gap)}async scoreOpportunities(e){const t=[];return e.contentGaps.forEach(o=>{const n=this.calculateROI({trafficPotential:o.estimatedTraffic,difficulty:o.difficulty,competitiveGap:o.competitorRank});t.push({type:"content",title:`Rank for "${o.keyword}"`,description:`${o.competitor} ranks #${o.competitorRank} for this ${o.searchVolume.toLocaleString()}/mo keyword`,roiScore:n,difficulty:o.opportunity==="easy_win"?"easy":o.opportunity==="medium"?"medium":"hard",estimatedImpact:{traffic:o.estimatedTraffic},actionable:`Create content targeting "${o.keyword}" - ${o.opportunity} opportunity`,data:o})}),e.messagingGaps.forEach(o=>{const n=this.calculateROI({trafficPotential:0,difficulty:50,competitiveGap:o.confidence});t.push({type:"messaging",title:o.opportunity,description:`${o.competitor} claims: "${o.competitorClaim}"`,roiScore:n,difficulty:"medium",estimatedImpact:{conversions:5},actionable:`Test messaging: "${o.competitorClaim}"`,data:o})}),e.performanceGaps.forEach(o=>{const n=this.calculateROI({trafficPotential:100,difficulty:70,competitiveGap:o.gap});t.push({type:"performance",title:`Improve ${o.metric}`,description:`${o.competitor} has ${o.competitorValue} vs our ${o.ourValue}`,roiScore:n,difficulty:"hard",estimatedImpact:{authority:o.metric==="authority"?o.gap:void 0},actionable:`Focus on improving ${o.metric} to match ${o.competitor}`,data:o})}),t.sort((o,n)=>n.roiScore-o.roiScore)}calculateROI(e){const t=Math.min(e.trafficPotential/1e3,1),o=1-e.difficulty/100,n=Math.min(e.competitiveGap/100,1),r=(t*.5+o*.3+n*.2)*100;return Math.round(Math.max(0,Math.min(100,r)))}}const Kt=new Wt;export{_t as C,Yt as H,Tt as P,Vt as S,Rt as V,Lt as a,Kt as c,Ht as d,qt as g,zt as l};
//# sourceMappingURL=synapse-CMLSaE2R.js.map
