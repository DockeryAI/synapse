var q=Object.defineProperty;var C=(n,e,t)=>e in n?q(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var I=(n,e,t)=>C(n,typeof e!="symbol"?e+"":e,t);import{c as M}from"./supabase-CviTlR-N.js";const P="https://jpwljchikgmggjidogon.supabase.co",j="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impwd2xqY2hpa2dtZ2dqaWRvZ29uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTY1NDAsImV4cCI6MjA3ODczMjU0MH0.At0TEROiEHP2XZQ7ccEErLa2qUG6LtGFwDJl4ukpTuo",f=M(P,j,{auth:{persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0},global:{headers:{Accept:"application/json","Content-Type":"application/json"}},db:{schema:"public"}}),R={async invoke(n,e){const{data:t,error:s}=await f.functions.invoke(n,{body:e});if(s)throw s;return t},async analyzeMirror(n,e,t=!1){return this.invoke("analyze-mirror",{brandId:n,section:e,forceRefresh:t})},async askMarbs(n,e,t){return this.invoke("marbs-assistant",{message:n,context:e,conversationId:t})},async generateContent(n,e,t,s,o){return this.invoke("generate-content",{brandId:n,platform:e,topic:t,mode:s,...o})},async enrichWithSynapse(n,e="full"){return this.invoke("enrich-with-synapse",{content:n,enrichmentType:e})},async publishToPlatform(n,e,t,s){return this.invoke("publish-to-platforms",{contentItemId:n,platform:e,content:t,imageUrl:s})},async collectAnalytics(n,e,t){return this.invoke("collect-analytics",{brandId:n,platform:e,dateRange:t})}},z={async getById(n,e){const{data:t,error:s}=await f.from(n).select("*").eq("id",e).single();if(s){if(s.code==="PGRST116")return null;throw s}return t},async getAll(n,e){let t=f.from(n).select("*");e&&Object.entries(e).forEach(([u,c])=>{t=t.eq(u,c)});const{data:s,error:o}=await t;if(o)throw o;return s||[]},async insert(n,e){const{data:t,error:s}=await f.from(n).insert(e).select().single();if(s)throw s;return t},async update(n,e,t){const{data:s,error:o}=await f.from(n).update(t).eq("id",e).select().single();if(o)throw o;return s},async delete(n,e){const{error:t}=await f.from(n).delete().eq("id",e);if(t)throw t}},U=Object.freeze(Object.defineProperty({__proto__:null,db:z,default:f,functions:R,supabase:f},Symbol.toStringTag,{value:"Module"}));class x{constructor(e,t,s){I(this,"sessionId");I(this,"userId");I(this,"brandId");this.sessionId=e||this.generateSessionId(),this.userId=t,this.brandId=s}async trackOnboardingStep(e,t){await this.trackEvent({eventType:"onboarding",step:e,metadata:t})}async trackCampaignStep(e,t){await this.trackEvent({eventType:"campaign",step:e,metadata:t})}async trackPublishingStep(e,t){await this.trackEvent({eventType:"publishing",step:e,metadata:t})}async trackEvent(e){try{const{error:t}=await f.from("analytics_events").insert({event_type:`funnel_${e.eventType}`,event_data:{step:e.step,sessionId:this.sessionId,userId:this.userId,brandId:this.brandId,metadata:e.metadata,timestamp:new Date().toISOString()},brand_id:this.brandId});t?console.error("[FunnelTracker] Failed to track event:",t):console.log(`[FunnelTracker] ${e.eventType}/${e.step} tracked`)}catch(t){console.error("[FunnelTracker] Track event error:",t)}}getSessionId(){return this.sessionId}setUserId(e){this.userId=e}setBrandId(e){this.brandId=e}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}static async getFunnelMetrics(e,t,s="30d"){const o=s==="7d"?7:s==="30d"?30:90,u=new Date;u.setDate(u.getDate()-o);try{let c=f.from("analytics_events").select("event_data, created_at").eq("event_type",`funnel_${e}`).gte("created_at",u.toISOString()).order("created_at",{ascending:!0});t&&(c=c.eq("brand_id",t));const{data:d,error:S}=await c;if(S)throw console.error("[FunnelTracker] Failed to fetch metrics:",S),S;const h=new Map;d==null||d.forEach(r=>{var i;const a=(i=r.event_data)==null?void 0:i.sessionId;a&&(h.has(a)||h.set(a,[]),h.get(a).push(r))});const p=h.size,l=new Map,y=new Map;h.forEach(r=>{var a;if(r.sort((i,v)=>new Date(i.created_at).getTime()-new Date(v.created_at).getTime()),r.forEach((i,v)=>{var D;const _=(D=i.event_data)==null?void 0:D.step;if(_&&(l.has(_)||l.set(_,{entered:0,completed:0}),l.get(_).entered++,v<r.length-1)){const F=(new Date(r[v+1].created_at).getTime()-new Date(i.created_at).getTime())/1e3;y.has(_)||y.set(_,[]),y.get(_).push(F)}}),r.length>0){const i=(a=r[r.length-1].event_data)==null?void 0:a.step;i&&l.has(i)&&l.get(i).completed++}});const g=Array.from(l.entries()).map(([r,a])=>{const i=y.get(r)||[],v=i.length>0?i.reduce((_,D)=>_+D,0)/i.length:0;return{step:r,entered:a.entered,completed:a.completed,conversionRate:a.entered>0?a.completed/a.entered*100:0,averageTimeSpent:v,dropOffRate:a.entered>0?(a.entered-a.completed)/a.entered*100:0}});g.sort((r,a)=>{const i=this.getStepOrder(e);return i.indexOf(r.step)-i.indexOf(a.step)});const b=g[0],k=g[g.length-1],T=b&&k&&b.entered>0?k.completed/b.entered*100:0,O=this.calculateDropOffPoints(g),m=Array.from(h.values()).filter(r=>r.length>1).map(r=>{const a=new Date(r[0].created_at);return(new Date(r[r.length-1].created_at).getTime()-a.getTime())/1e3}),A=m.length>0?m.reduce((r,a)=>r+a,0)/m.length:0;return{funnelType:e,totalSessions:p,stepMetrics:g,overallConversionRate:T,dropOffPoints:O,averageTimeToComplete:A}}catch(c){throw console.error("[FunnelTracker] Get funnel metrics error:",c),c}}static async getSessions(e,t,s=100){try{let o=f.from("analytics_events").select("event_data, created_at").eq("event_type",`funnel_${e}`).order("created_at",{ascending:!1}).limit(s*10);t&&(o=o.eq("brand_id",t));const{data:u,error:c}=await o;if(c)return console.error("[FunnelTracker] Failed to fetch sessions:",c),[];const d=new Map;return u==null||u.forEach(h=>{var l;const p=(l=h.event_data)==null?void 0:l.sessionId;p&&(d.has(p)||d.set(p,[]),d.get(p).push(h))}),Array.from(d.entries()).map(([h,p])=>{var T,O;p.sort((w,m)=>new Date(w.created_at).getTime()-new Date(m.created_at).getTime());const l=p[0],y=p[p.length-1],g=p.map(w=>{var m;return(m=w.event_data)==null?void 0:m.step}).filter(Boolean),b=this.getFinalSteps(e),k=g.some(w=>b.includes(w));return{sessionId:h,userId:(T=l.event_data)==null?void 0:T.userId,brandId:(O=l.event_data)==null?void 0:O.brandId,startedAt:new Date(l.created_at),completedAt:k?new Date(y.created_at):void 0,steps:g,completed:k,funnelType:e}}).slice(0,s)}catch(o){return console.error("[FunnelTracker] Get sessions error:",o),[]}}static getStepOrder(e){switch(e){case"onboarding":return["url_input","extraction_started","extraction_complete","confirmation_viewed","confirmation_confirmed","insights_viewed","suggestions_viewed","campaign_selected","post_selected","generation_started","generation_complete","preview_viewed"];case"campaign":return["type_selector_viewed","type_selected","customization_viewed","generation_started","generation_complete","preview_viewed","editing_started","post_edited","schedule_started","schedule_complete"];case"publishing":return["schedule_initiated","schedule_success","schedule_failed","publish_started","publish_success","publish_failed","retry_attempted"];default:return[]}}static getFinalSteps(e){switch(e){case"onboarding":return["generation_complete","preview_viewed"];case"campaign":return["schedule_complete"];case"publishing":return["publish_success"];default:return[]}}static calculateDropOffPoints(e){const t=[];for(let s=0;s<e.length-1;s++){const o=e[s],u=e[s+1],c=o.entered-u.entered,d=o.entered>0?c/o.entered*100:0;d>10&&t.push({fromStep:o.step,toStep:u.step,dropOffCount:c,dropOffRate:d,priority:d>40?"high":d>25?"medium":"low"})}return t.sort((s,o)=>o.dropOffRate-s.dropOffRate),t}}let E=null;function Z(n,e){return E||(E=new x(void 0,n,e)),E}class J{constructor(){I(this,"events",[]);I(this,"isProduction",!0)}track(e,t){const s={event:e,properties:t,timestamp:new Date};this.events.push(s),this.isProduction||console.log("[Analytics]",e,t),this.isProduction&&this.sendToAnalytics(s)}trackContentGeneration(e){this.track("content_generated",{count:e.count,industry:e.industry,duration_ms:e.duration,avg_score:e.avgScore,success_count:e.successCount,success_rate:e.successCount/e.count*100})}trackRegeneration(e){this.track("content_regenerated",{platform:e.platform,reason:e.reason||"user_request"})}trackPublish(e){this.track("content_published",{platform:e.platform,scheduled:!!e.scheduledDate,scheduled_date:e.scheduledDate})}trackIndustrySelected(e){this.track("industry_selected",{industry:e})}trackError(e){this.track("error_occurred",{error_type:e.type,error_message:e.message,...e.context})}getEvents(){return[...this.events]}clearEvents(){this.events=[]}sendToAnalytics(e){console.log("[Analytics - Production]",e.event,e.properties)}}const B=new J;export{B as a,U as b,z as d,R as f,Z as g,f as s};
//# sourceMappingURL=analytics-BeoNQ3KZ.js.map
