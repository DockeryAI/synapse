{"version":3,"file":"campaign-BJZ6C_mM.js","sources":["../../src/lib/constants.ts","../../src/lib/openrouter.ts","../../src/services/errors/error-handler.service.ts","../../src/config/bannerbear.config.ts","../../src/config/campaign-templates.config.ts","../../src/services/visuals/bannerbear.service.ts","../../src/services/campaign/CampaignGenerator.ts","../../src/types/campaign.types.ts","../../src/services/campaign/CampaignRecommender.ts","../../src/types/smart-picks.types.ts","../../src/services/campaign/SmartPickGenerator.ts","../../src/services/campaign/CampaignState.ts","../../src/services/campaign/CampaignDB.ts","../../src/services/campaign/CampaignWorkflow.ts","../../src/services/campaign/CampaignOrchestrator.ts"],"sourcesContent":["// Application-wide constants\n\nimport type { ContentPlatform } from '@/types';\n\n// MIRROR Framework Phase Names\n// MIRROR: Measure, Intend, Reimagine, Reach, Optimize, Reflect\nexport const MIRROR_PHASES = {\n  measure: 'Measure',\n  intend: 'Intend',\n  reimagine: 'Reimagine',\n  reach: 'Reach',\n  optimize: 'Optimize',\n  reflect: 'Reflect',\n} as const;\n\n// Content Platforms\nexport const PLATFORMS: Record<ContentPlatform, { name: string; icon: string; color: string }> = {\n  facebook: { name: 'Facebook', icon: 'facebook', color: '#1877F2' },\n  instagram: { name: 'Instagram', icon: 'instagram', color: '#E4405F' },\n  linkedin: { name: 'LinkedIn', icon: 'linkedin', color: '#0A66C2' },\n  twitter: { name: 'Twitter', icon: 'twitter', color: '#1DA1F2' },\n  tiktok: { name: 'TikTok', icon: 'tiktok', color: '#000000' },\n  google_business: { name: 'Google Business', icon: 'google', color: '#4285F4' },\n  blog: { name: 'Blog', icon: 'file-text', color: '#6366F1' },\n  email: { name: 'Email', icon: 'mail', color: '#8B5CF6' },\n};\n\n// Content Generation Modes\nexport const GENERATION_MODES = {\n  marba: {\n    name: 'MARBA',\n    description: 'Fast generation with Claude Sonnet 3.5',\n    icon: 'zap',\n    color: 'blue',\n  },\n  synapse: {\n    name: 'Synapse',\n    description: 'Enhanced with psychology, connections, and power words',\n    icon: 'brain',\n    color: 'purple',\n  },\n} as const;\n\n// MARBA Score Components\nexport const MARBA_COMPONENTS = {\n  messaging: { name: 'Messaging', max: 20, color: 'blue' },\n  authenticity: { name: 'Authenticity', max: 20, color: 'green' },\n  relevance: { name: 'Relevance', max: 20, color: 'yellow' },\n  brand_alignment: { name: 'Brand Alignment', max: 20, color: 'purple' },\n  action: { name: 'Action', max: 20, color: 'red' },\n} as const;\n\n// Priority Levels\nexport const PRIORITY_LEVELS = {\n  critical: { label: 'Critical', color: 'red', icon: 'alert-circle' },\n  high: { label: 'High', color: 'orange', icon: 'alert-triangle' },\n  medium: { label: 'Medium', color: 'yellow', icon: 'info' },\n  low: { label: 'Low', color: 'blue', icon: 'circle' },\n} as const;\n\n// Status Colors\nexport const STATUS_COLORS = {\n  draft: 'gray',\n  scheduled: 'blue',\n  published: 'green',\n  failed: 'red',\n  archived: 'gray',\n  new: 'blue',\n  in_progress: 'yellow',\n  reviewed: 'purple',\n  actioned: 'green',\n  dismissed: 'gray',\n  expired: 'red',\n  completed: 'green',\n  on_track: 'green',\n  at_risk: 'yellow',\n  behind: 'red',\n} as const;\n\n// Opportunity Types\nexport const OPPORTUNITY_TYPES = {\n  weather_based: { label: 'Weather', icon: 'cloud', color: 'blue' },\n  trending_topic: { label: 'Trending', icon: 'trending-up', color: 'purple' },\n  competitor_move: { label: 'Competitor', icon: 'users', color: 'orange' },\n  keyword_opportunity: { label: 'Keyword', icon: 'search', color: 'green' },\n  review_response: { label: 'Review', icon: 'star', color: 'yellow' },\n  seasonal_event: { label: 'Seasonal', icon: 'calendar', color: 'red' },\n  local_news: { label: 'Local News', icon: 'newspaper', color: 'indigo' },\n  industry_shift: { label: 'Industry', icon: 'bar-chart', color: 'teal' },\n  audience_behavior: { label: 'Audience', icon: 'activity', color: 'pink' },\n  platform_update: { label: 'Platform', icon: 'settings', color: 'cyan' },\n} as const;\n\n// Urgency Levels\nexport const URGENCY_LEVELS = {\n  critical: { label: 'Critical', hours: 24, color: 'red' },\n  high: { label: 'High', hours: 72, color: 'orange' },\n  medium: { label: 'Medium', hours: 168, color: 'yellow' },\n  low: { label: 'Low', hours: 336, color: 'blue' },\n} as const;\n\n// Marbs Action Types\nexport const MARBS_ACTION_TYPES = {\n  content_generated: { label: 'Content Generated', icon: 'file-text' },\n  analysis_run: { label: 'Analysis Run', icon: 'pie-chart' },\n  data_updated: { label: 'Data Updated', icon: 'database' },\n  insight_discovered: { label: 'Insight Discovered', icon: 'lightbulb' },\n  task_created: { label: 'Task Created', icon: 'check-square' },\n  objective_set: { label: 'Objective Set', icon: 'target' },\n  recommendation_made: { label: 'Recommendation Made', icon: 'message-circle' },\n  calendar_updated: { label: 'Calendar Updated', icon: 'calendar' },\n  design_created: { label: 'Design Created', icon: 'image' },\n  post_scheduled: { label: 'Post Scheduled', icon: 'clock' },\n  analytics_fetched: { label: 'Analytics Fetched', icon: 'trending-up' },\n} as const;\n\n// Intelligence Badge Styles\nexport const INTELLIGENCE_BADGES = {\n  synapse: 'intelligence-badge-synapse',\n  industry: 'intelligence-badge-industry',\n  opportunity: 'intelligence-badge-opportunity',\n  learning: 'intelligence-badge-learning',\n  competitive: 'intelligence-badge-competitive',\n} as const;\n\n// Default Content Lengths (characters)\nexport const CONTENT_LENGTHS = {\n  facebook: { short: 100, medium: 250, long: 500 },\n  instagram: { short: 125, medium: 300, long: 600 },\n  linkedin: { short: 150, medium: 500, long: 1300 },\n  twitter: { short: 100, medium: 200, long: 280 },\n  tiktok: { short: 50, medium: 100, long: 150 },\n  google_business: { short: 100, medium: 300, long: 500 },\n  blog: { short: 300, medium: 800, long: 2000 },\n  email: { short: 200, medium: 500, long: 1000 },\n} as const;\n\n// Recommended Posting Times (hours in 24h format)\nexport const RECOMMENDED_POSTING_TIMES = {\n  facebook: [9, 13, 15],\n  instagram: [11, 13, 19],\n  linkedin: [8, 12, 17],\n  twitter: [9, 12, 17],\n  tiktok: [18, 19, 21],\n  google_business: [9, 12, 17],\n  blog: [9, 10, 14],\n  email: [10, 14, 18],\n} as const;\n\n// API Endpoints\nexport const API_ENDPOINTS = {\n  analyzeMirror: '/supabase/functions/v1/analyze-mirror',\n  marbsAssistant: '/supabase/functions/v1/marbs-assistant',\n  generateContent: '/supabase/functions/v1/generate-content',\n  enrichWithSynapse: '/supabase/functions/v1/enrich-with-synapse',\n  publishToPlatforms: '/supabase/functions/v1/publish-to-platforms',\n  collectAnalytics: '/supabase/functions/v1/collect-analytics',\n} as const;\n\n// OpenRouter Models\nexport const OPENROUTER_MODELS = {\n  claude35Sonnet: 'anthropic/claude-3.5-sonnet',\n  claude3Opus: 'anthropic/claude-3-opus',\n  gpt4: 'openai/gpt-4-turbo',\n  gpt35: 'openai/gpt-3.5-turbo',\n} as const;\n\n// Feature Flags\nexport const FEATURES = {\n  synapseMode: true,\n  designStudio: true,\n  marbsAssistant: true,\n  intelligenceOpportunities: true,\n  competitiveTracking: true,\n  learningPatterns: true,\n  abTesting: false, // Coming soon\n  advancedAnalytics: false, // Coming soon\n} as const;\n\n// Local Storage Keys\nexport const STORAGE_KEYS = {\n  theme: 'marba_theme',\n  selectedBrand: 'marba_selected_brand',\n  marbsConversation: 'marba_marbs_conversation',\n  calendarView: 'marba_calendar_view',\n  calendarFilters: 'marba_calendar_filters',\n  recentSearches: 'marba_recent_searches',\n  userPreferences: 'marba_user_preferences',\n} as const;\n\n// Error Messages\nexport const ERROR_MESSAGES = {\n  generic: 'An unexpected error occurred. Please try again.',\n  network: 'Network error. Please check your connection and try again.',\n  unauthorized: 'You are not authorized to perform this action.',\n  notFound: 'The requested resource was not found.',\n  validation: 'Please check your input and try again.',\n  rateLimit: 'Too many requests. Please wait a moment and try again.',\n  timeout: 'Request timed out. Please try again.',\n} as const;\n\n// Success Messages\nexport const SUCCESS_MESSAGES = {\n  contentGenerated: 'Content generated successfully!',\n  contentScheduled: 'Content scheduled successfully!',\n  contentPublished: 'Content published successfully!',\n  settingsSaved: 'Settings saved successfully!',\n  dataSynced: 'Data synced successfully!',\n  analysisComplete: 'Analysis complete!',\n} as const;\n\n// Validation Rules\nexport const VALIDATION = {\n  minPasswordLength: 8,\n  maxContentLength: 5000,\n  maxHashtags: 30,\n  maxImageSize: 5 * 1024 * 1024, // 5MB\n  maxVideoSize: 100 * 1024 * 1024, // 100MB\n  allowedImageTypes: ['image/jpeg', 'image/png', 'image/gif', 'image/webp'],\n  allowedVideoTypes: ['video/mp4', 'video/quicktime', 'video/x-msvideo'],\n} as const;\n\n// Date Formats\nexport const DATE_FORMATS = {\n  short: 'MMM d, yyyy',\n  long: 'MMMM d, yyyy h:mm a',\n  time: 'h:mm a',\n  iso: \"yyyy-MM-dd'T'HH:mm:ss\",\n} as const;\n\n// Chart Colors (for data visualization)\nexport const CHART_COLORS = {\n  primary: ['#3B82F6', '#8B5CF6', '#EC4899', '#F59E0B', '#10B981'],\n  pastels: ['#93C5FD', '#C4B5FD', '#F9A8D4', '#FCD34D', '#6EE7B7'],\n  dark: ['#1E40AF', '#6D28D9', '#BE185D', '#D97706', '#059669'],\n} as const;\n\n// Animation Durations (milliseconds)\nexport const ANIMATIONS = {\n  fast: 150,\n  normal: 300,\n  slow: 500,\n  verySlow: 1000,\n} as const;\n\n// Breakpoints (matches Tailwind defaults)\nexport const BREAKPOINTS = {\n  sm: 640,\n  md: 768,\n  lg: 1024,\n  xl: 1280,\n  '2xl': 1536,\n} as const;\n","// OpenRouter API client for AI content generation\n\nimport type { OpenRouterRequest, OpenRouterResponse, OpenRouterMessage } from '@/types';\nimport { OPENROUTER_MODELS } from './constants';\n\nconst OPENROUTER_API_URL = 'https://openrouter.ai/api/v1/chat/completions';\nconst OPENROUTER_API_KEY = import.meta.env.VITE_OPENROUTER_API_KEY;\n\nconsole.log('[OpenRouter] API Key loaded:', OPENROUTER_API_KEY ? `${OPENROUTER_API_KEY.substring(0, 20)}...` : 'NOT SET');\n\nif (!OPENROUTER_API_KEY) {\n  console.warn('VITE_OPENROUTER_API_KEY is not set. Content generation will not work.');\n}\n\ninterface ChatOptions {\n  model?: string;\n  temperature?: number;\n  maxTokens?: number;\n  topP?: number;\n  stream?: boolean;\n}\n\n/**\n * Send a chat completion request to OpenRouter\n */\nexport async function chat(\n  messages: OpenRouterMessage[],\n  options: ChatOptions = {}\n): Promise<string> {\n  if (!OPENROUTER_API_KEY) {\n    throw new Error('OpenRouter API key is not configured');\n  }\n\n  const {\n    model = OPENROUTER_MODELS.claude35Sonnet,\n    temperature = 0.7,\n    maxTokens = 2000,\n    topP = 1,\n    stream = false,\n  } = options;\n\n  const requestBody: OpenRouterRequest = {\n    model,\n    messages,\n    temperature,\n    max_tokens: maxTokens,\n    top_p: topP,\n    stream,\n  };\n\n  console.log('[OpenRouter] Making API request:', {\n    model,\n    messageCount: messages.length,\n    hasApiKey: !!OPENROUTER_API_KEY,\n    apiKeyPrefix: OPENROUTER_API_KEY?.substring(0, 20)\n  });\n\n  try {\n    const response = await fetch(OPENROUTER_API_URL, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,\n        'HTTP-Referer': window.location.origin,\n        'X-Title': 'MARBA',\n      },\n      body: JSON.stringify(requestBody),\n    });\n\n    console.log('[OpenRouter] Response status:', response.status);\n\n    if (!response.ok) {\n      const errorData = await response.json().catch(() => ({}));\n      console.error('[OpenRouter] Error response:', errorData);\n      throw new Error(\n        `OpenRouter API error: ${response.status} - ${errorData.error?.message || response.statusText}`\n      );\n    }\n\n    const data: OpenRouterResponse = await response.json();\n\n    if (!data.choices || data.choices.length === 0) {\n      throw new Error('No response from OpenRouter API');\n    }\n\n    return data.choices[0].message.content;\n  } catch (error) {\n    console.error('OpenRouter API error:', error);\n    throw error;\n  }\n}\n\n/**\n * Generate content with MARBA mode (fast, straightforward)\n */\nexport async function generateWithMARBA(params: {\n  platform: string;\n  topic: string;\n  tone?: string;\n  length?: 'short' | 'medium' | 'long';\n  includeHashtags?: boolean;\n  includeCTA?: boolean;\n}): Promise<{ text: string; variations: string[] }> {\n  const { platform, topic, tone = 'professional', length = 'medium', includeHashtags = true, includeCTA = true } = params;\n\n  const systemMessage: OpenRouterMessage = {\n    role: 'system',\n    content: `You are a professional social media content writer. Create engaging, platform-optimized content that drives results. Keep it authentic and conversational.`,\n  };\n\n  const userMessage: OpenRouterMessage = {\n    role: 'user',\n    content: `Create ${length} ${platform} content about: ${topic}\n\nTone: ${tone}\n${includeHashtags ? 'Include relevant hashtags.' : ''}\n${includeCTA ? 'Include a clear call-to-action.' : ''}\n\nProvide:\n1. Main version\n2. Three variations (slightly different angles/hooks)\n\nFormat as JSON:\n{\n  \"main\": \"content here\",\n  \"variations\": [\"variation 1\", \"variation 2\", \"variation 3\"]\n}`,\n  };\n\n  try {\n    const response = await chat([systemMessage, userMessage], {\n      model: OPENROUTER_MODELS.claude35Sonnet,\n      temperature: 0.8,\n      maxTokens: 1500,\n    });\n\n    const parsed = JSON.parse(response);\n    return {\n      text: parsed.main,\n      variations: parsed.variations,\n    };\n  } catch (error) {\n    console.error('MARBA generation error:', error);\n    // Fallback if JSON parsing fails\n    return {\n      text: 'Content generation failed. Please try again.',\n      variations: [],\n    };\n  }\n}\n\n/**\n * Generate content with Synapse mode (enhanced with psychology)\n */\nexport async function generateWithSynapse(params: {\n  platform: string;\n  topic: string;\n  tone?: string;\n  length?: 'short' | 'medium' | 'long';\n  industryContext?: string;\n  audienceInsights?: string[];\n  edginess?: number;\n}): Promise<{\n  text: string;\n  variations: string[];\n  psychologyScore: number;\n  connections: Array<{ from: string; to: string; strength: number }>;\n  powerWords: string[];\n  provenance?: any;\n}> {\n  const {\n    platform,\n    topic,\n    tone = 'professional',\n    length = 'medium',\n    industryContext = '',\n    audienceInsights = [],\n    edginess = 50,\n  } = params;\n\n  const systemMessage: OpenRouterMessage = {\n    role: 'system',\n    content: `You are an expert in persuasive communication and behavioral psychology. You create content that:\n- Leverages psychological triggers (curiosity, urgency, social proof, etc.)\n- Uses power words and emotional language strategically\n- Creates strong mental connections between concepts\n- Optimizes for engagement and action\n\nYou analyze content through the lens of:\n- Cialdini's 6 principles of persuasion\n- Cognitive psychology and mental models\n- Emotional resonance and storytelling\n- Behavioral economics`,\n  };\n\n  const contextInfo = industryContext ? `\\nIndustry context: ${industryContext}` : '';\n  const audienceInfo = audienceInsights.length > 0 ? `\\nAudience insights: ${audienceInsights.join(', ')}` : '';\n\n  // Get edginess description\n  const edginessDescription =\n    edginess <= 25\n      ? 'Professional and polished tone, corporate-safe'\n      : edginess <= 50\n      ? 'Approachable and warm tone, relatable and friendly'\n      : edginess <= 75\n      ? 'Casual and conversational tone, witty and personable'\n      : 'Edgy and bold tone, attention-grabbing and playful';\n\n  const userMessage: OpenRouterMessage = {\n    role: 'user',\n    content: `Create highly persuasive ${length} ${platform} content about: ${topic}${contextInfo}${audienceInfo}\n\nTone: ${tone}\nEdginess Level: ${edginess}/100 (${edginessDescription})\n\nRequirements:\n- Use psychology-backed persuasion techniques\n- Include power words strategically\n- Create strong conceptual connections\n- Optimize for emotional impact\n- Match the specified edginess level (${edginess}/100)\n- Include relevant hashtags\n- Include a compelling call-to-action\n\nProvide:\n1. Main version (optimized for psychology)\n2. Three variations (different psychological angles)\n3. Psychology score (0-10)\n4. Key conceptual connections used\n5. Power words included\n\nFormat as JSON:\n{\n  \"main\": \"content here\",\n  \"variations\": [\"variation 1\", \"variation 2\", \"variation 3\"],\n  \"psychologyScore\": 8.5,\n  \"connections\": [\n    {\"from\": \"concept1\", \"to\": \"concept2\", \"strength\": 0.9}\n  ],\n  \"powerWords\": [\"exclusive\", \"guaranteed\", \"breakthrough\"]\n}`,\n  };\n\n  try {\n    const response = await chat([systemMessage, userMessage], {\n      model: OPENROUTER_MODELS.claude35Sonnet,\n      temperature: 0.7,\n      maxTokens: 2000,\n    });\n\n    const parsed = JSON.parse(response);\n    return {\n      text: parsed.main,\n      variations: parsed.variations || [],\n      psychologyScore: parsed.psychologyScore || 7.0,\n      connections: parsed.connections || [],\n      powerWords: parsed.powerWords || [],\n    };\n  } catch (error) {\n    console.error('Synapse generation error:', error);\n    // Fallback if JSON parsing fails\n    return {\n      text: 'Content generation failed. Please try again.',\n      variations: [],\n      psychologyScore: 0,\n      connections: [],\n      powerWords: [],\n    };\n  }\n}\n\n/**\n * Ask Marbs assistant a question\n */\nexport async function askMarbs(\n  message: string,\n  context: {\n    section?: string;\n    pageData?: Record<string, any>;\n    conversationHistory?: OpenRouterMessage[];\n  }\n): Promise<string> {\n  const systemMessage: OpenRouterMessage = {\n    role: 'system',\n    content: `You are Marbs, an expert AI marketing assistant for MARBA (a marketing intelligence platform). You help users:\n- Understand their marketing data and insights\n- Create effective content strategies\n- Optimize campaigns based on data\n- Navigate the MARBA platform\n- Make data-driven marketing decisions\n\nYou are contextually aware, proactive, and always focused on delivering value. Keep responses concise and actionable.`,\n  };\n\n  const contextInfo = context.section ? `\\nCurrent section: ${context.section}` : '';\n  const dataInfo = context.pageData ? `\\nPage data: ${JSON.stringify(context.pageData).slice(0, 500)}` : '';\n\n  const userMessage: OpenRouterMessage = {\n    role: 'user',\n    content: `${message}${contextInfo}${dataInfo}`,\n  };\n\n  const messages = [systemMessage];\n\n  // Include conversation history if available\n  if (context.conversationHistory && context.conversationHistory.length > 0) {\n    messages.push(...context.conversationHistory.slice(-6)); // Last 6 messages for context\n  }\n\n  messages.push(userMessage);\n\n  return await chat(messages, {\n    model: OPENROUTER_MODELS.claude35Sonnet,\n    temperature: 0.7,\n    maxTokens: 1000,\n  });\n}\n\n/**\n * Calculate MARBA score for content\n */\nexport async function calculateMARBAScore(\n  content: string,\n  context?: {\n    platform?: string;\n    targetAudience?: string[];\n    industry?: string;\n  }\n): Promise<any> {\n  const systemMessage: OpenRouterMessage = {\n    role: 'system',\n    content: `You are an expert content analyst. You evaluate content using the MARBA framework:\n\nM - Messaging (20 points): Clarity, value proposition, differentiation, consistency\nA - Authenticity (20 points): Brand voice, transparency, human connection, social proof\nR - Relevance (20 points): Audience alignment, timeliness, context awareness, personalization\nB - Brand Alignment (20 points): Visual consistency, tone match, values alignment, positioning\nA - Action (20 points): Clear CTA, urgency, friction reduction, conversion optimization\n\nProvide detailed scoring and actionable recommendations.`,\n  };\n\n  const contextInfo = context\n    ? `\\nPlatform: ${context.platform || 'general'}\nAudience: ${context.targetAudience?.join(', ') || 'general'}\nIndustry: ${context.industry || 'general'}`\n    : '';\n\n  const userMessage: OpenRouterMessage = {\n    role: 'user',\n    content: `Score this content using the MARBA framework:${contextInfo}\n\nContent:\n\"${content}\"\n\nProvide detailed JSON:\n{\n  \"overall\": 85,\n  \"breakdown\": {\n    \"messaging\": {\"score\": 17, \"details\": \"...\"},\n    \"authenticity\": {\"score\": 16, \"details\": \"...\"},\n    \"relevance\": {\"score\": 18, \"details\": \"...\"},\n    \"brand_alignment\": {\"score\": 16, \"details\": \"...\"},\n    \"action\": {\"score\": 18, \"details\": \"...\"}\n  },\n  \"insights\": [\n    {\"category\": \"strength\", \"title\": \"...\", \"description\": \"...\"}\n  ],\n  \"recommendations\": [\"...\", \"...\"]\n}`,\n  };\n\n  try {\n    const response = await chat([systemMessage, userMessage], {\n      model: OPENROUTER_MODELS.claude35Sonnet,\n      temperature: 0.3,\n      maxTokens: 2000,\n    });\n\n    return JSON.parse(response);\n  } catch (error) {\n    console.error('MARBA scoring error:', error);\n    throw error;\n  }\n}\n\nexport default {\n  chat,\n  generateWithMARBA,\n  generateWithSynapse,\n  askMarbs,\n  calculateMARBAScore,\n};\n","/**\n * Error Handler Service\n *\n * Centralized error handling with exponential backoff retry logic,\n * fallback strategies, and user-friendly error messages.\n *\n * Features:\n * - Exponential backoff retry with configurable attempts\n * - Error categorization (retryable vs fatal)\n * - Fallback strategies (cache, degraded mode)\n * - User-friendly error messages\n * - Progress callbacks for retry UI\n *\n * Created: Nov 17, 2025 - Week 2 Workstream C\n */\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\nexport type ErrorCategory =\n  | 'network'\n  | 'api_limit'\n  | 'authentication'\n  | 'validation'\n  | 'timeout'\n  | 'server_error'\n  | 'unknown';\n\nexport type ErrorSeverity = 'fatal' | 'retryable' | 'warning';\n\nexport interface AppError {\n  category: ErrorCategory;\n  severity: ErrorSeverity;\n  message: string;\n  userMessage: string;\n  originalError: Error;\n  retryable: boolean;\n  timestamp: Date;\n  context?: Record<string, any>;\n}\n\nexport interface RetryConfig {\n  maxAttempts: number;\n  initialDelayMs: number;\n  maxDelayMs: number;\n  backoffMultiplier: number;\n  retryableCategories: ErrorCategory[];\n}\n\nexport interface RetryProgress {\n  attempt: number;\n  maxAttempts: number;\n  nextRetryIn?: number; // milliseconds\n  error?: AppError;\n}\n\nexport interface FallbackStrategy<T> {\n  name: string;\n  execute: () => Promise<T>;\n  description: string;\n}\n\n// ============================================================================\n// DEFAULT CONFIGURATIONS\n// ============================================================================\n\nconst DEFAULT_RETRY_CONFIG: RetryConfig = {\n  maxAttempts: 3,\n  initialDelayMs: 1000,\n  maxDelayMs: 10000,\n  backoffMultiplier: 2,\n  retryableCategories: ['network', 'api_limit', 'timeout', 'server_error'],\n};\n\n// ============================================================================\n// ERROR HANDLER SERVICE\n// ============================================================================\n\nexport class ErrorHandlerService {\n  /**\n   * Execute an async operation with retry logic\n   */\n  static async executeWithRetry<T>(\n    operation: () => Promise<T>,\n    config: Partial<RetryConfig> = {},\n    onProgress?: (progress: RetryProgress) => void,\n    fallbackStrategies: FallbackStrategy<T>[] = []\n  ): Promise<T> {\n    const retryConfig = { ...DEFAULT_RETRY_CONFIG, ...config };\n    let lastError: AppError | null = null;\n\n    for (let attempt = 1; attempt <= retryConfig.maxAttempts; attempt++) {\n      try {\n        // Notify progress\n        if (onProgress) {\n          onProgress({\n            attempt,\n            maxAttempts: retryConfig.maxAttempts,\n            error: lastError || undefined,\n          });\n        }\n\n        // Execute the operation\n        const result = await operation();\n        return result;\n      } catch (error) {\n        // Categorize the error\n        const appError = this.categorizeError(error);\n        lastError = appError;\n\n        console.error(`[ErrorHandler] Attempt ${attempt}/${retryConfig.maxAttempts} failed:`, {\n          category: appError.category,\n          message: appError.message,\n          retryable: appError.retryable,\n        });\n\n        // Check if error is retryable\n        if (!this.isRetryable(appError, retryConfig)) {\n          console.error('[ErrorHandler] Non-retryable error encountered:', appError);\n          break; // Exit retry loop\n        }\n\n        // If this was the last attempt, break\n        if (attempt === retryConfig.maxAttempts) {\n          console.error('[ErrorHandler] Max retry attempts reached');\n          break;\n        }\n\n        // Calculate delay with exponential backoff\n        const delay = this.calculateBackoffDelay(\n          attempt,\n          retryConfig.initialDelayMs,\n          retryConfig.maxDelayMs,\n          retryConfig.backoffMultiplier\n        );\n\n        console.log(`[ErrorHandler] Retrying in ${delay}ms...`);\n\n        // Notify progress with next retry time\n        if (onProgress) {\n          onProgress({\n            attempt,\n            maxAttempts: retryConfig.maxAttempts,\n            nextRetryIn: delay,\n            error: appError,\n          });\n        }\n\n        // Wait before retrying\n        await this.sleep(delay);\n      }\n    }\n\n    // All retries failed, try fallback strategies\n    if (fallbackStrategies.length > 0) {\n      console.log(`[ErrorHandler] Attempting ${fallbackStrategies.length} fallback strategies...`);\n\n      for (const strategy of fallbackStrategies) {\n        try {\n          console.log(`[ErrorHandler] Trying fallback: ${strategy.name}`);\n          const result = await strategy.execute();\n          console.log(`[ErrorHandler] Fallback \"${strategy.name}\" succeeded`);\n          return result;\n        } catch (error) {\n          console.error(`[ErrorHandler] Fallback \"${strategy.name}\" failed:`, error);\n        }\n      }\n    }\n\n    // Everything failed, throw the last error\n    throw lastError || new Error('Operation failed with unknown error');\n  }\n\n  /**\n   * Categorize an error into AppError format\n   */\n  static categorizeError(error: unknown): AppError {\n    const timestamp = new Date();\n\n    // If it's already an AppError, return it\n    if (this.isAppError(error)) {\n      return error;\n    }\n\n    // Convert to Error object if needed\n    const err = error instanceof Error ? error : new Error(String(error));\n\n    // Categorize based on error message and type\n    let category: ErrorCategory = 'unknown';\n    let severity: ErrorSeverity = 'retryable';\n    let userMessage = 'An unexpected error occurred. Please try again.';\n\n    const errorMessage = err.message.toLowerCase();\n\n    // Network errors\n    if (\n      errorMessage.includes('network') ||\n      errorMessage.includes('fetch') ||\n      errorMessage.includes('connection') ||\n      errorMessage.includes('ECONNREFUSED') ||\n      errorMessage.includes('ETIMEDOUT')\n    ) {\n      category = 'network';\n      userMessage =\n        'Network connection issue. Please check your internet connection and try again.';\n    }\n    // API rate limit errors\n    else if (\n      errorMessage.includes('rate limit') ||\n      errorMessage.includes('too many requests') ||\n      errorMessage.includes('429')\n    ) {\n      category = 'api_limit';\n      userMessage = 'Service is busy. We\\'ll retry automatically in a moment.';\n    }\n    // Authentication errors\n    else if (\n      errorMessage.includes('unauthorized') ||\n      errorMessage.includes('authentication') ||\n      errorMessage.includes('401') ||\n      errorMessage.includes('403')\n    ) {\n      category = 'authentication';\n      severity = 'fatal';\n      userMessage = 'Authentication failed. Please check your credentials.';\n    }\n    // Validation errors\n    else if (errorMessage.includes('validation') || errorMessage.includes('invalid')) {\n      category = 'validation';\n      severity = 'fatal';\n      userMessage = 'Invalid input. Please check your data and try again.';\n    }\n    // Timeout errors\n    else if (errorMessage.includes('timeout') || errorMessage.includes('timed out')) {\n      category = 'timeout';\n      userMessage = 'Request timed out. Retrying...';\n    }\n    // Server errors\n    else if (\n      errorMessage.includes('500') ||\n      errorMessage.includes('502') ||\n      errorMessage.includes('503') ||\n      errorMessage.includes('server error')\n    ) {\n      category = 'server_error';\n      userMessage = 'Server error. We\\'re retrying automatically.';\n    }\n\n    const retryable =\n      severity === 'retryable' &&\n      ['network', 'api_limit', 'timeout', 'server_error'].includes(category);\n\n    return {\n      category,\n      severity,\n      message: err.message,\n      userMessage,\n      originalError: err,\n      retryable,\n      timestamp,\n    };\n  }\n\n  /**\n   * Check if an error is retryable\n   */\n  private static isRetryable(error: AppError, config: RetryConfig): boolean {\n    if (error.severity === 'fatal') {\n      return false;\n    }\n\n    return config.retryableCategories.includes(error.category);\n  }\n\n  /**\n   * Calculate exponential backoff delay\n   */\n  private static calculateBackoffDelay(\n    attempt: number,\n    initialDelay: number,\n    maxDelay: number,\n    multiplier: number\n  ): number {\n    const delay = initialDelay * Math.pow(multiplier, attempt - 1);\n    // Add jitter (Â±25%)\n    const jitter = delay * 0.25 * (Math.random() * 2 - 1);\n    const finalDelay = Math.min(delay + jitter, maxDelay);\n\n    return Math.floor(finalDelay);\n  }\n\n  /**\n   * Sleep for specified milliseconds\n   */\n  private static sleep(ms: number): Promise<void> {\n    return new Promise((resolve) => setTimeout(resolve, ms));\n  }\n\n  /**\n   * Type guard for AppError\n   */\n  private static isAppError(error: unknown): error is AppError {\n    return (\n      typeof error === 'object' &&\n      error !== null &&\n      'category' in error &&\n      'severity' in error &&\n      'userMessage' in error\n    );\n  }\n\n  /**\n   * Get user-friendly error message\n   */\n  static getUserMessage(error: unknown): string {\n    const appError = this.categorizeError(error);\n    return appError.userMessage;\n  }\n\n  /**\n   * Log error for debugging\n   */\n  static logError(error: unknown, context?: Record<string, any>): void {\n    const appError = this.categorizeError(error);\n\n    console.error('[ErrorHandler]', {\n      timestamp: appError.timestamp.toISOString(),\n      category: appError.category,\n      severity: appError.severity,\n      message: appError.message,\n      userMessage: appError.userMessage,\n      retryable: appError.retryable,\n      context,\n    });\n\n    // In production, send to error tracking service (e.g., Sentry)\n    // if (import.meta.env.PROD) {\n    //   Sentry.captureException(appError.originalError, { extra: context });\n    // }\n  }\n\n  /**\n   * Create a cache fallback strategy\n   */\n  static createCacheFallback<T>(\n    cacheKey: string,\n    getCachedData: (key: string) => Promise<T | null>\n  ): FallbackStrategy<T> {\n    return {\n      name: 'cache',\n      description: 'Use cached data from previous request',\n      execute: async () => {\n        const cachedData = await getCachedData(cacheKey);\n        if (!cachedData) {\n          throw new Error('No cached data available');\n        }\n        return cachedData;\n      },\n    };\n  }\n\n  /**\n   * Create a degraded mode fallback strategy\n   */\n  static createDegradedModeFallback<T>(\n    getMinimalData: () => Promise<T>,\n    description: string = 'Use minimal data in degraded mode'\n  ): FallbackStrategy<T> {\n    return {\n      name: 'degraded_mode',\n      description,\n      execute: getMinimalData,\n    };\n  }\n}\n\n// ============================================================================\n// CONVENIENCE FUNCTIONS\n// ============================================================================\n\n/**\n * Retry an API call with exponential backoff\n */\nexport async function retryApiCall<T>(\n  apiCall: () => Promise<T>,\n  maxAttempts: number = 3,\n  onProgress?: (progress: RetryProgress) => void\n): Promise<T> {\n  return ErrorHandlerService.executeWithRetry(\n    apiCall,\n    { maxAttempts },\n    onProgress\n  );\n}\n\n/**\n * Retry with cache fallback\n */\nexport async function retryWithCacheFallback<T>(\n  operation: () => Promise<T>,\n  cacheKey: string,\n  getCachedData: (key: string) => Promise<T | null>,\n  onProgress?: (progress: RetryProgress) => void\n): Promise<T> {\n  return ErrorHandlerService.executeWithRetry(\n    operation,\n    {},\n    onProgress,\n    [ErrorHandlerService.createCacheFallback(cacheKey, getCachedData)]\n  );\n}\n\n/**\n * Get user-friendly error message\n */\nexport function getUserErrorMessage(error: unknown): string {\n  return ErrorHandlerService.getUserMessage(error);\n}\n\n/**\n * Log error with context\n */\nexport function logError(error: unknown, context?: Record<string, any>): void {\n  ErrorHandlerService.logError(error, context);\n}\n","/**\n * Bannerbear Configuration\n *\n * Configuration for Bannerbear API integration\n * Used for automated visual generation\n */\n\nexport const BANNERBEAR_CONFIG = {\n  apiUrl: 'https://api.bannerbear.com/v2',\n  apiKey: import.meta.env.VITE_BANNERBEAR_API_KEY || '',\n  timeout: 60000, // 60 seconds for image generation\n  retry: {\n    maxAttempts: 3,\n    backoffMs: 1000\n  },\n  rateLimit: {\n    concurrent: 2 // Process 2 images at a time\n  }\n};\n\n/**\n * Check if Bannerbear is properly configured\n */\nexport function isBannerbearConfigured(): boolean {\n  return Boolean(BANNERBEAR_CONFIG.apiKey && BANNERBEAR_CONFIG.apiKey.length > 0);\n}\n\n/**\n * Platform-specific aspect ratios and dimensions\n */\nexport const PLATFORM_SPECS = {\n  linkedin: {\n    feed: { width: 1200, height: 627, aspectRatio: '1.91:1' },\n    story: { width: 1080, height: 1920, aspectRatio: '9:16' }\n  },\n  facebook: {\n    feed: { width: 1200, height: 630, aspectRatio: '1.91:1' },\n    story: { width: 1080, height: 1920, aspectRatio: '9:16' }\n  },\n  instagram: {\n    feed: { width: 1080, height: 1080, aspectRatio: '1:1' },\n    story: { width: 1080, height: 1920, aspectRatio: '9:16' },\n    reel: { width: 1080, height: 1920, aspectRatio: '9:16' }\n  },\n  twitter: {\n    feed: { width: 1200, height: 675, aspectRatio: '16:9' },\n    card: { width: 800, height: 418, aspectRatio: '1.91:1' }\n  },\n  tiktok: {\n    video: { width: 1080, height: 1920, aspectRatio: '9:16' }\n  }\n} as const;\n\nexport type PlatformKey = keyof typeof PLATFORM_SPECS;\nexport type PlatformFormat = keyof typeof PLATFORM_SPECS[PlatformKey];\n","/**\n * Campaign Template Configurations\n *\n * Defines Bannerbear templates for each campaign type\n * Template IDs are placeholders - update after creating in Bannerbear dashboard\n */\n\nimport type { CampaignTemplateConfig } from '@/types/campaign-visual.types';\nimport type { CampaignTypeId } from '@/types/campaign.types';\n\n// ============================================================================\n// TEMPLATE CONFIGURATIONS\n// ============================================================================\n\n/**\n * Authority Builder Template\n * Professional, data-focused design emphasizing expertise\n */\nexport const AUTHORITY_BUILDER_TEMPLATE: CampaignTemplateConfig = {\n  campaignType: 'authority_builder',\n  templateId: 'TEMPLATE_AUTHORITY_001', // Placeholder - set after Bannerbear dashboard creation\n  name: 'Authority Builder - Professional',\n  description: 'Clean, professional design with emphasis on data and expertise. Features bold headline, supporting stats, and trust elements.',\n\n  fieldMappings: {\n    headline: 'headline',\n    subheadline: 'subheadline',\n    stat: 'key_stat',\n    bodyText: 'supporting_text',\n    logoUrl: 'logo',\n    brandColor: 'primary_color'\n  },\n\n  defaults: {\n    subheadline: 'Industry Insights',\n    supporting_text: 'Expert analysis backed by data'\n  },\n\n  style: {\n    colorScheme: 'professional',\n    layout: 'centered',\n    typography: 'bold'\n  }\n};\n\n/**\n * Trust Builder Template\n * Testimonial-focused design highlighting customer success and transformations\n */\nexport const TRUST_BUILDER_TEMPLATE: CampaignTemplateConfig = {\n  campaignType: 'trust_builder',\n  templateId: 'TEMPLATE_TRUST_001', // Placeholder - set after Bannerbear dashboard creation\n  name: 'Trust Builder - Testimonial',\n  description: 'Warm, trustworthy design featuring customer testimonials and ratings. Emphasizes real results and satisfaction.',\n\n  fieldMappings: {\n    headline: 'headline',\n    testimonial: 'testimonial_text',\n    customerName: 'customer_name',\n    bodyText: 'result_text',\n    logoUrl: 'logo',\n    brandColor: 'primary_color'\n  },\n\n  defaults: {\n    testimonial_text: 'Exceptional service and results!',\n    customer_name: 'Verified Customer'\n  },\n\n  style: {\n    colorScheme: 'warm',\n    layout: 'split',\n    typography: 'elegant'\n  }\n};\n\n/**\n * Community Champion Template\n * Location-focused design emphasizing local relevance and community connection\n */\nexport const COMMUNITY_CHAMPION_TEMPLATE: CampaignTemplateConfig = {\n  campaignType: 'community_champion',\n  templateId: 'TEMPLATE_COMMUNITY_001', // Placeholder - set after Bannerbear dashboard creation\n  name: 'Community Champion - Local',\n  description: 'Vibrant, community-focused design highlighting local events and timing. Features location emphasis and timely messaging.',\n\n  fieldMappings: {\n    headline: 'headline',\n    subheadline: 'subheadline',\n    location: 'location_text',\n    date: 'date_text',\n    bodyText: 'event_description',\n    logoUrl: 'logo',\n    brandColor: 'primary_color'\n  },\n\n  defaults: {\n    location_text: 'Your Local Community',\n    date_text: 'This Week'\n  },\n\n  style: {\n    colorScheme: 'vibrant',\n    layout: 'overlay',\n    typography: 'modern'\n  }\n};\n\n/**\n * Revenue Rush Template\n * Social commerce design for immediate sales and shoppable posts\n */\nexport const REVENUE_RUSH_TEMPLATE: CampaignTemplateConfig = {\n  campaignType: 'revenue_rush',\n  templateId: 'TEMPLATE_REVENUE_001', // Placeholder - set after Bannerbear dashboard creation\n  name: 'Revenue Rush - Commerce',\n  description: 'Bold, urgency-driven design for social commerce. Features product focus, pricing, and clear CTAs for immediate sales.',\n\n  fieldMappings: {\n    headline: 'headline',\n    price: 'price_text',\n    offer: 'offer_text',\n    bodyText: 'product_description',\n    logoUrl: 'logo',\n    brandColor: 'primary_color'\n  },\n\n  defaults: {\n    offer_text: 'Limited Time Offer',\n    product_description: 'Shop now and save'\n  },\n\n  style: {\n    colorScheme: 'bold',\n    layout: 'product-focused',\n    typography: 'impactful'\n  }\n};\n\n/**\n * Viral Spark Template\n * Video-first, trending content design for massive reach\n */\nexport const VIRAL_SPARK_TEMPLATE: CampaignTemplateConfig = {\n  campaignType: 'viral_spark',\n  templateId: 'TEMPLATE_VIRAL_001', // Placeholder - set after Bannerbear dashboard creation\n  name: 'Viral Spark - Trending',\n  description: 'Dynamic, attention-grabbing design for video-first content. Features bold text overlays and trending aesthetics.',\n\n  fieldMappings: {\n    headline: 'headline',\n    trendingText: 'trending_text',\n    bodyText: 'hook_text',\n    logoUrl: 'logo',\n    brandColor: 'primary_color'\n  },\n\n  defaults: {\n    trending_text: 'POV:',\n    hook_text: 'Watch till the end'\n  },\n\n  style: {\n    colorScheme: 'dynamic',\n    layout: 'vertical-video',\n    typography: 'bold'\n  }\n};\n\n// ============================================================================\n// TEMPLATE REGISTRY\n// ============================================================================\n\n/**\n * Complete registry of all campaign templates\n */\nexport const CAMPAIGN_TEMPLATES: Record<CampaignTypeId, CampaignTemplateConfig> = {\n  authority_builder: AUTHORITY_BUILDER_TEMPLATE,\n  trust_builder: TRUST_BUILDER_TEMPLATE,\n  community_champion: COMMUNITY_CHAMPION_TEMPLATE,\n  revenue_rush: REVENUE_RUSH_TEMPLATE,\n  viral_spark: VIRAL_SPARK_TEMPLATE\n};\n\n/**\n * Get template config for a campaign type\n */\nexport function getTemplateForCampaignType(campaignType: CampaignTypeId): CampaignTemplateConfig {\n  return CAMPAIGN_TEMPLATES[campaignType];\n}\n\n/**\n * Get all template configs\n */\nexport function getAllTemplates(): CampaignTemplateConfig[] {\n  return Object.values(CAMPAIGN_TEMPLATES);\n}\n\n// ============================================================================\n// TEMPLATE VALIDATION\n// ============================================================================\n\n/**\n * Check if a template is properly configured (has real template ID)\n */\nexport function isTemplateConfigured(campaignType: CampaignTypeId): boolean {\n  const template = CAMPAIGN_TEMPLATES[campaignType];\n  return !template.templateId.startsWith('TEMPLATE_'); // Real IDs don't start with TEMPLATE_\n}\n\n/**\n * Get list of unconfigured templates (need Bannerbear dashboard setup)\n */\nexport function getUnconfiguredTemplates(): CampaignTypeId[] {\n  return Object.keys(CAMPAIGN_TEMPLATES).filter(\n    type => !isTemplateConfigured(type as CampaignTypeId)\n  ) as CampaignTypeId[];\n}\n","/**\n * BANNERBEAR SERVICE\n *\n * Integration with Bannerbear API for automated visual generation\n * Handles image creation, template management, and error handling\n *\n * Philosophy: \"Professional visuals, zero design effort\"\n */\n\nimport { BANNERBEAR_CONFIG, isBannerbearConfigured, PLATFORM_SPECS, PlatformKey } from '../../config/bannerbear.config';\nimport { getTemplateForCampaignType, isTemplateConfigured } from '../../config/campaign-templates.config';\nimport type {\n  GenerateCampaignVisualRequest,\n  GeneratedVisual,\n  GenerateAllPlatformsRequest,\n  BatchVisualResult,\n  CampaignTemplateConfig\n} from '../../types/campaign-visual.types';\nimport type { CampaignTypeId } from '../../types/campaign.types';\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\nexport interface ImageParams {\n  templateId: string;\n  modifications: Record<string, string | number>; // Key-value pairs for template variables\n  metadata?: Record<string, any>; // Optional tracking data\n}\n\nexport interface CarouselParams {\n  templateId: string;\n  slides: Array<Record<string, string | number>>; // Array of modifications per slide\n  metadata?: Record<string, any>;\n}\n\nexport interface BannerbearTemplate {\n  uid: string;\n  name: string;\n  width: number;\n  height: number;\n  tags: string[];\n  available_modifications: string[];\n}\n\nexport interface BannerbearImage {\n  uid: string;\n  status: 'pending' | 'completed' | 'failed';\n  image_url?: string;\n  image_url_png?: string;\n  image_url_jpg?: string;\n  created_at: string;\n  self: string; // URL to check status\n}\n\nexport interface BannerbearError {\n  message: string;\n  code?: string;\n  statusCode: number;\n  retryable: boolean;\n}\n\n// ============================================================================\n// BANNERBEAR SERVICE\n// ============================================================================\n\nclass BannerbearService {\n  private apiUrl: string;\n  private apiKey: string;\n  private requestQueue: Promise<any>[] = [];\n  private visualCache: Map<string, { visual: GeneratedVisual; timestamp: number }> = new Map();\n  private readonly CACHE_TTL = 7 * 24 * 60 * 60 * 1000; // 7 days\n\n  constructor() {\n    this.apiUrl = BANNERBEAR_CONFIG.apiUrl;\n    this.apiKey = BANNERBEAR_CONFIG.apiKey;\n  }\n\n  // ==========================================================================\n  // PUBLIC API\n  // ==========================================================================\n\n  /**\n   * Create a single image from template\n   * Returns image URL once generated\n   */\n  async createImage(params: ImageParams): Promise<string> {\n    this.validateConfig();\n\n    try {\n      const response = await this.makeRequest<{ uid: string }>('/images', {\n        method: 'POST',\n        body: JSON.stringify({\n          template: params.templateId,\n          modifications: this.formatModifications(params.modifications),\n          metadata: params.metadata,\n          webhook_url: null, // Synchronous for MVP\n        }),\n      });\n\n      // Poll for completion (synchronous generation)\n      const imageUrl = await this.pollForImage(response.uid);\n      return imageUrl;\n    } catch (error) {\n      throw this.handleError(error);\n    }\n  }\n\n  /**\n   * Create multiple images (carousel)\n   * Returns array of image URLs\n   */\n  async createCarousel(params: CarouselParams): Promise<string[]> {\n    this.validateConfig();\n\n    try {\n      const imagePromises = params.slides.map((modifications, index) =>\n        this.createImage({\n          templateId: params.templateId,\n          modifications,\n          metadata: {\n            ...params.metadata,\n            slide_index: index,\n            total_slides: params.slides.length,\n          },\n        })\n      );\n\n      // Generate all images in parallel (with rate limiting)\n      return await this.withRateLimit(imagePromises);\n    } catch (error) {\n      throw this.handleError(error);\n    }\n  }\n\n  /**\n   * List available templates\n   */\n  async listTemplates(): Promise<BannerbearTemplate[]> {\n    this.validateConfig();\n\n    try {\n      const response = await this.makeRequest<BannerbearTemplate[]>('/templates', {\n        method: 'GET',\n      });\n\n      return response;\n    } catch (error) {\n      throw this.handleError(error);\n    }\n  }\n\n  /**\n   * Get template details\n   */\n  async getTemplate(templateId: string): Promise<BannerbearTemplate> {\n    this.validateConfig();\n\n    try {\n      const response = await this.makeRequest<BannerbearTemplate>(`/templates/${templateId}`, {\n        method: 'GET',\n      });\n\n      return response;\n    } catch (error) {\n      throw this.handleError(error);\n    }\n  }\n\n  /**\n   * Check if service is configured and ready\n   */\n  isConfigured(): boolean {\n    return isBannerbearConfigured();\n  }\n\n  // ==========================================================================\n  // CAMPAIGN-SPECIFIC VISUAL GENERATION\n  // ==========================================================================\n\n  /**\n   * Generate a visual for a specific campaign type and platform\n   * Automatically maps campaign content to appropriate template\n   */\n  async generateCampaignVisual(request: GenerateCampaignVisualRequest): Promise<GeneratedVisual> {\n    this.validateConfig();\n    const startTime = Date.now();\n\n    // Check cache first\n    const cacheKey = this.getCacheKey(request);\n    const cached = this.getCachedVisual(cacheKey);\n    if (cached) {\n      console.log(`[Bannerbear] Cache hit for ${request.campaignType}/${request.platform}`);\n      return cached;\n    }\n\n    try {\n      // Get template config for campaign type\n      const templateConfig = getTemplateForCampaignType(request.campaignType);\n      const templateId = request.templateId || templateConfig.templateId;\n\n      // Check if template is configured\n      if (!isTemplateConfigured(request.campaignType) && !request.templateId) {\n        throw new Error(\n          `Template for ${request.campaignType} not configured in Bannerbear dashboard. ` +\n          `Please create template and update campaign-templates.config.ts`\n        );\n      }\n\n      // Map campaign content to template variables\n      const modifications = this.mapCampaignContentToTemplate(request.content, templateConfig, request.branding);\n\n      // Get platform-specific dimensions\n      const platformKey = request.platform as PlatformKey;\n      const format = request.format || 'feed';\n      const dimensions = PLATFORM_SPECS[platformKey]?.[format as keyof typeof PLATFORM_SPECS[typeof platformKey]];\n\n      if (!dimensions) {\n        throw new Error(`Invalid platform/format: ${request.platform}/${format}`);\n      }\n\n      // Generate image\n      console.log(`[Bannerbear] Generating ${request.campaignType} visual for ${request.platform}...`);\n      const response = await this.makeRequest<{ uid: string }>('/images', {\n        method: 'POST',\n        body: JSON.stringify({\n          template: templateId,\n          modifications: this.formatModifications(modifications),\n          metadata: {\n            campaign_type: request.campaignType,\n            platform: request.platform,\n            format: format,\n            brand_name: request.content.brandName,\n          },\n          webhook_url: null,\n        }),\n      });\n\n      // Poll for completion\n      const imageUrl = await this.pollForImage(response.uid);\n      const generationTime = Date.now() - startTime;\n\n      // Create result\n      const visual: GeneratedVisual = {\n        id: `visual_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n        campaignType: request.campaignType,\n        platform: request.platform,\n        format: format,\n        imageUrl,\n        bannerbearUid: response.uid,\n        templateId,\n        metadata: {\n          generatedAt: new Date(),\n          generationTime,\n          dimensions: { width: dimensions.width, height: dimensions.height },\n          aspectRatio: dimensions.aspectRatio,\n        },\n        status: 'completed',\n      };\n\n      // Cache the result\n      this.cacheVisual(cacheKey, visual);\n\n      console.log(`[Bannerbear] â Generated in ${generationTime}ms: ${imageUrl}`);\n      return visual;\n\n    } catch (error: any) {\n      console.error(`[Bannerbear] Failed to generate ${request.campaignType} visual:`, error);\n\n      // Return failed visual\n      return {\n        id: `visual_failed_${Date.now()}`,\n        campaignType: request.campaignType,\n        platform: request.platform,\n        format: request.format || 'feed',\n        imageUrl: '',\n        bannerbearUid: '',\n        templateId: '',\n        metadata: {\n          generatedAt: new Date(),\n          generationTime: Date.now() - startTime,\n          dimensions: { width: 0, height: 0 },\n          aspectRatio: '0:0',\n        },\n        status: 'failed',\n        error: error.message || 'Image generation failed',\n      };\n    }\n  }\n\n  /**\n   * Generate visuals for all platforms (batch generation)\n   * Returns results for each platform, with graceful failure handling\n   */\n  async generateAllPlatforms(request: GenerateAllPlatformsRequest): Promise<BatchVisualResult> {\n    const platforms = request.platforms || ['linkedin', 'facebook', 'instagram', 'twitter'];\n    const startTime = Date.now();\n\n    console.log(`[Bannerbear] Generating ${request.campaignType} visuals for ${platforms.length} platforms...`);\n\n    const visualPromises = platforms.map(platform =>\n      this.generateCampaignVisual({\n        campaignType: request.campaignType,\n        platform: platform as any,\n        content: request.content,\n        branding: request.branding,\n      }).catch(error => {\n        console.error(`[Bannerbear] Failed to generate for ${platform}:`, error);\n        return null;\n      })\n    );\n\n    // Generate with rate limiting\n    const visuals = await this.withRateLimit(visualPromises);\n\n    // Filter out nulls and separate completed/failed\n    const validVisuals = visuals.filter((v): v is GeneratedVisual => v !== null);\n    const completed = validVisuals.filter(v => v.status === 'completed').length;\n    const failed = validVisuals.filter(v => v.status === 'failed').length;\n    const errors = validVisuals\n      .filter(v => v.status === 'failed')\n      .map(v => ({ platform: v.platform, error: v.error || 'Unknown error' }));\n\n    const totalTime = Date.now() - startTime;\n    console.log(\n      `[Bannerbear] Batch complete in ${totalTime}ms: ${completed} succeeded, ${failed} failed`\n    );\n\n    return {\n      total: platforms.length,\n      completed,\n      failed,\n      visuals: validVisuals,\n      errors,\n    };\n  }\n\n  // ==========================================================================\n  // PRIVATE HELPERS\n  // ==========================================================================\n\n  private validateConfig(): void {\n    if (!this.apiKey) {\n      throw new Error(\n        'Bannerbear API key not configured. Please set VITE_BANNERBEAR_API_KEY in your .env file.'\n      );\n    }\n  }\n\n  private async makeRequest<T>(endpoint: string, options: RequestInit): Promise<T> {\n    const url = `${this.apiUrl}${endpoint}`;\n\n    const response = await fetch(url, {\n      ...options,\n      headers: {\n        'Content-Type': 'application/json',\n        Authorization: `Bearer ${this.apiKey}`,\n        ...options.headers,\n      },\n      signal: AbortSignal.timeout(BANNERBEAR_CONFIG.timeout),\n    });\n\n    if (!response.ok) {\n      const errorData = await response.json().catch(() => ({}));\n      throw {\n        message: errorData.message || response.statusText,\n        statusCode: response.status,\n        code: errorData.code,\n      };\n    }\n\n    return response.json();\n  }\n\n  private async pollForImage(imageUid: string, maxAttempts = 30): Promise<string> {\n    let attempts = 0;\n    const pollInterval = 2000; // 2 seconds\n\n    while (attempts < maxAttempts) {\n      try {\n        const image = await this.makeRequest<BannerbearImage>(`/images/${imageUid}`, {\n          method: 'GET',\n        });\n\n        if (image.status === 'completed') {\n          // Return PNG by default, fallback to JPG\n          return image.image_url_png || image.image_url_jpg || image.image_url || '';\n        }\n\n        if (image.status === 'failed') {\n          throw new Error('Image generation failed');\n        }\n\n        // Still pending, wait and retry\n        await this.sleep(pollInterval);\n        attempts++;\n      } catch (error) {\n        if (attempts >= maxAttempts - 1) {\n          throw error;\n        }\n        await this.sleep(pollInterval);\n        attempts++;\n      }\n    }\n\n    throw new Error('Image generation timed out after 60 seconds');\n  }\n\n  private formatModifications(modifications: Record<string, string | number>): Array<{\n    name: string;\n    text?: string;\n    color?: string;\n    image_url?: string;\n  }> {\n    // Convert flat object to Bannerbear's expected format\n    return Object.entries(modifications).map(([name, value]) => ({\n      name,\n      text: String(value),\n    }));\n  }\n\n  private async withRateLimit<T>(promises: Promise<T>[]): Promise<T[]> {\n    const { concurrent } = BANNERBEAR_CONFIG.rateLimit;\n    const results: T[] = [];\n\n    // Process in batches\n    for (let i = 0; i < promises.length; i += concurrent) {\n      const batch = promises.slice(i, i + concurrent);\n      const batchResults = await Promise.all(batch);\n      results.push(...batchResults);\n\n      // Add delay between batches to respect rate limits\n      if (i + concurrent < promises.length) {\n        await this.sleep(1000); // 1 second between batches\n      }\n    }\n\n    return results;\n  }\n\n  private handleError(error: any): BannerbearError {\n    const statusCode = error.statusCode || 500;\n    const message = error.message || 'Bannerbear API error';\n\n    // Determine if error is retryable\n    const retryable = statusCode === 429 || statusCode >= 500;\n\n    return {\n      message,\n      code: error.code,\n      statusCode,\n      retryable,\n    };\n  }\n\n  private sleep(ms: number): Promise<void> {\n    return new Promise((resolve) => setTimeout(resolve, ms));\n  }\n\n  /**\n   * Map campaign content to template variables based on field mappings\n   */\n  private mapCampaignContentToTemplate(\n    content: GenerateCampaignVisualRequest['content'],\n    templateConfig: CampaignTemplateConfig,\n    branding?: GenerateCampaignVisualRequest['branding']\n  ): Record<string, string | number> {\n    const modifications: Record<string, string | number> = {};\n    const { fieldMappings, defaults } = templateConfig;\n\n    // Map headline (always required)\n    if (fieldMappings.headline) {\n      modifications[fieldMappings.headline] = content.headline;\n    }\n\n    // Map subheadline if present\n    if (fieldMappings.subheadline && content.subheadline) {\n      modifications[fieldMappings.subheadline] = content.subheadline;\n    }\n\n    // Map body text if present\n    if (fieldMappings.bodyText && content.bodyText) {\n      modifications[fieldMappings.bodyText] = content.bodyText;\n    }\n\n    // Campaign-specific fields\n    // Stats (Authority Builder)\n    if (fieldMappings.stat && content.stats && content.stats.length > 0) {\n      modifications[fieldMappings.stat] = content.stats[0];\n    }\n\n    // Testimonial & Customer Name (Social Proof)\n    if (fieldMappings.testimonial && content.testimonial) {\n      modifications[fieldMappings.testimonial] = content.testimonial;\n    }\n    if (fieldMappings.customerName && content.customerName) {\n      modifications[fieldMappings.customerName] = content.customerName;\n    }\n\n    // Location (Local Pulse)\n    if (fieldMappings.location && content.location) {\n      modifications[fieldMappings.location] = content.location;\n    }\n\n    // Branding\n    if (fieldMappings.logoUrl && branding?.logoUrl) {\n      modifications[fieldMappings.logoUrl] = branding.logoUrl;\n    }\n    if (fieldMappings.brandColor && branding?.primaryColor) {\n      modifications[fieldMappings.brandColor] = branding.primaryColor;\n    }\n\n    // Apply defaults for missing optional fields\n    if (defaults) {\n      Object.entries(defaults).forEach(([key, value]) => {\n        if (!modifications[key]) {\n          modifications[key] = value;\n        }\n      });\n    }\n\n    return modifications;\n  }\n\n  /**\n   * Generate cache key for a visual request\n   */\n  private getCacheKey(request: GenerateCampaignVisualRequest): string {\n    const parts = [\n      request.campaignType,\n      request.platform,\n      request.format || 'feed',\n      request.content.headline,\n      request.content.brandName,\n    ];\n    return parts.join('::');\n  }\n\n  /**\n   * Get cached visual if still valid\n   */\n  private getCachedVisual(cacheKey: string): GeneratedVisual | null {\n    const cached = this.visualCache.get(cacheKey);\n    if (!cached) return null;\n\n    // Check if expired\n    const age = Date.now() - cached.timestamp;\n    if (age > this.CACHE_TTL) {\n      this.visualCache.delete(cacheKey);\n      return null;\n    }\n\n    return cached.visual;\n  }\n\n  /**\n   * Cache a generated visual\n   */\n  private cacheVisual(cacheKey: string, visual: GeneratedVisual): void {\n    this.visualCache.set(cacheKey, {\n      visual,\n      timestamp: Date.now(),\n    });\n\n    // Periodic cleanup of expired entries (every 100 additions)\n    if (this.visualCache.size % 100 === 0) {\n      this.cleanupCache();\n    }\n  }\n\n  /**\n   * Remove expired entries from cache\n   */\n  private cleanupCache(): void {\n    const now = Date.now();\n    for (const [key, entry] of this.visualCache.entries()) {\n      if (now - entry.timestamp > this.CACHE_TTL) {\n        this.visualCache.delete(key);\n      }\n    }\n  }\n}\n\n// ============================================================================\n// SINGLETON INSTANCE\n// ============================================================================\n\nexport const bannerbearService = new BannerbearService();\n\n// ============================================================================\n// CONVENIENCE FUNCTIONS\n// ============================================================================\n\n/**\n * Quick image generation with retries\n */\nexport async function generateImage(\n  templateId: string,\n  modifications: Record<string, string | number>,\n  retries = BANNERBEAR_CONFIG.retry.maxAttempts\n): Promise<string | null> {\n  let lastError: any;\n\n  for (let attempt = 0; attempt < retries; attempt++) {\n    try {\n      return await bannerbearService.createImage({\n        templateId,\n        modifications,\n      });\n    } catch (error: any) {\n      lastError = error;\n\n      if (!error.retryable || attempt === retries - 1) {\n        break;\n      }\n\n      // Exponential backoff\n      const backoff = BANNERBEAR_CONFIG.retry.backoffMs * Math.pow(2, attempt);\n      console.log(`Bannerbear attempt ${attempt + 1} failed, retrying in ${backoff}ms...`);\n      await new Promise((resolve) => setTimeout(resolve, backoff));\n    }\n  }\n\n  console.error('Bannerbear image generation failed after retries:', lastError);\n  return null; // Graceful fallback\n}\n\n/**\n * Batch image generation with progress callback\n */\nexport async function generateBatch(\n  items: Array<{ templateId: string; modifications: Record<string, string | number> }>,\n  onProgress?: (completed: number, total: number) => void\n): Promise<Array<string | null>> {\n  const results: Array<string | null> = [];\n\n  for (let i = 0; i < items.length; i++) {\n    const result = await generateImage(items[i].templateId, items[i].modifications);\n    results.push(result);\n\n    if (onProgress) {\n      onProgress(i + 1, items.length);\n    }\n  }\n\n  return results;\n}\n","/**\n * Campaign Generator Service\n *\n * Core service that transforms business insights into complete campaigns\n * with real AI-generated content and visuals.\n *\n * Process:\n * 1. Takes campaign type + business context\n * 2. Generates 7-10 posts using SynapseContentGenerator\n * 3. Creates visuals via Bannerbear\n * 4. Saves to database\n * 5. Returns complete campaign\n *\n * Created: Nov 17, 2025 - Week 1 Workstream A\n * Updated: Nov 17, 2025 - Week 2 Track 1 (Error Handling Integration)\n */\n\nimport { SynapseContentGenerator } from '../synapse/generation/SynapseContentGenerator';\nimport { bannerbearService } from '../visuals/bannerbear.service';\nimport { campaignDB } from './CampaignDB';\nimport { ErrorHandlerService, RetryProgress, logError } from '../errors/error-handler.service';\nimport type {\n  CampaignGenerationInput,\n  PostGenerationInput,\n  GeneratedCampaign,\n  GeneratedPost,\n  PostContent,\n  PostVisual,\n  ContentSource,\n  PostMetadata,\n  CampaignType,\n  PostType,\n  Platform,\n  BusinessContext,\n  GenerationProgress,\n  GenerationStage,\n} from '@/types/campaign-generation.types';\nimport type { BreakthroughInsight } from '@/types/breakthrough.types';\nimport type { BusinessProfile } from '@/types/synapseContent.types';\nimport type { SynapseContent } from '@/types/synapse/synapseContent.types';\n\nexport class CampaignGenerator {\n  private contentGenerator: SynapseContentGenerator;\n  private progressCallbacks: Map<string, (progress: GenerationProgress) => void>;\n\n  constructor() {\n    this.contentGenerator = new SynapseContentGenerator();\n    this.progressCallbacks = new Map();\n  }\n\n  // ============================================================================\n  // CAMPAIGN GENERATION\n  // ============================================================================\n\n  /**\n   * Generate a complete campaign with 7-10 posts\n   */\n  async generateCampaign(\n    input: CampaignGenerationInput,\n    onProgress?: (progress: GenerationProgress) => void,\n    onRetry?: (retry: RetryProgress) => void\n  ): Promise<GeneratedCampaign> {\n    const startTime = Date.now();\n    console.log(`[CampaignGenerator] Starting campaign generation: ${input.campaignType}`);\n\n    try {\n      // Initialize progress tracking\n      const sessionId = `campaign-${Date.now()}`;\n      const progress = this.initializeProgress(sessionId, input.options?.postsPerCampaign || 7);\n\n      // Register progress callback\n      if (onProgress) {\n        this.onProgress(sessionId, onProgress);\n      }\n\n      // Stage 1: Initialize\n      this.updateProgress(sessionId, 'initializing', 5);\n\n      // Stage 2: Create campaign template\n      this.updateProgress(sessionId, 'analyzing_business', 10);\n      const template = this.createCampaignTemplate(input.campaignType);\n\n      // Stage 3: Convert business context to insights\n      this.updateProgress(sessionId, 'selecting_insights', 20);\n      const insights = await this.extractInsights(input.businessContext);\n\n      // Stage 4: Generate posts\n      this.updateProgress(sessionId, 'generating_content', 30);\n      const posts = await this.generateCampaignPosts(\n        input.campaignType,\n        template,\n        input.businessContext,\n        insights,\n        input.options?.postsPerCampaign || template.recommendedCount,\n        input.options?.platforms || ['linkedin', 'facebook'],\n        sessionId,\n        onRetry\n      );\n\n      // Stage 5: Generate visuals (if enabled)\n      if (input.options?.includeVisuals !== false) {\n        this.updateProgress(sessionId, 'generating_visuals', 70);\n        await this.generateVisualsForPosts(posts, onRetry);\n      }\n\n      // Stage 6: Save to database (if enabled)\n      if (input.options?.saveToDatabase !== false) {\n        this.updateProgress(sessionId, 'saving_to_database', 90);\n        await this.saveCampaignToDatabase(input, posts);\n      }\n\n      // Create campaign object\n      const campaign: GeneratedCampaign = {\n        id: input.campaignId,\n        campaignType: input.campaignType,\n        name: template.name,\n        description: template.description,\n        posts,\n        totalPosts: posts.length,\n        estimatedDuration: template.duration,\n        createdAt: new Date(),\n        businessId: input.businessContext.businessData.businessName,\n        metadata: {\n          generatedBy: 'ai',\n          sourceInsights: insights.map((i) => i.id),\n          confidence: this.calculateCampaignConfidence(posts),\n        },\n      };\n\n      this.updateProgress(sessionId, 'complete', 100);\n      this.offProgress(sessionId);\n\n      const duration = Date.now() - startTime;\n      console.log(`[CampaignGenerator] Campaign generated in ${duration}ms: ${posts.length} posts`);\n\n      return campaign;\n    } catch (error) {\n      logError(error, { operation: 'generateCampaign', campaignType: input.campaignType });\n      console.error('[CampaignGenerator] Campaign generation failed:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Generate a single post\n   */\n  async generatePost(\n    input: PostGenerationInput,\n    onRetry?: (retry: RetryProgress) => void\n  ): Promise<GeneratedPost> {\n    console.log(`[CampaignGenerator] Generating single post: ${input.postType}`);\n\n    try {\n      // Convert business context to insights\n      const insights =\n        input.selectedInsights ||\n        (await this.extractInsights(input.businessContext));\n\n      // Generate content with retry\n      const businessProfile = this.createBusinessProfile(input.businessContext);\n      const platform = input.platforms?.[0] || 'linkedin';\n\n      const generatedContent = await ErrorHandlerService.executeWithRetry(\n        () => this.contentGenerator.generate(insights, businessProfile, {\n          maxContent: 1,\n          formats: [this.mapPostTypeToFormat(input.postType)],\n          platforms: input.platforms || [platform],\n        }),\n        { maxAttempts: 3 },\n        onRetry\n      );\n\n      if (!generatedContent.content || generatedContent.content.length === 0) {\n        throw new Error('Content generation failed - no content generated');\n      }\n\n      const synapseContent = generatedContent.content[0];\n\n      // Convert to GeneratedPost format\n      const post: GeneratedPost = {\n        id: `post-${Date.now()}`,\n        type: input.postType,\n        platform,\n        content: {\n          headline: synapseContent.platformContent[platform]?.headline,\n          hook: synapseContent.platformContent[platform]?.hook,\n          body: synapseContent.platformContent[platform]?.body || '',\n          hashtags: synapseContent.platformContent[platform]?.hashtags || [],\n          callToAction: synapseContent.platformContent[platform]?.cta,\n        },\n        visuals: [],\n        status: 'draft',\n        sources: this.createSources(input.businessContext, synapseContent.insight),\n        metadata: {\n          impactScore: synapseContent.metadata.impactScore,\n          psychologyTriggers: synapseContent.metadata.psychologyTriggers,\n          tone: synapseContent.metadata.tone,\n          generatedAt: new Date(),\n          model: 'synapse',\n        },\n      };\n\n      // Generate visuals if enabled\n      if (input.options?.includeVisuals !== false) {\n        post.visuals = await this.generateVisualsForPost(post, onRetry);\n      }\n\n      // Save to database if enabled\n      if (input.options?.saveToDatabase !== false) {\n        await this.savePostToDatabase(post, input.businessContext);\n      }\n\n      console.log(`[CampaignGenerator] Post generated successfully: ${post.id}`);\n      return post;\n    } catch (error) {\n      logError(error, { operation: 'generatePost', postType: input.postType });\n      console.error('[CampaignGenerator] Post generation failed:', error);\n      throw error;\n    }\n  }\n\n  // ============================================================================\n  // HELPER METHODS\n  // ============================================================================\n\n  /**\n   * Create a simple campaign template\n   * TODO: Integrate with actual campaign templates from config\n   */\n  private createCampaignTemplate(campaignType: CampaignType): {\n    id: string;\n    name: string;\n    description: string;\n    postTypes: PostType[];\n    recommendedCount: number;\n    duration: number;\n  } {\n    const templates = {\n      trust_builder: {\n        id: 'trust-builder',\n        name: 'Trust Builder Campaign',\n        description: 'Build trust through customer success stories and testimonials',\n        postTypes: ['customer_success', 'value_proposition', 'behind_the_scenes'] as PostType[],\n        recommendedCount: 7,\n        duration: 14,\n      },\n      authority_builder: {\n        id: 'authority-builder',\n        name: 'Authority Builder Campaign',\n        description: 'Establish expertise through educational content',\n        postTypes: ['educational', 'service_spotlight', 'problem_solution'] as PostType[],\n        recommendedCount: 7,\n        duration: 14,\n      },\n      problem_solver: {\n        id: 'problem-solver',\n        name: 'Problem Solver Campaign',\n        description: 'Address customer pain points with solutions',\n        postTypes: ['problem_solution', 'customer_success', 'service_spotlight'] as PostType[],\n        recommendedCount: 7,\n        duration: 14,\n      },\n      differentiator: {\n        id: 'differentiator',\n        name: 'Value Differentiator Campaign',\n        description: 'Highlight what makes you unique',\n        postTypes: ['value_proposition', 'behind_the_scenes', 'service_spotlight'] as PostType[],\n        recommendedCount: 7,\n        duration: 14,\n      },\n      engagement_driver: {\n        id: 'engagement-driver',\n        name: 'Community Engagement Campaign',\n        description: 'Drive community interaction and loyalty',\n        postTypes: ['community_engagement', 'behind_the_scenes', 'customer_success'] as PostType[],\n        recommendedCount: 7,\n        duration: 14,\n      },\n    };\n\n    return templates[campaignType] || templates.authority_builder;\n  }\n\n  /**\n   * Generate multiple posts for a campaign with error handling and partial results\n   */\n  private async generateCampaignPosts(\n    campaignType: CampaignType,\n    template: { postTypes: PostType[]; id: string },\n    context: BusinessContext,\n    insights: BreakthroughInsight[],\n    count: number,\n    platforms: Platform[],\n    sessionId: string,\n    onRetry?: (retry: RetryProgress) => void\n  ): Promise<GeneratedPost[]> {\n    const posts: GeneratedPost[] = [];\n    const errors: Error[] = [];\n    const businessProfile = this.createBusinessProfile(context);\n\n    // Distribute post types according to template\n    const postTypes = this.distributePostTypes(template.postTypes, count);\n\n    for (let i = 0; i < count; i++) {\n      try {\n        const postType = postTypes[i];\n        const platform = platforms[i % platforms.length];\n\n        // Update progress\n        const progressPercent = 30 + Math.floor((i / count) * 40);\n        this.updateProgress(sessionId, 'generating_content', progressPercent, i + 1, count);\n\n        // Generate content for this post with retry and fallback\n        const generatedContent = await ErrorHandlerService.executeWithRetry(\n          () => this.contentGenerator.generate(\n            [insights[i % insights.length]], // Rotate through insights\n            businessProfile,\n            {\n              maxContent: 1,\n              formats: [this.mapPostTypeToFormat(postType)],\n              platforms: [platform],\n            }\n          ),\n          { maxAttempts: 2 }, // Fewer attempts per post to avoid long delays\n          onRetry,\n          [\n            // Fallback: Use template-based content\n            {\n              name: 'template_fallback',\n              description: 'Use template-based content generation',\n              execute: async () => this.generateFromTemplate(postType, context, platform)\n            }\n          ]\n        );\n\n        if (generatedContent.content && generatedContent.content.length > 0) {\n          const synapseContent = generatedContent.content[0];\n\n          const post: GeneratedPost = {\n            id: `post-${Date.now()}-${i}`,\n            type: postType,\n            platform,\n            content: {\n              headline: synapseContent.platformContent[platform]?.headline,\n              hook: synapseContent.platformContent[platform]?.hook,\n              body: synapseContent.platformContent[platform]?.body || '',\n              hashtags: synapseContent.platformContent[platform]?.hashtags || [],\n              callToAction: synapseContent.platformContent[platform]?.cta,\n            },\n            visuals: [],\n            status: 'draft',\n            sources: this.createSources(context, synapseContent.insight),\n            metadata: {\n              impactScore: synapseContent.metadata.impactScore,\n              psychologyTriggers: synapseContent.metadata.psychologyTriggers,\n              tone: synapseContent.metadata.tone,\n              generatedAt: new Date(),\n              model: 'synapse',\n              templateUsed: template.id,\n            },\n          };\n\n          posts.push(post);\n\n          // Save partial progress every 3 posts\n          if (posts.length % 3 === 0) {\n            await this.savePartialResults(posts, sessionId);\n          }\n        }\n      } catch (error) {\n        console.error(`[CampaignGenerator] Failed to generate post ${i + 1}:`, error);\n        logError(error, {\n          postIndex: i,\n          postType: postTypes[i],\n          sessionId\n        });\n        errors.push(error as Error);\n\n        // Continue with next post instead of failing entire campaign\n      }\n    }\n\n    // If we have some posts, return them even if not all succeeded\n    if (posts.length > 0) {\n      console.log(`[CampaignGenerator] Generated ${posts.length}/${count} posts successfully`);\n      return posts;\n    }\n\n    // If no posts succeeded, throw aggregated error\n    throw new Error(`Failed to generate any posts. Errors: ${errors.length}`);\n  }\n\n  /**\n   * Template-based fallback content generation\n   */\n  private async generateFromTemplate(\n    postType: PostType,\n    context: BusinessContext,\n    platform: Platform\n  ): Promise<{ content: SynapseContent[] }> {\n    // Generate basic content using templates without AI\n    const templates: Record<PostType, { body: string; hashtags: string[] }> = {\n      customer_success: {\n        body: `${context.businessData.businessName} helps customers succeed. Learn how we can help you achieve your goals.`,\n        hashtags: ['#CustomerSuccess', '#BusinessGrowth'],\n      },\n      service_spotlight: {\n        body: `Discover ${context.businessData.businessName}'s services. We provide quality solutions for ${context.businessData.primaryCustomer || 'businesses like yours'}.`,\n        hashtags: ['#Services', '#Professional'],\n      },\n      problem_solution: {\n        body: `Facing challenges? ${context.businessData.businessName} has the solution. Let us help you overcome obstacles and achieve success.`,\n        hashtags: ['#Solutions', '#ProblemSolving'],\n      },\n      value_proposition: {\n        body: `What makes ${context.businessData.businessName} unique? We deliver exceptional value through ${context.businessData.selectedServices?.[0] || 'our services'}.`,\n        hashtags: ['#Value', '#Quality'],\n      },\n      behind_the_scenes: {\n        body: `Get a glimpse behind the scenes at ${context.businessData.businessName}. See how we create value for our customers.`,\n        hashtags: ['#BehindTheScenes', '#Transparency'],\n      },\n      community_engagement: {\n        body: `Join the ${context.businessData.businessName} community. Connect, share, and grow together.`,\n        hashtags: ['#Community', '#Engagement'],\n      },\n      educational: {\n        body: `Learn from ${context.businessData.businessName}. We share insights and knowledge to help you succeed.`,\n        hashtags: ['#Education', '#Learning'],\n      },\n      promotional: {\n        body: `Special offer from ${context.businessData.businessName}. Discover how we can help you today.`,\n        hashtags: ['#Promotion', '#SpecialOffer'],\n      },\n    };\n\n    const template = templates[postType] || templates.service_spotlight;\n\n    const synapseContent: SynapseContent = {\n      id: `template-${Date.now()}`,\n      format: 'hook-post',\n      insight: {\n        id: 'template-insight',\n        type: 'service',\n        discovery: template.body,\n        implication: 'Template-based content',\n        actionableHook: template.body,\n        confidence: 0.5,\n        sources: [context.businessData.websiteUrl],\n      },\n      platformContent: {\n        [platform]: {\n          body: template.body,\n          hashtags: template.hashtags,\n        }\n      },\n      metadata: {\n        impactScore: 0.5,\n        psychologyTriggers: [],\n        tone: 'professional',\n      }\n    };\n\n    return { content: [synapseContent] };\n  }\n\n  /**\n   * Save partial results during generation\n   */\n  private async savePartialResults(posts: GeneratedPost[], sessionId: string): Promise<void> {\n    try {\n      console.log(`[CampaignGenerator] Saving partial results: ${posts.length} posts`);\n      // TODO: Implement actual partial save logic\n      // For now, just log\n    } catch (error) {\n      logError(error, { sessionId, postsCount: posts.length });\n      console.error('[CampaignGenerator] Failed to save partial results:', error);\n      // Don't throw - this is just a backup save\n    }\n  }\n\n  /**\n   * Extract breakthrough insights from business context\n   */\n  private async extractInsights(context: BusinessContext): Promise<BreakthroughInsight[]> {\n    const insights: BreakthroughInsight[] = [];\n\n    // Extract from UVP data\n    if (context.uvpData) {\n      // Customer types insights\n      context.uvpData.customerTypes.forEach((customer, index) => {\n        insights.push({\n          id: `customer-${index}`,\n          type: 'audience',\n          discovery: customer.text,\n          implication: `Target messaging for ${customer.text}`,\n          actionableHook: `${customer.text} face unique challenges we can address`,\n          confidence: customer.confidence,\n          sources: [customer.source.sourceUrl],\n          targetAudience: customer.text,\n        });\n      });\n\n      // Differentiators insights\n      context.uvpData.differentiators.forEach((diff, index) => {\n        insights.push({\n          id: `differentiator-${index}`,\n          type: 'differentiator',\n          discovery: diff.text,\n          implication: 'Unique value proposition',\n          actionableHook: diff.text,\n          confidence: diff.confidence,\n          sources: [diff.source.sourceUrl],\n        });\n      });\n\n      // Problems solved insights\n      context.uvpData.problemsSolved.forEach((problem, index) => {\n        insights.push({\n          id: `problem-${index}`,\n          type: 'problem',\n          discovery: problem.text,\n          implication: 'Customer pain point to address',\n          actionableHook: `Solve ${problem.text} effectively`,\n          confidence: problem.confidence,\n          sources: [problem.source.sourceUrl],\n        });\n      });\n    }\n\n    // Ensure we have at least a few insights\n    if (insights.length === 0) {\n      // Create generic insights from business data\n      insights.push({\n        id: 'generic-1',\n        type: 'service',\n        discovery: `${context.businessData.businessName} provides quality services`,\n        implication: 'Build trust with service quality messaging',\n        actionableHook: 'Expert service you can trust',\n        confidence: 0.7,\n        sources: [context.businessData.websiteUrl],\n      });\n    }\n\n    return insights.slice(0, 10); // Limit to top 10 insights\n  }\n\n  /**\n   * Create business profile from context\n   */\n  private createBusinessProfile(context: BusinessContext): BusinessProfile {\n    return {\n      businessName: context.businessData.businessName,\n      industry: context.businessData.industry || 'General',\n      specialization: context.specialization || 'Professional Services',\n      targetAudience: context.businessData.primaryCustomer || 'Business Owners',\n      tone: context.websiteAnalysis?.tone || 'professional',\n      services: context.businessData.selectedServices || [],\n      location: context.businessData.location || '',\n    };\n  }\n\n  /**\n   * Distribute post types evenly across count\n   */\n  private distributePostTypes(templateTypes: PostType[], count: number): PostType[] {\n    const distributed: PostType[] = [];\n    for (let i = 0; i < count; i++) {\n      distributed.push(templateTypes[i % templateTypes.length]);\n    }\n    return distributed;\n  }\n\n  /**\n   * Map post type to content format\n   */\n  private mapPostTypeToFormat(\n    postType: PostType\n  ): 'hook-post' | 'story-post' | 'data-post' | 'controversial-post' {\n    const mapping: Record<PostType, any> = {\n      customer_success: 'story-post',\n      service_spotlight: 'hook-post',\n      problem_solution: 'hook-post',\n      value_proposition: 'data-post',\n      behind_the_scenes: 'story-post',\n      community_engagement: 'hook-post',\n      educational: 'data-post',\n      promotional: 'controversial-post',\n    };\n\n    return mapping[postType] || 'hook-post';\n  }\n\n  /**\n   * Create content sources\n   */\n  private createSources(\n    context: BusinessContext,\n    insight?: BreakthroughInsight\n  ): ContentSource[] {\n    const sources: ContentSource[] = [];\n\n    sources.push({\n      type: 'website',\n      url: context.businessData.websiteUrl,\n      confidence: 1.0,\n    });\n\n    if (insight) {\n      sources.push({\n        type: 'insight',\n        insightId: insight.id,\n        excerpt: insight.discovery,\n        confidence: insight.confidence,\n      });\n    }\n\n    return sources;\n  }\n\n  /**\n   * Calculate overall campaign confidence\n   */\n  private calculateCampaignConfidence(posts: GeneratedPost[]): number {\n    if (posts.length === 0) return 0;\n\n    const avgImpact =\n      posts.reduce((sum, post) => sum + (post.metadata.impactScore || 0), 0) / posts.length;\n\n    return avgImpact;\n  }\n\n  // ============================================================================\n  // VISUAL GENERATION\n  // ============================================================================\n\n  /**\n   * Generate visuals for all posts with error handling\n   */\n  private async generateVisualsForPosts(\n    posts: GeneratedPost[],\n    onRetry?: (retry: RetryProgress) => void\n  ): Promise<void> {\n    for (const post of posts) {\n      try {\n        post.visuals = await this.generateVisualsForPost(post, onRetry);\n      } catch (error) {\n        logError(error, { postId: post.id, platform: post.platform });\n        console.error(`[CampaignGenerator] Visual generation failed for post ${post.id}:`, error);\n        // Continue without visuals\n      }\n    }\n  }\n\n  /**\n   * Generate visuals for a single post with retry and fallback\n   */\n  private async generateVisualsForPost(\n    post: GeneratedPost,\n    onRetry?: (retry: RetryProgress) => void\n  ): Promise<PostVisual[]> {\n    try {\n      const visual = await ErrorHandlerService.executeWithRetry(\n        () => bannerbearService.generateImage({\n          template: this.selectBannerbearTemplate(post.platform, post.type),\n          modifications: {\n            headline: post.content.headline || '',\n            body: post.content.body.substring(0, 200),\n            cta: post.content.callToAction || '',\n          },\n        }),\n        {\n          maxAttempts: 2, // Fewer attempts for visuals\n          initialDelayMs: 1000,\n        },\n        onRetry,\n        [\n          // Fallback: Return empty visuals array\n          {\n            name: 'no_visuals',\n            description: 'Continue without visuals',\n            execute: async () => ({ image_url: null, uid: null, template: null })\n          }\n        ]\n      );\n\n      if (visual && visual.image_url) {\n        return [\n          {\n            id: visual.uid,\n            url: visual.image_url,\n            type: 'image',\n            bannerbearTemplateId: visual.template,\n            bannerbearImageId: visual.uid,\n            altText: post.content.headline || 'Generated visual',\n          },\n        ];\n      }\n\n      return [];\n    } catch (error) {\n      logError(error, { postId: post.id, platform: post.platform });\n      return []; // Continue without visuals\n    }\n  }\n\n  /**\n   * Select appropriate Bannerbear template\n   */\n  private selectBannerbearTemplate(platform: Platform, postType: PostType): string {\n    // Template selection logic based on platform and post type\n    // This would map to actual Bannerbear template IDs\n    const templates: Record<string, string> = {\n      'linkedin-customer_success': 'template-linkedin-story',\n      'linkedin-service_spotlight': 'template-linkedin-service',\n      'facebook-customer_success': 'template-facebook-story',\n      'instagram-customer_success': 'template-instagram-story',\n    };\n\n    const key = `${platform}-${postType}`;\n    return templates[key] || 'template-default';\n  }\n\n  // ============================================================================\n  // DATABASE OPERATIONS\n  // ============================================================================\n\n  /**\n   * Save campaign and posts to database\n   */\n  private async saveCampaignToDatabase(\n    input: CampaignGenerationInput,\n    posts: GeneratedPost[]\n  ): Promise<void> {\n    // TODO: Implement database persistence\n    // The existing campaignDB service uses different types (CampaignWorkflow)\n    // Need to either:\n    // 1. Create adapter to convert GeneratedCampaign -> CampaignWorkflow types\n    // 2. Add new methods to campaignDB for GeneratedCampaign types\n    // 3. Create separate database service for campaign generation\n\n    console.log(`[CampaignGenerator] Database save not yet implemented for ${input.campaignId}`);\n    console.log(`[CampaignGenerator] Would save campaign with ${posts.length} posts`);\n\n    // For now, just log success\n    // try {\n    //   await campaignDB.saveDraft({\n    //     businessId: input.businessContext.businessData.businessName,\n    //     campaignName: `${input.campaignType} Campaign`,\n    //     campaignType: input.campaignType,\n    //   });\n    // } catch (error) {\n    //   console.error('[CampaignGenerator] Database save failed:', error);\n    // }\n  }\n\n  /**\n   * Save single post to database\n   */\n  private async savePostToDatabase(\n    post: GeneratedPost,\n    context: BusinessContext,\n    campaignId?: string\n  ): Promise<void> {\n    // TODO: Implement database persistence for single posts\n    // Same issue as saveCampaignToDatabase - need type adapters\n\n    console.log(`[CampaignGenerator] Database save not yet implemented for post ${post.id}`);\n\n    // For now, just log success\n    // try {\n    //   await campaignDB.saveContentPieces(...);\n    // } catch (error) {\n    //   console.error(`[CampaignGenerator] Failed to save post ${post.id}:`, error);\n    // }\n  }\n\n  // ============================================================================\n  // PROGRESS TRACKING\n  // ============================================================================\n\n  /**\n   * Initialize progress tracking\n   */\n  private initializeProgress(sessionId: string, totalPosts: number): GenerationProgress {\n    return {\n      sessionId,\n      stage: 'initializing',\n      progress: 0,\n      currentPost: 0,\n      totalPosts,\n      errors: [],\n    };\n  }\n\n  /**\n   * Update progress\n   */\n  private updateProgress(\n    sessionId: string,\n    stage: GenerationStage,\n    progress: number,\n    currentPost?: number,\n    totalPosts?: number\n  ): void {\n    const callback = this.progressCallbacks.get(sessionId);\n    if (callback) {\n      callback({\n        sessionId,\n        stage,\n        progress,\n        currentPost,\n        totalPosts: totalPosts || 0,\n        errors: [],\n      });\n    }\n  }\n\n  /**\n   * Subscribe to progress updates\n   */\n  onProgress(sessionId: string, callback: (progress: GenerationProgress) => void): void {\n    this.progressCallbacks.set(sessionId, callback);\n  }\n\n  /**\n   * Unsubscribe from progress updates\n   */\n  offProgress(sessionId: string): void {\n    this.progressCallbacks.delete(sessionId);\n  }\n\n  /**\n   * Get actionable error message for user\n   */\n  private getActionableErrorMessage(error: unknown, context: string): string {\n    const appError = ErrorHandlerService.categorizeError(error);\n\n    const messages = {\n      network: `Network issue while ${context}. Retrying automatically...`,\n      api_limit: `AI service is busy. Retrying in a moment...`,\n      timeout: `${context} is taking longer than expected. Retrying...`,\n      server_error: `Temporary server issue. Retrying automatically...`,\n      authentication: `Authentication failed. Please check your API keys in settings.`,\n      validation: `Invalid data for ${context}. Please check your inputs.`,\n      unknown: `An unexpected error occurred while ${context}. Retrying...`,\n    };\n\n    return messages[appError.category] || messages.unknown;\n  }\n}\n\n// Export singleton instance\nexport const campaignGenerator = new CampaignGenerator();\n","/**\n * Campaign Type Definitions (V3 - Research-Validated)\n *\n * Defines the five V3 campaign types for Synapse (5-14 days each):\n * - Authority Builder (7 days): Positions business as industry expert\n * - Community Champion (14 days): Local community connection and engagement\n * - Trust Builder (10 days): Leverages customer reviews and testimonials\n * - Revenue Rush (5 days): Social commerce for immediate sales\n * - Viral Spark (7 days): Video-first content for massive reach\n */\n\nexport type CampaignTypeId = 'authority_builder' | 'community_champion' | 'trust_builder' | 'revenue_rush' | 'viral_spark';\n\n/**\n * Campaign Type Metadata\n */\nexport interface CampaignTypeMetadata {\n  id: CampaignTypeId;\n  name: string;\n  description: string;\n  icon: string; // Lucide icon name\n  idealFor: string[];\n  platforms: string[]; // Best platforms for this type\n  contentFormats: string[]; // Types of content this generates\n  exampleOutputs: string[];\n  dataSources: string[]; // Which intelligence sources are used\n  color: string; // Tailwind color class\n}\n\n/**\n * Campaign Type with Recommendation Context\n */\nexport interface CampaignType extends CampaignTypeMetadata {\n  recommended?: boolean;\n  recommendationReason?: string;\n  confidenceScore?: number; // 0-1\n}\n\n/**\n * Campaign Type Registry (V3)\n * Complete definitions for all five V3 campaign types\n */\nexport const CAMPAIGN_TYPES: Record<CampaignTypeId, CampaignTypeMetadata> = {\n  authority_builder: {\n    id: 'authority_builder',\n    name: 'Authority Builder',\n    description: '7 days to visible expert - thought leadership content positioning you as the go-to industry authority',\n    icon: 'GraduationCap',\n    idealFor: [\n      'B2B businesses and professional services',\n      'Consultants and service providers',\n      'Businesses with deep industry expertise',\n      'Technical or specialized fields'\n    ],\n    platforms: ['LinkedIn', 'Facebook'],\n    contentFormats: [\n      'Video tutorials (15-60 seconds)',\n      'Industry insights and trends',\n      'How-to guides',\n      'Behind-the-scenes expertise',\n      'Quick tips and tutorials'\n    ],\n    exampleOutputs: [\n      '\"5 Industry Trends Every [Industry] Should Watch\"',\n      '\"Why Most Companies Get [Problem] Wrong (And How to Fix It)\"',\n      '\"Quick Tutorial: How to [Solve Problem] in 60 Seconds\"'\n    ],\n    dataSources: [\n      'YouTube content analysis',\n      'Industry trends',\n      'Website expertise',\n      'Review insights'\n    ],\n    color: 'blue'\n  },\n\n  community_champion: {\n    id: 'community_champion',\n    name: 'Community Champion',\n    description: 'Local community leader in 14 days - connection, customer stories, and local exclusive offers',\n    icon: 'MapPin',\n    idealFor: [\n      'Local businesses (restaurant, salon, retail)',\n      'Brick-and-mortar stores',\n      'Service area businesses',\n      'Neighborhood businesses'\n    ],\n    platforms: ['Facebook', 'Instagram', 'Google Business'],\n    contentFormats: [\n      'Behind-the-scenes videos',\n      'Local event coverage',\n      'Customer spotlights',\n      'Community involvement posts',\n      'Local exclusive offers'\n    ],\n    exampleOutputs: [\n      '\"Downtown parking problem affecting our neighbors\"',\n      '\"Partnering with [local festival from Perplexity]\"',\n      '\"How we helped Sarah from Main Street save $2000\"'\n    ],\n    dataSources: [\n      'Perplexity (local events)',\n      'Weather patterns',\n      'Local news',\n      'Google Reviews'\n    ],\n    color: 'orange'\n  },\n\n  trust_builder: {\n    id: 'trust_builder',\n    name: 'Trust Builder',\n    description: 'Build credibility in 10 days - customer transformation stories and video testimonials',\n    icon: 'Award',\n    idealFor: [\n      'New businesses (< 2 years)',\n      'High-consideration purchases',\n      'Competitive markets',\n      'Service businesses'\n    ],\n    platforms: ['Facebook', 'Instagram'],\n    contentFormats: [\n      'Customer video testimonials',\n      'Before/after photos',\n      'Review highlights',\n      'Transformation stories',\n      'Social proof amplification'\n    ],\n    exampleOutputs: [\n      '\"How [Customer Name] Achieved [Result] in Just [Timeframe]\"',\n      '\"Rated 4.9â by 500+ Customers: Here\\'s What They Say\"',\n      '\"Real Results: [Customer] Saved $X Using Our [Service]\"'\n    ],\n    dataSources: [\n      'Google Reviews',\n      'Customer testimonials',\n      'YouTube comments',\n      'Social media mentions'\n    ],\n    color: 'green'\n  },\n\n  revenue_rush: {\n    id: 'revenue_rush',\n    name: 'Revenue Rush',\n    description: 'Drive immediate sales in 5 days - shoppable posts and limited offers with social commerce',\n    icon: 'DollarSign',\n    idealFor: [\n      'E-commerce businesses',\n      'Retail stores',\n      'Service packages',\n      'Seasonal businesses'\n    ],\n    platforms: ['Instagram Shopping', 'Facebook Shop'],\n    contentFormats: [\n      'Product videos and demos',\n      'Customer unboxings',\n      'Shoppable posts/Stories',\n      'Limited-time offers',\n      'Countdown posts'\n    ],\n    exampleOutputs: [\n      '\"Flash Sale: 48 Hours Only - Shop Now\"',\n      '\"Customer Favorite: See Why Everyone Loves This\"',\n      '\"Limited Stock: Only 10 Left - Tag to Purchase\"'\n    ],\n    dataSources: [\n      'Product Scanner',\n      'Review mining',\n      'Seasonal triggers',\n      'Competitive pricing'\n    ],\n    color: 'purple'\n  },\n\n  viral_spark: {\n    id: 'viral_spark',\n    name: 'Viral Spark',\n    description: 'Massive reach in 7 days - trending TikTok/Reels content with authenticity over polish',\n    icon: 'Sparkles',\n    idealFor: [\n      'All SMBs seeking visibility',\n      'B2C businesses',\n      'Local businesses',\n      'Personality-driven brands'\n    ],\n    platforms: ['TikTok', 'Instagram Reels'],\n    contentFormats: [\n      'Trending challenges',\n      'Behind-the-scenes moments',\n      'Relatable content',\n      'Personality-driven videos',\n      'Trending audio participation'\n    ],\n    exampleOutputs: [\n      '\"POV: You walk into [Business] and see this\"',\n      '\"Things you didn\\'t know about [Industry]\"',\n      '\"Trying the viral [trend] at our [business]\"'\n    ],\n    dataSources: [\n      'TikTok/Instagram trending sounds',\n      'Viral challenge patterns',\n      'YouTube Shorts analytics',\n      'Competitor viral content'\n    ],\n    color: 'pink'\n  }\n};\n\n/**\n * Get all campaign types as an array\n */\nexport function getAllCampaignTypes(): CampaignTypeMetadata[] {\n  return Object.values(CAMPAIGN_TYPES);\n}\n\n/**\n * Get campaign type by ID\n */\nexport function getCampaignType(id: CampaignTypeId): CampaignTypeMetadata | undefined {\n  return CAMPAIGN_TYPES[id];\n}\n","/**\n * Campaign Recommender Service\n * \n * Analyzes DeepContext intelligence data to recommend the best campaign type\n * for a given business based on:\n * - Available data strength (reviews, location, expertise)\n * - Industry characteristics\n * - Business type and goals\n */\n\nimport { DeepContext } from '../../types/synapse/deepContext.types';\nimport { CampaignType, CampaignTypeId, CAMPAIGN_TYPES } from '../../types/campaign.types';\n\nexport interface RecommendationResult {\n  recommended: CampaignType;\n  all: CampaignType[];\n  reasoning: string;\n  confidenceScore: number;\n  dataStrength: {\n    authority: number;\n    socialProof: number;\n    localPulse: number;\n  };\n}\n\n/**\n * Campaign Recommender\n */\nexport class CampaignRecommender {\n  \n  /**\n   * Recommend the best campaign type based on DeepContext\n   */\n  recommendCampaignType(context: DeepContext): RecommendationResult {\n    const scores = this.calculateScores(context);\n    \n    // Determine which has highest score\n    const highestScore = Math.max(scores.authority, scores.socialProof, scores.localPulse);\n    \n    let recommendedId: CampaignTypeId;\n    let reasoning: string;\n    \n    if (scores.authority === highestScore) {\n      recommendedId = 'authority_builder';\n      reasoning = this.getAuthorityReasoning(context, scores);\n    } else if (scores.socialProof === highestScore) {\n      recommendedId = 'social_proof';\n      reasoning = this.getSocialProofReasoning(context, scores);\n    } else {\n      recommendedId = 'local_pulse';\n      reasoning = this.getLocalPulseReasoning(context, scores);\n    }\n    \n    // Build response with all types and mark recommended\n    const allTypes: CampaignType[] = Object.values(CAMPAIGN_TYPES).map(type => ({\n      ...type,\n      recommended: type.id === recommendedId,\n      recommendationReason: type.id === recommendedId ? reasoning : undefined,\n      confidenceScore: this.getConfidenceForType(type.id, scores)\n    }));\n    \n    const recommended = allTypes.find(t => t.id === recommendedId)!;\n    \n    return {\n      recommended,\n      all: allTypes,\n      reasoning,\n      confidenceScore: highestScore,\n      dataStrength: {\n        authority: scores.authority,\n        socialProof: scores.socialProof,\n        localPulse: scores.localPulse\n      }\n    };\n  }\n  \n  /**\n   * Calculate scores for each campaign type (0-1)\n   */\n  private calculateScores(context: DeepContext): {\n    authority: number;\n    socialProof: number;\n    localPulse: number;\n  } {\n    return {\n      authority: this.scoreAuthority(context),\n      socialProof: this.scoreSocialProof(context),\n      localPulse: this.scoreLocalPulse(context)\n    };\n  }\n  \n  /**\n   * Score Authority Builder potential (0-1)\n   * Based on: industry expertise, trends data, competitive intelligence\n   */\n  private scoreAuthority(context: DeepContext): number {\n    let score = 0;\n    let factors = 0;\n    \n    // Check for industry expertise data\n    if (context.business?.profile?.industry) {\n      score += 0.3;\n      factors++;\n    }\n    \n    // Check for industry trends\n    if (context.industry?.trends && context.industry.trends.length > 0) {\n      score += 0.2;\n      factors++;\n    }\n    \n    // Check for competitive intelligence\n    if (context.competitiveIntel?.opportunities && context.competitiveIntel.opportunities.length > 0) {\n      score += 0.2;\n      factors++;\n    }\n    \n    // Check for synthesis insights (indicates strong analytical capacity)\n    if (context.synthesis?.keyInsights && context.synthesis.keyInsights.length > 3) {\n      score += 0.15;\n      factors++;\n    }\n    \n    // B2B businesses score higher for authority\n    if (context.business?.profile?.industry &&\n        (context.business.profile.industry.toLowerCase().includes('consulting') ||\n         context.business.profile.industry.toLowerCase().includes('professional') ||\n         context.business.profile.industry.toLowerCase().includes('service'))) {\n      score += 0.15;\n      factors++;\n    }\n    \n    return factors > 0 ? Math.min(score, 1) : 0.3; // Minimum baseline\n  }\n  \n  /**\n   * Score Social Proof potential (0-1)\n   * Based on: customer reviews, testimonials, success stories\n   */\n  private scoreSocialProof(context: DeepContext): number {\n    let score = 0;\n    let factors = 0;\n    \n    // Check for review data (OutScraper)\n    // Note: DeepContext structure may vary, adapt as needed\n    const hasReviews = context.realTimeCultural?.reviews !== undefined &&\n                       context.realTimeCultural?.reviews !== null;\n    \n    if (hasReviews) {\n      score += 0.4; // Strong indicator\n      factors++;\n    }\n    \n    // Check for customer psychology insights\n    if (context.customerPsychology?.identityDesires &&\n        context.customerPsychology.identityDesires.length > 0) {\n      score += 0.2;\n      factors++;\n    }\n    \n    // Check for testimonial-worthy insights\n    if (context.synthesis?.keyInsights &&\n        context.synthesis.keyInsights.some(insight =>\n          insight.toLowerCase().includes('customer') ||\n          insight.toLowerCase().includes('review')\n        )) {\n      score += 0.2;\n      factors++;\n    }\n    \n    // Local businesses often have strong review presence\n    if (context.business?.profile?.location && context.business.profile.location.city) {\n      score += 0.2;\n      factors++;\n    }\n    \n    return factors > 0 ? Math.min(score, 1) : 0.3; // Minimum baseline\n  }\n  \n  /**\n   * Score Local Pulse potential (0-1)\n   * Based on: location data, weather, local events, timing\n   */\n  private scoreLocalPulse(context: DeepContext): number {\n    let score = 0;\n    let factors = 0;\n    \n    // Strong location data is essential\n    if (context.business?.profile?.location && context.business.profile.location.city) {\n      score += 0.3;\n      factors++;\n    }\n    \n    // Weather data available\n    if (context.realTimeCultural?.weather !== undefined) {\n      score += 0.25;\n      factors++;\n    }\n    \n    // Local events data\n    if (context.realTimeCultural?.localEvents && \n        context.realTimeCultural.localEvents.length > 0) {\n      score += 0.25;\n      factors++;\n    }\n    \n    // Trending local topics\n    if (context.realTimeCultural?.trendingTopics && \n        context.realTimeCultural.trendingTopics.some(topic => \n          topic.scope === 'local'\n        )) {\n      score += 0.2;\n      factors++;\n    }\n    \n    return factors > 0 ? Math.min(score, 1) : 0.3; // Minimum baseline\n  }\n  \n  /**\n   * Get confidence score for a specific type\n   */\n  private getConfidenceForType(\n    typeId: CampaignTypeId, \n    scores: { authority: number; socialProof: number; localPulse: number }\n  ): number {\n    switch (typeId) {\n      case 'authority_builder':\n        return scores.authority;\n      case 'social_proof':\n        return scores.socialProof;\n      case 'local_pulse':\n        return scores.localPulse;\n      default:\n        return 0.5;\n    }\n  }\n  \n  /**\n   * Generate reasoning for Authority Builder recommendation\n   */\n  private getAuthorityReasoning(\n    context: DeepContext, \n    scores: { authority: number; socialProof: number; localPulse: number }\n  ): string {\n    const reasons: string[] = [];\n    \n    if (context.business?.profile?.industry) {\n      reasons.push(`Your specialized expertise in ${context.business.profile.industry} positions you as an authority`);\n    }\n    \n    if (context.industry?.trends && context.industry.trends.length > 0) {\n      reasons.push(`${context.industry.trends.length} industry trends detected for thought leadership content`);\n    }\n    \n    if (context.competitiveIntel?.opportunities && context.competitiveIntel.opportunities.length > 0) {\n      reasons.push(`Identified ${context.competitiveIntel.opportunities.length} competitive gaps to address with expert content`);\n    }\n    \n    if (reasons.length === 0) {\n      return 'Your industry and business type benefit most from establishing thought leadership';\n    }\n    \n    return reasons.join('. ') + '.';\n  }\n  \n  /**\n   * Generate reasoning for Social Proof recommendation\n   */\n  private getSocialProofReasoning(\n    context: DeepContext,\n    scores: { authority: number; socialProof: number; localPulse: number }\n  ): string {\n    const reasons: string[] = [];\n    \n    if (context.realTimeCultural?.reviews) {\n      reasons.push('Strong customer review presence detected');\n    }\n\n    if (context.customerPsychology?.identityDesires) {\n      reasons.push(`Understanding of ${context.customerPsychology.identityDesires.length} customer desires enables compelling testimonial content`);\n    }\n\n    if (context.business?.profile?.location) {\n      reasons.push('Local business profile ideal for customer success stories');\n    }\n    \n    if (reasons.length === 0) {\n      return 'Your customer base and service delivery model are perfect for social proof campaigns';\n    }\n    \n    return reasons.join('. ') + '.';\n  }\n  \n  /**\n   * Generate reasoning for Local Pulse recommendation\n   */\n  private getLocalPulseReasoning(\n    context: DeepContext,\n    scores: { authority: number; socialProof: number; localPulse: number }\n  ): string {\n    const reasons: string[] = [];\n    \n    if (context.business?.profile?.location?.city) {\n      reasons.push(`Strong local presence in ${context.business.profile.location.city}`);\n    }\n    \n    if (context.realTimeCultural?.weather) {\n      reasons.push('Weather intelligence available for timely campaigns');\n    }\n    \n    if (context.realTimeCultural?.localEvents && context.realTimeCultural.localEvents.length > 0) {\n      reasons.push(`${context.realTimeCultural.localEvents.length} local events identified for tie-in opportunities`);\n    }\n    \n    if (reasons.length === 0) {\n      return 'Your local market position and timing opportunities are strongest';\n    }\n    \n    return reasons.join('. ') + '.';\n  }\n}\n\n// Export singleton instance\nexport const campaignRecommender = new CampaignRecommender();\n","/**\n * Smart Picks Type Definitions\n *\n * AI-recommended campaign suggestions with confidence scoring,\n * data provenance, and trust indicators\n *\n * Created: 2025-11-15\n */\n\nimport type { SynapseInsight } from './synapse/synapse.types'\nimport type { DeepContext } from './synapse/deepContext.types'\n\n// ============================================================================\n// CAMPAIGN TYPES\n// ============================================================================\n\nexport type CampaignType = 'authority-builder' | 'social-proof' | 'local-pulse'\n\nexport interface CampaignTypeMetadata {\n  id: CampaignType\n  name: string\n  description: string\n  icon: string\n  idealFor: string[]\n  platforms: string[]\n  color: string\n}\n\nexport const CAMPAIGN_TYPES: Record<CampaignType, CampaignTypeMetadata> = {\n  'authority-builder': {\n    id: 'authority-builder',\n    name: 'Authority Builder',\n    description: 'Establishes industry expertise through data, insights, and thought leadership',\n    icon: 'TrendingUp',\n    idealFor: ['B2B services', 'Professional services', 'Consultants', 'Technical businesses'],\n    platforms: ['LinkedIn', 'Twitter', 'Blog'],\n    color: 'blue'\n  },\n  'social-proof': {\n    id: 'social-proof',\n    name: 'Social Proof',\n    description: 'Leverages customer reviews, testimonials, and success stories',\n    icon: 'Star',\n    idealFor: ['Local businesses', 'E-commerce', 'Service providers', 'Restaurants'],\n    platforms: ['Facebook', 'Instagram', 'Google Business'],\n    color: 'yellow'\n  },\n  'local-pulse': {\n    id: 'local-pulse',\n    name: 'Local Pulse',\n    description: 'Connects to local events, weather, and community moments',\n    icon: 'MapPin',\n    idealFor: ['Local retailers', 'Restaurants', 'Service businesses', 'Community-focused brands'],\n    platforms: ['Facebook', 'Instagram', 'Nextdoor'],\n    color: 'green'\n  }\n}\n\n// ============================================================================\n// SMART PICK\n// ============================================================================\n\nexport interface SmartPick {\n  /** Unique identifier */\n  id: string\n\n  /** Campaign type this belongs to */\n  campaignType: CampaignType\n\n  /** Human-readable title for the pick */\n  title: string\n\n  /** The core insight combination */\n  insights: SynapseInsight[]\n\n  /** Preview of generated content */\n  preview: {\n    headline: string\n    hook: string\n    platform: string\n  }\n\n  /** Confidence score (0-1) */\n  confidence: number\n\n  /** Relevance score (0-1) */\n  relevance: number\n\n  /** Timeliness score (0-1) - how timely is this content */\n  timeliness: number\n\n  /** Evidence quality score (0-1) */\n  evidenceQuality: number\n\n  /** Overall pick score (weighted combination) */\n  overallScore: number\n\n  /** Data sources used */\n  dataSources: DataSourceInfo[]\n\n  /** Explanation of why this is recommended */\n  reasoning: string\n\n  /** Expected performance indicators */\n  expectedPerformance: {\n    engagement: 'low' | 'medium' | 'high'\n    reach: 'low' | 'medium' | 'high'\n    conversions: 'low' | 'medium' | 'high'\n  }\n\n  /** Metadata */\n  metadata: {\n    generatedAt: Date\n    expiresAt?: Date // For time-sensitive picks\n  }\n}\n\n// ============================================================================\n// DATA SOURCE INFO\n// ============================================================================\n\nexport interface DataSourceInfo {\n  /** Source name */\n  source: 'weather' | 'reviews' | 'trends' | 'news' | 'competitors' | 'reddit' | 'youtube' | 'location' | 'industry' | 'semrush'\n\n  /** Icon name for UI */\n  icon: string\n\n  /** Display label */\n  label: string\n\n  /** Is this data verified/trusted */\n  verified: boolean\n\n  /** Data freshness */\n  freshness: 'real-time' | 'hourly' | 'daily' | 'weekly' | 'static'\n\n  /** Number of data points from this source */\n  dataPoints: number\n}\n\n// ============================================================================\n// SMART PICK GENERATION OPTIONS\n// ============================================================================\n\nexport interface SmartPickGenerationOptions {\n  /** Maximum number of picks to generate */\n  maxPicks?: number\n\n  /** Minimum confidence threshold (0-1) */\n  minConfidence?: number\n\n  /** Filter by campaign type */\n  campaignType?: CampaignType\n\n  /** Prefer time-sensitive content */\n  preferTimely?: boolean\n\n  /** Include preview generation */\n  includePreview?: boolean\n}\n\n// ============================================================================\n// SMART PICK GENERATION RESULT\n// ============================================================================\n\nexport interface SmartPickGenerationResult {\n  /** Generated picks */\n  picks: SmartPick[]\n\n  /** Context used for generation */\n  context: DeepContext\n\n  /** Generation metadata */\n  metadata: {\n    totalCandidates: number\n    picksGenerated: number\n    generationTimeMs: number\n    strategiesUsed: string[]\n  }\n}\n\n// ============================================================================\n// SCORING WEIGHTS\n// ============================================================================\n\nexport interface ScoringWeights {\n  /** Weight for relevance (0-1) */\n  relevance: number\n\n  /** Weight for timeliness (0-1) */\n  timeliness: number\n\n  /** Weight for evidence quality (0-1) */\n  evidenceQuality: number\n\n  /** Weight for confidence (0-1) */\n  confidence: number\n}\n\nexport const DEFAULT_SCORING_WEIGHTS: ScoringWeights = {\n  relevance: 0.35,\n  timeliness: 0.25,\n  evidenceQuality: 0.25,\n  confidence: 0.15\n}\n","/**\n * Smart Pick Generator Service\n *\n * Intelligently selects and scores 3-5 best campaign ideas from available\n * Synapse insights based on relevance, timeliness, and evidence quality\n *\n * Scoring Algorithm:\n * - Relevance: How well insights match business/industry\n * - Timeliness: How time-sensitive the content is\n * - Evidence Quality: Strength of supporting data\n * - Confidence: AI model confidence in the insight\n *\n * Created: 2025-11-15\n */\n\nimport type { DeepContext } from '@/types/synapse/deepContext.types'\nimport type { SynapseInsight } from '@/types/synapse/synapse.types'\nimport type {\n  SmartPick,\n  CampaignType,\n  SmartPickGenerationOptions,\n  SmartPickGenerationResult,\n  ScoringWeights,\n  DataSourceInfo\n} from '@/types/smart-picks.types'\nimport { DEFAULT_SCORING_WEIGHTS } from '@/types/smart-picks.types'\nimport { generateSynapses, type SynapseInput } from '@/services/synapse/SynapseGenerator'\nimport { chat } from '@/lib/openrouter'\nimport { ErrorHandlerService, logError } from '../errors/error-handler.service'\n\n// ============================================================================\n// MAIN API\n// ============================================================================\n\n/**\n * Generate Smart Picks from DeepContext\n *\n * @param context - Deep business intelligence context\n * @param campaignType - Optional filter by campaign type\n * @param options - Generation options\n * @returns Smart picks with scoring and recommendations\n */\nexport async function generateSmartPicks(\n  context: DeepContext,\n  campaignType?: CampaignType,\n  options: SmartPickGenerationOptions = {}\n): Promise<SmartPickGenerationResult> {\n  const startTime = Date.now()\n\n  console.log('[SmartPickGenerator] Generating smart picks...')\n  console.log('[SmartPickGenerator] Campaign type filter:', campaignType || 'all')\n\n  const {\n    maxPicks = 5,\n    minConfidence = 0.6,\n    preferTimely = true,\n    includePreview = true\n  } = options\n\n  try {\n    // Step 1: Generate or use existing Synapse insights\n    const insights = await getOrGenerateInsights(context)\n\n    console.log(`[SmartPickGenerator] Found ${insights.length} total insights`)\n\n    // Step 2: Filter low-confidence insights\n    const qualityInsights = insights.filter(i => i.confidence >= minConfidence)\n\n    console.log(`[SmartPickGenerator] ${qualityInsights.length} insights meet confidence threshold (>=${minConfidence})`)\n\n    // Step 3: Generate candidates for each campaign type\n    const candidates: SmartPick[] = []\n\n    if (!campaignType || campaignType === 'authority-builder') {\n      candidates.push(...await generateAuthorityBuilderPicks(context, qualityInsights, includePreview))\n    }\n\n    if (!campaignType || campaignType === 'social-proof') {\n      candidates.push(...await generateSocialProofPicks(context, qualityInsights, includePreview))\n    }\n\n    if (!campaignType || campaignType === 'local-pulse') {\n      candidates.push(...await generateLocalPulsePicks(context, qualityInsights, includePreview))\n    }\n\n    console.log(`[SmartPickGenerator] Generated ${candidates.length} candidate picks`)\n\n    // Step 4: Score all candidates\n    const scoredPicks = candidates.map(pick => scoreSmartPick(pick, context, preferTimely))\n\n    // Step 5: Sort by overall score\n    scoredPicks.sort((a, b) => b.overallScore - a.overallScore)\n\n    // Step 6: Take top N\n    const topPicks = scoredPicks.slice(0, maxPicks)\n\n    const generationTimeMs = Date.now() - startTime\n\n    console.log(`[SmartPickGenerator] Selected ${topPicks.length} top picks in ${generationTimeMs}ms`)\n\n    return {\n      picks: topPicks,\n      context,\n      metadata: {\n        totalCandidates: candidates.length,\n        picksGenerated: topPicks.length,\n        generationTimeMs,\n        strategiesUsed: ['authority-builder', 'social-proof', 'local-pulse']\n      }\n    }\n  } catch (error) {\n    console.error('[SmartPickGenerator] Generation failed:', error)\n    logError(error, { campaignType, businessId: context.business?.profile?.name })\n\n    // Return template-based picks as fallback\n    const fallbackPicks = campaignType\n      ? generateTemplatePicks(context, campaignType)\n      : [\n          ...generateTemplatePicks(context, 'authority-builder'),\n          ...generateTemplatePicks(context, 'social-proof'),\n          ...generateTemplatePicks(context, 'local-pulse')\n        ].slice(0, maxPicks)\n\n    const generationTimeMs = Date.now() - startTime\n\n    return {\n      picks: fallbackPicks,\n      context,\n      metadata: {\n        totalCandidates: 0,\n        picksGenerated: fallbackPicks.length,\n        generationTimeMs,\n        strategiesUsed: ['template-fallback'],\n        fallback: true\n      }\n    }\n  }\n}\n\n// ============================================================================\n// INSIGHT GENERATION\n// ============================================================================\n\nasync function getOrGenerateInsights(context: DeepContext): Promise<SynapseInsight[]> {\n  // Check if insights already exist in context\n  if (context.synthesis?.insights && context.synthesis.insights.length > 0) {\n    console.log('[SmartPickGenerator] Using existing insights from context')\n    return context.synthesis.insights\n  }\n\n  // Generate new insights using Synapse Generator\n  console.log('[SmartPickGenerator] Generating new insights...')\n\n  const synapseInput: SynapseInput = {\n    business: {\n      name: context.business.profile.name,\n      industry: context.business.profile.industry,\n      location: {\n        city: context.business.profile.location.city,\n        state: context.business.profile.location.state\n      }\n    },\n    intelligence: context\n  }\n\n  const result = await generateSynapses(synapseInput)\n\n  return result.synapses\n}\n\n// ============================================================================\n// CAMPAIGN TYPE STRATEGIES\n// ============================================================================\n\n/**\n * Authority Builder: Industry expertise, data-driven insights\n */\nasync function generateAuthorityBuilderPicks(\n  context: DeepContext,\n  insights: SynapseInsight[],\n  includePreview: boolean\n): Promise<SmartPick[]> {\n  // Look for insights with strong evidence and industry connections\n  const authorityInsights = insights.filter(insight =>\n    insight.type === 'unexpected_connection' ||\n    insight.type === 'counter_intuitive' ||\n    insight.type === 'predictive_opportunity' ||\n    (insight.evidence && insight.evidence.length >= 2)\n  )\n\n  const picks: SmartPick[] = []\n\n  for (const insight of authorityInsights.slice(0, 3)) {\n    const pick: SmartPick = {\n      id: `authority-${insight.id}`,\n      campaignType: 'authority-builder',\n      title: `Industry Insight: ${truncate(insight.insight, 60)}`,\n      insights: [insight],\n      preview: includePreview\n        ? await generatePreview(insight, context, 'authority-builder')\n        : { headline: '', hook: '', platform: 'LinkedIn' },\n      confidence: insight.confidence,\n      relevance: 0, // Will be scored later\n      timeliness: 0,\n      evidenceQuality: calculateEvidenceQuality(insight),\n      overallScore: 0,\n      dataSources: extractDataSources(context, insight),\n      reasoning: `Strong evidence-based insight about ${context.business.profile.industry}. Perfect for establishing thought leadership on LinkedIn.`,\n      expectedPerformance: {\n        engagement: 'medium',\n        reach: 'medium',\n        conversions: 'low'\n      },\n      metadata: {\n        generatedAt: new Date()\n      }\n    }\n\n    picks.push(pick)\n  }\n\n  return picks\n}\n\n/**\n * Social Proof: Reviews, testimonials, customer success\n */\nasync function generateSocialProofPicks(\n  context: DeepContext,\n  insights: SynapseInsight[],\n  includePreview: boolean\n): Promise<SmartPick[]> {\n  // Look for insights related to customer psychology or social validation\n  const socialInsights = insights.filter(insight =>\n    insight.type === 'deep_psychology' ||\n    insight.type === 'cultural_moment' ||\n    (insight.insight.toLowerCase().includes('customer') ||\n     insight.insight.toLowerCase().includes('review') ||\n     insight.insight.toLowerCase().includes('testimonial'))\n  )\n\n  const picks: SmartPick[] = []\n\n  for (const insight of socialInsights.slice(0, 3)) {\n    const pick: SmartPick = {\n      id: `social-${insight.id}`,\n      campaignType: 'social-proof',\n      title: `Customer Story: ${truncate(insight.insight, 60)}`,\n      insights: [insight],\n      preview: includePreview\n        ? await generatePreview(insight, context, 'social-proof')\n        : { headline: '', hook: '', platform: 'Facebook' },\n      confidence: insight.confidence,\n      relevance: 0,\n      timeliness: 0,\n      evidenceQuality: calculateEvidenceQuality(insight),\n      overallScore: 0,\n      dataSources: extractDataSources(context, insight),\n      reasoning: `Leverages customer psychology and social validation. Great for Facebook and Instagram.`,\n      expectedPerformance: {\n        engagement: 'high',\n        reach: 'high',\n        conversions: 'medium'\n      },\n      metadata: {\n        generatedAt: new Date()\n      }\n    }\n\n    picks.push(pick)\n  }\n\n  return picks\n}\n\n/**\n * Local Pulse: Weather, events, local news\n */\nasync function generateLocalPulsePicks(\n  context: DeepContext,\n  insights: SynapseInsight[],\n  includePreview: boolean\n): Promise<SmartPick[]> {\n  // Check if we have location-based intelligence\n  const hasLocation = context.business.profile.location.city\n  const hasWeather = context.cultural?.currentContext?.some(c => c.source === 'weather')\n  const hasLocalNews = context.cultural?.currentContext?.some(c => c.source === 'local_news')\n\n  if (!hasLocation) {\n    console.log('[SmartPickGenerator] No location data for local pulse picks')\n    return []\n  }\n\n  // Look for time-sensitive, location-relevant insights\n  const localInsights = insights.filter(insight =>\n    insight.whyNow.toLowerCase().includes('now') ||\n    insight.whyNow.toLowerCase().includes('today') ||\n    insight.whyNow.toLowerCase().includes('week') ||\n    (hasWeather && insight.insight.toLowerCase().includes('weather')) ||\n    (hasLocalNews && insight.type === 'cultural_moment')\n  )\n\n  const picks: SmartPick[] = []\n\n  for (const insight of localInsights.slice(0, 3)) {\n    const expiresAt = new Date()\n    expiresAt.setDate(expiresAt.getDate() + 7) // Local content expires in 1 week\n\n    const pick: SmartPick = {\n      id: `local-${insight.id}`,\n      campaignType: 'local-pulse',\n      title: `Local Moment: ${truncate(insight.insight, 60)}`,\n      insights: [insight],\n      preview: includePreview\n        ? await generatePreview(insight, context, 'local-pulse')\n        : { headline: '', hook: '', platform: 'Instagram' },\n      confidence: insight.confidence,\n      relevance: 0,\n      timeliness: 0.9, // Local content is highly time-sensitive\n      evidenceQuality: calculateEvidenceQuality(insight),\n      overallScore: 0,\n      dataSources: extractDataSources(context, insight),\n      reasoning: `Time-sensitive local content for ${context.business.profile.location.city}. Best posted within 48 hours.`,\n      expectedPerformance: {\n        engagement: 'high',\n        reach: 'medium',\n        conversions: 'medium'\n      },\n      metadata: {\n        generatedAt: new Date(),\n        expiresAt\n      }\n    }\n\n    picks.push(pick)\n  }\n\n  return picks\n}\n\n// ============================================================================\n// SCORING LOGIC\n// ============================================================================\n\n/**\n * Score a Smart Pick using weighted algorithm\n */\nfunction scoreSmartPick(\n  pick: SmartPick,\n  context: DeepContext,\n  preferTimely: boolean\n): SmartPick {\n  // Calculate relevance: How well does this match the business?\n  const relevance = calculateRelevance(pick, context)\n\n  // Calculate timeliness: How time-sensitive is this?\n  const timeliness = calculateTimeliness(pick)\n\n  // Evidence quality already calculated\n  const evidenceQuality = pick.evidenceQuality\n\n  // Confidence from AI model\n  const confidence = pick.confidence\n\n  // Apply weights\n  const weights = {\n    ...DEFAULT_SCORING_WEIGHTS,\n    timeliness: preferTimely ? 0.35 : 0.25, // Boost timeliness if preferred\n    relevance: preferTimely ? 0.25 : 0.35\n  }\n\n  const overallScore =\n    (relevance * weights.relevance) +\n    (timeliness * weights.timeliness) +\n    (evidenceQuality * weights.evidenceQuality) +\n    (confidence * weights.confidence)\n\n  return {\n    ...pick,\n    relevance,\n    timeliness,\n    overallScore\n  }\n}\n\n/**\n * Calculate how relevant this pick is to the business\n */\nfunction calculateRelevance(pick: SmartPick, context: DeepContext): number {\n  let score = 0.5 // Base score\n\n  const businessKeywords = [\n    context.business.profile.industry.toLowerCase(),\n    context.business.profile.location.city.toLowerCase(),\n    context.business.profile.location.state.toLowerCase()\n  ]\n\n  const insightText = pick.insights.map(i => i.insight.toLowerCase()).join(' ')\n\n  // Boost if insight mentions business-specific keywords\n  for (const keyword of businessKeywords) {\n    if (insightText.includes(keyword)) {\n      score += 0.15\n    }\n  }\n\n  // Boost if matches campaign type intent\n  if (pick.campaignType === 'local-pulse' && context.business.profile.location.city) {\n    score += 0.1\n  }\n\n  if (pick.campaignType === 'authority-builder' && pick.evidenceQuality > 0.7) {\n    score += 0.1\n  }\n\n  if (pick.campaignType === 'social-proof' && insightText.includes('customer')) {\n    score += 0.1\n  }\n\n  return Math.min(score, 1.0)\n}\n\n/**\n * Calculate timeliness score\n */\nfunction calculateTimeliness(pick: SmartPick): number {\n  const now = new Date()\n\n  // Check if pick has expiration\n  if (pick.metadata.expiresAt) {\n    const timeLeft = pick.metadata.expiresAt.getTime() - now.getTime()\n    const daysLeft = timeLeft / (1000 * 60 * 60 * 24)\n\n    if (daysLeft < 1) return 1.0 // Extremely urgent\n    if (daysLeft < 3) return 0.9\n    if (daysLeft < 7) return 0.7\n    return 0.5\n  }\n\n  // Check for time-sensitive keywords in whyNow\n  const whyNow = pick.insights.map(i => i.whyNow.toLowerCase()).join(' ')\n\n  if (whyNow.includes('today') || whyNow.includes('now')) return 0.9\n  if (whyNow.includes('this week') || whyNow.includes('currently')) return 0.7\n  if (whyNow.includes('this month') || whyNow.includes('trending')) return 0.6\n  if (whyNow.includes('seasonal')) return 0.5\n\n  return 0.4 // Evergreen content\n}\n\n/**\n * Calculate evidence quality score\n */\nfunction calculateEvidenceQuality(insight: SynapseInsight): number {\n  const evidenceCount = insight.evidence?.length || 0\n\n  if (evidenceCount === 0) return 0.3\n  if (evidenceCount === 1) return 0.5\n  if (evidenceCount === 2) return 0.7\n  if (evidenceCount >= 3) return 0.9\n\n  return 0.5\n}\n\n// ============================================================================\n// DATA SOURCE EXTRACTION\n// ============================================================================\n\n/**\n * Extract data sources used for this insight\n */\nfunction extractDataSources(context: DeepContext, insight: SynapseInsight): DataSourceInfo[] {\n  const sources: DataSourceInfo[] = []\n  const addedSources = new Set<string>()\n\n  // Map of source detection to DataSourceInfo\n  const sourceMap: Record<string, DataSourceInfo> = {\n    weather: {\n      source: 'weather',\n      icon: 'Cloud',\n      label: 'Weather Data',\n      verified: true,\n      freshness: 'hourly',\n      dataPoints: 0\n    },\n    reviews: {\n      source: 'reviews',\n      icon: 'Star',\n      label: 'Customer Reviews',\n      verified: true,\n      freshness: 'daily',\n      dataPoints: 0\n    },\n    trends: {\n      source: 'trends',\n      icon: 'TrendingUp',\n      label: 'Search Trends',\n      verified: true,\n      freshness: 'real-time',\n      dataPoints: 0\n    },\n    news: {\n      source: 'news',\n      icon: 'Newspaper',\n      label: 'News Articles',\n      verified: true,\n      freshness: 'hourly',\n      dataPoints: 0\n    },\n    reddit: {\n      source: 'reddit',\n      icon: 'MessageCircle',\n      label: 'Reddit Discussions',\n      verified: true,\n      freshness: 'real-time',\n      dataPoints: 0\n    },\n    youtube: {\n      source: 'youtube',\n      icon: 'Video',\n      label: 'YouTube Trends',\n      verified: true,\n      freshness: 'daily',\n      dataPoints: 0\n    },\n    competitors: {\n      source: 'competitors',\n      icon: 'Target',\n      label: 'Competitor Analysis',\n      verified: true,\n      freshness: 'weekly',\n      dataPoints: 0\n    },\n    industry: {\n      source: 'industry',\n      icon: 'Building',\n      label: 'Industry Data',\n      verified: true,\n      freshness: 'static',\n      dataPoints: 0\n    }\n  }\n\n  // Detect sources from insight evidence\n  if (insight.evidence) {\n    for (const evidence of insight.evidence) {\n      const evidenceLower = evidence.toLowerCase()\n\n      if (evidenceLower.includes('weather') && !addedSources.has('weather')) {\n        sources.push({ ...sourceMap.weather, dataPoints: 1 })\n        addedSources.add('weather')\n      }\n      if ((evidenceLower.includes('review') || evidenceLower.includes('rating')) && !addedSources.has('reviews')) {\n        sources.push({ ...sourceMap.reviews, dataPoints: 1 })\n        addedSources.add('reviews')\n      }\n      if ((evidenceLower.includes('trend') || evidenceLower.includes('search')) && !addedSources.has('trends')) {\n        sources.push({ ...sourceMap.trends, dataPoints: 1 })\n        addedSources.add('trends')\n      }\n      if ((evidenceLower.includes('news') || evidenceLower.includes('article')) && !addedSources.has('news')) {\n        sources.push({ ...sourceMap.news, dataPoints: 1 })\n        addedSources.add('news')\n      }\n      if (evidenceLower.includes('reddit') && !addedSources.has('reddit')) {\n        sources.push({ ...sourceMap.reddit, dataPoints: 1 })\n        addedSources.add('reddit')\n      }\n      if (evidenceLower.includes('youtube') && !addedSources.has('youtube')) {\n        sources.push({ ...sourceMap.youtube, dataPoints: 1 })\n        addedSources.add('youtube')\n      }\n      if ((evidenceLower.includes('competitor') || evidenceLower.includes('competition')) && !addedSources.has('competitors')) {\n        sources.push({ ...sourceMap.competitors, dataPoints: 1 })\n        addedSources.add('competitors')\n      }\n    }\n  }\n\n  // Default: add industry data\n  if (sources.length === 0) {\n    sources.push({ ...sourceMap.industry, dataPoints: 1 })\n  }\n\n  return sources\n}\n\n// ============================================================================\n// PREVIEW GENERATION\n// ============================================================================\n\n/**\n * Generate a quick preview (headline + hook) for a pick\n */\nasync function generatePreview(\n  insight: SynapseInsight,\n  context: DeepContext,\n  campaignType: CampaignType\n): Promise<{ headline: string; hook: string; platform: string }> {\n  const platform = campaignType === 'authority-builder' ? 'LinkedIn' :\n                   campaignType === 'social-proof' ? 'Facebook' :\n                   'Instagram'\n\n  const prompt = `Generate a compelling social media post preview for ${platform}.\n\nBusiness: ${context.business.profile.name} (${context.business.profile.industry})\nLocation: ${context.business.profile.location.city}, ${context.business.profile.location.state}\n\nCampaign Type: ${campaignType}\nInsight: ${insight.insight}\nWhy Now: ${insight.whyNow}\n\nGenerate ONLY:\n1. Headline (8-12 words, attention-grabbing)\n2. Hook (first sentence, 15-25 words, creates curiosity)\n\nFormat your response as JSON:\n{\n  \"headline\": \"Your headline here\",\n  \"hook\": \"Your hook here\"\n}\n\nMake it specific to the business and actionable.`\n\n  try {\n    const response = await ErrorHandlerService.executeWithRetry(\n      async () => {\n        return await chat([{ role: 'user', content: prompt }], {\n          model: 'anthropic/claude-3.5-sonnet',\n          temperature: 0.8,\n          max_tokens: 300\n        })\n      },\n      {\n        maxAttempts: 3,\n        initialDelayMs: 2000,\n      },\n      undefined,\n      [\n        // Fallback: Return template-based preview\n        {\n          name: 'template_fallback',\n          description: 'Generate preview from template',\n          execute: async () => {\n            return JSON.stringify({\n              headline: insight.contentAngle,\n              hook: insight.insight.substring(0, 100)\n            })\n          }\n        }\n      ]\n    )\n\n    const parsed = JSON.parse(response)\n\n    return {\n      headline: parsed.headline || insight.contentAngle,\n      hook: parsed.hook || insight.insight.substring(0, 100),\n      platform\n    }\n  } catch (error) {\n    console.error('[SmartPickGenerator] Preview generation failed:', error)\n    logError(error, { campaignType, insightId: insight.id })\n\n    // Fallback\n    return {\n      headline: insight.contentAngle,\n      hook: insight.insight.substring(0, 100),\n      platform\n    }\n  }\n}\n\n// ============================================================================\n// TEMPLATE FALLBACK\n// ============================================================================\n\n/**\n * Generate template-based smart picks as fallback when AI generation fails\n */\nfunction generateTemplatePicks(\n  context: DeepContext,\n  campaignType: CampaignType\n): SmartPick[] {\n  // Generate basic smart picks from templates as fallback\n  const templates: Record<CampaignType, SmartPick[]> = {\n    'authority-builder': [\n      {\n        id: 'smart-pick-authority-1',\n        campaignType: 'authority-builder',\n        title: 'Industry Insights Campaign',\n        insights: [],\n        preview: {\n          headline: 'Share Your Expertise',\n          hook: 'Educational content that positions you as an industry expert',\n          platform: 'LinkedIn'\n        },\n        confidence: 0.5,\n        relevance: 0.5,\n        timeliness: 0.5,\n        evidenceQuality: 0.5,\n        overallScore: 0.5,\n        dataSources: [],\n        reasoning: 'Template-generated smart pick',\n        expectedPerformance: {\n          engagement: 'medium',\n          reach: 'medium',\n          conversions: 'low'\n        },\n        metadata: {\n          generatedAt: new Date(),\n          fallback: true\n        }\n      }\n    ],\n    'social-proof': [\n      {\n        id: 'smart-pick-trust-1',\n        campaignType: 'social-proof',\n        title: 'Customer Success Stories',\n        insights: [],\n        preview: {\n          headline: 'See Real Results',\n          hook: 'Showcase authentic customer testimonials and success stories',\n          platform: 'Facebook'\n        },\n        confidence: 0.5,\n        relevance: 0.5,\n        timeliness: 0.5,\n        evidenceQuality: 0.5,\n        overallScore: 0.5,\n        dataSources: [],\n        reasoning: 'Template-generated smart pick',\n        expectedPerformance: {\n          engagement: 'high',\n          reach: 'high',\n          conversions: 'medium'\n        },\n        metadata: {\n          generatedAt: new Date(),\n          fallback: true\n        }\n      }\n    ],\n    'local-pulse': [\n      {\n        id: 'smart-pick-local-1',\n        campaignType: 'local-pulse',\n        title: 'Local Community Connection',\n        insights: [],\n        preview: {\n          headline: 'Supporting Our Local Community',\n          hook: 'Connect with local events and community initiatives',\n          platform: 'Instagram'\n        },\n        confidence: 0.5,\n        relevance: 0.5,\n        timeliness: 0.5,\n        evidenceQuality: 0.5,\n        overallScore: 0.5,\n        dataSources: [],\n        reasoning: 'Template-generated smart pick',\n        expectedPerformance: {\n          engagement: 'high',\n          reach: 'medium',\n          conversions: 'medium'\n        },\n        metadata: {\n          generatedAt: new Date(),\n          fallback: true\n        }\n      }\n    ]\n  }\n\n  return templates[campaignType] || templates['authority-builder']\n}\n\n// ============================================================================\n// UTILITIES\n// ============================================================================\n\nfunction truncate(text: string, maxLength: number): string {\n  if (text.length <= maxLength) return text\n  return text.substring(0, maxLength - 3) + '...'\n}\n","/**\n * Campaign State Machine\n *\n * Manages campaign workflow state transitions with validation and persistence\n */\n\nimport type {\n  CampaignState,\n  CampaignStateTransition,\n  CampaignSession,\n  CampaignError,\n  CampaignWorkflowEvent,\n  CampaignEventHandler\n} from '@/types/campaign-workflow.types';\n\n// ============================================================================\n// STATE TRANSITION RULES\n// ============================================================================\n\nconst VALID_TRANSITIONS: Record<CampaignState, CampaignState[]> = {\n  IDLE: ['TYPE_SELECTED', 'ERROR'],\n  TYPE_SELECTED: ['CONTENT_SELECTED', 'ERROR'],\n  CONTENT_SELECTED: ['GENERATING', 'TYPE_SELECTED', 'ERROR'], // Can go back to type selection\n  GENERATING: ['PREVIEW', 'ERROR'],\n  PREVIEW: ['APPROVED', 'CONTENT_SELECTED', 'GENERATING', 'ERROR'], // Can regenerate or re-select\n  APPROVED: ['PUBLISHED', 'PREVIEW', 'ERROR'], // Can go back to preview\n  PUBLISHED: ['IDLE'], // Reset to start new campaign\n  ERROR: ['IDLE', 'TYPE_SELECTED', 'CONTENT_SELECTED', 'GENERATING', 'PREVIEW'] // Can recover from error\n};\n\n// ============================================================================\n// STATE MACHINE CLASS\n// ============================================================================\n\nexport class CampaignStateMachine {\n  private eventHandlers: CampaignEventHandler[] = [];\n\n  /**\n   * Check if a state transition is valid\n   */\n  canTransition(from: CampaignState, to: CampaignState): boolean {\n    const validTargets = VALID_TRANSITIONS[from];\n    return validTargets.includes(to);\n  }\n\n  /**\n   * Transition to a new state with validation\n   */\n  transition(\n    session: CampaignSession,\n    toState: CampaignState,\n    metadata?: Record<string, any>\n  ): CampaignSession {\n    const fromState = session.state;\n\n    // Validate transition\n    if (!this.canTransition(fromState, toState)) {\n      throw new Error(\n        `Invalid state transition: ${fromState} â ${toState}. ` +\n        `Valid transitions from ${fromState}: ${VALID_TRANSITIONS[fromState].join(', ')}`\n      );\n    }\n\n    // Create transition record\n    const transition: CampaignStateTransition = {\n      from: fromState,\n      to: toState,\n      timestamp: new Date(),\n      metadata\n    };\n\n    // Update session\n    const updatedSession: CampaignSession = {\n      ...session,\n      state: toState,\n      progress: this.calculateProgress(toState),\n      history: [...session.history, transition],\n      updatedAt: new Date(),\n      ...(toState === 'ERROR' && metadata?.error && { error: metadata.error })\n    };\n\n    // Emit event\n    this.emitEvent({\n      type: 'STATE_CHANGED',\n      sessionId: session.id,\n      timestamp: new Date(),\n      data: { fromState, toState, metadata }\n    });\n\n    // Save to localStorage for recovery\n    this.saveSessionToStorage(updatedSession);\n\n    console.log(`[CampaignState] ${fromState} â ${toState}`, metadata);\n\n    return updatedSession;\n  }\n\n  /**\n   * Calculate progress percentage based on state\n   */\n  private calculateProgress(state: CampaignState): number {\n    const progressMap: Record<CampaignState, number> = {\n      IDLE: 0,\n      TYPE_SELECTED: 20,\n      CONTENT_SELECTED: 40,\n      GENERATING: 60,\n      PREVIEW: 80,\n      APPROVED: 90,\n      PUBLISHED: 100,\n      ERROR: -1 // Keep current progress on error\n    };\n\n    return progressMap[state];\n  }\n\n  /**\n   * Handle errors and transition to ERROR state\n   */\n  handleError(\n    session: CampaignSession,\n    error: Partial<CampaignError>\n  ): CampaignSession {\n    const campaignError: CampaignError = {\n      code: error.code || 'UNKNOWN_ERROR',\n      message: error.message || 'An unknown error occurred',\n      timestamp: new Date(),\n      recoverable: error.recoverable ?? true,\n      retryCount: error.retryCount ?? 0,\n      stack: error.stack\n    };\n\n    return this.transition(session, 'ERROR', { error: campaignError });\n  }\n\n  /**\n   * Recover from error state\n   */\n  recoverFromError(\n    session: CampaignSession,\n    toState: CampaignState\n  ): CampaignSession {\n    if (session.state !== 'ERROR') {\n      throw new Error('Can only recover from ERROR state');\n    }\n\n    if (!this.canTransition('ERROR', toState)) {\n      throw new Error(`Cannot recover to state: ${toState}`);\n    }\n\n    return this.transition(session, toState, { recovered: true });\n  }\n\n  /**\n   * Reset state machine to IDLE\n   */\n  reset(session: CampaignSession): CampaignSession {\n    return {\n      ...session,\n      state: 'IDLE',\n      progress: 0,\n      selectedType: undefined,\n      selectedInsights: undefined,\n      selectedSmartPickId: undefined,\n      generatedContent: undefined,\n      error: undefined,\n      history: [\n        ...session.history,\n        {\n          from: session.state,\n          to: 'IDLE',\n          timestamp: new Date(),\n          metadata: { reset: true }\n        }\n      ],\n      updatedAt: new Date()\n    };\n  }\n\n  /**\n   * Get state history\n   */\n  getHistory(session: CampaignSession): CampaignStateTransition[] {\n    return session.history;\n  }\n\n  /**\n   * Get current state name with human-readable format\n   */\n  getStateName(state: CampaignState): string {\n    const names: Record<CampaignState, string> = {\n      IDLE: 'Ready to Start',\n      TYPE_SELECTED: 'Campaign Type Selected',\n      CONTENT_SELECTED: 'Content Selected',\n      GENERATING: 'Generating Campaign',\n      PREVIEW: 'Previewing Campaign',\n      APPROVED: 'Campaign Approved',\n      PUBLISHED: 'Campaign Published',\n      ERROR: 'Error Occurred'\n    };\n\n    return names[state];\n  }\n\n  /**\n   * Subscribe to state change events\n   */\n  on(handler: CampaignEventHandler): () => void {\n    this.eventHandlers.push(handler);\n\n    // Return unsubscribe function\n    return () => {\n      this.eventHandlers = this.eventHandlers.filter(h => h !== handler);\n    };\n  }\n\n  /**\n   * Emit event to all subscribers\n   */\n  private emitEvent(event: CampaignWorkflowEvent): void {\n    this.eventHandlers.forEach(handler => {\n      try {\n        handler(event);\n      } catch (error) {\n        console.error('[CampaignState] Event handler error:', error);\n      }\n    });\n  }\n\n  /**\n   * Save session to localStorage for recovery\n   */\n  private saveSessionToStorage(session: CampaignSession): void {\n    try {\n      const key = `campaign_session_${session.id}`;\n      localStorage.setItem(key, JSON.stringify({\n        ...session,\n        // Don't save large context object\n        context: undefined\n      }));\n    } catch (error) {\n      console.warn('[CampaignState] Failed to save to localStorage:', error);\n    }\n  }\n\n  /**\n   * Load session from localStorage\n   */\n  loadSessionFromStorage(sessionId: string): CampaignSession | null {\n    try {\n      const key = `campaign_session_${sessionId}`;\n      const data = localStorage.getItem(key);\n      if (!data) return null;\n\n      const session = JSON.parse(data);\n      // Convert date strings back to Date objects\n      session.createdAt = new Date(session.createdAt);\n      session.updatedAt = new Date(session.updatedAt);\n      session.history = session.history.map((t: any) => ({\n        ...t,\n        timestamp: new Date(t.timestamp)\n      }));\n\n      return session;\n    } catch (error) {\n      console.error('[CampaignState] Failed to load from localStorage:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Clear session from localStorage\n   */\n  clearSessionStorage(sessionId: string): void {\n    try {\n      const key = `campaign_session_${sessionId}`;\n      localStorage.removeItem(key);\n    } catch (error) {\n      console.warn('[CampaignState] Failed to clear localStorage:', error);\n    }\n  }\n}\n\n// Export singleton instance\nexport const campaignStateMachine = new CampaignStateMachine();\n","/**\n * Campaign Database Service\n *\n * Handles database persistence for campaigns using Supabase\n */\n\nimport { supabase } from '@/lib/supabase';\nimport type {\n  CampaignRecord,\n  ContentPieceRecord,\n  GeneratedCampaignContent,\n  CampaignType\n} from '@/types/campaign-workflow.types';\n\nexport class CampaignDatabaseService {\n  /**\n   * Save a campaign draft\n   */\n  async saveDraft(params: {\n    businessId: string;\n    campaignName: string;\n    campaignType: CampaignType;\n    contentData?: GeneratedCampaignContent;\n    goals?: Record<string, any>;\n    targetAudience?: Record<string, any>;\n  }): Promise<CampaignRecord> {\n    console.log('[CampaignDB] Saving draft:', params.campaignName);\n\n    const { data, error } = await supabase\n      .from('marketing_campaigns')\n      .insert({\n        business_id: params.businessId,\n        campaign_name: params.campaignName,\n        campaign_type: params.campaignType,\n        status: 'draft',\n        goals: params.goals,\n        target_audience: params.targetAudience,\n        content_data: params.contentData\n      })\n      .select()\n      .single();\n\n    if (error) {\n      console.error('[CampaignDB] Error saving draft:', error);\n      throw new Error(`Failed to save campaign draft: ${error.message}`);\n    }\n\n    console.log('[CampaignDB] Draft saved successfully:', data.id);\n    return data as CampaignRecord;\n  }\n\n  /**\n   * Update an existing campaign\n   */\n  async updateCampaign(\n    campaignId: string,\n    updates: Partial<CampaignRecord>\n  ): Promise<CampaignRecord> {\n    console.log('[CampaignDB] Updating campaign:', campaignId);\n\n    const { data, error } = await supabase\n      .from('marketing_campaigns')\n      .update({\n        ...updates,\n        updated_at: new Date().toISOString()\n      })\n      .eq('id', campaignId)\n      .select()\n      .single();\n\n    if (error) {\n      console.error('[CampaignDB] Error updating campaign:', error);\n      throw new Error(`Failed to update campaign: ${error.message}`);\n    }\n\n    return data as CampaignRecord;\n  }\n\n  /**\n   * Mark campaign as approved\n   */\n  async approveCampaign(campaignId: string): Promise<CampaignRecord> {\n    console.log('[CampaignDB] Approving campaign:', campaignId);\n\n    return this.updateCampaign(campaignId, {\n      status: 'active',\n      start_date: new Date().toISOString().split('T')[0]\n    });\n  }\n\n  /**\n   * Get campaign by ID\n   */\n  async getCampaign(campaignId: string): Promise<CampaignRecord | null> {\n    console.log('[CampaignDB] Fetching campaign:', campaignId);\n\n    const { data, error } = await supabase\n      .from('marketing_campaigns')\n      .select(`\n        id,\n        business_id,\n        campaign_name,\n        campaign_type,\n        status,\n        start_date,\n        end_date,\n        budget_usd,\n        goals,\n        target_audience,\n        content_data,\n        created_at,\n        updated_at\n      `)\n      .eq('id', campaignId)\n      .single();\n\n    if (error) {\n      if (error.code === 'PGRST116') {\n        // Not found\n        return null;\n      }\n      console.error('[CampaignDB] Error fetching campaign:', error);\n      throw new Error(`Failed to fetch campaign: ${error.message}`);\n    }\n\n    return data as CampaignRecord;\n  }\n\n  /**\n   * List campaigns for a business\n   */\n  async listCampaigns(params: {\n    businessId: string;\n    status?: 'draft' | 'active' | 'paused' | 'completed';\n    limit?: number;\n    offset?: number;\n  }): Promise<{ campaigns: CampaignRecord[]; total: number }> {\n    console.log('[CampaignDB] Listing campaigns for business:', params.businessId);\n\n    let query = supabase\n      .from('marketing_campaigns')\n      .select(`\n        id,\n        business_id,\n        campaign_name,\n        campaign_type,\n        status,\n        start_date,\n        end_date,\n        budget_usd,\n        goals,\n        target_audience,\n        content_data,\n        created_at,\n        updated_at\n      `, { count: 'exact' })\n      .eq('business_id', params.businessId)\n      .order('created_at', { ascending: false });\n\n    if (params.status) {\n      query = query.eq('status', params.status);\n    }\n\n    if (params.limit) {\n      query = query.limit(params.limit);\n    }\n\n    if (params.offset) {\n      query = query.range(params.offset, params.offset + (params.limit || 10) - 1);\n    }\n\n    const { data, error, count } = await query;\n\n    if (error) {\n      console.error('[CampaignDB] Error listing campaigns:', error);\n      throw new Error(`Failed to list campaigns: ${error.message}`);\n    }\n\n    return {\n      campaigns: data as CampaignRecord[],\n      total: count || 0\n    };\n  }\n\n  /**\n   * Delete a campaign\n   */\n  async deleteCampaign(campaignId: string): Promise<void> {\n    console.log('[CampaignDB] Deleting campaign:', campaignId);\n\n    const { error } = await supabase\n      .from('marketing_campaigns')\n      .delete()\n      .eq('id', campaignId);\n\n    if (error) {\n      console.error('[CampaignDB] Error deleting campaign:', error);\n      throw new Error(`Failed to delete campaign: ${error.message}`);\n    }\n\n    console.log('[CampaignDB] Campaign deleted successfully');\n  }\n\n  /**\n   * Save individual content pieces from a campaign\n   */\n  async saveContentPieces(\n    campaignId: string,\n    businessId: string,\n    content: GeneratedCampaignContent\n  ): Promise<ContentPieceRecord[]> {\n    console.log('[CampaignDB] Saving content pieces for campaign:', campaignId);\n\n    const pieces = content.platforms.map(platformContent => ({\n      business_id: businessId,\n      campaign_id: campaignId,\n      content_type: 'post',\n      platform: platformContent.platform,\n      title: platformContent.content.headline,\n      content_text: `${platformContent.content.hook}\\n\\n${platformContent.content.body}\\n\\n${platformContent.content.cta}`,\n      hashtags: platformContent.content.hashtags || [],\n      media_urls: platformContent.mediaUrls || [],\n      status: 'draft'\n    }));\n\n    const { data, error } = await supabase\n      .from('content_pieces')\n      .insert(pieces)\n      .select();\n\n    if (error) {\n      console.error('[CampaignDB] Error saving content pieces:', error);\n      throw new Error(`Failed to save content pieces: ${error.message}`);\n    }\n\n    console.log('[CampaignDB] Saved', data.length, 'content pieces');\n    return data as ContentPieceRecord[];\n  }\n\n  /**\n   * Get content pieces for a campaign\n   */\n  async getContentPieces(campaignId: string): Promise<ContentPieceRecord[]> {\n    console.log('[CampaignDB] Fetching content pieces for campaign:', campaignId);\n\n    const { data, error } = await supabase\n      .from('content_pieces')\n      .select(`\n        id,\n        business_id,\n        campaign_id,\n        content_type,\n        platform,\n        title,\n        content_text,\n        media_urls,\n        hashtags,\n        status,\n        scheduled_for,\n        published_at,\n        created_at,\n        updated_at\n      `)\n      .eq('campaign_id', campaignId)\n      .order('created_at', { ascending: true });\n\n    if (error) {\n      console.error('[CampaignDB] Error fetching content pieces:', error);\n      throw new Error(`Failed to fetch content pieces: ${error.message}`);\n    }\n\n    return data as ContentPieceRecord[];\n  }\n\n  /**\n   * Update content piece\n   */\n  async updateContentPiece(\n    pieceId: string,\n    updates: Partial<ContentPieceRecord>\n  ): Promise<ContentPieceRecord> {\n    console.log('[CampaignDB] Updating content piece:', pieceId);\n\n    const { data, error } = await supabase\n      .from('content_pieces')\n      .update({\n        ...updates,\n        updated_at: new Date().toISOString()\n      })\n      .eq('id', pieceId)\n      .select()\n      .single();\n\n    if (error) {\n      console.error('[CampaignDB] Error updating content piece:', error);\n      throw new Error(`Failed to update content piece: ${error.message}`);\n    }\n\n    return data as ContentPieceRecord;\n  }\n\n  /**\n   * Mark content piece as scheduled\n   */\n  async scheduleContentPiece(\n    pieceId: string,\n    scheduledFor: Date\n  ): Promise<ContentPieceRecord> {\n    return this.updateContentPiece(pieceId, {\n      status: 'scheduled',\n      scheduled_for: scheduledFor.toISOString()\n    });\n  }\n\n  /**\n   * Mark content piece as published\n   */\n  async publishContentPiece(pieceId: string): Promise<ContentPieceRecord> {\n    return this.updateContentPiece(pieceId, {\n      status: 'published',\n      published_at: new Date().toISOString()\n    });\n  }\n}\n\n// Export singleton instance\nexport const campaignDB = new CampaignDatabaseService();\n","/**\n * Campaign Workflow Service\n *\n * Manages the campaign generation workflow with methods for each step\n */\n\nimport { v4 as uuidv4 } from 'uuid';\nimport { campaignStateMachine } from './CampaignState';\nimport { campaignDB } from './CampaignDB';\nimport { PremiumContentWriter } from '../synapse/generation/formats/PremiumContentWriter';\nimport { campaignGenerator } from './CampaignGenerator';\nimport type {\n  CampaignSession,\n  CampaignType,\n  GeneratedCampaignContent,\n  PlatformContent,\n  WorkflowConfig\n} from '@/types/campaign-workflow.types';\nimport type { DeepContext } from '@/types/synapse/deepContext.types';\nimport type { BreakthroughInsight } from '@/types/synapse/breakthrough.types';\nimport type { BusinessProfile } from '@/types/synapseContent.types';\nimport type { CampaignGenerationInput } from '@/types/campaign-generation.types';\n\n// ============================================================================\n// DEFAULT CONFIGURATION\n// ============================================================================\n\nconst DEFAULT_CONFIG: WorkflowConfig = {\n  autoSave: true,\n  autoSaveInterval: 30000, // 30 seconds\n  retryAttempts: 3,\n  timeoutMs: 120000, // 2 minutes\n  enableLogging: true\n};\n\n// ============================================================================\n// WORKFLOW SERVICE\n// ============================================================================\n\nexport class CampaignWorkflowService {\n  private sessions: Map<string, CampaignSession> = new Map();\n  private config: WorkflowConfig;\n  private autoSaveIntervals: Map<string, NodeJS.Timeout> = new Map();\n\n  constructor(config: Partial<WorkflowConfig> = {}) {\n    this.config = { ...DEFAULT_CONFIG, ...config };\n    this.log('CampaignWorkflow initialized');\n  }\n\n  /**\n   * Start a new campaign session\n   */\n  async startCampaign(params: {\n    businessId: string;\n    context: DeepContext;\n  }): Promise<CampaignSession> {\n    this.log('Starting new campaign for business:', params.businessId);\n\n    const session: CampaignSession = {\n      id: uuidv4(),\n      businessId: params.businessId,\n      state: 'IDLE',\n      progress: 0,\n      context: params.context,\n      history: [],\n      createdAt: new Date(),\n      updatedAt: new Date()\n    };\n\n    this.sessions.set(session.id, session);\n\n    // Start auto-save if enabled\n    if (this.config.autoSave) {\n      this.startAutoSave(session.id);\n    }\n\n    this.log('Campaign session created:', session.id);\n    return session;\n  }\n\n  /**\n   * Select campaign type\n   */\n  selectCampaignType(\n    sessionId: string,\n    campaignType: CampaignType\n  ): CampaignSession {\n    this.log('Selecting campaign type:', campaignType);\n\n    const session = this.getSession(sessionId);\n\n    // Transition to TYPE_SELECTED state\n    const updatedSession = campaignStateMachine.transition(\n      session,\n      'TYPE_SELECTED',\n      { campaignType }\n    );\n\n    // Update session data\n    updatedSession.selectedType = campaignType;\n\n    this.sessions.set(sessionId, updatedSession);\n    return updatedSession;\n  }\n\n  /**\n   * Select a Smart Pick\n   */\n  selectSmartPick(\n    sessionId: string,\n    smartPickId: string,\n    insights: BreakthroughInsight[]\n  ): CampaignSession {\n    this.log('Selecting Smart Pick:', smartPickId);\n\n    const session = this.getSession(sessionId);\n\n    // Must have type selected first\n    if (!session.selectedType) {\n      throw new Error('Campaign type must be selected before choosing content');\n    }\n\n    // Transition to CONTENT_SELECTED state\n    const updatedSession = campaignStateMachine.transition(\n      session,\n      'CONTENT_SELECTED',\n      { smartPickId, insightCount: insights.length }\n    );\n\n    // Update session data\n    updatedSession.selectedSmartPickId = smartPickId;\n    updatedSession.selectedInsights = insights;\n\n    this.sessions.set(sessionId, updatedSession);\n    return updatedSession;\n  }\n\n  /**\n   * Select custom insights (Content Mixer)\n   */\n  selectCustomInsights(\n    sessionId: string,\n    insights: BreakthroughInsight[]\n  ): CampaignSession {\n    this.log('Selecting custom insights:', insights.length);\n\n    const session = this.getSession(sessionId);\n\n    // Must have type selected first\n    if (!session.selectedType) {\n      throw new Error('Campaign type must be selected before choosing content');\n    }\n\n    // Transition to CONTENT_SELECTED state\n    const updatedSession = campaignStateMachine.transition(\n      session,\n      'CONTENT_SELECTED',\n      { insightCount: insights.length, custom: true }\n    );\n\n    // Update session data\n    updatedSession.selectedInsights = insights;\n\n    this.sessions.set(sessionId, updatedSession);\n    return updatedSession;\n  }\n\n  /**\n   * Generate campaign content\n   *\n   * NOTE: Actual content generation will be implemented by the content generator services\n   * This is a placeholder that returns mock data for testing the workflow\n   */\n  async generateCampaign(sessionId: string): Promise<CampaignSession> {\n    this.log('Generating campaign content');\n\n    const session = this.getSession(sessionId);\n\n    // Must have content selected\n    if (!session.selectedInsights || session.selectedInsights.length === 0) {\n      throw new Error('Insights must be selected before generating campaign');\n    }\n\n    try {\n      // Transition to GENERATING state\n      let updatedSession = campaignStateMachine.transition(session, 'GENERATING');\n      this.sessions.set(sessionId, updatedSession);\n\n      // Generate real content using CampaignGenerator\n      const input: CampaignGenerationInput = {\n        campaignId: sessionId,\n        campaignType: session.selectedType!,\n        businessContext: {\n          businessData: session.context.businessProfile as any, // TODO: Type adapter\n          uvpData: session.context.uvpData as any, // TODO: Type adapter\n          websiteAnalysis: null,\n          specialization: session.context.businessProfile?.specialization,\n        },\n        options: {\n          postsPerCampaign: 7,\n          platforms: ['linkedin', 'facebook'],\n          includeVisuals: true,\n          saveToDatabase: true,\n        },\n      };\n\n      const generatedCampaign = await campaignGenerator.generateCampaign(input);\n\n      // Convert GeneratedCampaign to GeneratedCampaignContent for session\n      const generatedContent: GeneratedCampaignContent = {\n        campaignName: generatedCampaign.name,\n        posts: generatedCampaign.posts.map((post) => ({\n          id: post.id,\n          platform: post.platform,\n          content: {\n            headline: post.content.headline || '',\n            body: post.content.body,\n            hashtags: post.content.hashtags,\n            cta: post.content.callToAction || '',\n          },\n          visuals: post.visuals,\n          scheduledDate: post.scheduledFor?.toISOString(),\n          status: post.status,\n        })),\n        metadata: {\n          totalPosts: generatedCampaign.totalPosts,\n          generatedAt: generatedCampaign.createdAt.toISOString(),\n          confidence: generatedCampaign.metadata.confidence,\n        },\n      };\n\n      // Transition to PREVIEW state\n      updatedSession = campaignStateMachine.transition(\n        updatedSession,\n        'PREVIEW',\n        { contentGenerated: true }\n      );\n\n      // Update session with generated content\n      updatedSession.generatedContent = generatedContent;\n\n      this.sessions.set(sessionId, updatedSession);\n\n      // Save to database\n      if (this.config.autoSave) {\n        await this.saveCampaignToDB(updatedSession);\n      }\n\n      this.log('Campaign content generated successfully');\n      return updatedSession;\n    } catch (error) {\n      this.log('Error generating campaign:', error);\n\n      const errorSession = campaignStateMachine.handleError(session, {\n        code: 'CONTENT_GENERATION_FAILED',\n        message: error instanceof Error ? error.message : 'Content generation failed',\n        recoverable: true\n      });\n\n      this.sessions.set(sessionId, errorSession);\n      throw error;\n    }\n  }\n\n  /**\n   * Approve campaign\n   */\n  async approveCampaign(sessionId: string): Promise<CampaignSession> {\n    this.log('Approving campaign');\n\n    const session = this.getSession(sessionId);\n\n    if (!session.generatedContent) {\n      throw new Error('Campaign must be generated before approval');\n    }\n\n    try {\n      // Transition to APPROVED state\n      const updatedSession = campaignStateMachine.transition(session, 'APPROVED');\n\n      this.sessions.set(sessionId, updatedSession);\n\n      // Save to database and mark as approved\n      const campaignRecord = await this.saveCampaignToDB(updatedSession);\n      if (campaignRecord) {\n        await campaignDB.approveCampaign(campaignRecord.id);\n      }\n\n      this.log('Campaign approved successfully');\n      return updatedSession;\n    } catch (error) {\n      this.log('Error approving campaign:', error);\n\n      const errorSession = campaignStateMachine.handleError(session, {\n        code: 'DATABASE_ERROR',\n        message: error instanceof Error ? error.message : 'Failed to approve campaign',\n        recoverable: true\n      });\n\n      this.sessions.set(sessionId, errorSession);\n      throw error;\n    }\n  }\n\n  /**\n   * Publish campaign to platforms\n   *\n   * NOTE: Actual publishing will integrate with SocialPilot or other platforms\n   * This is a placeholder for the workflow\n   */\n  async publishCampaign(\n    sessionId: string,\n    platforms: string[]\n  ): Promise<CampaignSession> {\n    this.log('Publishing campaign to platforms:', platforms);\n\n    const session = this.getSession(sessionId);\n\n    if (session.state !== 'APPROVED') {\n      throw new Error('Campaign must be approved before publishing');\n    }\n\n    try {\n      // TODO: Integrate with actual publishing service (SocialPilot, etc.)\n      this.log('Publishing not yet implemented - placeholder only');\n\n      // Transition to PUBLISHED state\n      const updatedSession = campaignStateMachine.transition(session, 'PUBLISHED', {\n        platforms,\n        publishedAt: new Date()\n      });\n\n      this.sessions.set(sessionId, updatedSession);\n\n      // Stop auto-save\n      this.stopAutoSave(sessionId);\n\n      this.log('Campaign published successfully');\n      return updatedSession;\n    } catch (error) {\n      this.log('Error publishing campaign:', error);\n\n      const errorSession = campaignStateMachine.handleError(session, {\n        code: 'NETWORK_ERROR',\n        message: error instanceof Error ? error.message : 'Failed to publish campaign',\n        recoverable: true\n      });\n\n      this.sessions.set(sessionId, errorSession);\n      throw error;\n    }\n  }\n\n  /**\n   * Get current session\n   */\n  getSession(sessionId: string): CampaignSession {\n    const session = this.sessions.get(sessionId);\n\n    if (!session) {\n      // Try to load from localStorage\n      const storedSession = campaignStateMachine.loadSessionFromStorage(sessionId);\n      if (storedSession) {\n        this.sessions.set(sessionId, storedSession);\n        return storedSession;\n      }\n\n      throw new Error(`Campaign session not found: ${sessionId}`);\n    }\n\n    return session;\n  }\n\n  /**\n   * Reset session to start over\n   */\n  resetSession(sessionId: string): CampaignSession {\n    this.log('Resetting session:', sessionId);\n\n    const session = this.getSession(sessionId);\n    const resetSession = campaignStateMachine.reset(session);\n\n    this.sessions.set(sessionId, resetSession);\n    return resetSession;\n  }\n\n  /**\n   * Delete session\n   */\n  deleteSession(sessionId: string): void {\n    this.log('Deleting session:', sessionId);\n\n    this.stopAutoSave(sessionId);\n    this.sessions.delete(sessionId);\n    campaignStateMachine.clearSessionStorage(sessionId);\n  }\n\n  // ============================================================================\n  // PRIVATE HELPERS\n  // ============================================================================\n\n  /**\n   * Generate mock content for testing\n   * TODO: Replace with actual content generation service calls\n   */\n  private async generateMockContent(\n    campaignType: CampaignType,\n    insights: BreakthroughInsight[],\n    context?: DeepContext\n  ): Promise<GeneratedCampaignContent> {\n    // Use real content generation with PremiumContentWriter\n    const contentWriter = new PremiumContentWriter();\n\n    // Extract business profile from context\n    const businessProfile: BusinessProfile = context ? {\n      id: context.business.profile.id,\n      name: context.business.profile.name,\n      industry: context.business.profile.industry,\n      location: context.business.profile.location,\n      website: context.business.profile.website\n    } : {\n      id: 'demo-business',\n      name: 'Demo Business',\n      industry: 'Professional Services',\n      location: { city: 'San Francisco', state: 'CA', country: 'USA' },\n      website: 'https://example.com'\n    };\n\n    // Select primary insight (first one or highest confidence)\n    const primaryInsight = insights.length > 0 ?\n      insights.reduce((prev, current) =>\n        (current.confidence > prev.confidence) ? current : prev\n      ) : {\n        id: 'fallback-insight',\n        insight: 'Industry expertise and thought leadership',\n        confidence: 0.7,\n        reasoning: 'Fallback insight for demonstration',\n        dataSource: 'System',\n        timestamp: new Date(),\n        score: 70,\n        metadata: {}\n      };\n\n    // Define platforms to generate content for\n    const platformsToGenerate: Array<'linkedin' | 'facebook' | 'instagram' | 'twitter'> = [\n      'linkedin',\n      'facebook',\n      'instagram',\n      'twitter'\n    ];\n\n    // Generate content for each platform in parallel\n    const platformContentPromises = platformsToGenerate.map(async (platform) => {\n      try {\n        const content = await contentWriter.generatePremiumContent(\n          primaryInsight,\n          businessProfile,\n          platform\n        );\n\n        const fullText = `${content.headline}\\n\\n${content.hook}\\n\\n${content.body}\\n\\n${content.cta}`;\n        const characterCount = fullText.length;\n\n        return {\n          platform,\n          content,\n          characterCount\n        };\n      } catch (error) {\n        this.log(`Error generating content for ${platform}:`, error);\n        // Fallback to basic content if generation fails\n        return {\n          platform,\n          content: {\n            headline: `${campaignType} Campaign - ${platform}`,\n            hook: primaryInsight.insight,\n            body: 'Generated body content based on your business insights and industry expertise.',\n            cta: 'Learn more',\n            hashtags: ['business', 'growth']\n          },\n          characterCount: 200\n        };\n      }\n    });\n\n    const platforms = await Promise.all(platformContentPromises);\n\n    return {\n      campaignId: uuidv4(),\n      campaignType,\n      platforms: platforms as PlatformContent[],\n      metadata: {\n        insightsUsed: insights.map(i => i.id),\n        generatedAt: new Date(),\n        model: 'claude-sonnet-4.5',\n        confidence: primaryInsight.confidence\n      }\n    };\n  }\n\n  /**\n   * Save campaign to database\n   */\n  private async saveCampaignToDB(session: CampaignSession) {\n    if (!session.generatedContent) return null;\n\n    try {\n      const campaign = await campaignDB.saveDraft({\n        businessId: session.businessId,\n        campaignName: `${session.selectedType} Campaign - ${new Date().toLocaleDateString()}`,\n        campaignType: session.selectedType!,\n        contentData: session.generatedContent,\n        goals: {\n          type: session.selectedType,\n          insightCount: session.selectedInsights?.length || 0\n        }\n      });\n\n      // Save individual content pieces\n      await campaignDB.saveContentPieces(\n        campaign.id,\n        session.businessId,\n        session.generatedContent\n      );\n\n      return campaign;\n    } catch (error) {\n      this.log('Error saving to database:', error);\n      return null;\n    }\n  }\n\n  /**\n   * Start auto-save interval\n   */\n  private startAutoSave(sessionId: string): void {\n    const interval = setInterval(() => {\n      const session = this.sessions.get(sessionId);\n      if (session) {\n        this.saveCampaignToDB(session).catch(err =>\n          this.log('Auto-save error:', err)\n        );\n      }\n    }, this.config.autoSaveInterval);\n\n    this.autoSaveIntervals.set(sessionId, interval);\n  }\n\n  /**\n   * Stop auto-save interval\n   */\n  private stopAutoSave(sessionId: string): void {\n    const interval = this.autoSaveIntervals.get(sessionId);\n    if (interval) {\n      clearInterval(interval);\n      this.autoSaveIntervals.delete(sessionId);\n    }\n  }\n\n  /**\n   * Log if logging is enabled\n   */\n  private log(...args: any[]): void {\n    if (this.config.enableLogging) {\n      console.log('[CampaignWorkflow]', ...args);\n    }\n  }\n}\n\n// Export singleton instance\nexport const campaignWorkflow = new CampaignWorkflowService();\n","/**\n * Campaign Orchestrator\n *\n * Main coordination layer that integrates:\n * - Campaign Type Selector â Smart Picks/Content Mixer â Content Generation â Preview â Approval â Publishing\n *\n * This is the \"glue\" that connects all Week 1 components into a complete workflow\n */\n\nimport { campaignWorkflow } from './CampaignWorkflow';\nimport { campaignStateMachine } from './CampaignState';\nimport { ErrorHandlerService, logError } from '../errors/error-handler.service';\nimport type {\n  CampaignSession,\n  CampaignType,\n  CampaignWorkflowEvent,\n  CampaignEventHandler\n} from '@/types/campaign-workflow.types';\nimport type { DeepContext } from '@/types/synapse/deepContext.types';\nimport type { BreakthroughInsight } from '@/types/synapse/breakthrough.types';\n\n// ============================================================================\n// ORCHESTRATOR INTERFACE\n// ============================================================================\n\nexport interface CampaignOrchestratorConfig {\n  onStateChange?: (session: CampaignSession) => void;\n  onError?: (error: Error, session: CampaignSession) => void;\n  onProgress?: (progress: number, session: CampaignSession) => void;\n}\n\n// ============================================================================\n// CAMPAIGN ORCHESTRATOR\n// ============================================================================\n\nexport class CampaignOrchestrator {\n  private currentSessionId?: string;\n  private config: CampaignOrchestratorConfig;\n  private eventUnsubscribe?: () => void;\n\n  constructor(config: CampaignOrchestratorConfig = {}) {\n    this.config = config;\n    this.log('CampaignOrchestrator initialized');\n  }\n\n  // ============================================================================\n  // WORKFLOW METHODS\n  // ============================================================================\n\n  /**\n   * Step 1: Initialize campaign with DeepContext\n   */\n  async initialize(params: {\n    businessId: string;\n    context: DeepContext;\n  }): Promise<CampaignSession> {\n    this.log('Initializing campaign for business:', params.businessId);\n\n    try {\n      // Start new campaign session\n      const session = await campaignWorkflow.startCampaign(params);\n      this.currentSessionId = session.id;\n\n      // Subscribe to state changes\n      this.subscribeToStateChanges();\n\n      this.log('Campaign initialized:', session.id);\n      this.notifyStateChange(session);\n\n      return session;\n    } catch (error) {\n      this.handleError(error);\n      throw error;\n    }\n  }\n\n  /**\n   * Step 2: User selects campaign type (or AI recommends)\n   */\n  selectCampaignType(campaignType: CampaignType): CampaignSession {\n    this.log('Selecting campaign type:', campaignType);\n\n    try {\n      const session = campaignWorkflow.selectCampaignType(\n        this.requireSessionId(),\n        campaignType\n      );\n\n      this.notifyStateChange(session);\n      this.notifyProgress(session);\n\n      return session;\n    } catch (error) {\n      this.handleError(error);\n      throw error;\n    }\n  }\n\n  /**\n   * Step 3a: User selects a Smart Pick (AI-recommended campaign)\n   */\n  selectSmartPick(params: {\n    smartPickId: string;\n    insights: BreakthroughInsight[];\n  }): CampaignSession {\n    this.log('Selecting Smart Pick:', params.smartPickId);\n\n    try {\n      const session = campaignWorkflow.selectSmartPick(\n        this.requireSessionId(),\n        params.smartPickId,\n        params.insights\n      );\n\n      this.notifyStateChange(session);\n      this.notifyProgress(session);\n\n      return session;\n    } catch (error) {\n      this.handleError(error);\n      throw error;\n    }\n  }\n\n  /**\n   * Step 3b: User selects custom insights (Content Mixer)\n   */\n  selectCustomInsights(insights: BreakthroughInsight[]): CampaignSession {\n    this.log('Selecting custom insights:', insights.length);\n\n    try {\n      const session = campaignWorkflow.selectCustomInsights(\n        this.requireSessionId(),\n        insights\n      );\n\n      this.notifyStateChange(session);\n      this.notifyProgress(session);\n\n      return session;\n    } catch (error) {\n      this.handleError(error);\n      throw error;\n    }\n  }\n\n  /**\n   * Step 4: Generate campaign content\n   */\n  async generateCampaign(): Promise<CampaignSession> {\n    this.log('Generating campaign content');\n\n    try {\n      const session = await ErrorHandlerService.executeWithRetry(\n        () => campaignWorkflow.generateCampaign(this.requireSessionId()),\n        { maxAttempts: 3 }\n      );\n\n      this.notifyStateChange(session);\n      this.notifyProgress(session);\n\n      return session;\n    } catch (error) {\n      logError(error, { sessionId: this.currentSessionId, operation: 'generateCampaign' });\n      this.handleError(error);\n      throw error;\n    }\n  }\n\n  /**\n   * Step 4b: Regenerate specific sections (called from Preview)\n   *\n   * NOTE: This will integrate with content generation services\n   * Placeholder for now\n   */\n  async regenerateSection(params: {\n    platform: string;\n    section: 'headline' | 'hook' | 'body' | 'cta';\n  }): Promise<CampaignSession> {\n    this.log('Regenerating section:', params);\n\n    try {\n      // TODO: Integrate with actual content generators\n      // For now, just return current session\n      const session = campaignWorkflow.getSession(this.requireSessionId());\n\n      this.log('Section regeneration not yet implemented');\n      return session;\n    } catch (error) {\n      this.handleError(error);\n      throw error;\n    }\n  }\n\n  /**\n   * Step 5: Approve campaign\n   */\n  async approveCampaign(): Promise<CampaignSession> {\n    this.log('Approving campaign');\n\n    try {\n      const session = await campaignWorkflow.approveCampaign(this.requireSessionId());\n\n      this.notifyStateChange(session);\n      this.notifyProgress(session);\n\n      return session;\n    } catch (error) {\n      this.handleError(error);\n      throw error;\n    }\n  }\n\n  /**\n   * Step 6: Publish to platforms\n   */\n  async publishCampaign(platforms: string[]): Promise<CampaignSession> {\n    this.log('Publishing campaign to platforms:', platforms);\n\n    try {\n      const session = await ErrorHandlerService.executeWithRetry(\n        () => campaignWorkflow.publishCampaign(this.requireSessionId(), platforms),\n        { maxAttempts: 2 }, // Fewer retries for publishing\n      );\n\n      this.notifyStateChange(session);\n      this.notifyProgress(session);\n\n      return session;\n    } catch (error) {\n      logError(error, { sessionId: this.currentSessionId, platforms, operation: 'publishCampaign' });\n      this.handleError(error);\n      throw error;\n    }\n  }\n\n  // ============================================================================\n  // SESSION MANAGEMENT\n  // ============================================================================\n\n  /**\n   * Get current session\n   */\n  getCurrentSession(): CampaignSession | null {\n    if (!this.currentSessionId) {\n      return null;\n    }\n\n    try {\n      return campaignWorkflow.getSession(this.currentSessionId);\n    } catch {\n      return null;\n    }\n  }\n\n  /**\n   * Resume an existing session\n   */\n  resumeSession(sessionId: string): CampaignSession {\n    this.log('Resuming session:', sessionId);\n\n    const session = campaignWorkflow.getSession(sessionId);\n    this.currentSessionId = sessionId;\n    this.subscribeToStateChanges();\n\n    return session;\n  }\n\n  /**\n   * Reset current session to start over\n   */\n  resetSession(): CampaignSession {\n    this.log('Resetting session');\n\n    const session = campaignWorkflow.resetSession(this.requireSessionId());\n    this.notifyStateChange(session);\n    this.notifyProgress(session);\n\n    return session;\n  }\n\n  /**\n   * End current session\n   */\n  endSession(): void {\n    this.log('Ending session');\n\n    if (this.currentSessionId) {\n      campaignWorkflow.deleteSession(this.currentSessionId);\n      this.currentSessionId = undefined;\n    }\n\n    if (this.eventUnsubscribe) {\n      this.eventUnsubscribe();\n      this.eventUnsubscribe = undefined;\n    }\n  }\n\n  // ============================================================================\n  // ERROR HANDLING & RECOVERY\n  // ============================================================================\n\n  /**\n   * Handle errors with recovery options\n   */\n  private handleError(error: unknown): void {\n    const err = error instanceof Error ? error : new Error(String(error));\n    this.log('Error occurred:', err.message);\n\n    if (this.config.onError && this.currentSessionId) {\n      try {\n        const session = campaignWorkflow.getSession(this.currentSessionId);\n        this.config.onError(err, session);\n      } catch {\n        this.config.onError(err, {} as CampaignSession);\n      }\n    }\n  }\n\n  /**\n   * Recover from error state\n   */\n  recoverFromError(targetState: 'TYPE_SELECTED' | 'CONTENT_SELECTED' | 'GENERATING' | 'PREVIEW'): CampaignSession {\n    this.log('Recovering from error to state:', targetState);\n\n    const session = campaignWorkflow.getSession(this.requireSessionId());\n    const recoveredSession = campaignStateMachine.recoverFromError(session, targetState);\n\n    this.notifyStateChange(recoveredSession);\n    return recoveredSession;\n  }\n\n  // ============================================================================\n  // PRIVATE HELPERS\n  // ============================================================================\n\n  /**\n   * Subscribe to state changes (public method for components)\n   */\n  onStateChange(callback: (session: CampaignSession) => void): () => void {\n    this.config.onStateChange = callback;\n    return () => {\n      this.config.onStateChange = undefined;\n    };\n  }\n\n  /**\n   * Subscribe to progress updates (public method for components)\n   */\n  onProgress(callback: (progress: number, session: CampaignSession) => void): () => void {\n    this.config.onProgress = callback;\n    return () => {\n      this.config.onProgress = undefined;\n    };\n  }\n\n  /**\n   * Require session ID or throw\n   */\n  private requireSessionId(): string {\n    if (!this.currentSessionId) {\n      throw new Error('No active campaign session. Call initialize() first.');\n    }\n    return this.currentSessionId;\n  }\n\n  /**\n   * Subscribe to state change events\n   */\n  private subscribeToStateChanges(): void {\n    // Unsubscribe from previous\n    if (this.eventUnsubscribe) {\n      this.eventUnsubscribe();\n    }\n\n    // Subscribe to new events\n    const handler: CampaignEventHandler = (event: CampaignWorkflowEvent) => {\n      if (event.sessionId === this.currentSessionId) {\n        this.log('Workflow event:', event.type);\n\n        if (event.type === 'STATE_CHANGED' && this.config.onStateChange) {\n          try {\n            const session = campaignWorkflow.getSession(this.currentSessionId!);\n            this.config.onStateChange(session);\n          } catch (error) {\n            this.log('Error in state change handler:', error);\n          }\n        }\n\n        if (event.type === 'PROGRESS_UPDATED' && this.config.onProgress) {\n          try {\n            const session = campaignWorkflow.getSession(this.currentSessionId!);\n            this.config.onProgress(session.progress, session);\n          } catch (error) {\n            this.log('Error in progress handler:', error);\n          }\n        }\n      }\n    };\n\n    this.eventUnsubscribe = campaignStateMachine.on(handler);\n  }\n\n  /**\n   * Notify state change\n   */\n  private notifyStateChange(session: CampaignSession): void {\n    if (this.config.onStateChange) {\n      this.config.onStateChange(session);\n    }\n  }\n\n  /**\n   * Notify progress update\n   */\n  private notifyProgress(session: CampaignSession): void {\n    if (this.config.onProgress) {\n      this.config.onProgress(session.progress, session);\n    }\n  }\n\n  /**\n   * Log messages\n   */\n  private log(...args: any[]): void {\n    console.log('[CampaignOrchestrator]', ...args);\n  }\n}\n\n// Export singleton instance\nexport const campaignOrchestrator = new CampaignOrchestrator();\n"],"names":["OPENROUTER_MODELS","OPENROUTER_API_URL","OPENROUTER_API_KEY","chat","messages","options","model","temperature","maxTokens","topP","stream","requestBody","response","errorData","_a","data","error","DEFAULT_RETRY_CONFIG","ErrorHandlerService","operation","config","onProgress","fallbackStrategies","retryConfig","lastError","attempt","appError","delay","strategy","result","timestamp","err","category","severity","userMessage","errorMessage","retryable","initialDelay","maxDelay","multiplier","jitter","finalDelay","ms","resolve","context","cacheKey","getCachedData","cachedData","getMinimalData","description","logError","BANNERBEAR_CONFIG","isBannerbearConfigured","PLATFORM_SPECS","AUTHORITY_BUILDER_TEMPLATE","TRUST_BUILDER_TEMPLATE","COMMUNITY_CHAMPION_TEMPLATE","REVENUE_RUSH_TEMPLATE","VIRAL_SPARK_TEMPLATE","CAMPAIGN_TEMPLATES","getTemplateForCampaignType","campaignType","isTemplateConfigured","BannerbearService","__publicField","params","imagePromises","modifications","index","templateId","request","startTime","cached","templateConfig","platformKey","format","dimensions","imageUrl","generationTime","visual","platforms","visualPromises","platform","validVisuals","v","completed","failed","errors","totalTime","endpoint","url","imageUid","maxAttempts","attempts","pollInterval","image","name","value","promises","concurrent","results","i","batch","batchResults","statusCode","message","content","branding","fieldMappings","defaults","key","now","entry","bannerbearService","CampaignGenerator","SynapseContentGenerator","input","onRetry","sessionId","progress","template","insights","posts","_b","_c","_d","_e","campaign","duration","businessProfile","generatedContent","synapseContent","post","_f","_g","_h","templates","count","postTypes","postType","progressPercent","customer","diff","problem","templateTypes","distributed","insight","sources","sum","campaignId","totalPosts","stage","currentPost","callback","campaignGenerator","CAMPAIGN_TYPES","CampaignRecommender","scores","highestScore","recommendedId","reasoning","allTypes","type","t","score","factors","topic","typeId","reasons","campaignRecommender","DEFAULT_SCORING_WEIGHTS","generateSmartPicks","maxPicks","minConfidence","preferTimely","includePreview","getOrGenerateInsights","qualityInsights","candidates","generateAuthorityBuilderPicks","generateSocialProofPicks","generateLocalPulsePicks","scoredPicks","pick","scoreSmartPick","a","b","topPicks","generationTimeMs","fallbackPicks","generateTemplatePicks","synapseInput","generateSynapses","authorityInsights","picks","truncate","generatePreview","calculateEvidenceQuality","extractDataSources","socialInsights","hasLocation","hasWeather","c","hasLocalNews","localInsights","expiresAt","relevance","calculateRelevance","timeliness","calculateTimeliness","evidenceQuality","confidence","weights","overallScore","businessKeywords","insightText","keyword","daysLeft","whyNow","evidenceCount","addedSources","sourceMap","evidence","evidenceLower","prompt","parsed","text","maxLength","VALID_TRANSITIONS","CampaignStateMachine","from","to","session","toState","metadata","fromState","transition","updatedSession","state","campaignError","handler","h","event","campaignStateMachine","CampaignDatabaseService","supabase","updates","query","businessId","pieces","platformContent","pieceId","scheduledFor","campaignDB","DEFAULT_CONFIG","CampaignWorkflowService","uuidv4","smartPickId","generatedCampaign","errorSession","campaignRecord","storedSession","resetSession","contentWriter","PremiumContentWriter","primaryInsight","prev","current","platformContentPromises","characterCount","interval","args","campaignWorkflow","CampaignOrchestrator","targetState","recoveredSession","campaignOrchestrator"],"mappings":"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"}