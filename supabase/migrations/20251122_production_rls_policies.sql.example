-- PRODUCTION RLS POLICIES FOR SYNAPSE
-- Rename this file to .sql (remove .example) when ready to deploy
-- This implements proper user-based access control

BEGIN;

-- ============================================
-- PREREQUISITES (Run once in production)
-- ============================================
-- Create admin check function if it doesn't exist
CREATE OR REPLACE FUNCTION public.is_admin()
RETURNS BOOLEAN AS $$
BEGIN
    -- Check if user has admin role
    RETURN (
        SELECT EXISTS (
            SELECT 1
            FROM auth.users
            WHERE id = auth.uid()
            AND raw_user_meta_data->>'role' = 'admin'
        )
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================
-- DROP EXISTING POLICIES
-- ============================================
DO $$
DECLARE
    pol record;
BEGIN
    FOR pol IN
        SELECT tablename, policyname
        FROM pg_policies
        WHERE schemaname = 'public'
    LOOP
        EXECUTE format('DROP POLICY IF EXISTS %I ON %I', pol.policyname, pol.tablename);
    END LOOP;
END $$;

-- ============================================
-- INTELLIGENCE CACHE POLICIES
-- ============================================
-- Public read, authenticated write
CREATE POLICY "public_read_intelligence"
    ON public.intelligence_cache FOR SELECT
    TO public
    USING (true);

CREATE POLICY "authenticated_write_intelligence"
    ON public.intelligence_cache FOR INSERT
    TO authenticated
    WITH CHECK (auth.uid() IS NOT NULL);

CREATE POLICY "authenticated_update_intelligence"
    ON public.intelligence_cache FOR UPDATE
    TO authenticated
    USING (auth.uid() IS NOT NULL)
    WITH CHECK (auth.uid() IS NOT NULL);

CREATE POLICY "authenticated_delete_intelligence"
    ON public.intelligence_cache FOR DELETE
    TO authenticated
    USING (auth.uid() IS NOT NULL);

-- ============================================
-- UVP SESSIONS POLICIES
-- ============================================
-- Users can only access their own sessions
CREATE POLICY "user_read_own_uvp"
    ON public.uvp_sessions FOR SELECT
    TO authenticated
    USING (auth.uid() = user_id OR is_public = true);

CREATE POLICY "anon_read_public_uvp"
    ON public.uvp_sessions FOR SELECT
    TO anon
    USING (is_public = true);

CREATE POLICY "user_write_own_uvp"
    ON public.uvp_sessions FOR INSERT
    TO authenticated
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "user_update_own_uvp"
    ON public.uvp_sessions FOR UPDATE
    TO authenticated
    USING (auth.uid() = user_id)
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "user_delete_own_uvp"
    ON public.uvp_sessions FOR DELETE
    TO authenticated
    USING (auth.uid() = user_id);

-- ============================================
-- LOCATION DETECTION CACHE POLICIES
-- ============================================
-- Public read for cached data, authenticated write
CREATE POLICY "public_read_location"
    ON public.location_detection_cache FOR SELECT
    TO public
    USING (true);

CREATE POLICY "authenticated_write_location"
    ON public.location_detection_cache FOR INSERT
    TO authenticated
    WITH CHECK (auth.uid() IS NOT NULL);

CREATE POLICY "authenticated_update_location"
    ON public.location_detection_cache FOR UPDATE
    TO authenticated
    USING (auth.uid() IS NOT NULL)
    WITH CHECK (auth.uid() IS NOT NULL);

CREATE POLICY "admin_delete_location"
    ON public.location_detection_cache FOR DELETE
    TO authenticated
    USING (is_admin());

-- ============================================
-- INDUSTRY PROFILES POLICIES
-- ============================================
-- Public read, admin write
CREATE POLICY "public_read_industry"
    ON public.industry_profiles FOR SELECT
    TO public
    USING (true);

CREATE POLICY "admin_write_industry"
    ON public.industry_profiles FOR INSERT
    TO authenticated
    WITH CHECK (is_admin());

CREATE POLICY "admin_update_industry"
    ON public.industry_profiles FOR UPDATE
    TO authenticated
    USING (is_admin())
    WITH CHECK (is_admin());

CREATE POLICY "admin_delete_industry"
    ON public.industry_profiles FOR DELETE
    TO authenticated
    USING (is_admin());

-- ============================================
-- BRANDS POLICIES
-- ============================================
-- Users can only access their own brands
CREATE POLICY "user_read_own_brands"
    ON public.brands FOR SELECT
    TO authenticated
    USING (auth.uid() = user_id OR is_public = true);

CREATE POLICY "anon_read_public_brands"
    ON public.brands FOR SELECT
    TO anon
    USING (is_public = true);

CREATE POLICY "user_write_own_brands"
    ON public.brands FOR INSERT
    TO authenticated
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "user_update_own_brands"
    ON public.brands FOR UPDATE
    TO authenticated
    USING (auth.uid() = user_id)
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "user_delete_own_brands"
    ON public.brands FOR DELETE
    TO authenticated
    USING (auth.uid() = user_id);

-- ============================================
-- GRANT PERMISSIONS
-- ============================================
GRANT USAGE ON SCHEMA public TO anon, authenticated;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO anon;
GRANT ALL ON ALL TABLES IN SCHEMA public TO authenticated;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO authenticated;
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO anon, authenticated;

-- ============================================
-- FORCE POSTGREST RELOAD
-- ============================================
-- Add and drop columns to force reload
ALTER TABLE public.intelligence_cache ADD COLUMN _prod_reload BOOLEAN DEFAULT true;
ALTER TABLE public.uvp_sessions ADD COLUMN _prod_reload BOOLEAN DEFAULT true;
ALTER TABLE public.location_detection_cache ADD COLUMN _prod_reload BOOLEAN DEFAULT true;
ALTER TABLE public.industry_profiles ADD COLUMN _prod_reload BOOLEAN DEFAULT true;
ALTER TABLE public.brands ADD COLUMN _prod_reload BOOLEAN DEFAULT true;

SELECT pg_sleep(2);

ALTER TABLE public.intelligence_cache DROP COLUMN _prod_reload;
ALTER TABLE public.uvp_sessions DROP COLUMN _prod_reload;
ALTER TABLE public.location_detection_cache DROP COLUMN _prod_reload;
ALTER TABLE public.industry_profiles DROP COLUMN _prod_reload;
ALTER TABLE public.brands DROP COLUMN _prod_reload;

NOTIFY pgrst, 'reload schema';

COMMIT;

-- Verification
SELECT 'PRODUCTION RLS POLICIES APPLIED - User-based access control enabled' as status;