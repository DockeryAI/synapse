#!/bin/bash
# BR3 Pre-commit Hook
# Validates code before commit

set -e

echo "üîç BR3 Pre-commit checks..."

# Check for blocked patterns (exclude migrations and archived files)
# Only check staged files for RLS violations to avoid blocking legitimate migrations
if git diff --cached --name-only | grep "\.sql$" | grep -v "supabase/migrations/" | grep -v "sql/_archived/" | xargs grep -l "DISABLE ROW LEVEL SECURITY" 2>/dev/null; then
    echo "‚ùå BLOCKED: Found 'DISABLE ROW LEVEL SECURITY' in new/modified SQL files - this is forbidden"
    exit 1
fi

# Check for blocked imports in package.json changes
if git diff --cached --name-only | grep -q "package.json"; then
    for lib in "@chakra-ui" "@mui/material" "antd" "@nextui-org" "@mantine"; do
        if git diff --cached package.json | grep -q "$lib"; then
            echo "‚ùå BLOCKED: Adding blocked library $lib"
            exit 1
        fi
    done
fi

# Validate features.json if changed
if git diff --cached --name-only | grep -q "features.json"; then
    if ! python3 -c "import json; json.load(open('.buildrunner/features.json'))" 2>/dev/null; then
        echo "‚ùå features.json is not valid JSON"
        exit 1
    fi
fi

# Check for direct API calls in frontend code (must use edge functions)
FRONTEND_PATTERNS=(
    "src/components"
    "src/pages"
    "src/app"
)

API_PATTERNS=(
    "fetch.*https://api\."
    "axios\.get.*https://api\."
    "axios\.post.*https://api\."
    "axios\.put.*https://api\."
    "axios\.delete.*https://api\."
)

for dir in "${FRONTEND_PATTERNS[@]}"; do
    if [ -d "$dir" ]; then
        for pattern in "${API_PATTERNS[@]}"; do
            if grep -rE "$pattern" "$dir" --include="*.tsx" --include="*.jsx" --include="*.ts" --include="*.js" 2>/dev/null; then
                echo "‚ùå BLOCKED: Direct API call found in frontend code"
                echo "   Use edge functions instead of calling external APIs directly"
                exit 1
            fi
        done
    fi
done

echo "‚úÖ Pre-commit checks passed"
